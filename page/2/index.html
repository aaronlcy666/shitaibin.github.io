<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">
































<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="区块链、Go语言">
<meta name="keywords" content="区块链 Go语言 后端 技术 人生 编程">
<meta property="og:type" content="website">
<meta property="og:title" content="Go语言充电站">
<meta property="og:url" content="http://lessisbetter.site/page/2/index.html">
<meta property="og:site_name" content="Go语言充电站">
<meta property="og:description" content="区块链、Go语言">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Go语言充电站">
<meta name="twitter:description" content="区块链、Go语言">






  <link rel="canonical" href="http://lessisbetter.site/page/2/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Go语言充电站 – 大彬 less is better</title>
  












  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Go语言充电站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">大彬 less is better</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-主页">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />主页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-标签云">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签云</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-专题文章">

    
    
    
      
    

    

    <a href="/subject/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />专题文章</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-文章列表">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />文章列表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-关于">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-大牛博客">

    
    
    
      
    

    

    <a href="/blogs/" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />大牛博客</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

    <a href="https://github.com/Shitaibin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/17/fabric-concepts-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/17/fabric-concepts-notes/" class="post-title-link" itemprop="url">快速入门Fabric核心概念和框架</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-17 18:54:56" itemprop="dateCreated datePublished" datetime="2019-07-17T18:54:56+08:00">2019-07-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><p>这是一篇信息整合的文章，80%的内容来自Fabric官方文档和网络文章，在此基础上整理和修改，剩下20%为操作记录。</p>
<h3 id="官方文档资料链接"><a href="#官方文档资料链接" class="headerlink" title="官方文档资料链接"></a>官方文档资料链接</h3><ul>
<li><p><a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html</a><br>Fabric术语表，所有概念都能在这找到，建议详读几遍，有疑问时也可以随时来查，会有新的理解。</p>
</li>
<li><p><a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/Fabric-FAQ.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/Fabric-FAQ.html</a></p>
<p>这篇FAQ，也会解决很多疑问。</p>
</li>
</ul>
<p><strong>剩下的官方文档链接都加入到了下面的笔记中</strong>。</p>
<h3 id="网络文章"><a href="#网络文章" class="headerlink" title="网络文章"></a>网络文章</h3><p><a href="https://blog.51cto.com/9291927/category29.html" target="_blank" rel="noopener">天山老妖S：HyperLeger Fabric SDK开发系列文章</a></p>
<p><a href="http://www.taohui.pub/2018/05/26/%e5%8c%ba%e5%9d%97%e9%93%be%e5%bc%80%e6%ba%90%e5%ae%9e%e7%8e%b0hyperledger-fabric%e6%9e%b6%e6%9e%84%e8%af%a6%e8%a7%a3/" target="_blank" rel="noopener">陶辉：区块链开源实现hyperledger fabric架构详解</a></p>
<p><a href="https://shanma.pro/tutorial/hyperledger/16632.html" target="_blank" rel="noopener">Hyperledger Fabric 开发系列文章</a></p>
<h2 id="笔记摘录"><a href="#笔记摘录" class="headerlink" title="笔记摘录"></a>笔记摘录</h2><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="http://img.lessisbetter.site/2019-07-fabric-arch.png" alt="HyperLeger Fabric架构"></p>
<p> Fabric网络是通过组织（organization）来划分的，每个组织内都包含承担不同功能的Peer 节点，每个Peer节点又可以担任多种角色。<strong>所有的组织共用一个统一的Orderer排序服务集群</strong>。基于Hyperledger Fabric区块链网络的设计时需要考虑组织之间的业务关系以及内部每个模块之间的联系，统一进行规划。</p>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-network.png" alt=""></p>
<p>每个组织通常拥有自己的客户端、Peer节点和CA节点，并且可以根据需要创建一个或多个不同的类型节点。Orderer节点不属于某个组织的实体，属于组织共同维护的节点。</p>
<p><img src="http://img.lessisbetter.site/2019-07-fabirc-org.png" alt=""></p>
<h3 id="排序节点"><a href="#排序节点" class="headerlink" title="排序节点"></a>排序节点</h3><p>orderer负责排序和打包区块。排序服务节点只是决定交易处理的顺序，并不对交易的合法性进行校验，也无需去管之前的交易是否合法，也不负责维护账本信息，只有记账节点才有账本写入权限。peer验证交易后会给交易打上交易是否合法。</p>
<p>排序服务节点接收包含背书签名的交易，对未打包的交易进行排序生成区块，广播给Peer节点中的主节点。排序服务提供的是原子广播，保证同一个链上的节点接收到相同的消息，并且有相同的逻辑顺序。排序服务独立于Peer进程存在并且以先来先服务的方式对Fabric网络上的所有通道进行排序交易。</p>
<p>Tx排序的依据是什么？根据每个通道按时间顺序调用，创建每个通道的交易区块。</p>
<p>出块的依据是什么？交易数、时间？都可以，具体见<a href="#orderer排序交易">orderer排序交易</a>。</p>
<h3 id="peer节点角色"><a href="#peer节点角色" class="headerlink" title="peer节点角色"></a>peer节点角色</h3><p>peer文档：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/peers/peers.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/peers/peers.html</a></p>
<p>peer节点负责背书和验证交易，以及Org之间的通信。</p>
<p>每个Org可以有多个Peer，每个Peer节点都是记账节点，并且可担任多种角色：</p>
<ul>
<li>Endorser Peer（背书节点）</li>
<li>Leading Peer（主节点）</li>
<li>Committer Peer（记账节点）</li>
<li>Anchor Peer（锚节点）</li>
</ul>
<h4 id="背书节点-Endorser-Peer"><a href="#背书节点-Endorser-Peer" class="headerlink" title="背书节点(Endorser Peer)"></a>背书节点(Endorser Peer)</h4><p>部分Peer节点会执行交易并对结果进行签名背书。背书节点是动态的角色，是与具体链码绑定的，由链码的背书策略指定。</p>
<p>只有在应用程序向节点发起交易背书请求时才成为背书节点，其它时候是普通的记账节点，只负责验证交易并记账。</p>
<h4 id="主节点（Leading-Peer）"><a href="#主节点（Leading-Peer）" class="headerlink" title="主节点（Leading Peer）"></a>主节点（Leading Peer）</h4><p>主节点负责和Orderer排序服务节点通信，从排序服务节点处获取最新的区块，并把区块分发到本channel内同组织的其他节点。可以使用配置文件强制设置，也可以选举产生。</p>
<blockquote>
<p>注意：主节点不是指Raft中的leader，是指org中的主节点(leading peer)。</p>
</blockquote>
<h4 id="记账节点（Committer-Peer）"><a href="#记账节点（Committer-Peer）" class="headerlink" title="记账节点（Committer Peer）"></a>记账节点（Committer Peer）</h4><p>负责验证区块里的交易，然后将区块提交（写入/追加）到其通道账本的副本。记账节点还将每个块中的每个交易标记为<strong>有效或无效</strong>，通过验证的为有效，否则为无效。</p>
<h4 id="锚节点（Anchor-Peer）"><a href="#锚节点（Anchor-Peer）" class="headerlink" title="锚节点（Anchor Peer）"></a>锚节点（Anchor Peer）</h4><p>在一个通道上可以被所有其它Peer节点发现的Peer节点，通道上的每个组织都有一个或多个锚节点，多个锚节点可以用来防止单点故障，通过锚节点实现不同组织的Peer节点发现通道上的所有组织的锚节点。</p>
<p>举个例子，peer0.org1是org1的锚节点，它连接peer0.org2时，如果peer0.org2知道org3的锚节点peer0.org3，那么会告诉peer0.org1，org3的锚节点是peer0.org3，以后peer0.org1就可以直接和peer0.org3通信了。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>2种：1. CLI，2. SDK.</p>
<h4 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h4><p>Fabric提供了三种语言版本的SDK，分别如下：</p>
<ol>
<li>Fabric Nodejs SDK</li>
<li>Fabric Java SDK</li>
<li>Fabric Go SDK</li>
</ol>
<p>Fabric区块链应用可以通过SDK访问Fabric区块链网络中的多种资源，包括账本、交易、链码、事件、权限管理等。应用程序代表用户与Fabric区块链网络进行交互，Fabric SDK API提供了如下功能：</p>
<ol>
<li>创建通道</li>
<li>将peer节点加入通道</li>
<li>在peer节点安装链码</li>
<li>在通道实例化链码</li>
<li>通过链码调用交易</li>
<li>查询交易或区块的账本</li>
</ol>
<h3 id="链码"><a href="#链码" class="headerlink" title="链码"></a>链码</h3><p>链码即智能合约，链码分系统链码和用户链码，在没有特殊强调的时候，链码就是指用户链码。</p>
<p>链码操作包含3个基本操作：安装（install）、实例化（instantiation）和调用（Invoke），以及其他操作比如打包、签名。</p>
<p>用户链码被编译成一个独立的应用程序，运行于隔离的Docker容器中，在链码部署的时候会自动生成链码的Docker镜像，链码容器通过gRPC协议与相应的Peer节点进行交互，以操作分布式账本中的数据。</p>
<p>一个channel内链码只需实例化1次，所有运行链码的节点都需要安装该链码，如果只需要验证交易，并不需要安装链码，因为实例化后，可以通过gRPC通信与链码容器交互验证链码。</p>
<h4 id="背书策略（Endorser-Policy）"><a href="#背书策略（Endorser-Policy）" class="headerlink" title="背书策略（Endorser Policy）"></a>背书策略（Endorser Policy）</h4><p><strong>背书策略是背书节点如何决策交易是否合法的条件</strong>。链码实例化时可指定背书策略，当记账节点接收到交易时，会获知相关链码信息，然后检查链码的背书策略，判断交易是否满足背书策略，若满足则标注交易为合法。</p>
<p>背书策略可分为主体Principal(P)和阈值Threshold(T)两部分，具体如下：</p>
<ul>
<li>Principal指定由哪些成员进行背书。</li>
<li>Threshold接受两个输入，分别为阈值t和若干个P的集合n，只要交易中包含了n中t个成员的背书则认为交易合法。</li>
</ul>
<p>背书策略可以指定某几个组织内的任意成员身份进行背书，或者要求至少有一个管理员身份进行背书等等。</p>
<ul>
<li>T(1, ‘A’, ‘B’) 则需要A，B中任意成员背书。</li>
<li>T(1, ‘A’, T(2, ‘B’, ‘C’))则需要A成员背书或B，C成员同时背书。</li>
</ul>
<p>目前客户端已经实现对背书策略的支持，可以通过-P来指定背书策略，结合AND、OR来组合成员，完成成员身份（admin、member）的集合。</p>
<p><code>-P OR ( &#39;Org1.admin&#39; , AND (&#39;Org2.member&#39; , &#39;Org3.member&#39;) )</code></p>
<blockquote>
<p>可以把OR、AND理解为函数，函数内为参数。</p>
</blockquote>
<p>上述背书策略指定要么Org1的admin进行背书，或者Org2和Org3的成员同时进行背书，才满足背书策略。</p>
<p>链接：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#endorsement-policy" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#endorsement-policy</a></p>
<h4 id="系统链码"><a href="#系统链码" class="headerlink" title="系统链码"></a>系统链码</h4><p>系统链码与用户链码有相同的编程模型，但<strong>系统链码运行在Peer节点，用户链码则在隔离的容器中运行。因此，系统链码内置为Peer节点的可执行文件中，不遵循用户链码的生命周期，安装、实例化、升级不适用于系统链码</strong>。</p>
<p>系统链码用于减少Peer节点与用户链码进行gRPC通信的开销，同时权衡管理的灵活性。系统链码只能通过Peer节点的二进制文件升级，必须通过一组固定的参数进行注册，但<strong>不具有背书策略</strong>。</p>
<p>Hyperledger Fabric系统链码实现了一系列系统功能，以便系统集成人员能够根据需求对其进行修改与替换。</p>
<p>常见系统链码如下：</p>
<ul>
<li>生命周期系统链码（LSCC ）：负责对用户链码的生命周期进行管理。</li>
<li>配置系统链码（CSCC）：处理在Peer节点上的通道配置。</li>
<li>查询系统链码（QSCC）：提供账本的查询API，例如获取区块以及交易。</li>
<li>背书系统链码（ESCC）：背书过程的管理和配置。</li>
<li>验证系统链码（VSCC）：处理交易验证，包括检查背书策略以及多进程并发控制。</li>
</ul>
<p><strong>这样容易记：一共5个SCC，前2个与配置相关，后3个与操作相关，配置有生命周期和配置，操作有背书、验证和查询</strong>。</p>
<p>在修改或者替换系统链码（LSCC、ESCC、VSCC）时必须注意，因为系统链码在主交易执行的路径中。VSCC在将区块提交至账本前，所有在通道的Peer节点会计算相同的验证以避免账本分歧（不确定性）。如果VSCC被改变或者替换，需要特别小心。</p>
<h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><p>通过install安装链码，通过instantiate实例化链码，然后可以通过invoke、query调用链码和查询链码。<br>如果需要升级链码，则需要先install安装新版本的链码，通过upgrade升级链码。在install安装链码前，可以通过package打包并签名生成打包文件，然后再通过install安装。</p>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-chaincode-lifecycle.png" alt=""></p>
<h4 id="链码管理"><a href="#链码管理" class="headerlink" title="链码管理"></a>链码管理</h4><p><code>peer chaincode -h</code>可以列出链码的几种操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">install     Package the specified chaincode into a deployment spec and save it on the peer&apos;s path.</span><br><span class="line">instantiate Deploy the specified chaincode to the network.</span><br><span class="line">invoke      Invoke the specified chaincode.</span><br><span class="line">list        Get the instantiated chaincodes on a channel or installed chaincodes on a peer.</span><br><span class="line">package     Package the specified chaincode into a deployment spec.</span><br><span class="line">query       Query using the specified chaincode.</span><br><span class="line">signpackage Sign the specified chaincode package</span><br><span class="line">upgrade     Upgrade chaincode.</span><br></pre></td></tr></table></figure>
<ul>
<li><p>安装：把chaincode打包成部署规格，并且保存到peer的某个路径。</p>
</li>
<li><p>实例化：部署chaincode到网络。</p>
</li>
<li>调用：调用chaincode。</li>
<li>list：列出某个通道上已经实例化的chaincode或已安装到peer上的chaincode。</li>
<li>打包：把chaincode打包成部署规格。</li>
<li>查询：使用chaincode查询，即查询该查询该chaincode上的信息。</li>
<li>signpackage：对打包的chaincode签名。</li>
<li>升级：升级已实例化的chaincode。</li>
</ul>
<p>可以看到安装chaincode实际已经包含了打包的过程。</p>
<h4 id="打包链码"><a href="#打包链码" class="headerlink" title="打包链码"></a>打包链码</h4><p>链码包由三个部分组成：</p>
<ol>
<li><strong>由ChaincodeDeploymentSpec（CDS）格式定义的链码</strong>。CDS根据代码及其它属性（如名称与版本）定义链码包；</li>
<li><strong>一个可选的实例化策略，能够被用作背书的策略进行描述</strong>；</li>
<li>拥有链码的实体的一组签名。</li>
</ol>
<p>其中，链码的签名主要目的如下：</p>
<ol>
<li>建立链码的所有权；</li>
<li>允许验证链码包中的内容；</li>
<li>允许检测链码包是否被篡改。</li>
</ol>
<p>通道上的链码的实例化交易的创建者能够被链码的实例化策略验证。</p>
<p>链码打包的方法由两种，一种是打包被多个所有者所拥有的链码，需要初始化创建一个被签名的链码包（SignedCDS），然后将其按顺序的传递给其它所有者进行签名；一种是打包单个所有者持有的链码。</p>
<p>创建一个被签名的链码包的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode package -n sacc -p chaincodedev/chaincode/sacc -v 0 -s -S -i &quot;AND(&apos;OrgA.admin&apos;)&quot; ccpack.out</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-s</code>选项创建一个能被多个所有者签名的链码包，而不是简单的创建一个原始的CDS。一旦-s被指定，如果其它所有者想要签名CDS，则-S选项必须被指定。否则，将会创建一个SignedCDS，除CDS外仅仅包括实例化策略。</li>
<li><code>-S</code>选项使用被在core.yaml文件中定义的localMspid属性的值标识的MSP对链码包进行签名。</li>
<li><code>-S</code>选项是可选的。如果创建了一个没有签名的链码包，不能被其它所有者使用signpackage命令进行签名。</li>
<li><code>-i</code>选项是可选的，允许为链码指定实例化策略。实例化策略与背书策略有相同的格式，指定哪些身份能够实例化链码。本例中仅OrgA的admin能够实例化链码。如果没有实例化策略被指定，将会使用默认的策略，仅允许拥有Peer的MSP的管理员身份实例化链码。</li>
</ul>
<h4 id="签名链码"><a href="#签名链码" class="headerlink" title="签名链码"></a>签名链码</h4><p>在创建阶段就被签名的链码包能够交给其它所有者进行检查与签名，支持带外对链码进行签名。<br> ChaincodeDeploymentSpec可以选择由所有者集合进行签名，从而创建一个SignedChaincodeDeploymentSpec(SignedCDS)。SignedCDS包括3个部分：</p>
<ol>
<li><p>CDS包括源代码，链码的名称与版本号；</p>
</li>
<li><p>链码的实例化策略，表示为背书策略；</p>
</li>
<li><p>链码所有者的列表，由背书策略定义。</p>
</li>
</ol>
<p><strong>当在某些通道上实例化链码时，背书策略是在带外确定的</strong>，用于提供合适的MSP主体。如果没指定实例化策略，则默认的策略就是通道的任何MSP管理员。</p>
<p>每一个链码的所有者通过将SignedCDS与链码所有者的身份（例如证书）组合并签署组合结果来背书ChaincodeDeploymentSpec。</p>
<p>一个链码的所有者能够对自己所创建的签名过的链码包进行签名，需要使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode signpackage ccpack.out signedccpack.out</span><br></pre></td></tr></table></figure>
<p>ccpack.out、signedccpack.out分别是输入与输出包。signedccpack.out包括一个对链码包附加的签名（通过local msp进行的签名）。</p>
<h4 id="安装链码"><a href="#安装链码" class="headerlink" title="安装链码"></a>安装链码</h4><p>将链码的源代码打包成ChaincodeDeploymentSpec（CDS）的规定的格式，然后<strong>安装到通道中的背书节点上</strong>。</p>
<p>当安装的链码包只包含一个ChaincodeDeploymentSpec时，将使用默认初始化策略并包括一个空的所有者列表。<br>链码应该仅仅被安装在链码所有者成员的背书节点上，用于实现链码对于网络中其它成员在逻辑上是隔离的。</p>
<p>安装链码会发送一个<strong>SignedProposal到生命周期系统链码(LSCC)</strong> ，也就是说会发送调用系统链码的交易。</p>
<p>使用CLI安装sacc链码的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode install -n sacc -v 1.0 -p sacc</span><br></pre></td></tr></table></figure>
<ul>
<li>-n选项指定链码实例名称</li>
<li>-v选项指定链码的版本</li>
<li>-p选项指定链码所在路径，必须在GOPATH路径下</li>
</ul>
<p>CLI内部创建<strong>sacc</strong>的SignedChaincodeDeploymentSpec，然后将其发送给本地Peer节点，Peer节点会<strong>调用</strong>LSCC上的安装方法。<strong>为了在Peer节点上安装链码，SignedProposal的签名必须来自于Peer节点的本地MSP管理员之一</strong>。</p>
<p><strong>未安装 chaincode 的节点不能执行 chaincode，但仍可以验证交易并提交到账本中。所以背书节点必须按照链码，记账节点并非必须安装链码。</strong></p>
<h4 id="实例化链码"><a href="#实例化链码" class="headerlink" title="实例化链码"></a>实例化链码</h4><p><strong>链码和通道是低耦合的：实例化调用生命周期系统链码(LSCC)用于创建及初始化通道上的链码。链码能够被绑定到任意数量的通道，以及在每个通道上单独的操作。无论链码安装及实例化到多少个通道上，每个通道的状态都是隔离的。</strong></p>
<p>实例化的创建者必须满足包含在SignedCDS内链码的<strong>实例化策略</strong>，而且还必须是通道的写入器（作为通道创建的一部分被配置）。可以防止部署链码的流氓实体或者欺骗者在未被绑定的通道上执行链码。</p>
<p><strong>默认的实例化策略是任意的通道MSP的管理员，因此链码实例化交易的创建者必须是通道管理员之一</strong>。当交易提案到达背书节点后，背书节点会根据实例化策略验证创建者的签名。在提交实例化交易到账本前，在交易验证时再一次完成该操作。</p>
<p><strong>实例化交易同样设置了通道上的链码的背书策略</strong> 。背书策略描述了交易被通道上成员接受的认证要求。<br>使用CLI去实例化sacc的链码并初始化状态为user1与0，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode instantiate -n sacc -v 1.0 -c &apos;&#123;&quot;Args&quot;:[&quot;user1&quot;,&quot;0&quot;]&#125;&apos; -P &quot;OR (&apos;Org1.member&apos;,&apos;Org2.member&apos;)&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-n选项指定链码实例名称</strong></li>
<li>-v选项指定链码的版本</li>
<li>-c 选项指定链码的调用参数</li>
<li>-P选项指定链码的背书策略</li>
</ul>
<p>链码的背书策略表示，org1.member或者org2.member必须对调用使用sacc(这名字起的让我以为是某种SCC)的交易进行签名，以保障交易是有效的。在成功实例化后，通道的链码进入激活状态，可以处理任意的交易提案。交易到达背书节点时，会同时被处理。</p>
<p>实例化选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@5af5a3fb3bb7:/var/hyperledger/production# peer chaincode instantiate -h</span><br><span class="line">Deploy the specified chaincode to the network.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  peer chaincode instantiate [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -C, --channelID string               The channel on which this command should be executed</span><br><span class="line">      --collections-config string      The fully qualified path to the collection JSON file including the file name</span><br><span class="line">      --connectionProfile string       Connection profile that provides the necessary connection information for the network. Note: currently only supported for providing peer connection information</span><br><span class="line">  -c, --ctor string                    Constructor message for the chaincode in JSON format (default &quot;&#123;&#125;&quot;)</span><br><span class="line">  -E, --escc string                    The name of the endorsement system chaincode to be used for this chaincode</span><br><span class="line">  -h, --help                           help for instantiate</span><br><span class="line">  -l, --lang string                    Language the chaincode is written in (default &quot;golang&quot;)</span><br><span class="line">  -n, --name string                    Name of the chaincode</span><br><span class="line">      --peerAddresses stringArray      The addresses of the peers to connect to</span><br><span class="line">  -P, --policy string                  The endorsement policy associated to this chaincode</span><br><span class="line">      --tlsRootCertFiles stringArray   If TLS is enabled, the paths to the TLS root cert files of the peers to connect to. The order and number of certs specified should match the --peerAddresses flag</span><br><span class="line">  -v, --version string                 Version of the chaincode specified in install/instantiate/upgrade commands</span><br><span class="line">  -V, --vscc string                    The name of the verification system chaincode to be used for this chaincode</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">      --cafile string                       Path to file containing PEM-encoded trusted certificate(s) for the ordering endpoint</span><br><span class="line">      --certfile string                     Path to file containing PEM-encoded X509 public key to use for mutual TLS communication with the orderer endpoint</span><br><span class="line">      --clientauth                          Use mutual TLS when communicating with the orderer endpoint</span><br><span class="line">      --connTimeout duration                Timeout for client to connect (default 3s)</span><br><span class="line">      --keyfile string                      Path to file containing PEM-encoded private key to use for mutual TLS communication with the orderer endpoint</span><br><span class="line">  -o, --orderer string                      Ordering service endpoint</span><br><span class="line">      --ordererTLSHostnameOverride string   The hostname override to use when validating the TLS connection to the orderer.</span><br><span class="line">      --tls                                 Use TLS when communicating with the orderer endpoint</span><br><span class="line">      --transient string                    Transient map of arguments in JSON encoding</span><br></pre></td></tr></table></figure>
<h4 id="调用链码"><a href="#调用链码" class="headerlink" title="调用链码"></a>调用链码</h4><p>调用链码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C mychannel -n sacc -c &apos;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;user1&quot;,&quot;user2&quot;,&quot;10&quot;]&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>查询链码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n sacc -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;user1&quot;]&#125;&apos;</span><br></pre></td></tr></table></figure>
<p><strong>调用链码的前提是链码已经实例化。</strong></p>
<p>链码实例化之后存在了运行了一个容器，这个容器一直在运行，所以调用1个链码，实际是peer容器和链码容器交互的过程。</p>
<p>链码与Peer节点的交互过程如下：</p>
<ol>
<li>链码通过gRPC与Peer节点交互，当Peer节点收到客户端的交易提案请求后，会发送一个链码消息对象（包含交易提案信息、调用者信息）给对应的链码。</li>
<li>链码调用Invoke方法，通过发送获取数据（GetState）和写入数据（PutState）消息，向Peer节点获取账本状态信息和发送预提交状态。</li>
<li>链码发送模拟执行结果给Peer节点，Peer节点对交易提案和模拟执行结果进行背书签名。</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-invoke-chaincode.png" alt=""></p>
<p><img src="http://img.lessisbetter.site/2019-07-chaincode_swimlane.png" alt=""></p>
<h4 id="升级链码"><a href="#升级链码" class="headerlink" title="升级链码"></a>升级链码</h4><p>链码的升级通过改变其版本号（作为SignedCDS的一部分）。SignedCDS另外的部分，如所有者及实例化策略都是可选的。然而，<strong>链码的名称必须是一致的，否则会被当做另外一个新的链码</strong>。<br>在升级前，必须将新版本的链码安装到有需求的背书节点上。升级也是一种交易，会把新版本的链码绑定到通道中。<strong>升级只能在一个时间点对一个通道产生影响，其它通道仍然运行旧版本的链码</strong>。<br>由于可能存在多个版本的链码同时存在，<strong>升级过程不会自动删除老版本链码，用户必须手动操作删除过程</strong>。<br>升级与实例化transaction有一点不同的是：通过现有的chaincode实例化策略检查升级transaction，而不是用新的策略检查。这是为了确保只有当前实例化策略中指定的成员能够升级chaincode。<br>在升级期间，链码的Init函数也会被调用，执行有关升级的数据或者使用数据重新进行初始化，在升级链码的期间避免对状态进行重置。<br>安装新版本的链码<br><code>peer chaincode install -n sacc -v 1 -p path/to/my/chaincode/v1</code><br>upgrade升级链码<br><code>peer chaincode upgrade -n sacc -v 1 -c &#39;{&quot;Args&quot;:[&quot;d&quot;, &quot;e&quot;, &quot;f&quot;]}&#39; -C mychannel</code></p>
<h4 id="都是交易"><a href="#都是交易" class="headerlink" title="都是交易"></a>都是交易</h4><p>安装、实例化、调用、升级链码，都是创建一笔交易，通过交易实现。</p>
<h4 id="链码开发"><a href="#链码开发" class="headerlink" title="链码开发"></a>链码开发</h4><p><code>github.com/hyperledger/fabric/core/chaincode/shim</code>包是开发Go语言链码的API。shim 包提供了链码与账本交互的中间层。链码通过 shim.ChaincodeStub 提供的方法来读取和修改账本的状态。</p>
<p>链码启动必须通过调用 shim 包中的 Start 函数，而 Start 函数被调用时需要传递一个类型为 Chaincode 的参数，这个参数 Chaincode 是一个接口类型，该接口中有两个重要的函数 Init 与 Invoke 。</p>
<p>Chaincode 接口定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Chaincode <span class="keyword">interface</span>&#123;</span><br><span class="line">    Init(stub ChaincodeStubInterface) peer.Response</span><br><span class="line">    Invoke(stub ChaincodeStubInterface) peer.Response</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Init 与 Invoke 方法</strong></p>
<p>编写链码，关键是实现 Init 与 Invoke 两个方法，必须由所有链码实现。Fabric 通过调用指定的函数来运行事务。</p>
<ul>
<li><strong>Init：</strong>在链码实例化或升级时被调用, 完成初始化数据的工作。</li>
<li><strong>invoke：</strong>更新或查询提案事务中的分类帐本数据状态时，Invoke 方法被调用， 因此响应调用或查询的业务实现逻辑都需要在此方法中编写实现。</li>
</ul>
<p>示例：<a href="https://blog.51cto.com/9291927/2318364" target="_blank" rel="noopener">https://blog.51cto.com/9291927/2318364</a></p>
<h3 id="通道"><a href="#通道" class="headerlink" title="通道"></a>通道</h3><p><strong>通道由排序服务管理</strong>，排序服务节点还负责对通道中的交易进行排序。。</p>
<p>目前通道分为<strong>系统通道（System Channel）和应用通道</strong>（Application Channel）。排序服务通过系统通道来管理应用通道，用户的交易信息通过应用通道传递。</p>
<p><strong>每个组织可以有多个节点加入同一个通道</strong>，组织内的节点中可以指定一个锚节点或多个锚节点（增强系统可靠性，避免单点故障）。另外，同一组织的节点会选举或指定主导节点（leading peer），主导节点负责接收从排序服务发来的区块，然后转发给本组织的其它节点。主导节点可以通过特定的算法选出，可以保证在节点数量不断变动的情况下仍能维持整个网络的稳定性。</p>
<p>在Fabric网络中，<strong>可能同时存在多条彼此隔离的通道，每条通道包含一条私有的区块链和一个私有账本，通道中可以实例化一个或多个链码，以操作区块链上的数据</strong>。</p>
<p><strong>通道是共识服务提供的一种通讯机制</strong>，基于发布-订阅关系，将Peer节点和排序节点根据某个Topic连接在一起，形成一个具有保密性的通讯链路（虚拟），实现业务隔离的要求。</p>
<p><strong>排序服务提供了供Peer节点订阅的主题</strong>（如发布-订阅消息队列），每个主题是一个通道。Peer节点可以订阅多个通道，并且只能访问自己所订阅通道上的交易，因此一个Peer节点可以通过接入多个通道参与到多条链中。</p>
<p><strong>排序服务支持多通道，提供了通向客户端和Peer节点的共享通信通道</strong>，提供了包含交易的消息广播服务（broadcast和deliver）。客户端可以通过通道向连接到通道的所有节点广播（broadcast）消息，向连接到通道的所有节点投递(deliver)消息。多通道使得Peer节点可以基于应用访问控制策略来订阅任意数量的通道，应用程序根据业务逻辑决定将交易发送到1个或多个通道。</p>
<p>文档：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/channels.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/channels.html</a></p>
<h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><p>在创建通道的时候，需要定义通道的成员和组织、锚节点（anchor peer）和排序服务节点，一条与通道对应的区块链会同时生成，用于记录账本的交易，通道的初始配置信息记录在区块链的创世区块中，可以通过增加一个新的配置区块来更改通道的配置信息。</p>
<p>创建通道的时候定义了成员，只有通过成员MSP验证的实体，才能够加入到通道并访问通道的数据。在通道中一般包含有若干成员（组织），若两个网络实体的×××书能够追溯到同一个根CA，则认为这两个实体属于同一组织。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>通道的配置信息都被打包到一个区块中，并存放在通道的共享账本中，成为通道的配置区块，配置区块除了配置信息外不包含其它交易信息。通道可以使用配置区块来更新配置，因此在账本中每新添加一个配置区块，通道就按照最新配置区块的定义来修改配置。通道账本的首个区块一定是配置区块，也称为<strong>创世区块</strong>（Genesis Block）。</p>
<h3 id="交易"><a href="#交易" class="headerlink" title="交易"></a>交易</h3><p>交易的过程，实际是共识的3步：背书、排序和校验。</p>
<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><p>Fabric区块链的交易分两种，<strong>部署交易和调用交易</strong>。</p>
<p><strong>部署交易把链码部署到Peer节点上并准备好被调用，当一个部署交易成功执行时，链码就被部署到各个背书节点上。（部署指实例化）</strong></p>
<p>调用交易是客户端应用程序通过Fabric提供的API调用先前已部署好的某个链码的某个函数执行交易，并相应地读取和写入KV数据库，返回是否成功或者失败。</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>详读这篇文档：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/txflow.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/txflow.html</a></p>
<p>背书节点校验客户端的签名，然后执行智能合约代码模拟交易。交易处理完成后，对交易信息签名，返回给客户端。客户端收到签名后的交易信息后，发给排序服务节点排序。排序服务节点将交易信息排序打包成区块后，广播发给确认节点，写入区块链中。</p>
<p><img src="http://img.lessisbetter.site/2019-07-tx-flow.png" alt=""></p>
<h5 id="客户端提案"><a href="#客户端提案" class="headerlink" title="客户端提案"></a>客户端提案</h5><p>客户端应用程序利用SDK（Node.js，Java，Python）构造交易提案（Proposal），提案有2种：</p>
<ol>
<li>实例化chaincode。</li>
<li>调用chaincode。</li>
</ol>
<p>客户端把交易提案（<strong>Proposal</strong>）根据背书策略发送给一个或多个背书节点，<strong>交易提案中包含本次交易要调用的合约标识、合约方法和参数信息以及客户端签名</strong>等。<br>SDK将交易提案打包为可识别的格式（如gRPC上的protobuf），并使用用户的加密凭证为该交易提案生成唯一的签名。</p>
<p>背书策略定义需要哪些节点背书交易才有效，例如需要5个成员的背书节点中至少3个同意；或者某个特殊身份的成员支持等。客户端只有在收集足够多的背书节点的交易提案签名，交易才能被视为有效。</p>
<p><img src="http://img.lessisbetter.site/2019-07-txflow-step1.png" alt=""></p>
<h5 id="背书节点为提案背书"><a href="#背书节点为提案背书" class="headerlink" title="背书节点为提案背书"></a>背书节点为提案背书</h5><p>背书节点（endorser）收到交易提案后，<strong>验证签名</strong>并确定提交者是否有权执行操作。背书节点将交易提案的参数作为输入，在当前状态KV数据库上执行交易，生成响应返回给客户端，响应包<strong>含执行返回值、读写集的交易结果（此时不会更新账本），交易结果集、背书节点的签名和背书结果（YES/NO）作为提案的结果</strong>，客户端SDK解析信息判断是否应用于后续的交易。</p>
<p><img src="http://img.lessisbetter.site/2019-07-txflow-step2.png" alt=""></p>
<p>在所有合法性校验通过后，背书节点按照交易提案调用链码模拟执行交易。链码执行时，读取的数据（键值对）是背书节点中本地的状态数据库，链码读取过的数据回被归总到读集（Read Set）；链码对状态数据库的写操作并不会对账本做改变，所有的写操作将归总到一个写入集（Write Set）中记录下来。读集和写集将在确认节点中用于确定交易是否最终写入账本。</p>
<p>资料：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#endorsement" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#endorsement</a></p>
<h5 id="客户端收集提案背书"><a href="#客户端收集提案背书" class="headerlink" title="客户端收集提案背书"></a>客户端收集提案背书</h5><p>客户端验证背书节点签名，并比较各节点返回的提案结果，判断提案结果是否一致以及是否参照指定的背书策略执行。</p>
<p><img src="http://img.lessisbetter.site/2019-07-txflow-step3.png" alt=""></p>
<p>当背书结果都通过验证，并且满足背书策略时，客户端生成一笔交易发送给排序节点。<strong>交易包含交易签名、proposal、读写集、背书结果和通道ID。</strong></p>
<p><img src="http://img.lessisbetter.site/2019-07-txflow-step4.png" alt=""></p>
<h5 id="orderer排序交易"><a href="#orderer排序交易" class="headerlink" title="orderer排序交易"></a>orderer排序交易</h5><p>排序服务节点对接收到的交易进行共识排序，然后按照区块生成策略，将一批交易打包到一起，生成新的区块，调用deliver API投递消息，发送给确认节点。</p>
<p><img src="http://img.lessisbetter.site/2019-07-txflow-step5.png" alt=""></p>
<p><strong>区块的广播有两种触发条件</strong>，一种是当通道的交易数量达到某个预设的阈值，另一种是在交易数量没有超过阈值但距离上次广播的时间超过某个特定阈值，也可触发广播数据块。两种方式相结合，使得经过排序的交易及时生成区块并广播给通道的Leader节点（记账节点），Leader节点验证后，再发送给同channel同组织的其他记账节点。</p>
<h5 id="peer验证区块"><a href="#peer验证区块" class="headerlink" title="peer验证区块"></a>peer验证区块</h5><p>peer需要对区块内的所有交易进行验证，验证交易是否按背书策略执行以及根据读写集把交易打上有效或者无效的标签。最后把区块追加到本地的区块链，修改世界状态。</p>
<p>记账节点收到排序服务节点发来的区块后，逐笔检查区块中的交易：</p>
<ol>
<li>先检查交易的合法性以及该交易是否曾经出现过。</li>
<li>然后调用校验系统链码（VSCC，Validation System Chaincode）检验交易的签名背书是否合法，</li>
<li>以及背书的数量是否满足背书策略的要求。</li>
<li>记账节点对交易进行<strong>多版本并发控制（MVCC）</strong>检查，即校验交易的读集（Read Set）是否和当前账本中的版本一致（即没有变化）。如果没有改变，说明交易写集（Write Set）中对数据的修改有效，把该交易标注为有效，交易的写集更新到状态数据库中。如果当前账本的数据和读集版本不一致，则该交易被标注为无效，不更新状态数据库。</li>
</ol>
<p>交易流程中，采用<strong>MVCC的乐观锁模型，提高了系统的并发能力。但MVCC也带来了一些局限性。例如，在同一个区块中若有两个交易先后对某个数据项做更新，顺序在后的交易将失败，因为后序交易的读集版本和当前数据项版本已经不一致。</strong></p>
<p><img src="http://img.lessisbetter.site/2019-07-blocks-3.png" alt=""></p>
<h5 id="区块写入账本"><a href="#区块写入账本" class="headerlink" title="区块写入账本"></a>区块写入账本</h5><p>每个peer都把区块追加到对应channel的账本上，每个有效交易的write set会被提交到状态数据库。</p>
<p><img src="http://img.lessisbetter.site/2019-07-txflow-step6.png" alt=""></p>
<h5 id="客户端获取交易结果"><a href="#客户端获取交易结果" class="headerlink" title="客户端获取交易结果"></a>客户端获取交易结果</h5><p>客户端可以通过事件订阅交易的结果：是否添加到数据库，是否有效。</p>
<h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><p><img src="http://img.lessisbetter.site/2019-07-fabric-storage.png" alt=""></p>
<h3 id="账本"><a href="#账本" class="headerlink" title="账本"></a>账本</h3><p><strong>账本由区块链和状态数据库两部分组成</strong>。</p>
<ol>
<li>区块链是一组不可更改的有序的区块（数据块），记录着全部交易的日志。</li>
<li>状态数据库记录了账本中所有键值对的当前值（世界状态），相当于对当前账本的交易日志做了索引。链码执行交易的时候需要读取账本的当前状态，从状态数据库可以迅速获取键值的最新状态。</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-storage.png" alt=""></p>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-storage-flow.png" alt=""></p>
<h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>Fabric区块链网络中，每个通道都有其账本，每个Peer节点都保存着其所加入通道的账本，Peer节点的账本包含如下数据：</p>
<ol>
<li>账本编号，用于快速查询存在哪些账本</li>
<li>账本数据，用于区块数据存储</li>
<li>区块索引，用于快速查询区块／交易</li>
<li>状态数据，用于最新的<strong>世界状态</strong>数据</li>
<li>历史数据，用于跟踪键的历史</li>
</ol>
<p>Fabric的Peer节点账本中有四种数据库，idStore（ledgerID数据库）、blkstorage（block文件存储）、statedb（状态数据库）、historydb（历史数据库）。</p>
<p><strong>账本数据库</strong>基于文件系统，将区块存储在文件块中，然后在区块索引LevelDB中存储区块交易对应的文件块及其偏移，即将区块索引LevelDB作为账本数据库的索引。目前<strong>支持的区块索引有：区块编号、区块哈希、交易ID、区块交易编号</strong>。</p>
<p><strong>状态数据库</strong>存储的是所有曾经在交易中出现的键值对的最新值（世界状态）。调用链码执行交易可以改变状态数据，为了高效的执行链码调用，所有数据的最新值都被存放在状态数据库中；状态数据库是有序交易日志的快照，任何时候都可以根据交易日志重新生成状态数据库；状态数据库会在Peer节点启动的时候自动恢复或重构，未完备前，本Peer节点不会接受新的交易；状态数据库可以使用LevelDB或者CouchDB，CouchDB能够存储任意的二进制数据，支持富文本查询。链接：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#world-state" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#world-state</a> 。</p>
<p><strong>历史状态数据库</strong>用于查询某个key的历史修改记录，历史状态数据库并不存储key具体的值，而只记录在某个区块的某个交易里，某key变动了一次。后续需要查询的时候，根据变动历史去查询实际变动的值。</p>
<p><strong>ledgerID数据库</strong>存储chainID，用于快速查询节点存在哪些账本。</p>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-storage-file.png" alt=""></p>
<p>ledgersData是Peer节点账本的根目录，Peer节点的账本存储在Peer节点容器的<code>/var/hyperledger/production/ledgersData</code>目录下，通过命令行可以进入Peer节点容器进行查看，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it peer0.org1.example.com bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root@5af5a3fb3bb7:/var/hyperledger/production# ls -R chaincodes</span><br><span class="line">chaincodes:</span><br><span class="line">root@5af5a3fb3bb7:/var/hyperledger/production# ls -R transientStore/</span><br><span class="line">transientStore/:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@5af5a3fb3bb7:/var/hyperledger/production# ls -R ledgersData/</span><br><span class="line">ledgersData/:</span><br><span class="line">bookkeeper  chains  configHistory  historyLeveldb  ledgerProvider  pvtdataStore  stateLeveldb</span><br><span class="line"></span><br><span class="line">ledgersData/bookkeeper:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line">ledgersData/chains:</span><br><span class="line">chains  index</span><br><span class="line"></span><br><span class="line">ledgersData/chains/chains:</span><br><span class="line">mychannel</span><br><span class="line"></span><br><span class="line">ledgersData/chains/chains/mychannel:</span><br><span class="line">blockfile_000000</span><br><span class="line"></span><br><span class="line">ledgersData/chains/index:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line">ledgersData/configHistory:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line">ledgersData/historyLeveldb:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line">ledgersData/ledgerProvider:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line">ledgersData/pvtdataStore:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br><span class="line"></span><br><span class="line">ledgersData/stateLeveldb:</span><br><span class="line">000001.log  CURRENT  LOCK  LOG  MANIFEST-000000</span><br></pre></td></tr></table></figure>
<ul>
<li>chains/chains目录下的mychannel目录channel的名称，Fabric支持多通道的机制，而通道之间的账本是隔离的，每个通道都有自己的账本空间。</li>
<li>chains/index目录包含levelDB数据库文件，存储区块索引数据库，使用leveldb实现。</li>
<li>historyLeveldb目录存储智能合约中写入的key的历史记录的索引地址，使用leveldb实现。</li>
<li>ledgerProvider目录存储当前节点所包含channel的信息（已经创建的channel id 和正在创建中的channel id），使用leveldb实现。</li>
<li>stateLeveldb目录存储智能合约写入的数据，可选择使用leveldb或couchDB，即状态数据库。</li>
</ul>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><p>区块索引用于快速定位区块。<strong>索引键可以是区块高度、区块哈希、交易哈希。索引值为区块文件编号+文件内偏移量+区块数据长度。</strong></p>
<p>Hyperledger Fabric提供了多种区块索引的方式，以便能快速找到区块。索引的内容是文件位置指针（File Location Pointer）。文件位置指针由三个部分组成：所在文件的编号（fileSuffixNum）、文件内的偏移量（offset）、区块占用的字节数（bytesLength）。</p>
<h4 id="链"><a href="#链" class="headerlink" title="链"></a>链</h4><p>整个网络有一条系统链，保存有网络的配置信息，比如MSP、各种策略、各种配置项，系统链在排序服务中（即，peer上没有？），保存在ordering节点的系统channel中，任何改变整个网络配置的，都会产生一个新的配置块添加到系统链上去。</p>
<p>链接：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#system-chain" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#system-chain</a></p>
<h3 id="共识-排序服务"><a href="#共识-排序服务" class="headerlink" title="共识/排序服务"></a>共识/排序服务</h3><p>文档：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/orderer/ordering_service.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/orderer/ordering_service.html</a></p>
<h4 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h4><p>共识集群由多个排序服务节点（OSN）和一个Kafka集群组成。排序节点之间不直接通信，仅仅与Kafka集群通信。</p>
<p>在排序节点的实现里，通道(Channel)在Kafka中是以主题topic的形式隔离。</p>
<p><strong>每个排序节点内部，针对每个通道都会建立与Kafka集群对应topic的生产者及消费者</strong>。生产者将排序节点收到的交易发送到Kafka集群进行排序，在生产的同时，消费者也同步消费排序后的交易。</p>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-kafka.png" alt=""></p>
<h4 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h4><p>fabric的raft基于etcd的raft，raft是CFT，是leader-follower模型。</p>
<p>需要注意的一点是，所有channel共用排序集群，但每个channel都有各自的Raft实例，所以每个channel可以选举自己的leader。</p>
<p>虽然所有的 Raft 节点都必须包含在系统通道中，但他们并不需要都包含在应用通道中。通道创建者(和通道管理员)拥有选择可用排序节点子集的能力并且可以根据需要增加或移除排序节点(只要每次只增加会移除一个节点)。</p>
<blockquote>
<p>where a leader node is elected (per channel) and its decisions are replicated by the followers.</p>
</blockquote>
<p>链接：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#raft" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/glossary.html#raft</a></p>
<h3 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h3><h4 id="Gossip"><a href="#Gossip" class="headerlink" title="Gossip"></a>Gossip</h4><p>gossip是数据扩散协议，有3个功能：</p>
<ol>
<li>管理节点发现和channel的成员关系</li>
<li>同channel上的所有peer扩散账本数据</li>
<li>同channel上的所有peer间同步账本状态</li>
</ol>
<p>更多信息：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/gossip.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/gossip.html</a></p>
<p><strong>Gossip 协议最终的目的是将数据分发到网络中的每一个节点</strong>，Gossip数据分发协议实现了两种数据传输方式。</p>
<h5 id="推送数据"><a href="#推送数据" class="headerlink" title="推送数据"></a>推送数据</h5><ol>
<li>网络中的某个节点<strong>随机选择N个节点</strong>作为数据接收对象，N配置在配置文件中</li>
<li>该节点向其选中的N个节点传输相应的信息</li>
<li>接收到信息的节点处理它接收到的数据</li>
<li>接收到数据的节点再从第一步开始重复执行</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-gossip-push.png" alt=""></p>
<h5 id="拉去数据"><a href="#拉去数据" class="headerlink" title="拉去数据"></a>拉去数据</h5><ol>
<li>某个节点<strong>周期性</strong>地选择随机N个节点询问有没有最新的信息</li>
<li>收到请求的节点回复请求节点其最近未收到的信息</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-gossip-pull.png" alt=""></p>
<h4 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h4><p>节点之间使用数据同步保证账本数据和状态数据的即使更新，数据同步主要有2类：</p>
<ol>
<li>主动广播，比如广播新打包的区块，排序节点把区块发送给主节点，它基于Gossip的推送数据</li>
<li>主动请求，比如新加入的节点，向已存在的其他组织锚节点请求数据，锚节点给他响应，它基于Gossip的拉去数据</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-deliver-data.png" alt=""></p>
<p><img src="http://img.lessisbetter.site/2019-07-fabric-request-data.png" alt=""></p>
<h3 id="应用开发"><a href="#应用开发" class="headerlink" title="应用开发"></a>应用开发</h3><p>文档：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/developapps/developing_applications.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/developapps/developing_applications.html</a></p>
<h3 id="Fabric网络"><a href="#Fabric网络" class="headerlink" title="Fabric网络"></a>Fabric网络</h3><p>文档：<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/network/network.html" target="_blank" rel="noopener">https://hyperledger-fabric.readthedocs.io/en/release-1.4/network/network.html</a></p>
<p>文档里介绍了以上各种概念在网络中的位置。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/13/fast-mirrors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/13/fast-mirrors/" class="post-title-link" itemprop="url">让镜像飞，加速你的开发</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-13 11:15:51" itemprop="dateCreated datePublished" datetime="2019-07-13T11:15:51+08:00">2019-07-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于你知我知的网络原因，开发者遇到了以下问题：</p>
<ol>
<li>brew/apt-get/yum等安装软件慢、更新慢</li>
<li>docker下载镜像慢</li>
<li>go get某些package无法访问、超时</li>
<li>…</li>
</ol>
<p>怎么解决？</p>
<ol>
<li>挂代理，实现科学上网</li>
<li>换镜像，曲线救国</li>
</ol>
<p>镜像都在国内，所以镜像效果比代理好。</p>
<p>换代理请看<a href="http://lessisbetter.site/2018/09/06/Science-and-the-Internet/">让终端科学上网</a>。</p>
<p>接下来看几个常用的镜像。</p>
<h2 id="Linux发行版镜像"><a href="#Linux发行版镜像" class="headerlink" title="Linux发行版镜像"></a>Linux发行版镜像</h2><p><a href="https://opsx.alibaba.com/mirror" target="_blank" rel="noopener">阿里镜像首页</a>列出了所有发行版的镜像状态，以及【帮助】，展示了如何更换源。</p>
<p>这里不仅包含了发行版的镜像，还有homebrew、docker，但我认为这2个阿里的镜像不太好用，但列出来了。</p>
<h2 id="Brew镜像"><a href="#Brew镜像" class="headerlink" title="Brew镜像"></a>Brew镜像</h2><p>你需要<a href="http://lessisbetter.site/2019/07/13/better-brew/">让Homebrew飞</a>。</p>
<h2 id="Docker镜像"><a href="#Docker镜像" class="headerlink" title="Docker镜像"></a>Docker镜像</h2><p>看如何配置<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html" target="_blank" rel="noopener">Docker镜像加速器</a>。</p>
<p>推荐使用七牛或DaoCloud的镜像。</p>
<h2 id="Go-modules代理"><a href="#Go-modules代理" class="headerlink" title="Go modules代理"></a>Go modules代理</h2><p>现在国内已经有第三方的Go modules代理服务了，比如：</p>
<ol>
<li><a href="https://goproxy.io/zh/" target="_blank" rel="noopener">goproxy.io</a>，是即将毕业的<a href="https://github.com/aofei" target="_blank" rel="noopener">盛奥飞</a>小哥捐给了七牛搭建的Go modules代理服务。</li>
<li><a href="http://mirrors.aliyun.com/goproxy/" target="_blank" rel="noopener">aliyun goproxy</a>，阿里云昨天（大概2019年07月15日）刚开放了Go modules代理服务。</li>
</ol>
<p>fabric使用vendor，下载各种东西的时候需要翻墙，即便是可以翻墙，也是有缺点的：</p>
<ol>
<li>慢。</li>
<li>翻墙有流量限制。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/13/better-brew/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/13/better-brew/" class="post-title-link" itemprop="url">让Homebrew飞</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-13 11:12:17" itemprop="dateCreated datePublished" datetime="2019-07-13T11:12:17+08:00">2019-07-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Homebrew源"><a href="#Homebrew源" class="headerlink" title="Homebrew源"></a>Homebrew源</h2><p>homebrew默认使用的是Github，虽然已经科学上网了，速度依然是KB级别的，相当的慢。使用国内的源，速度有质的提升，推荐2个国内的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.cloud.tencent.com/homebrew/brew.git</span><br><span class="line">git://mirrors.ustc.edu.cn/brew.git</span><br></pre></td></tr></table></figure>
<p>腾讯源更多信息见：<a href="https://mirrors.cloud.tencent.com/help/homebrew-bottles.html" target="_blank" rel="noopener">https://mirrors.cloud.tencent.com/help/homebrew-bottles.html</a></p>
<p>建议ping一下以上2个源，选延时小的。</p>
<h2 id="下载和修改安装脚本"><a href="#下载和修改安装脚本" class="headerlink" title="下载和修改安装脚本"></a>下载和修改安装脚本</h2><p>下载官方安装脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install &gt;&gt; brew_install</span><br></pre></td></tr></table></figure>
<p>修改官方脚本，把Github源替换为腾讯源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/ruby</span><br><span class="line"># This script installs to /usr/local only. To install elsewhere (which is</span><br><span class="line"># unsupported) you can untar https://github.com/Homebrew/brew/tarball/master</span><br><span class="line"># anywhere you like.</span><br><span class="line">HOMEBREW_PREFIX = &quot;/usr/local&quot;.freeze</span><br><span class="line">HOMEBREW_REPOSITORY = &quot;/usr/local/Homebrew&quot;.freeze</span><br><span class="line">HOMEBREW_CORE_TAP = &quot;/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core&quot;.freeze</span><br><span class="line">HOMEBREW_CACHE = &quot;#&#123;ENV[&quot;HOME&quot;]&#125;/Library/Caches/Homebrew&quot;.freeze</span><br><span class="line">BREW_REPO = &quot;https://github.com/Homebrew/brew.git&quot;.freeze</span><br></pre></td></tr></table></figure>
<p>把<code>BREW_REPO = &quot;https://github.com/Homebrew/brew.git&quot;.freeze</code>替换为<code>BREW_REPO = &quot;https://mirrors.cloud.tencent.com/homebrew/brew.git&quot;.freeze</code>。</p>
<h2 id="运行脚本安装"><a href="#运行脚本安装" class="headerlink" title="运行脚本安装"></a>运行脚本安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby ~/brew_install</span><br></pre></td></tr></table></figure>
<p>这个版本的安装脚本已经没有CORE_TAP_REPO了，所以下载homebrew core的时候依然去Github下载，非常慢，可以在brew.git下载完，control-c结束掉。</p>
<p>把仓库<code>https://mirrors.cloud.tencent.com/homebrew/homebrew-core.git</code>克隆到<code>/usr/local/Homebrew/Library/Taps/homebrew/</code>目录，然后再执行上面的安装脚本。</p>
<h2 id="更换brew源"><a href="#更换brew源" class="headerlink" title="更换brew源"></a>更换brew源</h2><p>如果brew已经安装了，直接修改源就行了。</p>
<p>1、替换brew.git和homebrew-core.git的源:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>"</span></span><br><span class="line">git remote <span class="built_in">set</span>-url origin https://mirrors.cloud.tencent.com/homebrew/brew.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core"</span></span><br><span class="line">git remote <span class="built_in">set</span>-url origin https://mirrors.cloud.tencent.com/homebrew/homebrew-core.git</span><br></pre></td></tr></table></figure>
<p>2、更新 bottles源</p>
<p>对于bash用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.cloud.tencent.com/homebrew-bottles'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
<p>对于zsh用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.cloud.tencent.com/homebrew-bottles'</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/12/do-not-abuse-of-log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/12/do-not-abuse-of-log/" class="post-title-link" itemprop="url">你滥用log了吗</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-12 18:17:24" itemprop="dateCreated datePublished" datetime="2019-07-12T18:17:24+08:00">2019-07-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>代码Review的时候，遇到过一些log滥用的情况，今天聊一聊滥用（过渡使用）日志。</p>
<blockquote>
<p>好的log能够帮助开发人员快速定位bug，而差的log各有各的不同。</p>
</blockquote>
<h2 id="你滥用日志了吗？"><a href="#你滥用日志了吗？" class="headerlink" title="你滥用日志了吗？"></a>你滥用日志了吗？</h2><p>是什么导致了滥用log？是不是存在这些误解：</p>
<p><strong>1. 害怕出了问题，现有的log无法定位</strong>，要多加一些log，恨不得每段都有一个log，log数简直越多越好，看日志有一种，每一步都非常清晰的错觉。</p>
<p><strong>2. 不知道log多了，定位效率更低</strong>，试问你有没有经历过几分钟刷出了G级别日志文件？在这种日志文件里定位bug，简直是大海捞针，这让log的价值非常低。</p>
<p><strong>3. 不知道log多了会影响性能</strong>，log自身涉及格式化和文件读写，虽然现在各log库都已经比较高效了，但是，这也扛不住“海量”的log啊，积少成多，势必影响程序性能。</p>
<p><strong>4. 对log级别错误的认知</strong>：日志级别设置为Info，Debug、Trace级别的日志不会打印，Debug、Trace级别日志多没关系。虽然日志不会输出，并不代表相关代码没执行啊。</p>
<p>第4点重点解释一下：</p>
<p><img src="http://img.lessisbetter.site/2019-07-debug-demo.png" alt="debug-demo"></p>
<p>这是一个打印Debug级别的日志，它还有1项日志信息，是来自<code>func()</code>的结果，请问：</p>
<ol>
<li>日志级别设置为Info，log.Debug会执行吗？<code>func()</code>还会执行吗？</li>
<li>如果这行日志频繁被执行，是不是浪费了CPU做无用功？</li>
</ol>
<p>如果你认为不会执行，看下面的Demo，log使用zap。</p>
<p><img src="http://img.lessisbetter.site/2019-07-log-test.png" alt="log-test"></p>
<p>结果：</p>
<p><img src="http://img.lessisbetter.site/2019-07-log-ret.png" alt="log-ret"></p>
<p>事实证明无论限制的日志级别是什么，<code>log.***</code>一定会被调用，它入参中的函数也一定会被调用，只不过是日记级别不满足打印时，不会打印而已。被调函数的结果只被这条<code>log.***</code>使用，结果这个日志根本不打印，这就浪费了CPU。</p>
<p>日志级别都设置为Info了，Debug级别的日志为何还会打印？</p>
<p>如果你有这个问题，你可能没有理解2个地方。</p>
<p>日志级别设置为Info，不代表<code>log.Debug</code>函数不执行。<code>log.Debug</code>函数一定会执行，看下图，<code>log.Info，Error</code>等接口会调用相同的真实实现函数<code>log.log</code>，<code>log.log</code>的入参包含了<code>log.Info</code>等接口的入参，以及当前的<code>log_level</code>，比如以下2种是等价的：</p>
<p><img src="http://img.lessisbetter.site/2019-07-log-log.png" alt="log-log"></p>
<p>所以，无论设置的是什么日志级别控制，<code>log.Debug</code>一定会被执行，至于当前日志是否会打印，会在<code>log.log</code>里决定。</p>
<p><img src="http://img.lessisbetter.site/2019-07-log-call.png" alt="image-20190712072742045"></p>
<p>日志为Warn级别，Debug日志不会打印，<code>func()</code>会不会执行？</p>
<p>日志打印本质是函数调用，会先计算入参，再调用函数。比如：</p>
<p><img src="http://img.lessisbetter.site/2019-07-log-debug.png" alt="log-debug"></p>
<p>所以<code>func()</code>一定会被调用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>针对滥用日志的情况给几点建议：</p>
<ol>
<li>1条日志描述清when、where、what，提供有效信息，这就对定位很有帮助了。</li>
<li>只在“可能”出问题的地方打印日志，一些能根据上下文日志推断的地方，就无需再增加日志。</li>
<li>日志打印不要调用函数。</li>
</ol>
<blockquote>
<ol>
<li>如果这篇文章对你有帮助，不妨关注下我的Github，有文章会收到通知。</li>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/07/12/do-not-abuse-of-log/">http://lessisbetter.site/2019/07/12/do-not-abuse-of-log/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/10/fabric-makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/10/fabric-makefile/" class="post-title-link" itemprop="url">通过Fabric 1.4 的Makefile，轻松掌握Fabric构建</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-10 07:18:48" itemprop="dateCreated datePublished" datetime="2019-07-10T07:18:48+08:00">2019-07-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-28 10:45:31" itemprop="dateModified" datetime="2019-08-28T10:45:31+08:00">2019-08-28</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。</p>
<p>fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。</p>
<p>Makefile文件就在fabric的根目录下，该文件还引入了另外2个Makefile文件：</p>
<ol>
<li>docker-env.mk，这个文件描述了Docker构建先关的信息</li>
<li>gotools.mk，这个文件描述了go tools相关的构建信息</li>
</ol>
<p>我们先介绍Makefile文件，然后介绍另外2个文件，如果想在Makefile遇到这2个文件的时候查看，可随时使用目录跳转去查看即可。</p>
<p>即使掌握了Makefile，仍然会遇到一些问题，所以最后会给出一些建议，让你少踩一些坑。</p>
<blockquote>
<p>本文基于fabric 1.4，commit id：9dce73，不同版本可能有细微差别，但不影响掌握构建过程。</p>
</blockquote>
<h1 id="Makefile详细解读"><a href="#Makefile详细解读" class="headerlink" title="Makefile详细解读"></a>Makefile详细解读</h1><p>Makefile看起来有点长，磨刀不误砍柴工，花2个小时，是非常有益处的，建议多看几遍，吃透编译流程。</p>
<h2 id="fabric的Makefile"><a href="#fabric的Makefile" class="headerlink" title="fabric的Makefile"></a>fabric的Makefile</h2><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright IBM Corp All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># -------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># This makefile defines the following targets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># make项列表</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 构建所有</span></span><br><span class="line"><span class="comment">#   - all (default) - builds all targets and runs all non-integration tests/checks</span></span><br><span class="line"><span class="comment"># 运行所有测试和检查</span></span><br><span class="line"><span class="comment">#   - checks - runs all non-integration tests/checks</span></span><br><span class="line"><span class="comment"># 运行linter和verify来检查改动的文件</span></span><br><span class="line"><span class="comment">#   - desk-check - runs linters and verify to test changed packages</span></span><br><span class="line"><span class="comment"># 构建configtxgen，主要用来创建创世块、创建通道时的配置交易、更新通道的锚点交易</span></span><br><span class="line"><span class="comment">#   - configtxgen - builds a native configtxgen binary</span></span><br><span class="line"><span class="comment"># 构建configtxlator，configtxgen生成的配置是二进制，使用configtxlator转换为json</span></span><br><span class="line"><span class="comment">#   - configtxlator - builds a native configtxlator binary</span></span><br><span class="line"><span class="comment"># 构建cryptogen，提供加解密的程序</span></span><br><span class="line"><span class="comment">#   - cryptogen  -  builds a native cryptogen binary</span></span><br><span class="line"><span class="comment"># 构建idemixgen，用来创建身份（id）混合器创建配置文件</span></span><br><span class="line"><span class="comment">#   - idemixgen  -  builds a native idemixgen binary</span></span><br><span class="line"><span class="comment"># peer节点</span></span><br><span class="line"><span class="comment">#   - peer - builds a native fabric peer binary</span></span><br><span class="line"><span class="comment"># 排序节点</span></span><br><span class="line"><span class="comment">#   - orderer - builds a native fabric orderer binary</span></span><br><span class="line"><span class="comment"># 发布当前平台的包</span></span><br><span class="line"><span class="comment">#   - release - builds release packages for the host platform</span></span><br><span class="line"><span class="comment"># 发布所有平台的包</span></span><br><span class="line"><span class="comment">#   - release-all - builds release packages for all target platforms</span></span><br><span class="line"><span class="comment"># 跑单元测试</span></span><br><span class="line"><span class="comment">#   - unit-test - runs the go-test based unit tests</span></span><br><span class="line"><span class="comment"># 对更改过的文件跑单元测试</span></span><br><span class="line"><span class="comment">#   - verify - runs unit tests for only the changed package tree</span></span><br><span class="line"><span class="comment"># 以coverprofile模式对所有pkg跑单元测试</span></span><br><span class="line"><span class="comment">#   - profile - runs unit tests for all packages in coverprofile mode (slow)</span></span><br><span class="line"><span class="comment">#   - test-cmd - generates a "go test" string suitable for manual customization</span></span><br><span class="line"><span class="comment"># 安装go tools，TODO 安装到哪，镜像还是外部GOPATH下？</span></span><br><span class="line"><span class="comment">#   - gotools - installs go tools like golint</span></span><br><span class="line"><span class="comment"># 对所有代码运行lint</span></span><br><span class="line"><span class="comment">#   - linter - runs all code checks</span></span><br><span class="line"><span class="comment"># 检查dep依赖</span></span><br><span class="line"><span class="comment">#   - check-deps - check for vendored dependencies that are no longer used</span></span><br><span class="line"><span class="comment"># 检查所有代码Apache license</span></span><br><span class="line"><span class="comment">#   - license - checks go source files for Apache license header</span></span><br><span class="line"><span class="comment"># 构建所有的native程序，包含peer，orderer等</span></span><br><span class="line"><span class="comment">#   - native - ensures all native binaries are available</span></span><br><span class="line"><span class="comment"># 构建所有的docker镜像，docker-clean为清除镜像</span></span><br><span class="line"><span class="comment">#   - docker[-clean] - ensures all docker images are available[/cleaned]</span></span><br><span class="line"><span class="comment"># 列出所有相关的docker镜像</span></span><br><span class="line"><span class="comment">#   - docker-list - generates a list of docker images that 'make docker' produces</span></span><br><span class="line"><span class="comment"># 构建peer-docker镜像</span></span><br><span class="line"><span class="comment">#   - peer-docker[-clean] - ensures the peer container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 构建orderer-docker镜像</span></span><br><span class="line"><span class="comment">#   - orderer-docker[-clean] - ensures the orderer container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 构建tools-docker镜像</span></span><br><span class="line"><span class="comment">#   - tools-docker[-clean] - ensures the tools container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 基于.proto文件生成所有的protobuf文件</span></span><br><span class="line"><span class="comment">#   - protos - generate all protobuf artifacts based on .proto files</span></span><br><span class="line"><span class="comment"># 清理所有构建数据</span></span><br><span class="line"><span class="comment">#   - clean - cleans the build area</span></span><br><span class="line"><span class="comment"># 比clean更牛，还会清理掉持久状态数据</span></span><br><span class="line"><span class="comment">#   - clean-all - superset of 'clean' that also removes persistent state</span></span><br><span class="line"><span class="comment"># 清理发布的包</span></span><br><span class="line"><span class="comment">#   - dist-clean - clean release packages for all target platforms</span></span><br><span class="line"><span class="comment"># 清理单元测试状态数据</span></span><br><span class="line"><span class="comment">#   - unit-test-clean - cleans unit test state (particularly from docker)</span></span><br><span class="line"><span class="comment"># 执行基本的检查，比如license，拼写，lint等</span></span><br><span class="line"><span class="comment">#   - basic-checks - performs basic checks like license, spelling, trailing spaces and linter</span></span><br><span class="line"><span class="comment"># CI使用的选项</span></span><br><span class="line"><span class="comment">#   - enable_ci_only_tests - triggers unit-tests in downstream jobs. Applicable only for CI not to</span></span><br><span class="line"><span class="comment">#     use in the local machine.</span></span><br><span class="line"><span class="comment"># 拉去第三方docker镜像</span></span><br><span class="line"><span class="comment">#   - docker-thirdparty - pulls thirdparty images (kafka,zookeeper,couchdb)</span></span><br><span class="line"><span class="comment"># 把所有make docker所产生的镜像，打上latest tag</span></span><br><span class="line"><span class="comment">#   - docker-tag-latest - re-tags the images made by 'make docker' with the :latest tag</span></span><br><span class="line"><span class="comment"># 把所有make docker所产生的镜像，打上stable tag</span></span><br><span class="line"><span class="comment">#   - docker-tag-stable - re-tags the images made by 'make docker' with the :stable tag</span></span><br><span class="line"><span class="comment"># 生成命令参考文档</span></span><br><span class="line"><span class="comment">#   - help-docs - generate the command reference docs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础版本</span></span><br><span class="line">BASE_VERSION = 1.4.2</span><br><span class="line"><span class="comment"># 前一个版本</span></span><br><span class="line">PREV_VERSION = 1.4.1</span><br><span class="line"><span class="comment"># chaintool版本</span></span><br><span class="line">CHAINTOOL_RELEASE=1.1.3</span><br><span class="line"><span class="comment"># 基础镜像版本</span></span><br><span class="line">BASEIMAGE_RELEASE=0.4.15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置项目名称，如果没有设置，则使用hyperledger</span></span><br><span class="line"><span class="comment"># Allow to build as a submodule setting the main project to</span></span><br><span class="line"><span class="comment"># the PROJECT_NAME env variable, for example,</span></span><br><span class="line"><span class="comment"># export PROJECT_NAME=hyperledger/fabric-test</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(PROJECT_NAME)</span>,true)</span><br><span class="line">PROJECT_NAME = <span class="variable">$(PROJECT_NAME)</span>/fabric</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">PROJECT_NAME = hyperledger/fabric</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建路径</span></span><br><span class="line"><span class="comment"># ?=指当没有指定BUILD_DIR时，才使用默认的`.build`作为构建目录</span></span><br><span class="line">BUILD_DIR ?= .build</span><br><span class="line"><span class="comment"># 未知，全文未使用</span></span><br><span class="line">NEXUS_REPO = nexus3.hyperledger.org:10001/hyperledger</span><br><span class="line"></span><br><span class="line"><span class="comment"># 额外版本：git commit号</span></span><br><span class="line">EXTRA_VERSION ?= <span class="variable">$(<span class="built_in">shell</span> git rev-parse --short HEAD)</span></span><br><span class="line"><span class="comment"># 项目版本由基础版本和额外版本组成</span></span><br><span class="line">PROJECT_VERSION=<span class="variable">$(BASE_VERSION)</span>-snapshot-<span class="variable">$(EXTRA_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go编译信息</span></span><br><span class="line"><span class="comment"># 设置包名</span></span><br><span class="line">PKGNAME = github.com/<span class="variable">$(PROJECT_NAME)</span></span><br><span class="line"><span class="comment"># CGO编译选项</span></span><br><span class="line">CGO_FLAGS = CGO_CFLAGS=<span class="string">" "</span></span><br><span class="line"><span class="comment"># 当前CPU架构</span></span><br><span class="line">ARCH=<span class="variable">$(<span class="built_in">shell</span> go env GOARCH)</span></span><br><span class="line"><span class="comment"># OS和CPU架构</span></span><br><span class="line">MARCH=<span class="variable">$(<span class="built_in">shell</span> go env GOOS)</span>-<span class="variable">$(<span class="built_in">shell</span> go env GOARCH)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go编译时传入的版本信息，主要是docker相关信息，比如</span></span><br><span class="line"><span class="comment">## var Version string = "latest"</span></span><br><span class="line"><span class="comment">## var CommitSHA string = "development build"</span></span><br><span class="line"><span class="comment">## var BaseVersion string = "0.4.15"</span></span><br><span class="line"><span class="comment">## var BaseDockerLabel string = "org.hyperledger.fabric"</span></span><br><span class="line"><span class="comment">## var DockerNamespace string = "hyperledger"</span></span><br><span class="line"><span class="comment">## var BaseDockerNamespace string = "hyperledger"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defined in common/metadata/metadata.go</span></span><br><span class="line">METADATA_VAR = Version=<span class="variable">$(BASE_VERSION)</span></span><br><span class="line">METADATA_VAR += CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span><br><span class="line">METADATA_VAR += BaseVersion=<span class="variable">$(BASEIMAGE_RELEASE)</span></span><br><span class="line">METADATA_VAR += BaseDockerLabel=<span class="variable">$(BASE_DOCKER_LABEL)</span></span><br><span class="line">METADATA_VAR += DockerNamespace=<span class="variable">$(DOCKER_NS)</span></span><br><span class="line">METADATA_VAR += BaseDockerNamespace=<span class="variable">$(BASE_DOCKER_NS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用GO_LDFLAGS设置go的ldflag信息，传入METADATA_VAR</span></span><br><span class="line"><span class="comment"># patsubst指替换通配符</span></span><br><span class="line">GO_LDFLAGS = <span class="variable">$(<span class="built_in">patsubst</span> %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line">GO_TAGS ?=</span><br><span class="line"></span><br><span class="line"><span class="comment"># chaintool下载链接</span></span><br><span class="line">CHAINTOOL_URL ?= https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/chaintool-<span class="variable">$(CHAINTOOL_RELEASE)</span>/hyperledger-fabric-chaintool-<span class="variable">$(CHAINTOOL_RELEASE)</span>.jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> GO_LDFLAGS GO_TAGS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查go、docker、git、curl这几个程序是否存在</span></span><br><span class="line">EXECUTABLES ?= go docker git curl</span><br><span class="line">K := <span class="variable">$(<span class="built_in">foreach</span> exec,<span class="variable">$(EXECUTABLES)</span>,\</span></span><br><span class="line"><span class="variable">	$(<span class="built_in">if</span> $(<span class="built_in">shell</span> which <span class="variable">$(exec)</span>)</span>,some string,<span class="variable">$(<span class="built_in">error</span> "No <span class="variable">$(exec)</span> in PATH: Check dependencies")</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go shim的依赖项，shim是chaincode的一个模块，可以先不去理解</span></span><br><span class="line">GOSHIM_DEPS = <span class="variable">$(<span class="built_in">shell</span> ./scripts/goListFiles.sh <span class="variable">$(PKGNAME)</span>/core/chaincode/shim)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># protobuf相关的文件</span></span><br><span class="line">PROTOS = <span class="variable">$(<span class="built_in">shell</span> git ls-files *.proto | grep -Ev 'vendor/|testdata/')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目文件，不包含git、样例、图片、vendor等文件</span></span><br><span class="line"><span class="comment"># No sense rebuilding when non production code is changed</span></span><br><span class="line">PROJECT_FILES = <span class="variable">$(<span class="built_in">shell</span> git ls-files  | grep -v ^test | grep -v ^unit-test | \</span></span><br><span class="line"><span class="variable">	grep -v ^.git | grep -v ^examples | grep -v ^devenv | grep -v .png$ | \</span></span><br><span class="line"><span class="variable">	grep -v ^LICENSE | grep -v ^vendor )</span></span><br><span class="line"><span class="comment"># docker镜像发布模板</span></span><br><span class="line">RELEASE_TEMPLATES = <span class="variable">$(<span class="built_in">shell</span> git ls-files | grep "release/templates")</span></span><br><span class="line"><span class="comment"># 镜像列表</span></span><br><span class="line">IMAGES = peer orderer ccenv buildenv tools</span><br><span class="line"><span class="comment"># 发布平台</span></span><br><span class="line">RELEASE_PLATFORMS = windows-amd64 darwin-amd64 linux-amd64 linux-s390x linux-ppc64le</span><br><span class="line"><span class="comment"># 发布的package</span></span><br><span class="line">RELEASE_PKGS = configtxgen cryptogen idemixgen discover configtxlator peer orderer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要发的pkg和它们的路径</span></span><br><span class="line">pkgmap.cryptogen      := <span class="variable">$(PKGNAME)</span>/common/tools/cryptogen</span><br><span class="line">pkgmap.idemixgen      := <span class="variable">$(PKGNAME)</span>/common/tools/idemixgen</span><br><span class="line">pkgmap.configtxgen    := <span class="variable">$(PKGNAME)</span>/common/tools/configtxgen</span><br><span class="line">pkgmap.configtxlator  := <span class="variable">$(PKGNAME)</span>/common/tools/configtxlator</span><br><span class="line">pkgmap.peer           := <span class="variable">$(PKGNAME)</span>/peer</span><br><span class="line">pkgmap.orderer        := <span class="variable">$(PKGNAME)</span>/orderer</span><br><span class="line">pkgmap.block-listener := <span class="variable">$(PKGNAME)</span>/examples/events/block-listener</span><br><span class="line">pkgmap.discover       := <span class="variable">$(PKGNAME)</span>/cmd/discover</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把docker-env.mk包含进来，主要是docker构建相关的选项</span></span><br><span class="line"><span class="keyword">include</span> docker-env.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># all包含/依赖了编译程序、编译镜像和进行检查</span></span><br><span class="line"><span class="comment"># all会进行检查，本地编译和发布docker镜像</span></span><br><span class="line"><span class="section">all: native docker checks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查包含/依赖了基本检查、单元测试和集成测试</span></span><br><span class="line"><span class="section">checks: basic-checks unit-test integration-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本检查指许可证、拼写和格式</span></span><br><span class="line"><span class="section">basic-checks: license spelling trailing-spaces linter check-metrics-doc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含/依赖检查和验证</span></span><br><span class="line"><span class="section">desk-check: checks verify</span></span><br><span class="line"></span><br><span class="line"><span class="section">help-docs: native</span></span><br><span class="line">	@scripts/generateHelpDocs.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取第三方镜像，并打上tag，BASE_DOCKER_TAG定义在docker-env.mk</span></span><br><span class="line"><span class="comment"># 都是fabric定制的couchdb、zookeeper、kafka镜像</span></span><br><span class="line"><span class="comment"># Pull thirdparty docker images based on the latest baseimage release version</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: docker-thirdparty</span></span><br><span class="line"><span class="section">docker-thirdparty:</span></span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-couchdb:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-couchdb:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-couchdb</span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-zookeeper:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-zookeeper:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-zookeeper</span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-kafka:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-kafka:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-kafka</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行拼写检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: spelling</span></span><br><span class="line"><span class="section">spelling:</span></span><br><span class="line">	@scripts/check_spelling.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行许可证检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: license</span></span><br><span class="line"><span class="section">license:</span></span><br><span class="line">	@scripts/check_license.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行末尾空格检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: trailing-spaces</span></span><br><span class="line"><span class="section">trailing-spaces:</span></span><br><span class="line">	@scripts/check_trailingspaces.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含gotools.mk，这个文件主要用来安装一些gotools，可以使用单个命令来装某个gotools，比如安装dep</span></span><br><span class="line"><span class="comment"># `make gotool.dep`，具体见该文件</span></span><br><span class="line"><span class="keyword">include</span> gotools.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际调用gotools-install安装相关的gotools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools</span></span><br><span class="line"><span class="section">gotools: gotools-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下这段设置是各程序的依赖</span></span><br><span class="line"><span class="comment"># 编译peer，依赖./build/bin/peer</span></span><br><span class="line"><span class="comment"># 编译peer-docker，依赖./build/image/peer/$(DUMMY)，DUMMY指DOCKER-TAG，定义在docker-env.mk</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: peer</span></span><br><span class="line"><span class="section">peer: <span class="variable">$(BUILD_DIR)</span>/bin/peer</span></span><br><span class="line"><span class="section">peer-docker: <span class="variable">$(BUILD_DIR)</span>/image/peer/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># orderer和镜像的依赖</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: orderer</span></span><br><span class="line"><span class="section">orderer: <span class="variable">$(BUILD_DIR)</span>/bin/orderer</span></span><br><span class="line"><span class="section">orderer-docker: <span class="variable">$(BUILD_DIR)</span>/image/orderer/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译configtxgen的依赖</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: configtxgen</span></span><br><span class="line"><span class="section">configtxgen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">configtxgen: <span class="variable">$(BUILD_DIR)</span>/bin/configtxgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译configtxlator的依赖</span></span><br><span class="line"><span class="section">configtxlator: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">configtxlator: <span class="variable">$(BUILD_DIR)</span>/bin/configtxlator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译cryptogen的依赖</span></span><br><span class="line"><span class="section">cryptogen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">cryptogen: <span class="variable">$(BUILD_DIR)</span>/bin/cryptogen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译idemixgen的依赖</span></span><br><span class="line"><span class="section">idemixgen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">idemixgen: <span class="variable">$(BUILD_DIR)</span>/bin/idemixgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译discover的依赖</span></span><br><span class="line"><span class="section">discover: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.Version=<span class="variable">$(PROJECT_VERSION)</span></span></span><br><span class="line"><span class="section">discover: <span class="variable">$(BUILD_DIR)</span>/bin/discover</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译tools相关的docker</span></span><br><span class="line"><span class="section">tools-docker: <span class="variable">$(BUILD_DIR)</span>/image/tools/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建环境（buildenv)镜像</span></span><br><span class="line"><span class="section">buildenv: <span class="variable">$(BUILD_DIR)</span>/image/buildenv/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 未知</span></span><br><span class="line"><span class="section">ccenv: <span class="variable">$(BUILD_DIR)</span>/image/ccenv/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行集成测试</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: integration-test</span></span><br><span class="line"><span class="section">integration-test: gotool.ginkgo ccenv docker-thirdparty</span></span><br><span class="line">	./scripts/run-integration-tests.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行单元测试</span></span><br><span class="line"><span class="section">unit-test: unit-test-clean peer-docker docker-thirdparty ccenv</span></span><br><span class="line">	unit-test/run.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行单元测试</span></span><br><span class="line"><span class="section">unit-tests: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CI选项</span></span><br><span class="line"><span class="section">enable_ci_only_tests: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行verify，就像注释说的，依然是单元测试</span></span><br><span class="line"><span class="section">verify: export JOB_TYPE=VERIFY</span></span><br><span class="line"><span class="section">verify: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行带有profile的单元测试</span></span><br><span class="line"><span class="section">profile: export JOB_TYPE=PROFILE</span></span><br><span class="line"><span class="section">profile: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generates a string to the terminal suitable for manual augmentation / re-issue, useful for running tests by hand</span></span><br><span class="line"><span class="section">test-cmd:</span></span><br><span class="line">	@echo <span class="string">"go test -tags \"<span class="variable">$(GO_TAGS)\"</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译所有docker镜像，依赖都是.build/image下</span></span><br><span class="line"><span class="section">docker: $(patsubst %,<span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译所有native程序，native指所有fabric本身的程序，依赖如下</span></span><br><span class="line"><span class="section">native: peer orderer configtxgen cryptogen idemixgen configtxlator discover</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行linter</span></span><br><span class="line"><span class="section">linter: check-deps buildenv</span></span><br><span class="line">	@echo <span class="string">"LINT: Running code checks.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/golinter.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行check-deps</span></span><br><span class="line"><span class="section">check-deps: buildenv</span></span><br><span class="line">	@echo <span class="string">"DEP: Checking for dependency issues.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/check_deps.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行check-metrics-doc</span></span><br><span class="line"><span class="section">check-metrics-doc: buildenv</span></span><br><span class="line">	@echo <span class="string">"METRICS: Checking for outdated reference documentation.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/metrics_doc.sh check</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行generate-metrics-doc</span></span><br><span class="line"><span class="section">generate-metrics-doc: buildenv</span></span><br><span class="line">	@echo <span class="string">"Generating metrics reference documentation..."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/metrics_doc.sh generate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装chain tool</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%/chaintool: Makefile</span><br><span class="line">	@echo <span class="string">"Installing chaintool"</span></span><br><span class="line">	@mkdir -p $(@D)</span><br><span class="line">	curl -fL <span class="variable">$(CHAINTOOL_URL)</span> &gt; <span class="variable">$@</span></span><br><span class="line">	chmod +x <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We (re)build a package within a docker context but persist the $GOPATH/pkg</span></span><br><span class="line"><span class="comment"># directory so that subsequent builds are faster</span></span><br><span class="line"><span class="comment"># 构建所有镜像和pkg</span></span><br><span class="line"><span class="comment"># DRUN是`docker run`和参数的简写</span></span><br><span class="line"><span class="comment"># 本地创建docker里要用到的gopath目录，然后挂载到docker里</span></span><br><span class="line"><span class="comment"># 然后在docker里按个编译pkgmap里面的程序，比如peer、orderer、cryptogen等等</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/bin/%: <span class="variable">$(PROJECT_FILES)</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/docker/bin/%,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span>"</span></span><br><span class="line">	@mkdir -p <span class="variable">$(BUILD_DIR)</span>/docker/bin <span class="variable">$(BUILD_DIR)</span>/docker/<span class="variable">$(TARGET)</span>/pkg</span><br><span class="line">	@<span class="variable">$(DRUN)</span> \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(BUILD_DIR)</span>/docker/bin)</span>:/opt/gopath/bin \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(BUILD_DIR)</span>/docker/<span class="variable">$(TARGET)</span>/pkg)</span>:/opt/gopath/pkg \</span><br><span class="line">		<span class="variable">$(BASE_DOCKER_NS)</span>/fabric-baseimage:<span class="variable">$(BASE_DOCKER_TAG)</span> \</span><br><span class="line">		go install -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(DOCKER_GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建本地bin目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/bin:</span><br><span class="line">	mkdir -p <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行changelog</span></span><br><span class="line"><span class="section">changelog:</span></span><br><span class="line">	./scripts/changelog.sh v<span class="variable">$(PREV_VERSION)</span> v<span class="variable">$(BASE_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># protoc-gen-go依赖.build/docker/gotools</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go: <span class="variable">$(BUILD_DIR)</span>/docker/gotools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建go tools的docker镜像，给payload使用</span></span><br><span class="line"><span class="comment"># 创建本地目录(.build/docker/gotools)并挂载到(/opt/gotools)，依赖基础镜像，然后在docker中执行gotools.mk</span></span><br><span class="line"><span class="comment"># 最后调用gotools.mk生成程序，设置了GOTOOLS_BINDIR，生成的二进制会放在这个目录，因为这个目录映射了出来，</span></span><br><span class="line"><span class="comment"># 所以bin就在主机的`.build/docker/gotools/bin/`目录</span></span><br><span class="line"><span class="comment"># So, 如果构建成功，不需要像其他文章说的那样，需要手动拷贝protoc-gen-go到`.build/docker/gotools/bin/`目录</span></span><br><span class="line"><span class="comment"># 但是，如果翻墙失败，可以考虑手动复制protoc-gen-go的方式</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/gotools: gotools.mk</span><br><span class="line">	@echo <span class="string">"Building dockerized gotools"</span></span><br><span class="line">	@mkdir -p <span class="variable">$@</span>/bin <span class="variable">$@</span>/obj</span><br><span class="line">	@<span class="variable">$(DRUN)</span> \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span>:/opt/gotools \</span><br><span class="line">		-w /opt/gopath/src/<span class="variable">$(PKGNAME)</span> \</span><br><span class="line">		<span class="variable">$(BASE_DOCKER_NS)</span>/fabric-baseimage:<span class="variable">$(BASE_DOCKER_TAG)</span> \</span><br><span class="line">		make -f gotools.mk GOTOOLS_BINDIR=/opt/gotools/bin GOTOOLS_GOPATH=/opt/gotools/obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建本地的运行文件，依赖设置都在上面了，这是进行构建，与Docker类似</span></span><br><span class="line"><span class="comment"># 程序即pkgmap中的程序</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/bin/%: <span class="variable">$(PROJECT_FILES)</span></span><br><span class="line">	@mkdir -p $(@D)</span><br><span class="line">	@echo <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> $(@D)</span>) go install -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line">	@echo <span class="string">"Binary available as <span class="variable">$@</span>"</span></span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置各镜像各自的payload文件</span></span><br><span class="line"><span class="comment"># 比如ccenv的payload拷贝会翻译成：cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span></span><br><span class="line"><span class="comment"># payload definitions'</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/ccenv/payload:      <span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/bin/chaintool \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/peer/payload:       <span class="variable">$(BUILD_DIR)</span>/docker/bin/peer \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/orderer/payload:    <span class="variable">$(BUILD_DIR)</span>/docker/bin/orderer \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/buildenv/payload:   <span class="variable">$(BUILD_DIR)</span>/gotools.tar.bz2 \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 各镜像payload的实际拷贝</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/payload:</span><br><span class="line">	mkdir -p <span class="variable">$@</span></span><br><span class="line">	cp <span class="variable">$^</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">.PRECIOUS: <span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据image下的各目录中的Dockerfile.in生成对应的Dockerfile</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile: images/%/Dockerfile.in</span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	@cat <span class="variable">$&lt;</span> \</span><br><span class="line">		| sed -e 's|_BASE_NS_|<span class="variable">$(BASE_DOCKER_NS)</span>|g' \</span><br><span class="line">		| sed -e 's|_NS_|<span class="variable">$(DOCKER_NS)</span>|g' \</span><br><span class="line">		| sed -e 's|_BASE_TAG_|<span class="variable">$(BASE_DOCKER_TAG)</span>|g' \</span><br><span class="line">		| sed -e 's|_TAG_|<span class="variable">$(DOCKER_TAG)</span>|g' \</span><br><span class="line">		&gt; <span class="variable">$@</span></span><br><span class="line">	@echo LABEL <span class="variable">$(BASE_DOCKER_LABEL)</span>.version=<span class="variable">$(BASE_VERSION)</span> \\&gt;&gt;<span class="variable">$@</span></span><br><span class="line">	@echo <span class="string">"     "</span> <span class="variable">$(BASE_DOCKER_LABEL)</span>.base.version=<span class="variable">$(BASEIMAGE_RELEASE)</span>&gt;&gt;<span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Dockerfile生成tools-image，并打上2个tag，分别是当前版本tag和latest tag</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/tools/<span class="variable">$(DUMMY)</span>: <span class="variable">$(BUILD_DIR)</span>/image/tools/Dockerfile</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building docker <span class="variable">$(TARGET)</span>-image"</span></span><br><span class="line">	<span class="variable">$(DBUILD)</span> -t <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> -f $(@D)/Dockerfile .</span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-latest</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Dockerfile、payload生成image下的所有镜像，比如orderer，然后打上tag</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>: Makefile <span class="variable">$(BUILD_DIR)</span>/image/%/payload <span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building docker <span class="variable">$(TARGET)</span>-image"</span></span><br><span class="line">	<span class="variable">$(DBUILD)</span> -t <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> $(@D)</span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-latest</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包gotools</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/gotools.tar.bz2: <span class="variable">$(BUILD_DIR)</span>/docker/gotools</span><br><span class="line">	(cd <span class="variable">$&lt;</span>/bin &amp;&amp; tar -jc *) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包goshim</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2: <span class="variable">$(GOSHIM_DEPS)</span></span><br><span class="line">	@echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">	@tar -jhc -C <span class="variable">$(GOPATH)</span>/src <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(GOPATH)</span>/src/%,%,<span class="variable">$(GOSHIM_DEPS)</span>)</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包sampleconfig</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2: <span class="variable">$(<span class="built_in">shell</span> find sampleconfig -type f)</span></span><br><span class="line">	(cd sampleconfig &amp;&amp; tar -jc *) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包protos</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/protos.tar.bz2: <span class="variable">$(PROTOS)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.tar.bz2:</span><br><span class="line">	@echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">	@tar -jc <span class="variable">$^</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布当前平台的relase包</span></span><br><span class="line"><span class="comment"># builds release packages for the host platform</span></span><br><span class="line"><span class="section">release: $(patsubst %,release/%, <span class="variable">$(MARCH)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># builds release packages for all target platforms</span></span><br><span class="line"><span class="section">release-all: $(patsubst %,release/%, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"></span><br><span class="line"><span class="section">release/windows-amd64: GOOS=windows</span></span><br><span class="line"><span class="section">release/windows-amd64: $(patsubst %,release/windows-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/darwin-amd64: GOOS=darwin</span></span><br><span class="line"><span class="section">release/darwin-amd64: $(patsubst %,release/darwin-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-amd64: GOOS=linux</span></span><br><span class="line"><span class="section">release/linux-amd64: $(patsubst %,release/linux-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%-amd64: GOARCH=amd64</span></span><br><span class="line"><span class="section">release/linux-%: GOOS=linux</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-s390x: GOARCH=s390x</span></span><br><span class="line"><span class="section">release/linux-s390x: $(patsubst %,release/linux-s390x/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-ppc64le: GOARCH=ppc64le</span></span><br><span class="line"><span class="section">release/linux-ppc64le: $(patsubst %,release/linux-ppc64le/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/configtxlator: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/configtxgen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/cryptogen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/idemixgen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/discover: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/orderer: GO_LDFLAGS = $(patsubst %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/orderer: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/peer: GO_LDFLAGS = $(patsubst %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/peer: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: dist</span></span><br><span class="line"><span class="section">dist: dist-clean dist/<span class="variable">$(MARCH)</span></span></span><br><span class="line"></span><br><span class="line"><span class="section">dist-all: dist-clean $(patsubst %,dist/%, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist/%: release/%</span></span><br><span class="line">	mkdir -p release/$(@F)/config</span><br><span class="line">	cp -r sampleconfig/*.yaml release/$(@F)/config</span><br><span class="line">	cd release/$(@F) &amp;&amp; tar -czvf hyperledger-fabric-$(@F).<span class="variable">$(PROJECT_VERSION)</span>.tar.gz *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在docker中生成protobuf文件</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: protos</span></span><br><span class="line"><span class="section">protos: buildenv</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/compile_protos.sh</span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-list:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-list,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出当前所有镜像</span></span><br><span class="line"><span class="section">docker-list: $(patsubst %,%-docker-list, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-clean:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-clean,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	-docker images --quiet --filter=reference='<span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-<span class="variable">$(BASE_VERSION)</span><span class="variable">$(<span class="built_in">if</span> <span class="variable">$(EXTRA_VERSION)</span>,-snapshot-*,)</span>' | xargs docker rmi -f</span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span>/image/<span class="variable">$(TARGET)</span> ||:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有镜像</span></span><br><span class="line"><span class="section">docker-clean: $(patsubst %,%-docker-clean, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">docker-tag-latest: $(IMAGES:%=%-docker-tag-latest)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-tag-latest:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-tag-latest,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:latest</span><br><span class="line"></span><br><span class="line"><span class="section">docker-tag-stable: $(IMAGES:%=%-docker-tag-stable)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-tag-stable:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-tag-stable,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:stable</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: docker-clean unit-test-clean release-clean</span></span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有状态数据，依赖tools清理，发包清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean-all</span></span><br><span class="line"><span class="section">clean-all: clean gotools-clean dist-clean</span></span><br><span class="line">	-@rm -rf /var/hyperledger/*</span><br><span class="line">	-@rm -rf docs/build/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布版本清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: dist-clean</span></span><br><span class="line"><span class="section">dist-clean:</span></span><br><span class="line">	-@rm -rf release/windows-amd64/hyperledger-fabric-windows-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/darwin-amd64/hyperledger-fabric-darwin-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-amd64/hyperledger-fabric-linux-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-s390x/hyperledger-fabric-linux-s390x.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-ppc64le/hyperledger-fabric-linux-ppc64le.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="section">%-release-clean:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-release-clean,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	-@rm -rf release/<span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发包清理</span></span><br><span class="line"><span class="section">release-clean: $(patsubst %,%-release-clean, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单元测试清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: unit-test-clean</span></span><br><span class="line"><span class="section">unit-test-clean:</span></span><br><span class="line">	cd unit-test &amp;&amp; docker-compose down</span><br></pre></td></tr></table></figure>
<h2 id="docker-env的Makefile"><a href="#docker-env的Makefile" class="headerlink" title="docker env的Makefile"></a>docker env的Makefile</h2><p><code>docker-env.mk</code>主要是Docker镜像构建相关的设置。</p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">// docker-env.mk</span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mac上设置--user选项</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> uname)</span>,Darwin)</span><br><span class="line">DOCKER_RUN_FLAGS=--user=<span class="variable">$(<span class="built_in">shell</span> id -u)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 架构是s390x，uid不是0（root账号）的时候，-v选项</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">shell</span> uname -m)</span>,s390x)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> id -u)</span>,0)</span><br><span class="line">DOCKER_RUN_FLAGS+=-v /etc/passwd:/etc/passwd:ro</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下是http和https的代理设置</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(http_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'http_proxy=<span class="variable">$(http_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'http_proxy=<span class="variable">$(http_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(https_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'https_proxy=<span class="variable">$(https_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'https_proxy=<span class="variable">$(https_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(HTTP_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'HTTP_PROXY=<span class="variable">$(HTTP_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'HTTP_PROXY=<span class="variable">$(HTTP_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(HTTPS_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'HTTPS_PROXY=<span class="variable">$(HTTPS_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'HTTPS_PROXY=<span class="variable">$(HTTPS_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(no_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'no_proxy=<span class="variable">$(no_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'no_proxy=<span class="variable">$(no_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(NO_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'NO_PROXY=<span class="variable">$(NO_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'NO_PROXY=<span class="variable">$(NO_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DRUN代表docker run，并伴随以下参数，把当前路径映射到容器的gopath对应路径下</span></span><br><span class="line"><span class="comment"># 并且设置容器内的工作目录</span></span><br><span class="line">DRUN = docker run -i --rm <span class="variable">$(DOCKER_RUN_FLAGS)</span> \</span><br><span class="line">	-v <span class="variable">$(<span class="built_in">abspath</span> .)</span>:/opt/gopath/src/<span class="variable">$(PKGNAME)</span> \</span><br><span class="line">	-w /opt/gopath/src/<span class="variable">$(PKGNAME)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker build</span></span><br><span class="line">DBUILD = docker build <span class="variable">$(DOCKER_BUILD_FLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础docker namespace设置时，使用hyperledger</span></span><br><span class="line">BASE_DOCKER_NS ?= hyperledger</span><br><span class="line"><span class="comment"># 基础docker tag，由arch和release组成docker tag</span></span><br><span class="line">BASE_DOCKER_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(BASEIMAGE_RELEASE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与上面类似</span></span><br><span class="line">DOCKER_NS ?= hyperledger</span><br><span class="line">DOCKER_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line">PREV_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(PREV_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础镜像标签</span></span><br><span class="line">BASE_DOCKER_LABEL=org.hyperledger.fabric</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态连接信息</span></span><br><span class="line">DOCKER_DYNAMIC_LINK ?= false</span><br><span class="line"><span class="comment"># Docker内的ldfalgs信息，继承makefile的</span></span><br><span class="line">DOCKER_GO_LDFLAGS += <span class="variable">$(GO_LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DOCKER_DYNAMIC_LINK)</span>,false)</span><br><span class="line">DOCKER_GO_LDFLAGS += -linkmode external -extldflags '-static -lpthread'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># What is a .dummy file?</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make is designed to work with files.  It uses the presence (or lack thereof)</span></span><br><span class="line"><span class="comment"># and timestamps of files when deciding if a given target needs to be rebuilt.</span></span><br><span class="line"><span class="comment"># Docker containers throw a wrench into the works because the output of docker</span></span><br><span class="line"><span class="comment"># builds do not translate into standard files that makefile rules can evaluate.</span></span><br><span class="line"><span class="comment"># Therefore, we have to fake it.  We do this by constructioning our rules such</span></span><br><span class="line"><span class="comment"># as</span></span><br><span class="line"><span class="comment">#       my-docker-target/.dummy:</span></span><br><span class="line"><span class="comment">#              docker build ...</span></span><br><span class="line"><span class="comment">#              touch $@</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If the docker-build succeeds, the touch operation creates/updates the .dummy</span></span><br><span class="line"><span class="comment"># file.  If it fails, the touch command never runs.  This means the .dummy</span></span><br><span class="line"><span class="comment"># file follows relatively 1:1 with the underlying container.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This isn't perfect, however.  For instance, someone could delete a docker</span></span><br><span class="line"><span class="comment"># container using docker-rmi outside of the build, and make would be fooled</span></span><br><span class="line"><span class="comment"># into thinking the dependency is statisfied when it really isn't.  This is</span></span><br><span class="line"><span class="comment"># our closest approximation we can come up with.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># As an aside, also note that we incorporate the version number in the .dummy</span></span><br><span class="line"><span class="comment"># file to differentiate different tags to fix FAB-1145</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">DUMMY = .dummy-<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make是跟文件打交道的，它使用文件位置（？）和时间戳觉得是否要重新构建文件。</span></span><br><span class="line"><span class="comment"># 但Docker容器产生的文件是make无法识别的。所以做了适配，docker build运行</span></span><br><span class="line"><span class="comment"># 成功时，touch回去创建或更新dummy文件，如果失败则touch不执行。</span></span><br><span class="line"><span class="comment"># 这样保证了dummy文件和容器保持一对一的关系。</span></span><br></pre></td></tr></table></figure>
<h2 id="go-tools的Makefile"><a href="#go-tools的Makefile" class="headerlink" title="go tools的Makefile"></a>go tools的Makefile</h2><p>gotools指的一些列go语言的工具，并不是golang/tools仓库，具体是哪些tools，请看Makefile文件解析。</p>
<p>这些tools的安装有2种方式：</p>
<ol>
<li>少数几个支持从vendor目录直接安装</li>
<li>默认方式是使用go get方式安装，所以请<strong>翻墙</strong></li>
</ol>
<p>另外，gotools.mk实际是在docker中运行的，也就是生成的程序都在docker镜像中，在当前host并没有运行，具体看gotools.mk调用的地方。调用处把GOBIN设置为了<code>.build/docker/gotools/bin</code>，并映射到了docker，构建后可以查看生成的程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ls .build/docker/gotools/bin</span><br><span class="line">counterfeiter  dep  ginkgo  gocov  gocov-xml  goimports  golint  manifest-tool  misspell  mockery  protoc-gen-go</span><br></pre></td></tr></table></figure>
<p>Makefile注释：</p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// gotools.mk</span><br><span class="line"><span class="comment"># Copyright IBM Corp All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有相关的tools，之所以叫go tools，因为是Go语言的，并不是指golang/tools仓库</span></span><br><span class="line">GOTOOLS = counterfeiter dep golint goimports protoc-gen-go ginkgo gocov gocov-xml misspell mockery manifest-tool</span><br><span class="line"><span class="comment"># 构建目录与Makefile保持一致</span></span><br><span class="line">BUILD_DIR ?= .build</span><br><span class="line"><span class="comment"># 构建gotools是的GOPATH，也就源码所在目录，当未设置时，使用默认路径</span></span><br><span class="line">GOTOOLS_GOPATH ?= <span class="variable">$(BUILD_DIR)</span>/gotools</span><br><span class="line"><span class="comment"># gotools的生成二进制位置，当未设置时，使用GOPATH/bin</span></span><br><span class="line">GOTOOLS_BINDIR ?= <span class="variable">$(GOPATH)</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个tool的目录映射</span></span><br><span class="line"><span class="comment"># go tool-&gt;path mapping</span></span><br><span class="line">go.fqp.counterfeiter := github.com/maxbrunsfeld/counterfeiter</span><br><span class="line">go.fqp.gocov         := github.com/axw/gocov/gocov</span><br><span class="line">go.fqp.gocov-xml     := github.com/AlekSi/gocov-xml</span><br><span class="line">go.fqp.goimports     := golang.org/x/tools/cmd/goimports</span><br><span class="line">go.fqp.golint        := golang.org/x/lint/golint</span><br><span class="line">go.fqp.manifest-tool := github.com/estesp/manifest-tool</span><br><span class="line">go.fqp.misspell      := github.com/client9/misspell/cmd/misspell</span><br><span class="line">go.fqp.mockery       := github.com/vektra/mockery/cmd/mockery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装所有tools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools-install</span></span><br><span class="line"><span class="section">gotools-install: $(patsubst %,<span class="variable">$(GOTOOLS_BINDIR)</span>/%, <span class="variable">$(GOTOOLS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理tools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools-clean</span></span><br><span class="line"><span class="section">gotools-clean:</span></span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span>/gotools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用vendor中的版本构建部分tools，比如protoc-gen-go，ginkgo，goimports，golint</span></span><br><span class="line"><span class="comment"># Special override for protoc-gen-go since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.protoc-gen-go:</span></span><br><span class="line">	@echo <span class="string">"Building github.com/golang/protobuf/protoc-gen-go -&gt; protoc-gen-go"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/github.com/golang/protobuf/protoc-gen-go</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for ginkgo since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.ginkgo:</span></span><br><span class="line">	@echo <span class="string">"Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for goimports since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.goimports:</span></span><br><span class="line">	@echo <span class="string">"Building golang.org/x/tools/cmd/goimports -&gt; goimports"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for golint since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.golint:</span></span><br><span class="line">	@echo <span class="string">"Building golang.org/x/lint/golint -&gt; golint"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/golang.org/x/lint/golint</span><br><span class="line"></span><br><span class="line"><span class="comment"># go dep的构建，使用特定版本</span></span><br><span class="line"><span class="comment"># Lock to a versioned dep</span></span><br><span class="line"><span class="section">gotool.dep: DEP_VERSION ?= "v0.5.1"</span></span><br><span class="line"><span class="section">gotool.dep:</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> go get -d -u github.com/golang/dep</span><br><span class="line">	@git -C <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span>/src/github.com/golang/dep checkout -q <span class="variable">$(DEP_VERSION)</span></span><br><span class="line">	@echo <span class="string">"Building github.com/golang/dep <span class="variable">$(DEP_VERSION)</span> -&gt; dep"</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install -ldflags=<span class="string">"-X main.version=<span class="variable">$(DEP_VERSION)</span> -X main.buildDate=$$(date '+%Y-%m-%d')"</span> github.com/golang/dep/cmd/dep</span><br><span class="line">	@git -C <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span>/src/github.com/golang/dep checkout -q master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有tools构建时的默认安装方式，会使用go get从网络拉去</span></span><br><span class="line"><span class="comment"># Default rule for gotools uses the name-&gt;path map for a generic 'go get' style build</span></span><br><span class="line"><span class="section">gotool.%:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TOOL = $&#123;<span class="built_in">subst</span> gotool.,,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building $&#123;go.fqp.$&#123;TOOL&#125;&#125; -&gt; <span class="variable">$(TOOL)</span>"</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go get $&#123;go.fqp.$&#123;TOOL&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$(GOTOOLS_BINDIR)</span>/%:</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TOOL = $&#123;<span class="built_in">subst</span> <span class="variable">$(GOTOOLS_BINDIR)</span>/,,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@<span class="variable">$(MAKE)</span> -f gotools.mk gotool.<span class="variable">$(TOOL)</span></span><br></pre></td></tr></table></figure>
<h1 id="构建建议"><a href="#构建建议" class="headerlink" title="构建建议"></a>构建建议</h1><p>列出几条构建建议，建议在make前先做好，会提高构建效率，并且少采坑。</p>
<h2 id="翻墙"><a href="#翻墙" class="headerlink" title="翻墙"></a>翻墙</h2><p>设置好翻墙，包括http和https代理，以便能下载Github，golang.org的包，参考<a href="http://lessisbetter.site/2018/09/06/Science-and-the-Internet/">让终端科学上网</a>。</p>
<blockquote>
<p>发文时fabric还使用的vendor，如果限制fabric已经使用go mod了，建议配置国内go modules代理，这样就无需翻墙了，参考本文<a href="#结束语">结束语</a>。</p>
</blockquote>
<h2 id="Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"><a href="#Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源" class="headerlink" title="Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"></a>Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源</h2><p>参考<a href="http://lessisbetter.site/2019/07/13/fast-mirrors/">让镜像飞，加速你的开发</a>。</p>
<h2 id="docker设置为国内的源"><a href="#docker设置为国内的源" class="headerlink" title="docker设置为国内的源"></a>docker设置为国内的源</h2><p>参考<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html" target="_blank" rel="noopener">Docker镜像加速</a>。</p>
<h2 id="检查GOPATH和PATH，以及http代理"><a href="#检查GOPATH和PATH，以及http代理" class="headerlink" title="检查GOPATH和PATH，以及http代理"></a>检查GOPATH和PATH，以及http代理</h2><p>确保配置正确：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo $http_proxy</span><br><span class="line">echo $https_proxy</span><br><span class="line">echo $GOPATH</span><br><span class="line">echo $PATH</span><br></pre></td></tr></table></figure>
<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><p>centos7下请参考：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></p>
<h2 id="Mac上安装Gnu-tar"><a href="#Mac上安装Gnu-tar" class="headerlink" title="Mac上安装Gnu-tar"></a>Mac上安装Gnu-tar</h2><p>如果未安装，可能遇到下面的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Step 3/5 : ADD payload/goshim.tar.bz2 $GOPATH/src/</span><br><span class="line">failed to copy files: Error processing tar file(bzip2 data invalid: bad magic value in continuation file):</span><br><span class="line">make: [build/image/ccenv/.dummy-x86_64-1.0.7-snapshot-ac3fabd] Error 1</span><br></pre></td></tr></table></figure>
<p>需要安装gnu-tar，用gnu-tar替换mac默认的bsdtar，可以用brew list gnu-tar找到gnu-tar的位置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ brew install gnu-tar</span><br><span class="line">➜  fabric git:(yx-release-1.4) ✗ brew install gnu-tar</span><br><span class="line">==&gt; Reinstalling gnu-tar</span><br><span class="line">==&gt; Downloading https://mirrors.cloud.tencent.com/homebrew-bottles/bottles/gnu-tar-1.32.mojave.bottle.tar.gz</span><br><span class="line">######################################################################## 100.0%</span><br><span class="line">==&gt; Pouring gnu-tar-1.32.mojave.bottle.tar.gz</span><br><span class="line">==&gt; Caveats</span><br><span class="line">GNU &quot;tar&quot; has been installed as &quot;gtar&quot;.</span><br><span class="line">If you need to use it as &quot;tar&quot;, you can add a &quot;gnubin&quot; directory</span><br><span class="line">to your PATH from your bashrc like:</span><br><span class="line"></span><br><span class="line">    PATH=&quot;/usr/local/opt/gnu-tar/libexec/gnubin:$PATH&quot;</span><br><span class="line">==&gt; Summary</span><br><span class="line">🍺  /usr/local/Cellar/gnu-tar/1.32: 15 files, 1.7MB</span><br><span class="line">$ which tar</span><br><span class="line">/usr/local/opt/gnu-tar/libexec/gnubin/tar</span><br></pre></td></tr></table></figure>
<p>按提示设置PATH才可以使用gnu tar。<code>export PATH=&quot;/usr/local/opt/gnu-tar/libexec/gnubin:$PATH&quot;</code>加入到<code>.zshrc</code>，不必每次构建都设置PATH，但这样会让Mac默认使用GNU tar。</p>
<p>需要<code>make clean</code>然后重新<code>make</code>，不然依然会遇到bad magic的问题。</p>
<h2 id="Git升级到2-22以上版本"><a href="#Git升级到2-22以上版本" class="headerlink" title="Git升级到2.22以上版本"></a>Git升级到2.22以上版本</h2><p>如果未升级可能遇到上文提到的dep不存在的问题。</p>
<h1 id="通过Makefile定位编译问题"><a href="#通过Makefile定位编译问题" class="headerlink" title="通过Makefile定位编译问题"></a>通过Makefile定位编译问题</h1><p>这类问题是类似的，要找到报错的位置，是做哪项构建时报的错，以及报错位置的前提条件是什么，这里列举2个。</p>
<h2 id="dep不存在的问题"><a href="#dep不存在的问题" class="headerlink" title="dep不存在的问题"></a>dep不存在的问题</h2><p>在执行<code>make all</code>的时候，遇到了<code>dep</code>不存在的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEP: Checking for dependency issues..</span><br><span class="line">./scripts/check_deps.sh: line 7: dep: command not found</span><br></pre></td></tr></table></figure>
<p>通过Makefile知道，dep属于gotools，单独执行<code>make gotools</code>查看问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make gotools</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/maxbrunsfeld/counterfeiter -&gt; counterfeiter</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building golang.org/x/lint/golint -&gt; golint</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/golang.org/x/lint/golint</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building golang.org/x/tools/cmd/goimports -&gt; goimports</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/axw/gocov/gocov -&gt; gocov</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/AlekSi/gocov-xml -&gt; gocov-xml</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/vektra/mockery/cmd/mockery -&gt; mockery</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/estesp/manifest-tool -&gt; manifest-tool</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br></pre></td></tr></table></figure>
<p>其中，果然没有安装dep，单独编译dep：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make gotool.dep</span><br><span class="line">Unknown option: -C</span><br><span class="line">usage: git [--version] [--<span class="built_in">help</span>] [-c name=value]</span><br><span class="line">           [--<span class="built_in">exec</span>-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class="line">           [-p|--paginate|--no-pager] [--no-replace-objects] [--bare]</span><br><span class="line">           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class="line">           &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line">make: *** [gotool.dep] 错误 129</span><br></pre></td></tr></table></figure>
<p>报错误，git没有<code>-C</code>选项，怀疑centos系统自带git太老，<code>git version</code>查看果然只有<code>1.9</code>。</p>
<p>按照Git的INSTALL文件指导安装git，详细见：<a href="https://github.com/git/git/blob/master/INSTALL" target="_blank" rel="noopener">https://github.com/git/git/blob/master/INSTALL</a> ，下面是简要安装步骤。</p>
<p>通过wget下载最新的<a href="https://github.com/git/git/releases" target="_blank" rel="noopener">git release</a>，然后使用以下命令安装git到<code>/usr/bin</code>目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/git/git/archive/v2.22.0.tar.gz</span><br><span class="line"><span class="comment"># 省略：解压然后进入该目录</span></span><br><span class="line">make</span><br><span class="line">make prefix=/usr install</span><br></pre></td></tr></table></figure>
<p>验证git版本，和make dep。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ git version</span><br><span class="line">git version 2.22.0</span><br><span class="line"></span><br><span class="line">➜  fabric git:(r1.4) ✗ make gotool.dep</span><br><span class="line">Building github.com/golang/dep v0.5.1 -&gt; dep</span><br></pre></td></tr></table></figure>
<p>通过fabric Makefile可知<code>check_deps.sh</code>是<code>make check-deps</code>的一部分，执行<code>make check-deps</code>可以看到检查dep通过了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) make check-deps</span><br><span class="line">DEP: Checking <span class="keyword">for</span> dependency issues..</span><br><span class="line">dep:</span><br><span class="line"> version     : v0.5.1</span><br><span class="line"> build date  : 2019-07-15</span><br><span class="line"> git <span class="built_in">hash</span>    :</span><br><span class="line"> go version  : go1.11.5</span><br><span class="line"> go compiler : gc</span><br><span class="line"> platform    : linux/amd64</span><br><span class="line"> features    : ImportDuringSolve=<span class="literal">false</span></span><br><span class="line"><span class="comment"># out of sync, but ignored, due to noverify in Gopkg.toml:</span></span><br><span class="line">github.com/grpc-ecosystem/go-grpc-middleware: <span class="built_in">hash</span> of vendored tree not equal to digest <span class="keyword">in</span> Gopkg.lock</span><br></pre></td></tr></table></figure>
<h2 id="protoc-gen-go-不存在的问题"><a href="#protoc-gen-go-不存在的问题" class="headerlink" title="protoc-gen-go 不存在的问题"></a>protoc-gen-go 不存在的问题</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make all</span><br><span class="line">mkdir -p .build/image/ccenv/payload</span><br><span class="line">cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span><br><span class="line">cp: .build/docker/gotools/bin/protoc-gen-go: No such file or directory</span><br><span class="line">make: *** [.build/image/ccenv/payload] Error 1</span><br></pre></td></tr></table></figure>
<p>查看构建日志是否有以下日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Building dockerized gotools</span><br></pre></td></tr></table></figure>
<p>应当是不存在，不过构建存在错误，所以才没有构建出docker要使用的gotools。</p>
<p>解决办法是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br><span class="line">$ make .build/docker/gotools <span class="comment"># 直接编译docker的gotools</span></span><br></pre></td></tr></table></figure>
<p>如果报网络连接导致的错误，参考<a href="http://lessisbetter.site/2018/09/06/Science-and-the-Internet/">终端科学上网</a>，然后重新执行，或者下面这种办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make gotools <span class="comment"># 本地安装gotools</span></span><br><span class="line">$ cp `<span class="built_in">which</span> protoc-gen-go` .build/docker/gotools/bin/ <span class="comment"># 拷贝到docker gotools目录</span></span><br></pre></td></tr></table></figure>
<p>然后重新<code>make all</code>或<code>make docker</code>。</p>
<h1 id="构建日志"><a href="#构建日志" class="headerlink" title="构建日志"></a>构建日志</h1><p>构建日志比较长，放到了<a href="#附录">附录</a>中，对构建日志加了注释，可根据构建日志进一步掌握构建过程。</p>
<h1 id="镜像解读"><a href="#镜像解读" class="headerlink" title="镜像解读"></a>镜像解读</h1><p>通过<code>make all</code>或<code>make docker</code>可以生成fabric的所有镜像，这些镜像可以通过<code>make docker-list</code>查看，如果使用docker images查看，会看到更多的镜像，并且发现下面这5个镜像还有另外一个”lastest”的标签，看Makefile可以知道，其实是1个镜像2个标签而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) make docker-list</span><br><span class="line">hyperledger/fabric-peer:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-orderer:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-ccenv:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-buildenv:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-tools:amd64-1.4.2-snapshot-9dce7357b</span><br></pre></td></tr></table></figure>
<ul>
<li>fabric-peer：可以使用该镜像启动一个peer节点。</li>
<li>fabric-orderer：可以使用该镜像启动一个排序节点。</li>
<li>fabric-ccenv：这是智能合约环境镜像，ccenv是chaincode env的缩写。</li>
<li>fabric-buildenv：实际包含的是go tools.tar.bz2和protoc-gen-go的镜像。</li>
<li>fabric-tools：是fabric自身tools集合的镜像。</li>
</ul>
<p>这几个镜像的Dockerfile文件在：<code>images</code>目录下，各镜像具体内容见各自的Dockerfile。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) tree images</span><br><span class="line">images</span><br><span class="line">├── buildenv</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── ccenv</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── orderer</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── peer</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── testenv</span><br><span class="line">│   ├── Dockerfile.alpine</span><br><span class="line">│   └── softhsm</span><br><span class="line">│       └── APKBUILD</span><br><span class="line">└── tools</span><br><span class="line">    └── Dockerfile.in</span><br><span class="line"></span><br><span class="line">7 directories, 7 files</span><br></pre></td></tr></table></figure>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>现在国内已经有第三方的Go modules代理服务了，比如：</p>
<ol>
<li><a href="https://goproxy.io/zh/" target="_blank" rel="noopener">goproxy.io</a>，是即将毕业的<a href="https://github.com/aofei" target="_blank" rel="noopener">盛奥飞</a>小哥捐给了七牛搭建的Go modules代理服务。</li>
<li><a href="http://mirrors.aliyun.com/goproxy/" target="_blank" rel="noopener">aliyun goproxy</a>，现在阿里云开放了Go modules代理服务。</li>
</ol>
<p>fabric使用vendor，下载各种东西的时候需要翻墙，即便是可以翻墙，也是有缺点的：</p>
<ol>
<li>慢。</li>
<li>翻墙有流量限制。</li>
</ol>
<p>fabric赶紧支持go mod吧，这样再也不用翻墙了。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://shanma.pro/tutorial/56688.html" target="_blank" rel="noopener">fabric工程项目构建Makefile翻译及解析</a></li>
</ol>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>一份构建日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make all</span><br><span class="line">// 构建native那些程序，等价make native</span><br><span class="line">// peer</span><br><span class="line">.build/bin/peer</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.4.2 -X github.com/hyperledger/fabric/common/metadata.CommitSHA=9dce735 -X github.com/hyperledger/fabric/common/metadata.BaseVersion=0.4.15 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger&quot; github.com/hyperledger/fabric/peer</span><br><span class="line">Binary available as .build/bin/peer</span><br><span class="line">// orderer</span><br><span class="line">.build/bin/orderer</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.4.2 -X github.com/hyperledger/fabric/common/metadata.CommitSHA=9dce735 -X github.com/hyperledger/fabric/common/metadata.BaseVersion=0.4.15 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger&quot; github.com/hyperledger/fabric/orderer</span><br><span class="line">Binary available as .build/bin/orderer</span><br><span class="line">// configtxgen</span><br><span class="line">.build/bin/configtxgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxgen</span><br><span class="line">Binary available as .build/bin/configtxgen</span><br><span class="line">// cryptogen</span><br><span class="line">.build/bin/cryptogen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/cryptogen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/cryptogen</span><br><span class="line">Binary available as .build/bin/cryptogen</span><br><span class="line">// idemixgen</span><br><span class="line">.build/bin/idemixgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/idemixgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/idemixgen</span><br><span class="line">Binary available as .build/bin/idemixgen</span><br><span class="line">// configtxlator</span><br><span class="line">.build/bin/configtxlator</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxlator/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxlator</span><br><span class="line">Binary available as .build/bin/configtxlator</span><br><span class="line">// discover</span><br><span class="line">.build/bin/discover</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/cmd/discover/metadata.Version=1.4.2-snapshot-9dce735&quot; github.com/hyperledger/fabric/cmd/discover</span><br><span class="line">Binary available as .build/bin/discover</span><br><span class="line"></span><br><span class="line">// 以下这部分等价make docker</span><br><span class="line">// 构建peer镜像</span><br><span class="line">Building .build/docker/bin/peer</span><br><span class="line"># github.com/hyperledger/fabric/peer</span><br><span class="line">/tmp/go-link-829040977/000006.o: In function `pluginOpen&apos;:</span><br><span class="line">/workdir/go/src/plugin/plugin_dlopen.go:19: warning: Using &apos;dlopen&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000021.o: In function `mygetgrouplist&apos;:</span><br><span class="line">/workdir/go/src/os/user/getgrouplist_unix.go:16: warning: Using &apos;getgrouplist&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetgrgid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:38: warning: Using &apos;getgrgid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetgrnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:43: warning: Using &apos;getgrnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetpwnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:33: warning: Using &apos;getpwnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetpwuid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:28: warning: Using &apos;getpwuid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000004.o: In function `_cgo_18049202ccd9_C2func_getaddrinfo&apos;:</span><br><span class="line">/tmp/go-build/cgo-gcc-prolog:49: warning: Using &apos;getaddrinfo&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">// 构建需要的压缩包</span><br><span class="line">(cd sampleconfig &amp;&amp; tar -jc *) &gt; .build/sampleconfig.tar.bz2</span><br><span class="line">// 复制peer需要的payload</span><br><span class="line">mkdir -p .build/image/peer/payload</span><br><span class="line">cp .build/docker/bin/peer .build/sampleconfig.tar.bz2 .build/image/peer/payload</span><br><span class="line">// 打包peer镜像</span><br><span class="line">mkdir -p .build/image/peer</span><br><span class="line">Building docker peer-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-peer .build/image/peer</span><br><span class="line">Sending build context to Docker daemon  33.56MB</span><br><span class="line">Step 1/7 : FROM hyperledger/fabric-baseos:amd64-0.4.15</span><br><span class="line"> ---&gt; 9d6ec11c60ff</span><br><span class="line">Step 2/7 : ENV FABRIC_CFG_PATH /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 3bea4b2a628b</span><br><span class="line">Removing intermediate container 3bea4b2a628b</span><br><span class="line"> ---&gt; 8892a2046872</span><br><span class="line">Step 3/7 : RUN mkdir -p /var/hyperledger/production $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; Running in 06437fde2305</span><br><span class="line">Removing intermediate container 06437fde2305</span><br><span class="line"> ---&gt; 98fc3c6b0fae</span><br><span class="line">Step 4/7 : COPY payload/peer /usr/local/bin</span><br><span class="line"> ---&gt; 635a5f0e02c4</span><br><span class="line">Step 5/7 : ADD  payload/sampleconfig.tar.bz2 $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; d2e3f4b80946</span><br><span class="line">Step 6/7 : CMD [&quot;peer&quot;,&quot;node&quot;,&quot;start&quot;]</span><br><span class="line"> ---&gt; Running in 47e57005f4f8</span><br><span class="line">Removing intermediate container 47e57005f4f8</span><br><span class="line"> ---&gt; 59a7e54bfe1a</span><br><span class="line">Step 7/7 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in aaacacec80e8</span><br><span class="line">Removing intermediate container aaacacec80e8</span><br><span class="line"> ---&gt; e97b7fd4ff49</span><br><span class="line">Successfully built e97b7fd4ff49</span><br><span class="line">// 构建peer镜像完成，为镜像打包</span><br><span class="line">Successfully tagged hyperledger/fabric-peer:latest</span><br><span class="line">docker tag hyperledger/fabric-peer hyperledger/fabric-peer:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-peer hyperledger/fabric-peer:amd64-latest</span><br><span class="line">// 以下为构建orderer镜像，与peer镜像过程类似</span><br><span class="line">Building .build/docker/bin/orderer</span><br><span class="line"># github.com/hyperledger/fabric/orderer</span><br><span class="line">/tmp/go-link-846385019/000018.o: In function `pluginOpen&apos;:</span><br><span class="line">/workdir/go/src/plugin/plugin_dlopen.go:19: warning: Using &apos;dlopen&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000021.o: In function `mygetgrouplist&apos;:</span><br><span class="line">/workdir/go/src/os/user/getgrouplist_unix.go:16: warning: Using &apos;getgrouplist&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetgrgid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:38: warning: Using &apos;getgrgid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetgrnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:43: warning: Using &apos;getgrnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetpwnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:33: warning: Using &apos;getpwnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetpwuid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:28: warning: Using &apos;getpwuid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000004.o: In function `_cgo_18049202ccd9_C2func_getaddrinfo&apos;:</span><br><span class="line">/tmp/go-build/cgo-gcc-prolog:49: warning: Using &apos;getaddrinfo&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">mkdir -p .build/image/orderer/payload</span><br><span class="line">cp .build/docker/bin/orderer .build/sampleconfig.tar.bz2 .build/image/orderer/payload</span><br><span class="line">mkdir -p .build/image/orderer</span><br><span class="line">Building docker orderer-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-orderer .build/image/orderer</span><br><span class="line">Sending build context to Docker daemon  28.09MB</span><br><span class="line">Step 1/8 : FROM hyperledger/fabric-baseos:amd64-0.4.15</span><br><span class="line"> ---&gt; 9d6ec11c60ff</span><br><span class="line">Step 2/8 : ENV FABRIC_CFG_PATH /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 8892a2046872</span><br><span class="line">Step 3/8 : RUN mkdir -p /var/hyperledger/production $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 98fc3c6b0fae</span><br><span class="line">Step 4/8 : COPY payload/orderer /usr/local/bin</span><br><span class="line"> ---&gt; 50854bee0fa6</span><br><span class="line">Step 5/8 : ADD payload/sampleconfig.tar.bz2 $FABRIC_CFG_PATH/</span><br><span class="line"> ---&gt; bab56963bf0f</span><br><span class="line">Step 6/8 : EXPOSE 7050</span><br><span class="line"> ---&gt; Running in bda05dbbf18a</span><br><span class="line">Removing intermediate container bda05dbbf18a</span><br><span class="line"> ---&gt; 7b335f36f7d2</span><br><span class="line">Step 7/8 : CMD [&quot;orderer&quot;]</span><br><span class="line"> ---&gt; Running in 210013bf0e3e</span><br><span class="line">Removing intermediate container 210013bf0e3e</span><br><span class="line"> ---&gt; b543c69c8caf</span><br><span class="line">Step 8/8 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in c762fc3e0590</span><br><span class="line">Removing intermediate container c762fc3e0590</span><br><span class="line"> ---&gt; aa8604c99f23</span><br><span class="line">Successfully built aa8604c99f23</span><br><span class="line">Successfully tagged hyperledger/fabric-orderer:latest</span><br><span class="line">docker tag hyperledger/fabric-orderer hyperledger/fabric-orderer:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-orderer hyperledger/fabric-orderer:amd64-latest</span><br><span class="line">// 以下开始构gotools镜像</span><br><span class="line">Building dockerized gotools</span><br><span class="line">// 以下实际在docker中运行</span><br><span class="line">// 默认go get下载，然后默认安装到$GOPATH/bin</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/maxbrunsfeld/counterfeiter -&gt; counterfeiter</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/golang/dep v0.5.1 -&gt; dep</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building golang.org/x/lint/golint -&gt; golint</span><br><span class="line">// 这几个指定了安装目录/opt/gotools/bin，实际映射到.build/docker/gotools/bin/</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/golang.org/x/lint/golint</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building golang.org/x/tools/cmd/goimports -&gt; goimports</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/golang/protobuf/protoc-gen-go -&gt; protoc-gen-go</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/github.com/golang/protobuf/protoc-gen-go</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line">// 以下安装到$GOPATH/bin</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/axw/gocov/gocov -&gt; gocov</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/AlekSi/gocov-xml -&gt; gocov-xml</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/client9/misspell/cmd/misspell -&gt; misspell</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/vektra/mockery/cmd/mockery -&gt; mockery</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/estesp/manifest-tool -&gt; manifest-tool</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">// 安装chaintool，gotools镜像需要</span><br><span class="line">Installing chaintool</span><br><span class="line">curl -fL https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/chaintool-1.1.3/hyperledger-fabric-chaintool-1.1.3.jar &gt; .build/bin/chaintool</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 16.4M  100 16.4M    0     0  1142k      0  0:00:14  0:00:14 --:--:-- 2544k</span><br><span class="line">chmod +x .build/bin/chaintool</span><br><span class="line">Creating .build/goshim.tar.bz2</span><br><span class="line">// 设置ccenv的payload</span><br><span class="line">mkdir -p .build/image/ccenv/payload</span><br><span class="line">cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span><br><span class="line">mkdir -p .build/image/ccenv</span><br><span class="line">// 构建ccenv镜像，是chain code的环境镜像，所以简写为ccenv</span><br><span class="line">Building docker ccenv-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-ccenv .build/image/ccenv</span><br><span class="line">Sending build context to Docker daemon  25.12MB</span><br><span class="line">Step 1/5 : FROM hyperledger/fabric-baseimage:amd64-0.4.15</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 2/5 : COPY payload/chaintool payload/protoc-gen-go /usr/local/bin/</span><br><span class="line"> ---&gt; 44e06a863d08</span><br><span class="line">Step 3/5 : ADD payload/goshim.tar.bz2 $GOPATH/src/</span><br><span class="line"> ---&gt; 233605b067d5</span><br><span class="line">Step 4/5 : RUN mkdir -p /chaincode/input /chaincode/output</span><br><span class="line"> ---&gt; Running in be1909a39e06</span><br><span class="line">Removing intermediate container be1909a39e06</span><br><span class="line"> ---&gt; 605b1c70e97f</span><br><span class="line">Step 5/5 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in dc470f15e125</span><br><span class="line">Removing intermediate container dc470f15e125</span><br><span class="line"> ---&gt; 7cb803c8b124</span><br><span class="line">Successfully built 7cb803c8b124</span><br><span class="line">Successfully tagged hyperledger/fabric-ccenv:latest</span><br><span class="line">docker tag hyperledger/fabric-ccenv hyperledger/fabric-ccenv:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-ccenv hyperledger/fabric-ccenv:amd64-latest</span><br><span class="line">// 构建buildenv镜像</span><br><span class="line">// gotools放进压缩包</span><br><span class="line">(cd .build/docker/gotools/bin &amp;&amp; tar -jc *) &gt; .build/gotools.tar.bz2</span><br><span class="line">mkdir -p .build/image/buildenv/payload</span><br><span class="line">// gotools和protoc-gen-go是buildenv的payload</span><br><span class="line">cp .build/gotools.tar.bz2 .build/docker/gotools/bin/protoc-gen-go .build/image/buildenv/payload</span><br><span class="line">mkdir -p .build/image/buildenv</span><br><span class="line">Building docker buildenv-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-buildenv .build/image/buildenv</span><br><span class="line">Sending build context to Docker daemon  47.17MB</span><br><span class="line">Step 1/5 : FROM hyperledger/fabric-baseimage:amd64-0.4.15</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 2/5 : COPY payload/protoc-gen-go /usr/local/bin/</span><br><span class="line"> ---&gt; 90f62f1410b4</span><br><span class="line">Step 3/5 : ADD payload/gotools.tar.bz2 /usr/local/bin/</span><br><span class="line"> ---&gt; e27228cd3fb8</span><br><span class="line">Step 4/5 : ENV GOCACHE &quot;/tmp&quot;</span><br><span class="line"> ---&gt; Running in 780e38380727</span><br><span class="line">Removing intermediate container 780e38380727</span><br><span class="line"> ---&gt; b610d861e6ce</span><br><span class="line">Step 5/5 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in 226095fc14b5</span><br><span class="line">Removing intermediate container 226095fc14b5</span><br><span class="line"> ---&gt; 6ba655852ec7</span><br><span class="line">Successfully built 6ba655852ec7</span><br><span class="line">Successfully tagged hyperledger/fabric-buildenv:latest</span><br><span class="line">// gotools实际打包在了buildenv镜像中</span><br><span class="line">docker tag hyperledger/fabric-buildenv hyperledger/fabric-buildenv:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-buildenv hyperledger/fabric-buildenv:amd64-latest</span><br><span class="line">// 打包tools镜像，它的dockerfile文件：.build/image/tools/Dockerfile</span><br><span class="line">// 从这里可以看到镜像里实际包含的是configtxgen configtxlator cryptogen peer discover idemixgen，这几个工具</span><br><span class="line">// 并对系统进行了更新</span><br><span class="line">// 所以tools镜像指的是fabric tools的镜像，而不是go tools</span><br><span class="line">mkdir -p .build/image/tools</span><br><span class="line">Building docker tools-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-tools -f .build/image/tools/Dockerfile .</span><br><span class="line">Sending build context to Docker daemon  179.5MB</span><br><span class="line">Step 1/14 : FROM hyperledger/fabric-baseimage:amd64-0.4.15 as builder</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 2/14 : WORKDIR /opt/gopath</span><br><span class="line"> ---&gt; Running in bc4dd206cdcd</span><br><span class="line">Removing intermediate container bc4dd206cdcd</span><br><span class="line"> ---&gt; c156c64ba0c0</span><br><span class="line">Step 3/14 : RUN mkdir src &amp;&amp; mkdir pkg &amp;&amp; mkdir bin</span><br><span class="line"> ---&gt; Running in 752a63efe3be</span><br><span class="line">Removing intermediate container 752a63efe3be</span><br><span class="line"> ---&gt; 001cb4d1136f</span><br><span class="line">Step 4/14 : ADD . src/github.com/hyperledger/fabric</span><br><span class="line"> ---&gt; 5ba1e6fe79df</span><br><span class="line">Step 5/14 : WORKDIR /opt/gopath/src/github.com/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 9b03a753a124</span><br><span class="line">Removing intermediate container 9b03a753a124</span><br><span class="line"> ---&gt; e0eb57e0b44b</span><br><span class="line">Step 6/14 : ENV EXECUTABLES go git curl</span><br><span class="line"> ---&gt; Running in 6b5978688143</span><br><span class="line">Removing intermediate container 6b5978688143</span><br><span class="line"> ---&gt; 2a28ae07b3da</span><br><span class="line">Step 7/14 : RUN make configtxgen configtxlator cryptogen peer discover idemixgen</span><br><span class="line"> ---&gt; Running in 27e814a9a148</span><br><span class="line">//  在镜像里安装native中的各种工具，所以gotools镜像，包含的并不是gotools那几个工具</span><br><span class="line">.build/bin/configtxgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxgen</span><br><span class="line">Binary available as .build/bin/configtxgen</span><br><span class="line">.build/bin/configtxlator</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxlator/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxlator</span><br><span class="line">Binary available as .build/bin/configtxlator</span><br><span class="line">.build/bin/cryptogen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/cryptogen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/cryptogen</span><br><span class="line">Binary available as .build/bin/cryptogen</span><br><span class="line">.build/bin/peer</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.4.2 -X github.com/hyperledger/fabric/common/metadata.CommitSHA=9dce735 -X github.com/hyperledger/fabric/common/metadata.BaseVersion=0.4.15 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger&quot; github.com/hyperledger/fabric/peer</span><br><span class="line">Binary available as .build/bin/peer</span><br><span class="line">.build/bin/discover</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/cmd/discover/metadata.Version=1.4.2-snapshot-9dce735&quot; github.com/hyperledger/fabric/cmd/discover</span><br><span class="line">Binary available as .build/bin/discover</span><br><span class="line">.build/bin/idemixgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/idemixgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/idemixgen</span><br><span class="line">Binary available as .build/bin/idemixgen</span><br><span class="line">Removing intermediate container 27e814a9a148</span><br><span class="line"> ---&gt; 019fcc98aafe</span><br><span class="line">Step 8/14 : FROM hyperledger/fabric-baseimage:amd64-0.4.15</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 9/14 : ENV FABRIC_CFG_PATH /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 971f1e778c1b</span><br><span class="line">Removing intermediate container 971f1e778c1b</span><br><span class="line"> ---&gt; 3abe7ab3eda7</span><br><span class="line">Step 10/14 : RUN apt-get update &amp;&amp; apt-get install -y jq</span><br><span class="line"> ---&gt; Running in 0c6bc2dab637</span><br><span class="line">Get:1 http://security.ubuntu.com/ubuntu xenial-security InRelease [109 kB]</span><br><span class="line">Get:2 http://archive.ubuntu.com/ubuntu xenial InRelease [247 kB]</span><br><span class="line">Get:3 http://archive.ubuntu.com/ubuntu xenial-updates InRelease [109 kB]</span><br><span class="line">Get:4 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [896 kB]</span><br><span class="line">Get:5 http://archive.ubuntu.com/ubuntu xenial-backports InRelease [107 kB]</span><br><span class="line">Get:6 http://archive.ubuntu.com/ubuntu xenial/main amd64 Packages [1558 kB]</span><br><span class="line">Get:7 http://security.ubuntu.com/ubuntu xenial-security/restricted amd64 Packages [12.7 kB]</span><br><span class="line">Get:8 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [569 kB]</span><br><span class="line">Get:9 http://archive.ubuntu.com/ubuntu xenial/restricted amd64 Packages [14.1 kB]</span><br><span class="line">Get:10 http://archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [9827 kB]</span><br><span class="line">Get:11 http://security.ubuntu.com/ubuntu xenial-security/multiverse amd64 Packages [6117 B]</span><br><span class="line">Get:12 http://archive.ubuntu.com/ubuntu xenial/multiverse amd64 Packages [176 kB]</span><br><span class="line">Get:13 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [1277 kB]</span><br><span class="line">Get:14 http://archive.ubuntu.com/ubuntu xenial-updates/restricted amd64 Packages [13.1 kB]</span><br><span class="line">Get:15 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [974 kB]</span><br><span class="line">Get:16 http://archive.ubuntu.com/ubuntu xenial-updates/multiverse amd64 Packages [19.1 kB]</span><br><span class="line">Get:17 http://archive.ubuntu.com/ubuntu xenial-backports/main amd64 Packages [7942 B]</span><br><span class="line">Get:18 http://archive.ubuntu.com/ubuntu xenial-backports/universe amd64 Packages [8532 B]</span><br><span class="line">Fetched 15.9 MB in 17s (896 kB/s)</span><br><span class="line">Reading package lists...</span><br><span class="line">Reading package lists...</span><br><span class="line">Building dependency tree...</span><br><span class="line">Reading state information...</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  libonig2</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  jq libonig2</span><br><span class="line">0 upgraded, 2 newly installed, 0 to remove and 55 not upgraded.</span><br><span class="line">Need to get 231 kB of archives.</span><br><span class="line">After this operation, 797 kB of additional disk space will be used.</span><br><span class="line">Get:1 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 libonig2 amd64 5.9.6-1ubuntu0.1 [86.7 kB]</span><br><span class="line">Get:2 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 jq amd64 1.5+dfsg-1ubuntu0.1 [144 kB]</span><br><span class="line">debconf: unable to initialize frontend: Dialog</span><br><span class="line">debconf: (TERM is not set, so the dialog frontend is not usable.)</span><br><span class="line">debconf: falling back to frontend: Readline</span><br><span class="line">debconf: unable to initialize frontend: Readline</span><br><span class="line">debconf: (This frontend requires a controlling tty.)</span><br><span class="line">debconf: falling back to frontend: Teletype</span><br><span class="line">dpkg-preconfigure: unable to re-open stdin:</span><br><span class="line">Fetched 231 kB in 2s (105 kB/s)</span><br><span class="line">Selecting previously unselected package libonig2:amd64.</span><br><span class="line">(Reading database ... 22655 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../libonig2_5.9.6-1ubuntu0.1_amd64.deb ...</span><br><span class="line">Unpacking libonig2:amd64 (5.9.6-1ubuntu0.1) ...</span><br><span class="line">Selecting previously unselected package jq.</span><br><span class="line">Preparing to unpack .../jq_1.5+dfsg-1ubuntu0.1_amd64.deb ...</span><br><span class="line">Unpacking jq (1.5+dfsg-1ubuntu0.1) ...</span><br><span class="line">Processing triggers for libc-bin (2.23-0ubuntu11) ...</span><br><span class="line">Setting up libonig2:amd64 (5.9.6-1ubuntu0.1) ...</span><br><span class="line">Setting up jq (1.5+dfsg-1ubuntu0.1) ...</span><br><span class="line">Processing triggers for libc-bin (2.23-0ubuntu11) ...</span><br><span class="line">Removing intermediate container 0c6bc2dab637</span><br><span class="line"> ---&gt; bc8cfafb544f</span><br><span class="line">Step 11/14 : VOLUME /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 260f4ec6bd3e</span><br><span class="line">Removing intermediate container 260f4ec6bd3e</span><br><span class="line"> ---&gt; 9f682419f109</span><br><span class="line">Step 12/14 : COPY --from=builder /opt/gopath/src/github.com/hyperledger/fabric/.build/bin /usr/local/bin</span><br><span class="line"> ---&gt; ff18ec787bf5</span><br><span class="line">Step 13/14 : COPY --from=builder /opt/gopath/src/github.com/hyperledger/fabric/sampleconfig $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; 70163f0cac4f</span><br><span class="line">Step 14/14 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in 2f70bb608ac2</span><br><span class="line">Removing intermediate container 2f70bb608ac2</span><br><span class="line"> ---&gt; e395ec9d27e8</span><br><span class="line">Successfully built e395ec9d27e8</span><br><span class="line">Successfully tagged hyperledger/fabric-tools:latest</span><br><span class="line">// gotools镜像打包完成，打上tag</span><br><span class="line">docker tag hyperledger/fabric-tools hyperledger/fabric-tools:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-tools hyperledger/fabric-tools:amd64-latest</span><br><span class="line"></span><br><span class="line">// 以下等价于make checks</span><br><span class="line">// 许可证检查</span><br><span class="line">All files have SPDX-License-Identifier headers</span><br><span class="line">// 拼写检查</span><br><span class="line">Checking changed go files for spelling errors ...</span><br><span class="line">spell checker passed</span><br><span class="line">// trailing spaces检查</span><br><span class="line">Checking trailing spaces ...</span><br><span class="line">// dep检查</span><br><span class="line">DEP: Checking for dependency issues..</span><br><span class="line">dep:</span><br><span class="line"> version     : v0.5.1</span><br><span class="line"> build date  : 2019-07-16</span><br><span class="line"> git hash    :</span><br><span class="line"> go version  : go1.11.5</span><br><span class="line"> go compiler : gc</span><br><span class="line"> platform    : linux/amd64</span><br><span class="line"> features    : ImportDuringSolve=false</span><br><span class="line"># out of sync, but ignored, due to noverify in Gopkg.toml:</span><br><span class="line">github.com/grpc-ecosystem/go-grpc-middleware: hash of vendored tree not equal to digest in Gopkg.lock</span><br><span class="line">// 执行lint</span><br><span class="line">LINT: Running code checks..</span><br><span class="line">Checking with gofmt</span><br><span class="line">Checking with goimports</span><br><span class="line">Checking for golang.org/x/net/context</span><br><span class="line">Checking with go vet</span><br><span class="line">METRICS: Checking for outdated reference documentation..</span><br><span class="line">cd unit-test &amp;&amp; docker-compose down</span><br><span class="line">WARNING: The TEST_PKGS variable is not set. Defaulting to a blank string.</span><br><span class="line">WARNING: The JOB_TYPE variable is not set. Defaulting to a blank string.</span><br><span class="line">docker pull hyperledger/fabric-couchdb:amd64-0.4.15</span><br><span class="line">amd64-0.4.15: Pulling from hyperledger/fabric-couchdb</span><br><span class="line">34667c7e4631: Already exists</span><br><span class="line">d18d76a881a4: Already exists</span><br><span class="line">119c7358fbfc: Already exists</span><br><span class="line">2aaf13f3eff0: Already exists</span><br><span class="line">3f89de4cf84b: Already exists</span><br><span class="line">24194f819972: Already exists</span><br><span class="line">78e4eabd31a5: Already exists</span><br><span class="line">c7652b6bde40: Already exists</span><br><span class="line">b4646dd65c45: Already exists</span><br><span class="line">5e6defad8a30: Already exists</span><br><span class="line">7695bf5d0b9d: Pull complete</span><br><span class="line">6d9d46f66bc3: Pull complete</span><br><span class="line">4912f1b4990a: Pull complete</span><br><span class="line">f3b174a93eea: Pull complete</span><br><span class="line">3763a939777a: Pull complete</span><br><span class="line">f293593adbb6: Pull complete</span><br><span class="line">1ae53ace804f: Pull complete</span><br><span class="line">d4aa6d764b18: Pull complete</span><br><span class="line">d747b2b30e48: Pull complete</span><br><span class="line">52cbd2253fea: Pull complete</span><br><span class="line">Digest: sha256:e9c528f90c84c50dd3a79c2d2c5f1ff87264a8009a1971b269ceecace4ef1fb9</span><br><span class="line">Status: Downloaded newer image for hyperledger/fabric-couchdb:amd64-0.4.15</span><br><span class="line">docker tag hyperledger/fabric-couchdb:amd64-0.4.15 hyperledger/fabric-couchdb</span><br><span class="line">docker pull hyperledger/fabric-zookeeper:amd64-0.4.15</span><br><span class="line">amd64-0.4.15: Pulling from hyperledger/fabric-zookeeper</span><br><span class="line">34667c7e4631: Already exists</span><br><span class="line">d18d76a881a4: Already exists</span><br><span class="line">119c7358fbfc: Already exists</span><br><span class="line">2aaf13f3eff0: Already exists</span><br><span class="line">3f89de4cf84b: Already exists</span><br><span class="line">24194f819972: Already exists</span><br><span class="line">78e4eabd31a5: Already exists</span><br><span class="line">c7652b6bde40: Already exists</span><br><span class="line">b4646dd65c45: Already exists</span><br><span class="line">5e6defad8a30: Already exists</span><br><span class="line">0e045d9c2cdc: Pull complete</span><br><span class="line">7ef4d8920518: Pull complete</span><br><span class="line">dbeed81d9a45: Pull complete</span><br><span class="line">aeea025ecc4e: Pull complete</span><br><span class="line">Digest: sha256:4e4e8b8aaed7864f23d0c6c018cc8589e8e1d042413abc034dd7a6b3faacd2f0</span><br><span class="line">Status: Downloaded newer image for hyperledger/fabric-zookeeper:amd64-0.4.15</span><br><span class="line">docker tag hyperledger/fabric-zookeeper:amd64-0.4.15 hyperledger/fabric-zookeeper</span><br><span class="line">docker pull hyperledger/fabric-kafka:amd64-0.4.15</span><br><span class="line">amd64-0.4.15: Pulling from hyperledger/fabric-kafka</span><br><span class="line">34667c7e4631: Already exists</span><br><span class="line">d18d76a881a4: Already exists</span><br><span class="line">119c7358fbfc: Already exists</span><br><span class="line">2aaf13f3eff0: Already exists</span><br><span class="line">3f89de4cf84b: Already exists</span><br><span class="line">24194f819972: Already exists</span><br><span class="line">78e4eabd31a5: Already exists</span><br><span class="line">c7652b6bde40: Already exists</span><br><span class="line">b4646dd65c45: Already exists</span><br><span class="line">5e6defad8a30: Already exists</span><br><span class="line">d0459116a54a: Pull complete</span><br><span class="line">1bbcec7bfdef: Pull complete</span><br><span class="line">5911218c5933: Pull complete</span><br><span class="line">Digest: sha256:68398b1e1ee4165fd80b1a2f0e123625f489150673c7dc4816177816e43ace78</span><br><span class="line">Status: Downloaded newer image for hyperledger/fabric-kafka:amd64-0.4.15</span><br><span class="line">docker tag hyperledger/fabric-kafka:amd64-0.4.15 hyperledger/fabric-kafka</span><br><span class="line">unit-test/run.sh</span><br><span class="line"></span><br><span class="line">// 省略后面的单元测试</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/07/16/fabric-makefile/">http://lessisbetter.site/2019/07/16/fabric-makefile/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/06/go-memory-allocation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/06/go-memory-allocation/" class="post-title-link" itemprop="url">Go内存分配那些事，就这么简单！</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-06 23:19:39" itemprop="dateCreated datePublished" datetime="2019-07-06T23:19:39+08:00">2019-07-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>新老朋友好久不见，我是大彬，这篇文章准备了很久，不是在拖延，而是中间做了一些其他事情，耽搁了一些。</p>
<p>这篇文章<strong>主要介绍Go内存分配和Go内存管理</strong>，会轻微涉及内存申请和释放，以及Go垃圾回收。</p>
<p>从非常宏观的角度看，Go的内存管理就是下图这个样子，我们今天主要关注其中标红的部分。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-memory-manage.png" alt="Go内存管理"></p>
<blockquote>
<p>友情提醒：</p>
<p>文章有点长，建议先收藏，后阅读，绝对是学习内存管理的好资料。</p>
</blockquote>
<p><strong>本文基于go1.11.2，不同版本Go的内存管理可能存在差别，比如1.9与1.11的mheap定义就是差别比较大的，后续看源码的时候，请注意你的go版本，但无论你用哪个go版本，这都是一个优秀的资料，因为内存管理的思想和框架始终未变。</strong></p>
<p>Go这门语言抛弃了C/C++中的开发者管理内存的方式：主动申请与主动释放，增加了逃逸分析和GC，将开发者从内存管理中释放出来，让开发者有更多的精力去关注软件设计，而不是底层的内存问题。这是Go语言成为高生产力语言的原因之一。</p>
<p>我们不需要精通内存的管理，因为它确实很复杂，但掌握内存的管理，可以让你写出更高质量的代码，另外，还能助你定位Bug。</p>
<p><strong>这篇文章采用层层递进的方式，依次会介绍关于存储的基本知识，Go内存管理的“前辈”TCMalloc，然后是Go的内存管理和分配，最后是总结。这么做的目的是，希望各位能通过全局的认识和思考，拥有更好的编码思维和架构思维。</strong></p>
<p>最后，这不是一篇源码分析文章，因为Go源码分析的文章已经有很多了，这些源码文章能够帮助你去学习具体的工程实践和奇淫巧计了，文章的末尾会推荐一些优秀文章，如果你对内存感兴趣，建议每一篇都去看一下，挑出自己喜欢的，多花时间研究下。</p>
<h2 id="1-存储基础知识回顾"><a href="#1-存储基础知识回顾" class="headerlink" title="1. 存储基础知识回顾"></a>1. 存储基础知识回顾</h2><p>这部分我们简单回顾一下计算机存储体系、虚拟内存、栈和堆，以及堆内存的管理，这部分内容对理解和掌握Go内存管理比较重要，建议忘记或不熟悉的朋友不要跳过。</p>
<h3 id="存储金字塔"><a href="#存储金字塔" class="headerlink" title="存储金字塔"></a>存储金字塔</h3><p><img src="http://img.lessisbetter.site/2019-07-data-heirarchy.jpg" alt="img"></p>
<p>这幅图表达了计算机的存储体系，从上至下依次是：</p>
<ul>
<li>CPU寄存器</li>
<li>Cache</li>
<li>内存</li>
<li>硬盘等辅助存储设备</li>
<li>鼠标等外接设备</li>
</ul>
<p>从上至下，访问速度越来越慢，访问时间越来越长。</p>
<p>你有没有思考过下面2个简单的问题，如果没有不妨想想：</p>
<ol>
<li>如果CPU直接访问硬盘，CPU能充分利用吗？</li>
<li>如果CPU直接访问内存，CPU能充分利用吗？</li>
</ol>
<p>CPU速度很快，但硬盘等持久存储很慢，如果CPU直接访问磁盘，磁盘可以拉低CPU的速度，机器整体性能就会低下，为了弥补这2个硬件之间的速率差异，所以在CPU和磁盘之间增加了比磁盘快很多的内存。</p>
<p><img src="http://img.lessisbetter.site/2019-07-CPU-DRAM.png" alt="CPU和内存速率差异"></p>
<p>然而，CPU跟内存的速率也不是相同的，从上图可以看到，CPU的速率提高的很快（摩尔定律），然而内存速率增长的很慢，<em>虽然CPU的速率现在增加的很慢了，但是内存的速率也没增加多少，速率差距很大</em>，从1980年开始CPU和内存速率差距在不断拉大，为了弥补这2个硬件之间的速率差异，所以在CPU跟内存之间增加了比内存更快的Cache，Cache是内存数据的缓存，可以降低CPU访问内存的时间。</p>
<p>不要以为有了<a href="https://zh.wikipedia.org/wiki/CPU缓存" target="_blank" rel="noopener">Cache</a>就万事大吉了，CPU的速率还在不断增大，Cache也在不断改变，从最初的1级，到后来的2级，到当代的3级Cache，<em><a href="https://zh.wikipedia.org/wiki/CPU%E7%BC%93%E5%AD%98#%E5%8E%86%E5%8F%B2%E5%92%8C%E6%9C%AA%E6%9D%A5" target="_blank" rel="noopener">（有兴趣看cache历史）</a></em>。</p>
<p><img src="http://img.lessisbetter.site/2019-07-mbp-memory.png" alt="MBP的CPU和Cache信息"></p>
<p>三级Cache分别是L1、L2、L3，它们的速率是三个不同的层级，L1速率最快，与CPU速率最接近，是RAM速率的100倍，L2速率就降到了RAM的25倍，L3的速率更靠近RAM的速率。</p>
<p>看到这了，你有没有Get到整个<strong>存储体系的分层设计</strong>？<strong>自顶向下，速率越来越低，访问时间越来越长，从磁盘到CPU寄存器，上一层都可以看做是下一层的缓存。</strong></p>
<p>看了分层设计，我们看一下内存，毕竟我们是介绍内存管理的文章。</p>
<h3 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><p>虚拟内存是当代操作系统必备的一项重要功能了，它向进程屏蔽了底层了RAM和磁盘，并向进程提供了远超物理内存大小的内存空间。我们看一下虚拟内存的<strong>分层设计</strong>。</p>
<p><img src="http://img.lessisbetter.site/2019-07-Virtual-Memory-in-OS-Operating-System.png" alt="虚拟内存原理"></p>
<p>上图展示了某进程访问数据，当Cache没有命中的时候，访问虚拟内存获取数据的过程。</p>
<p>访问内存，实际访问的是虚拟内存，虚拟内存通过页表查看，当前要访问的虚拟内存地址，是否已经加载到了物理内存，如果已经在物理内存，则取物理内存数据，如果没有对应的物理内存，则从磁盘加载数据到物理内存，并把物理内存地址和虚拟内存地址更新到页表。</p>
<p>有没有Get到：<strong>物理内存就是磁盘存储缓存层</strong>。</p>
<p>另外，在没有虚拟内存的时代，物理内存对所有进程是共享的，多进程同时访问同一个物理内存存在并发访问问题。<strong>引入虚拟内存后，每个进程都要各自的虚拟内存，内存的并发访问问题的粒度从多进程级别，可以降低到多线程级别</strong>。</p>
<h3 id="栈和堆"><a href="#栈和堆" class="headerlink" title="栈和堆"></a>栈和堆</h3><p>我们现在从虚拟内存，再进一层，看虚拟内存中的栈和堆，也就是进程对内存的管理。</p>
<p><img src="http://img.lessisbetter.site/2019-07-figure_6-1.png" alt="虚拟内存布局"></p>
<p>上图展示了一个进程的虚拟内存划分，代码中使用的内存地址都是虚拟内存地址，而不是实际的物理内存地址。栈和堆只是虚拟内存上2块不同功能的内存区域：</p>
<ul>
<li><p>栈在高地址，从高地址向低地址增长。</p>
</li>
<li><p>堆在低地址，从低地址向高地址增长。</p>
</li>
</ul>
<p><strong>栈和堆相比有这么几个好处</strong>：</p>
<ol>
<li>栈的内存管理简单，分配比堆上快。</li>
<li>栈的内存不需要回收，而堆需要，无论是主动free，还是被动的垃圾回收，这都需要花费额外的CPU。</li>
<li>栈上的内存有更好的局部性，堆上内存访问就不那么友好了，CPU访问的2块数据可能在不同的页上，CPU访问数据的时间可能就上去了。</li>
</ol>
<h3 id="堆内存管理"><a href="#堆内存管理" class="headerlink" title="堆内存管理"></a>堆内存管理</h3><p><img src="http://img.lessisbetter.site/2019-07-Mutator-Allocator-Collector.png" alt="内存管理"></p>
<p>我们再进一层，当我们说内存管理的时候，主要是指堆内存的管理，因为栈的内存管理不需要程序去操心。这小节看下堆内存管理干的是啥，如上图所示主要是3部分：<strong>分配内存块，回收内存块和组织内存块</strong>。</p>
<p>在一个最简单的内存管理中，堆内存最初会是一个完整的大块，即未分配内存，当来申请的时候，就会从未分配内存，分割出一个小内存块(block)，然后用链表把所有内存块连接起来。需要一些信息描述每个内存块的基本信息，比如大小(size)、是否使用中(used)和下一个内存块的地址(next)，内存块实际数据存储在data中。</p>
<p><img src="http://img.lessisbetter.site/2019-07-Memory_Blocks.png" alt="内存块链表"></p>
<p>一个内存块包含了3类信息，如下图所示，元数据、用户数据和对齐字段，内存对齐是为了提高访问效率。下图申请5Byte内存的时候，就需要进行内存对齐。</p>
<p><img src="http://img.lessisbetter.site/2019-07-Alignment-Header.png" alt="内存块和对齐"></p>
<p>释放内存实质是把使用的内存块从链表中取出来，然后标记为未使用，当分配内存块的时候，可以从未使用内存块中有先查找大小相近的内存块，如果找不到，再从未分配的内存中分配内存。</p>
<p>上面这个简单的设计中还没考虑内存碎片的问题，因为随着内存不断的申请和释放，内存上会存在大量的碎片，降低内存的使用率。为了解决内存碎片，可以将2个连续的未使用的内存块合并，减少碎片。</p>
<p>以上就是内存管理的基本思路，关于基本的内存管理，想了解更多，可以阅读这篇文章《<a href="http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/" target="_blank" rel="noopener">Writing a Memory Allocator</a>》，本节的3张图片也是来自这片文章。</p>
<h2 id="2-TCMalloc"><a href="#2-TCMalloc" class="headerlink" title="2. TCMalloc"></a>2. TCMalloc</h2><p><strong>TCMalloc是Thread Cache Malloc的简称，是Go内存管理的起源</strong>，Go的内存管理是借鉴了TCMalloc，随着Go的迭代，Go的内存管理与TCMalloc不一致地方在不断扩大，但<strong>其主要思想、原理和概念都是和TCMalloc一致的</strong>，如果跳过TCMalloc直接去看Go的内存管理，也许你会似懂非懂。</p>
<p>掌握TCMalloc的理念，<em>无需去关注过多的源码细节</em>，就可以为掌握Go的内存管理打好基础，基础打好了，后面知识才扎实。</p>
<p>在Linux里，其实有不少的内存管理库，比如glibc的ptmalloc，FreeBSD的jemalloc，Google的tcmalloc等等，为何会出现这么多的内存管理库？本质都是<strong>在多线程编程下，追求更高内存管理效率</strong>：更快的分配是主要目的。</p>
<p>那如何更快的分配内存？</p>
<p>我们前面提到：</p>
<blockquote>
<p>引入虚拟内存后，让内存的并发访问问题的粒度从多进程级别，降低到多线程级别。</p>
</blockquote>
<p>这是<strong>更快分配内存的第一个层次</strong>。</p>
<p>同一进程的所有线程共享相同的内存空间，他们申请内存时需要加锁，如果不加锁就存在同一块内存被2个线程同时访问的问题。</p>
<p>TCMalloc的做法是什么呢？<strong>为每个线程预分配一块缓存，线程申请小内存时，可以从缓存分配内存</strong>，这样有2个好处：</p>
<ol>
<li>为线程预分配缓存需要进行1次系统调用，后续线程申请小内存时，从缓存分配，都是在用户态执行，没有系统调用，<strong>缩短了内存总体的分配和释放时间，这是快速分配内存的第二个层次</strong>。</li>
<li>多个线程同时申请小内存时，从各自的缓存分配，访问的是不同的地址空间，无需加锁，<strong>把内存并发访问的粒度进一步降低了，这是快速分配内存的第三个层次</strong>。</li>
</ol>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>下面就简单介绍下TCMalloc，细致程度够我们理解Go的内存管理即可。</p>
<blockquote>
<p>声明：我没有研究过TCMalloc，以下介绍根据TCMalloc官方资料和其他博主资料总结而来，错误之处请朋友告知我。</p>
</blockquote>
<p><img src="http://img.lessisbetter.site/2019-07-tcmalloc-Overview.svg" alt="TCMalloc概要图"></p>
<p>结合上图，介绍TCMalloc的几个重要概念：</p>
<ol>
<li><strong>Page</strong>：操作系统对内存管理以页为单位，TCMalloc也是这样，只不过TCMalloc里的Page大小与操作系统里的大小并不一定相等，而是倍数关系。《<a href="https://wallenwang.com/2018/11/tcmalloc/" target="_blank" rel="noopener">TCMalloc解密</a>》里称x64下Page大小是8KB。</li>
<li><strong>Span</strong>：一组连续的Page被称为Span，比如可以有2个页大小的Span，也可以有16页大小的Span，Span比Page高一个层级，是为了方便管理一定大小的内存区域，Span是TCMalloc中内存管理的基本单位。</li>
<li><strong>ThreadCache</strong>：每个线程各自的Cache，一个Cache包含多个空闲内存块链表，每个链表连接的都是内存块，同一个链表上内存块的大小是相同的，也可以说按内存块大小，给内存块分了个类，这样可以根据申请的内存大小，快速从合适的链表选择空闲内存块。由于每个线程有自己的ThreadCache，所以ThreadCache访问是无锁的。</li>
<li><strong>CentralCache</strong>：是所有线程共享的缓存，也是保存的空闲内存块链表，链表的数量与ThreadCache中链表数量相同，当ThreadCache内存块不足时，可以从CentralCache取，当ThreadCache内存块多时，可以放回CentralCache。由于CentralCache是共享的，所以它的访问是要加锁的。</li>
<li><strong>PageHeap</strong>：PageHeap是堆内存的抽象，PageHeap存的也是若干链表，链表保存的是Span，当CentralCache没有内存的时，会从PageHeap取，把1个Span拆成若干内存块，添加到对应大小的链表中，当CentralCache内存多的时候，会放回PageHeap。如下图，分别是1页Page的Span链表，2页Page的Span链表等，最后是large span set，这个是用来保存中大对象的。毫无疑问，PageHeap也是要加锁的。</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-07-tcmalloc-PageHeap.svg" alt="PageHeap"></p>
<p>上文提到了小、中、大对象，Go内存管理中也有类似的概念，我们瞄一眼TCMalloc的定义：</p>
<ol>
<li>小对象大小：0~256KB</li>
<li>中对象大小：257~1MB</li>
<li>大对象大小：&gt;1MB</li>
</ol>
<p>小对象的分配流程：ThreadCache -&gt; CentralCache -&gt; HeapPage，大部分时候，ThreadCache缓存都是足够的，不需要去访问CentralCache和HeapPage，无锁分配加无系统调用，分配效率是非常高的。</p>
<p>中对象分配流程：直接在PageHeap中选择适当的大小即可，128 Page的Span所保存的最大内存就是1MB。</p>
<p>大对象分配流程：从large span set选择合适数量的页面组成span，用来存储数据。</p>
<p>通过本节的介绍，你应当对TCMalloc主要思想有一定了解了，我建议再回顾一下上面的内容。</p>
<p><strong><em>本节图片皆来自《<a href="https://wallenwang.com/2018/11/tcmalloc/" target="_blank" rel="noopener">TCMalloc解密</a>》，图片版权归原作者所有。</em></strong></p>
<h3 id="精彩文章推荐"><a href="#精彩文章推荐" class="headerlink" title="精彩文章推荐"></a>精彩文章推荐</h3><p>本文对于TCMalloc的介绍并不多，<strong>重要的是3个快速分配内存的层次</strong>，如果想了解更多，可阅读下面文章。</p>
<ol>
<li><a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html" target="_blank" rel="noopener">TCMalloc</a><br><strong>必读</strong>，通过这篇你能掌握TCMalloc的原理和性能，对掌握Go的内存管理有非常大的帮助，虽然如今Go的内存管理与TCMalloc已经相差很大，但是，这是<strong>Go内存管理的起源和“大道”</strong>，这篇文章顶看十几篇Go内存管理的文章。</li>
<li><a href="https://wallenwang.com/2018/11/tcmalloc/" target="_blank" rel="noopener">TCMalloc解密</a><br><strong>可选</strong>，<strong>异常详细，包含大量精美图片</strong>，看完得花小时级别，理解就需要更多时间了，看完这篇不需要看其他TCMalloc的文章了。</li>
<li><a href="https://blog.csdn.net/aaronjzhang/article/details/8696212" target="_blank" rel="noopener">TCMalloc介绍</a><br><strong>可选</strong>，算是TCMalloc的文档的中文版，多数是从英文版翻译过来的，如果你英文不好，看看。</li>
</ol>
<h2 id="3-Go内存管理"><a href="#3-Go内存管理" class="headerlink" title="3. Go内存管理"></a>3. Go内存管理</h2><p>前面铺垫了那么多，终于到了本文核心的地方。前面的铺垫不是不重要，相反它们很重要，Go语言内存管理源自前面的基础知识和内存管理思维，如果你跳过了前面的内容，建议你回头看一看，它可以帮助你更好的掌握Go内存管理。</p>
<p>前文提到<strong>Go内存管理源自<a href="#TCMalloc">TCMalloc</a>，但它比TCMalloc还多了2件东西：逃逸分析和垃圾回收</strong>，这是2项提高生产力的绝佳武器。</p>
<p>这一大章节，我们先介绍Go内存管理和Go内存分配，最后涉及一点垃圾回收和内存释放。</p>
<h3 id="Go内存管理的基本概念"><a href="#Go内存管理的基本概念" class="headerlink" title="Go内存管理的基本概念"></a>Go内存管理的基本概念</h3><p>前面计算机基础知识回顾，是一种自上而下，从宏观到微观的介绍方式，把目光引入到今天的主题。</p>
<p>Go内存管理的许多概念在TCMalloc中已经有了，含义是相同的，只是名字有一些变化。先给大家上一幅宏观的图，借助图一起来介绍。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-memory-detail.png" alt="Go内存管理"></p>
<h4 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h4><p>与TCMalloc中的Page相同，x64下1个Page的大小是8KB。上图的最下方，1个浅蓝色的长方形代表1个Page。</p>
<h4 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h4><p>与TCMalloc中的Span相同，<strong>Span是内存管理的基本单位</strong>，代码中为<code>mspan</code>，<strong>一组连续的Page组成1个Span</strong>，所以上图一组连续的浅蓝色长方形代表的是一组Page组成的1个Span，另外，1个淡紫色长方形为1个Span。</p>
<h4 id="mcache"><a href="#mcache" class="headerlink" title="mcache"></a>mcache</h4><p>mcache与TCMalloc中的ThreadCache类似，<strong>mcache保存的是各种大小的Span，并按Span class分类，小对象直接从mcache分配内存，它起到了缓存的作用，并且可以无锁访问</strong>。</p>
<p>但mcache与ThreadCache也有不同点，TCMalloc中是每个线程1个ThreadCache，Go中是<strong>每个P拥有1个mcache</strong>，因为在Go程序中，当前最多有GOMAXPROCS个线程在用户态运行，所以最多需要GOMAXPROCS个mcache就可以保证各线程对mcache的无锁访问，线程的运行又是与P绑定的，把mcache交给P刚刚好。</p>
<h4 id="mcentral"><a href="#mcentral" class="headerlink" title="mcentral"></a>mcentral</h4><p>mcentral与TCMalloc中的CentralCache类似，<strong>是所有线程共享的缓存，需要加锁访问</strong>，它按Span class对Span分类，串联成链表，当mcache的某个级别Span的内存被分配光时，它会向mcentral申请1个当前级别的Span。</p>
<p>但mcentral与CentralCache也有不同点，CentralCache是每个级别的Span有1个链表，mcache是每个级别的Span有2个链表，这和mcache申请内存有关，稍后我们再解释。</p>
<h4 id="mheap"><a href="#mheap" class="headerlink" title="mheap"></a>mheap</h4><p>mheap与TCMalloc中的PageHeap类似，<strong>它是堆内存的抽象，把从OS申请出的内存页组织成Span，并保存起来</strong>。当mcentral的Span不够用时会向mheap申请，mheap的Span不够用时会向OS申请，向OS的内存申请是按页来的，然后把申请来的内存页生成Span组织起来，同样也是需要加锁访问的。</p>
<p>但mheap与PageHeap也有不同点：mheap把Span组织成了树结构，而不是链表，并且还是2棵树，然后把Span分配到heapArena进行管理，它包含地址映射和span是否包含指针等位图，这样做的主要原因是为了更高效的利用内存：分配、回收和再利用。</p>
<h4 id="大小转换"><a href="#大小转换" class="headerlink" title="大小转换"></a>大小转换</h4><p>除了以上内存块组织概念，还有几个重要的大小概念，一定要拿出来讲一下，不要忽视他们的重要性，他们是内存分配、组织和地址转换的基础。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-memory-sizes.png" alt="Go内存大小转换"></p>
<ol>
<li><strong>object size</strong>：代码里简称<code>size</code>，指申请内存的对象大小。</li>
<li><strong>size class</strong>：代码里简称<code>class</code>，它是size的级别，相当于把size归类到一定大小的区间段，比如size[1,8]属于size class 1，size(8,16]属于size class 2。</li>
<li><strong>span class</strong>：指span的级别，但span class的大小与span的大小并没有正比关系。span class主要用来和size class做对应，1个size class对应2个span class，2个span class的span大小相同，只是功能不同，1个用来存放包含指针的对象，一个用来存放不包含指针的对象，不包含指针对象的Span就无需GC扫描了。</li>
<li><strong>num of page</strong>：代码里简称<code>npage</code>，代表Page的数量，其实就是Span包含的页数，用来分配内存。</li>
</ol>
<p>在介绍这几个大小之间的换算前，我们得先看下图这个表，这个表决定了映射关系。</p>
<p>最上面2行是我手动加的，前3列分别是size class，object size和span size，根据这3列做size、size class和num of page之间的转换。</p>
<p>仔细看一遍这个表，再向下看转换是如何实现的。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-sizetable.png" alt="Go内存分配表"></p>
<p>在Go内存大小转换那幅图中已经标记各大小之间的转换，分别是数组：<code>class_to_size</code>，<code>size_to_class*</code>和<code>class_to_allocnpages</code>，这3个数组内容，就是跟上表的映射关系匹配的。比如<code>class_to_size</code>，从上表看class 1对应的保存对象大小为8，所以<code>class_to_size[1]=8</code>，span大小为8192Byte，即8KB，为1页，所以<code>class_to_allocnpages[1]=1</code>。</p>
<p><img src="http://img.lessisbetter.site/2019-07-size_tranform.png" alt="Size转换"></p>
<p><strong>为何不使用函数计算各种转换，而是写成数组？</strong></p>
<p>有1个很重要的原因：<strong>空间换时间</strong>。你如果仔细观察了，上表中的转换，并不能通过简单的公式进行转换，比如size和size class的关系，并不是正比的。这些数据是使用较复杂的公式计算出来的，公式在<code>makesizeclass.go</code>中，这其中存在指数运算与for循环，造成每次大小转换的时间复杂度为O(N*2^N)。另外，对一个程序而言，内存的申请和管理操作是很多的，如果不能快速完成，就是非常的低效。把以上大小转换写死到数组里，做到了把大小转换的时间复杂度直接降到O(1)。</p>
<h4 id="其他转换表字段"><a href="#其他转换表字段" class="headerlink" title="其他转换表字段"></a>其他转换表字段</h4><p>第4列num of objects代表是当前size class级别的Span可以保存多少对象数量，第5列tail waste是<code>span%obj</code>计算的结果，因为span的大小并不一定是对象大小的整数倍。</p>
<p>最后一列max waste代表最大浪费的内存百分比，计算方法在<code>printComment</code>函数中:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printComment</span><span class="params">(w io.Writer, classes []class)</span></span> &#123;</span><br><span class="line">	fmt.Fprintf(w, <span class="string">"// %-5s  %-9s  %-10s  %-7s  %-10s  %-9s\n"</span>, <span class="string">"class"</span>, <span class="string">"bytes/obj"</span>, <span class="string">"bytes/span"</span>, <span class="string">"objects"</span>, <span class="string">"tail waste"</span>, <span class="string">"max waste"</span>)</span><br><span class="line">	prevSize := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> classes &#123;</span><br><span class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		spanSize := c.npages * pageSize</span><br><span class="line">		objects := spanSize / c.size</span><br><span class="line">		tailWaste := spanSize - c.size*(spanSize/c.size)</span><br><span class="line">		maxWaste := <span class="keyword">float64</span>((c.size-prevSize<span class="number">-1</span>)*objects+tailWaste) / <span class="keyword">float64</span>(spanSize)</span><br><span class="line">		prevSize = c.size</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"// %5d  %9d  %10d  %7d  %10d  %8.2f%%\n"</span>, i, c.size, spanSize, objects, tailWaste, <span class="number">100</span>*maxWaste)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Fprintf(w, <span class="string">"\n"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Span最浪费内存的场景是：Span内的每一个对象空间保存的对象，实际占用内存是前一个class中对象的大小加1，这样无法占用低一级的Span。一个对象空间未被占用的内存就被浪费了，所以一个Span内对象空间所浪费的内存为：所有对象空间浪费的内存之和+tail waste。</p>
<blockquote>
<p>((c.size - (preSize+1)) * objects + tailWaste) / spanSize</p>
</blockquote>
<p><img src="http://img.lessisbetter.site/2019-07-span-objects.png" alt="Span内object分布情况"></p>
<blockquote>
<p>感谢<a href="https://github.com/foobar" target="_blank" rel="noopener">foobar</a>的提醒max waste的计算。</p>
</blockquote>
<h3 id="Go内存分配"><a href="#Go内存分配" class="headerlink" title="Go内存分配"></a>Go内存分配</h3><p>涉及的概念已经讲完了，我们看下Go内存分配原理。</p>
<p>Go中的内存分类并不像TCMalloc那样分成小、中、大对象，但是它的小对象里又细分了一个Tiny对象，Tiny对象指大小在1Byte到16Byte之间并且不包含指针的对象。小对象和大对象只用大小划定，无其他区分。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-memory-classify.png" alt="Go内存对象分类"></p>
<p>小对象是在mcache中分配的，而大对象是直接从mheap分配的，从小对象的内存分配看起。</p>
<h4 id="小对象分配"><a href="#小对象分配" class="headerlink" title="小对象分配"></a>小对象分配</h4><p><img src="http://img.lessisbetter.site/2019-07-go-memory-detail.png" alt="Go内存管理"></p>
<p><a href="#大小转换">大小转换</a>这一小节，我们介绍了转换表，size class从1到66共66个，代码中<code>_NumSizeClasses=67</code>代表了实际使用的size class数量，即67个，从0到67，size class 0实际并未使用到。</p>
<p>上文提到1个size class对应2个span class：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numSpanClasses = _NumSizeClasses * <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p><code>numSpanClasses</code>为span class的数量为134个，所以span class的下标是从0到133，所以上图中mcache标注了的span class是，<code>span class 0</code>到<code>span class 133</code>。每1个span class都指向1个span，也就是mcache最多有134个span。</p>
<h5 id="为对象寻找span"><a href="#为对象寻找span" class="headerlink" title="为对象寻找span"></a>为对象寻找span</h5><p>寻找span的流程如下：</p>
<ol>
<li>计算对象所需内存大小size </li>
<li>根据size到size class映射，计算出所需的size class</li>
<li>根据size class和对象是否包含指针计算出span class</li>
<li>获取该span class指向的span。</li>
</ol>
<p>以分配一个不包含指针的，大小为24Byte的对象为例。</p>
<p>根据映射表：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class  bytes/obj  bytes/span  objects  tail waste  max waste</span></span><br><span class="line"><span class="comment">//     1          8        8192     1024           0     87.50%</span></span><br><span class="line"><span class="comment">//     2         16        8192      512           0     43.75%</span></span><br><span class="line"><span class="comment">//     3         32        8192      256           0     46.88%</span></span><br><span class="line"><span class="comment">//     4         48        8192      170          32     31.52%</span></span><br></pre></td></tr></table></figure>
<p>size class 3，它的对象大小范围是(16,32]Byte，24Byte刚好在此区间，所以此对象的size class为3。</p>
<p>Size class到span class的计算如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// noscan为true代表对象不包含指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeSpanClass</span><span class="params">(sizeclass <span class="keyword">uint8</span>, noscan <span class="keyword">bool</span>)</span> <span class="title">spanClass</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> spanClass(sizeclass&lt;&lt;<span class="number">1</span>) | spanClass(bool2int(noscan))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，对应的span class为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">span class = <span class="number">3</span> &lt;&lt; <span class="number">1</span> | <span class="number">1</span> = <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>所以该对象需要的是span class 7指向的span。</p>
<h5 id="从span分配对象空间"><a href="#从span分配对象空间" class="headerlink" title="从span分配对象空间"></a>从span分配对象空间</h5><p>Span可以按对象大小切成很多份，这些都可以从映射表上计算出来，以size class 3对应的span为例，span大小是8KB，每个对象实际所占空间为32Byte，这个span就被分成了256块，可以根据span的起始地址计算出每个对象块的内存地址。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-memory-objs.png" alt="Span内对象"></p>
<p>随着内存的分配，span中的对象内存块，有些被占用，有些未被占用，比如上图，整体代表1个span，蓝色块代表已被占用内存，绿色块代表未被占用内存。</p>
<p>当分配内存时，只要快速找到第一个可用的绿色块，并计算出内存地址即可，如果需要还可以对内存块数据清零。</p>
<h5 id="span没有空间怎么分配对象"><a href="#span没有空间怎么分配对象" class="headerlink" title="span没有空间怎么分配对象"></a>span没有空间怎么分配对象</h5><p>span内的所有内存块都被占用时，没有剩余空间继续分配对象，mcache会向mcentral申请1个span，mcache拿到span后继续分配对象。</p>
<h5 id="mcentral向mcache提供span"><a href="#mcentral向mcache提供span" class="headerlink" title="mcentral向mcache提供span"></a>mcentral向mcache提供span</h5><p>mcentral和mcache一样，都是0~133这134个span class级别，但每个级别都保存了2个span list，即2个span链表：</p>
<ol>
<li><code>nonempty</code>：这个链表里的span，所有span都至少有1个空闲的对象空间。这些span是mcache释放span时加入到该链表的。</li>
<li><code>empty</code>：这个链表里的span，所有的span都不确定里面是否有空闲的对象空间。当一个span交给mcache的时候，就会加入到empty链表。</li>
</ol>
<p>这2个东西名称一直有点绕，建议直接把empty理解为没有对象空间就好了。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-mcentral.png" alt="mcentral"></p>
<p><em>实际代码中每1个span class对应1个mcentral，图里把所有mcentral抽象成1个整体了。</em></p>
<p>mcache向mcentral要span时，mcentral会先从<code>nonempty</code>搜索满足条件的span，如果每找到再从<code>emtpy</code>搜索满足条件的span，然后把找到的span交给mcache。</p>
<h5 id="mheap的span管理"><a href="#mheap的span管理" class="headerlink" title="mheap的span管理"></a>mheap的span管理</h5><p>mheap里保存了2棵<strong>二叉排序树</strong>，按span的page数量进行排序：</p>
<ol>
<li><code>free</code>：free中保存的span是空闲并且非垃圾回收的span。</li>
<li><code>scav</code>：scav中保存的是空闲并且已经垃圾回收的span。</li>
</ol>
<p>如果是垃圾回收导致的span释放，span会被加入到<code>scav</code>，否则加入到<code>free</code>，比如刚从OS申请的的内存也组成的Span。</p>
<p><img src="http://img.lessisbetter.site/2019-07-go-mheap.png" alt="mheap"></p>
<p>mheap中还有arenas，有一组heapArena组成，每一个heapArena都包含了连续的<code>pagesPerArena</code>个span，这个主要是为mheap管理span和垃圾回收服务。</p>
<p>mheap本身是一个全局变量，它其中的数据，也都是从OS直接申请来的内存，并不在mheap所管理的那部分内存内。</p>
<h5 id="mcentral向mheap要span"><a href="#mcentral向mheap要span" class="headerlink" title="mcentral向mheap要span"></a>mcentral向mheap要span</h5><p>mcentral向mcache提供span时，如果<code>emtpy</code>里也没有符合条件的span，mcentral会向mheap申请span。</p>
<p>mcentral需要向mheap提供需要的内存页数和span class级别，然后它优先从<code>free</code>中搜索可用的span，如果没有找到，会从<code>scav</code>中搜索可用的span，如果还没有找到，它会向OS申请内存，再重新搜索2棵树，必然能找到span。如果找到的span比需求的span大，则把span进行分割成2个span，其中1个刚好是需求大小，把剩下的span再加入到<code>free</code>中去，然后设置需求span的基本信息，然后交给mcentral。</p>
<h5 id="mheap向OS申请内存"><a href="#mheap向OS申请内存" class="headerlink" title="mheap向OS申请内存"></a>mheap向OS申请内存</h5><p>当mheap没有足够的内存时，mheap会向OS申请内存，把申请的内存页保存到span，然后把span插入到<code>free</code>树 。</p>
<p>在32位系统上，mheap还会预留一部分空间，当mheap没有空间时，先从预留空间申请，如果预留空间内存也没有了，才向OS申请。</p>
<h4 id="大对象分配"><a href="#大对象分配" class="headerlink" title="大对象分配"></a>大对象分配</h4><p>大对象的分配比小对象省事多了，99%的流程与mcentral向mheap申请内存的相同，所以不重复介绍了，不同的一点在于mheap会记录一点大对象的统计信息，见<code>mheap.alloc_m()</code>。</p>
<h3 id="Go垃圾回收和内存释放"><a href="#Go垃圾回收和内存释放" class="headerlink" title="Go垃圾回收和内存释放"></a>Go垃圾回收和内存释放</h3><p>如果只申请和分配内存，内存终将枯竭，Go使用垃圾回收收集不再使用的span，调用<code>mspan.scavenge()</code>把span释放给OS（并非真释放，只是告诉OS这片内存的信息无用了，如果你需要的话，收回去好了），然后交给mheap，mheap对span进行span的合并，把合并后的span加入<code>scav</code>树中，等待再分配内存时，由mheap进行内存再分配，Go垃圾回收也是一个很强的主题，计划后面单独写一篇文章介绍。</p>
<p>现在我们关注一下，Go程序是怎么把内存释放给操作系统的？</p>
<p>释放内存的函数是<code>sysUnused</code>，它会被<code>mspan.scavenge()</code>调用:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MAC下的实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysUnused</span><span class="params">(v unsafe.Pointer, n <span class="keyword">uintptr</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// MADV_FREE_REUSABLE is like MADV_FREE except it also propagates</span></span><br><span class="line">	<span class="comment">// accounting information about the process to task_info.</span></span><br><span class="line">	madvise(v, n, _MADV_FREE_REUSABLE)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释说<code>_MADV_FREE_REUSABLE</code>与<code>MADV_FREE</code>的功能类似，它的功能是给内核提供一个建议：<strong>这个内存地址区间的内存已经不再使用，可以回收。但内核是否回收，以及什么时候回收，这就是内核的事情了</strong>。如果内核真把这片内存回收了，当Go程序再使用这个地址时，内核会重新进行虚拟地址到物理地址的映射。所以在内存充足的情况下，内核也没有必要立刻回收内存。</p>
<h2 id="4-Go栈内存"><a href="#4-Go栈内存" class="headerlink" title="4. Go栈内存"></a>4. Go栈内存</h2><p>最后提一下栈内存。从一个宏观的角度看，内存管理不应当只有堆，也应当有栈。</p>
<p>每个goroutine都有自己的栈，栈的初始大小是2KB，100万的goroutine会占用2G，但goroutine的栈会在2KB不够用时自动扩容，当扩容为4KB的时候，百万goroutine会占用4GB。</p>
<p>关于goroutine栈内存管理，有篇很好的文章，饿了么框架技术部的专栏文章：《<a href="https://zhuanlan.zhihu.com/p/28409657" target="_blank" rel="noopener">聊一聊goroutine stack</a>》，把里面的一段内容摘录下，你感受下：</p>
<blockquote>
<p>可以看到在rpc调用(<em>grpc invoke</em>)时，栈会发生扩容(<em>runtime.morestack</em>)，也就意味着在读写routine内的任何rpc调用都会导致栈扩容， 占用的内存空间会扩大为原来的两倍，4kB的栈会变为8kB，100w的连接的内存占用会从8G扩大为16G（全双工，不考虑其他开销），这简直是噩梦。</p>
</blockquote>
<p>另外，再推荐一篇曹大翻译的一篇汇编入门文章，里面也介绍了扩栈：<a href="https://github.com/go-internals-cn/go-internals/blob/master/chapter1_assembly_primer/README.md#%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B-%E6%A0%88%E5%8F%8A%E6%A0%88%E5%88%86%E8%A3%82" target="_blank" rel="noopener">第一章: Go 汇编入门</a> ，顺便<strong>入门</strong>一下汇编。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>内存分配原理就不再回顾了，强调2个重要的思想：</p>
<ol>
<li><strong>使用缓存提高效率</strong>。在存储的整个体系中到处可见缓存的思想，Go内存分配和管理也使用了缓存，利用缓存一是减少了系统调用的次数，二是降低了锁的粒度，减少加锁的次数，从这2点提高了内存管理效率。</li>
<li><strong>以空间换时间，提高内存管理效率</strong>。空间换时间是一种常用的性能优化思想，这种思想其实非常普遍，比如Hash、Map、二叉排序树等数据结构的本质就是空间换时间，在数据库中也很常见，比如数据库索引、索引视图和数据缓存等，再如Redis等缓存数据库也是空间换时间的思想。</li>
</ol>
<h2 id="6-参考资料"><a href="#6-参考资料" class="headerlink" title="6. 参考资料"></a>6. 参考资料</h2><p>除了文章中已经推荐的文章，再推荐几篇值得读的文章：</p>
<ol>
<li>全成的内存分配文章，有不少帮助：<a href="https://juejin.im/post/5c888a79e51d456ed11955a8#heading-5" target="_blank" rel="noopener">https://juejin.im/post/5c888a79e51d456ed11955a8#heading-5</a></li>
<li>异常详细的源码分析文章，看完这篇我就不想写源码分析的文章了：<a href="https://www.cnblogs.com/zkweb/p/7880099.html" target="_blank" rel="noopener">https://www.cnblogs.com/zkweb/p/7880099.html</a></li>
<li>从硬件讲起的一篇文章，也是有点意思：<a href="https://www.infoq.cn/article/IEhRLwmmIM7-11RYaLHR" target="_blank" rel="noopener">https://www.infoq.cn/article/IEhRLwmmIM7-11RYaLHR</a></li>
<li>这篇文章的总流程图很棒：<a href="http://media.newbmiao.com/blog/malloc.png" target="_blank" rel="noopener">http://media.newbmiao.com/blog/malloc.png</a></li>
</ol>
<h2 id="7-彩蛋"><a href="#7-彩蛋" class="headerlink" title="7. 彩蛋"></a>7. 彩蛋</h2><p>在查阅资料时，多篇文章都提到了这本书《<a href="http://man7.org/tlpi/" target="_blank" rel="noopener">The Linux Programming Interface</a>》，关于Thread Cache有兴趣去读一下本书第31章。</p>
<hr>
<blockquote>
<ol>
<li>如果这篇文章对你有帮助，不妨关注下我的Github，有文章会收到通知。</li>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/07/06/go-memory-allocation/">http://lessisbetter.site/2019/07/06/go-memory-allocation/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/06/09/golang-first-class-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/09/golang-first-class-function/" class="post-title-link" itemprop="url">First class function in Go</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-09 22:00:26" itemprop="dateCreated datePublished" datetime="2019-06-09T22:00:26+08:00">2019-06-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://img.lessisbetter.site/2019-06-09-photo.jpeg" alt="合照"></p>
<p>6月2日Go语言中文网在杭州举办了线下的MeetUp活动，这次活动办很成功，感谢站长polaris在杭州举办活动的提议，感谢Seekload的筹备与主持，感谢Aaron提供场地，感谢所有到场者的技术经验分享，没有你们就没有这次精彩的活动。</p>
<p>在活动上，我做了个主题分享，今天把分享整理成文章，分享给学习Go语言的各位朋友。</p>
<p>参加本次活动的朋友，大多是刚接触Go，少数几个朋友把玩Go 2~3年了，所以我把主题定位到能让所有人听懂的主题。另外，大家所处行业各有不同，这就要求专注介绍Go本身的特性，这才是大家通用的地方。</p>
<p>最后选题为First class function in Go，这次没有做中文翻译，避免翻译后有误解。这个特性浅显易懂，但掌握Go语言的思维，才能把它用好。</p>
<p>线下分享后，证明选题选对了，大家都能听懂，所以现在不了解First class function的朋友不用着急，后面我会层层推进的方式介绍，相信你一定能理解，那就进入正文吧。</p>
<h1 id="First-class-function-in-Go"><a href="#First-class-function-in-Go" class="headerlink" title="First class function in Go"></a>First class function in Go</h1><h2 id="概念介绍"><a href="#概念介绍" class="headerlink" title="概念介绍"></a>概念介绍</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片04.png" alt="幻灯片04"></p>
<p>某个编程语言拥有First class function特性指可以把函数作为变量对待。也就说，函数与变量没有差别，它们是一样的，变量出现的地方都可以替换成函数，并且编译也是可以通过的，没有任何语法问题。</p>
<p>在Go里，变量可以存在于哪些地方？</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片05.png" alt="幻灯片05"></p>
<p>变量可以被声明、定义，可以使用<code>type</code>创建变量的类型，可以作为函数的入参和返回值，可以存在<code>slice</code>, <code>array</code>, <code>map</code>等数据结构里，可以被动态的创建。</p>
<p>在Go中，函数也可以被声明、定义，可以使用<code>type</code>创建一个函数类型，可以作为其他函数的入参和返回值，可以保存在其他类型的数据结构里，最后，函数是可以被动态创建的。</p>
<p>简要归类一下就是下图的样子，除了上面提到的内容，还有匿名函数和闭包，将按下图顺序介绍每一个小特性。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片06.png" alt="幻灯片06"></p>
<h2 id="定义函数类型"><a href="#定义函数类型" class="headerlink" title="定义函数类型"></a>定义函数类型</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片07.png" alt="幻灯片07"></p>
<p>使用<code>type</code>定义一个函数类型，<code>type</code>后是类型名称，本例中是<code>Operation</code>，再后面是类型的定义，对于函数而言，被称为signature，即函数签名，这个函数签名表示：Operation类型的函数，它以2个int类型为入参，以1个int为返回值。所有满足该函数签名的函数，都是Operation类型的函数。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片08.png" alt="幻灯片08"></p>
<p>函数<code>Add</code>和<code>Sub</code>都符合<code>Operation</code>的签名，所以<code>Add</code>和<code>Sub</code>都是<code>Operation</code>类型。</p>
<h2 id="声明函数类型的变量和为变量赋值"><a href="#声明函数类型的变量和为变量赋值" class="headerlink" title="声明函数类型的变量和为变量赋值"></a>声明函数类型的变量和为变量赋值</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片09.png" alt="幻灯片09"></p>
<p>变量<code>op</code>是<code>Operation</code>类型的，可以把<code>Add</code>作为值赋值给变量<code>op</code>，执行<code>op</code>等价于执行<code>Add</code>。</p>
<h2 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h2><p>高阶函数分为函数作为入参和函数作为返回值2部分。</p>
<h3 id="函数作为其他函数入参"><a href="#函数作为其他函数入参" class="headerlink" title="函数作为其他函数入参"></a>函数作为其他函数入参</h3><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片10.png" alt="幻灯片10"></p>
<p>定义一个<code>Calculator</code>结构体，它始终保持计算后的结果。</p>
<p>它有一个方法<code>Do</code>，入参为一个<code>Operation</code>类型的函数<code>op</code>和1个<code>int</code>类型的变量a，使用计算器的值<code>c.v</code>和<code>a</code>作为<code>op</code>的入参，进行指定运算，并把结果保存会<code>c.v</code>。</p>
<p><code>main</code>中，声明了一个变量<code>calc</code>，<code>calc.v</code>初始值为0，然后运行了加1和减2的操作，加减法的完成使用的我们之前定义的函数<code>Add</code>和<code>Sub</code>。操作等价于：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">calc.v = Add(calc.v, <span class="number">1</span>)</span><br><span class="line">calc.v = Sub(calc.v, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h3 id="函数作为返回值-动态创建"><a href="#函数作为返回值-动态创建" class="headerlink" title="函数作为返回值+动态创建"></a>函数作为返回值+动态创建</h3><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片11.png" alt="幻灯片11"></p>
<p>这次，改变<code>Operation</code>的定义，修改为接收1个<code>int</code>类型的入参，返回1个<code>int</code>类型的返回值。</p>
<p>同时修改函数<code>Add</code>和<code>Sub</code>，它们接收1个<code>int</code>类型的入参，返回1个<code>Operation</code>类型的函数，这个函数是动态创建出来的。</p>
<p>以<code>Add</code>为例介绍，在<code>Add</code>里动态创建了一个函数，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数实现了在变量a基础上加b的操作，并返回结果，我们把这个函数赋值给<strong>变量<code>addB</code></strong>，把<code>addB</code>作为返回值返回。</p>
<p>所以本例实现了以函数作为返回值和动态创建函数。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片12.png" alt="幻灯片12"></p>
<p><code>Operation</code>，<code>Add</code>和<code>Sub</code>修改后，<code>Calculator</code>也要同步修改，方法<code>Do</code>修改为只接收<code>Operation</code>类型的函数。</p>
<p><code>main</code>函数里，注意<code>Do</code>的入参：<code>Add(1)</code>，它实现的效果是，创建了1个函数，该函数接收1个值，然后把这个值+1返回，如果用数学表示就是这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add(1)</span></span><br><span class="line">add1(x) = x + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>同理，<code>Sub(2)</code>的数学表示如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sub(2)</span></span><br><span class="line">sub2(x) = x - <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>所以2次<code>Do</code>操作等价于：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calc.Do(Add(1))</span></span><br><span class="line">calc.v = add1(calc.v)</span><br><span class="line"><span class="comment">// calc.Do(Sub(2))</span></span><br><span class="line">calc.v = sub2(calc.v)</span><br></pre></td></tr></table></figure>
<h2 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片13.png" alt="幻灯片13"></p>
<p>上图左边是普通函数，<code>func</code>后为函数名，然后为函数签名。右边只有<code>func</code>和函数签名，缺少函数名，右边的情况为匿名函数。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片14.png" alt="幻灯片14"></p>
<p>以<code>Add</code>函数其中定义的函数为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是1个匿名函数，它没有名字。<strong><code>addB</code>并不是函数的名字，只是1个变量名而已，只不过这个变量名的类型是没有显示定义出来的</strong>。</p>
<p><code>Add</code>通常简写为右边的形式。</p>
<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片15.png" alt="幻灯片15"></p>
<p>很多人搞不清什么是匿名函数，什么是闭包，所以这里分开介绍这2个概念。</p>
<p><strong>闭包指有权访问另一个函数作用域中的变量的函数</strong>。大白话就是，可以创建1个函数，它可以访问其他函数遍历，但不需要传值。</p>
<p>仍然是<code>Add</code>函数为例，比如匿名函数里直接使用了变量b，该匿名函数也是闭包函数。</p>
<p>闭包的特性注定了，闭包函数要定义在一个函数里面，定义在一个函数里面又只能是匿名函数。</p>
<p><strong>那，匿名函数和闭包是不是就等价了？</strong></p>
<p><strong>No，一个函数可以是匿名函数，但不是闭包函数，因为闭包有时是有副作用的。</strong></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片16.png" alt="幻灯片16"></p>
<p>我们想并发的把sl中的值打印出来，结果为何会是右边这样？</p>
<p>因为并发的匿名函数，使用的是<code>test1</code>中的<code>i,v</code>，即这是闭包函数，所有的goroutine都共享这2个值，并且启动1个goroutine后，这2个值变为下一个位置的值。你运行的结果也许不是9 9 9….，因为这个goroutine的调度有关。</p>
<p>如何才能符合预期的打印？只使用匿名函数进行传值，不使用闭包。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片17.png" alt="幻灯片17"></p>
<h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><p>接下来以一个实际的场景，和3种实现版本看如何用Go的思维去解决问题。</p>
<h2 id="场景介绍"><a href="#场景介绍" class="headerlink" title="场景介绍"></a>场景介绍</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片19.png" alt="幻灯片19"></p>
<p>做Go语言工作，尤其是跟网络打交道的工作，连接管理是逃不开的。我做区块链相关的技术工作，区块链中也有网络管理，所以我就以区块链的网络管理为场景进行介绍，但不涉及具体的技术细节，大家莫慌，只需要理解2个概念就行。</p>
<p>区块链是构建在P2P网络之上，在P2P网络中：</p>
<ol>
<li>一个节点即可以是服务器也可以是客户端，被称为<strong>Host</strong>，</li>
<li>和本节点连接的所有节点都被称为<strong>Peer</strong>。</li>
</ol>
<p><strong>具体的场景是：Host需要保存所有建立连接的Peer，并对这些Peer进行维护：增加和删除Peer，并且提供Peer的查询和向所有Peer广播消息的接口</strong>。</p>
<p>针对这个问题场景，我写了3个版本的Demo，我们依次来介绍，再看的时候，可以思考其中的不同。</p>
<h2 id="版本1"><a href="#版本1" class="headerlink" title="版本1"></a>版本1</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片20.png" alt="幻灯片20"></p>
<p>先看<code>Peer</code>定义，<code>Peer</code>中保存了<code>ID</code>，我们可以通过<code>ID</code>来表示全网中所有的节点，<code>Peer</code>中还有其他字段，比如网络连接、地址、协议版本等信息，此处已经省略掉。</p>
<p><code>Peer</code>有一个<code>WriteMsg</code>的方法，实现向该<code>Peer</code>发送消息的功能，例子中使用打印替代。</p>
<p><strong>Peer的定义在3个版本中都不会发生变化，所以后面就不再展示</strong>。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片21.png" alt="幻灯片21"></p>
<p><code>Host</code>通过<code>peers</code>保存了所有连接的Peer，可以通过<code>Peer.ID</code>对Peer进行索引。Peer的管理是并发场景，比如，我们可能同时接收到多个Peer的连接，又同时需要向所有Peer广播消息，需要对<code>peers</code>加锁保护。最后，我们省略了<code>Host</code>的其他字段。</p>
<p><code>NewHost()</code>用来创建一个<code>Host</code>对象，用来代表当前节点。</p>
<p><em>友情提醒：<code>Host</code>在每一个版本都会不同。</em></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片22.png" alt="幻灯片22"></p>
<p><code>Host</code>有4个方法，分别是：</p>
<ol>
<li><code>AddPeer</code>: 增加1个Peer。</li>
<li><code>RemovePeer</code>: 删除1个Peer。</li>
<li><code>GetPeer</code>: 通过Peer.ID查询1个Peer。</li>
<li><code>BroadcastMsg</code>: 向所有Peer发送消息。</li>
</ol>
<p>每一个方法都需要获取<code>lock</code>，然后访问<code>peers</code>，如果只读取<code>peers</code>则使用读锁。</p>
<p><strong>第1个版本已经介绍完了，大家可以思考一下版本1的缺点。</strong></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片23.png" alt="幻灯片23"></p>
<p>第1个版本跟其他语言实现其实没有本质区别，用C++、Java等也能写出上面逻辑的代码，只不过这个是Go语言实现的罢了。</p>
<p><strong>这个版本是一个communicate by sharing memory的体现</strong>，具体来讲，每个goroutine都是1个实体，它们同时运行，调用<code>Host</code>的不同方法来访问<code>peers</code>，只有拿到当前<code>lock</code>的goroutine才能访问peers，仿佛当前goroutine在同其他goroutine讲：我现在有访问权，你们等一下。本质上就是，通过共享<code>Host.lock</code>这块内存，各goroutine进行交流（表明自己拥有访问权）。</p>
<h2 id="版本2"><a href="#版本2" class="headerlink" title="版本2"></a>版本2</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片24.png" alt="幻灯片24"></p>
<p>很多Go老手都听过这句话了，这是Go的“联合创始人”<strong>Rob Pike</strong>某个会议上说的。</p>
<p><strong>在Go中，推荐使用CSP实现并发，而不是习惯性的使用Lock，使用channel传递数据，达到多goroutine间共享数据的目的，也就是share memory by communicating</strong>。</p>
<p>所以，我们版本2，就使用channel的方式，来实现Peer的管理。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片25.png" alt="幻灯片25"></p>
<p>在版本1中，<code>peers</code>是大家都想访问的，并且Host有4个方法，画到了上面的图中，我们看下怎么用CSP实现。</p>
<p><code>peers</code>需要在单独的goroutine中，其他的4个方法在其他的goroutine中调用，它们之间进行通信。</p>
<p>我对使用CSP有一个好的实践，就是把数据流动画出来，并把要流动的数据标上，然后那些数据流动的线条，就是channel，线条上的数据就是channel要传递的数据，图中也把这些线条和数据标上了。具体的细节，可以识别图片中的二维码，看看这篇老文，还有就是并不是所有的并发场景都适合使用channel，有些用锁更好，这篇文章也有介绍。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片26.png" alt="幻灯片26"></p>
<p>重新定义Host，增加了4个channel，从上到下分别用于增加Peer、广播消息、删除Peer和停止Host。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片27.png" alt="幻灯片27"></p>
<p>Host增加了2个方法：</p>
<ol>
<li><code>Start()</code>用于启动1个goroutine运行<code>loop()</code>，<code>loop</code>保存所有的<code>peers</code>。</li>
<li><code>Stop()</code>用于关闭Host，让<code>loop</code>退出。</li>
</ol>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片28.png" alt="幻灯片28"></p>
<p>左边是<code>loop()</code>的实现，它从4个channel里接收数据，然后做不同的操作。</p>
<p>右边是<code>AddPeer</code>， <code>RemovePeer</code>, <code>BroadcastMsg</code>的实现。</p>
<p>利用1分钟的事件，左右两边对照着看，理解增加1个Peer的全过程。</p>
<p>这就是版本2的全部实现了，思考一下版本2有什么问题，原因是啥？</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片29.png" alt="幻灯片29"></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片30.png" alt="幻灯片30"></p>
<p>问题就是我们没有实现<code>GetPeer</code>这个方法，聪明的你一定在Host的定义就发现了，只有增加、删除和广播消息的channel。</p>
<p><strong>没能实现<code>GetPeer</code>的原因下图中进行了介绍，你有没有解决办法？</strong></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片31.png" alt="幻灯片31"></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片32.png" alt="幻灯片32"></p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片33.png" alt="幻灯片33"></p>
<p>可能会有很多goroutine调用<code>GetPeer</code>，我们需要向每一个goroutine发送结果，这就需要每一个goroutine都需要对应的1个接收结果的channel。</p>
<p>所以<strong>我们可以增加1个query channel，channel里传递Peer.ID和接收结果的channel。</strong></p>
<p><strong>还有没有其他办法？</strong>我们今天的主题<code>First class function</code>还有入场，你有办法用这个特性实现吗？</p>
<h2 id="版本3"><a href="#版本3" class="headerlink" title="版本3"></a>版本3</h2><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片34.png" alt="幻灯片34"></p>
<p>First class function: 函数可以向变量一样使用。那channel里面是不是可以传递函数呢？当然可以。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片35.png" alt="幻灯片35"></p>
<p>我们可以建立一个channel，用这个channel向<code>loop</code>传递操作<code>peers</code>的函数，所以函数的入参是<code>peers map[string]*Peer</code>，无需返回值，因为函数是在<code>loop</code>里面调用的，调用<code>AddPeer</code>等函数的goroutine是接收不到返回值的。我们把这个类型的函数定义为<code>Operation</code>。</p>
<p><code>Host</code>修改为只有2个channel，<code>stop</code>功能如版本2，<code>opCh</code>用来传递<code>Operation</code>类型的函数。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片36.png" alt="幻灯片36"></p>
<p><code>loop</code>函数可以简化为左边的形式了，右边是<code>AddPeer</code>和<code>RemovePeer</code>，以<code>AddPeer</code>为例进行介绍，创建了一个匿名函数，向<code>peers</code>里增加<code>p</code>，然后把函数发送到<code>opCh</code>。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片37.png" alt="幻灯片37"></p>
<p><code>BroadcastMsg</code>与<code>AddPeer</code>类似。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片38.png" alt="幻灯片38"></p>
<p>我们重点看一下<code>GetPeer</code>，创建了<code>retCh</code>用于接收查询的结果，创建了匿名函数进行查询，并把查询结果发送到<code>retCh</code>，然后启动1个goroutine把匿名函数写入到<code>opCh</code>，最后等待从<code>retCh</code>读取查询结果。</p>
<p>这样就实现了向每个调用<code>GetPeer</code>的goroutine发送查询结果。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片40.png" alt="幻灯片40"></p>
<p>总结都在上面了，不多说了。</p>
<p><strong>友情提醒：这3种方式本身并无优劣之分，具体要用那种实现，要依赖自身的实际场景进行取舍。</strong></p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>识别下图二维码。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片41.png" alt="幻灯片41"></p>
<h2 id="PPT下载"><a href="#PPT下载" class="headerlink" title="PPT下载"></a>PPT下载</h2><p>下载链接：<a href="http://img.lessisbetter.site/Go%E8%AF%AD%E8%A8%80%E6%80%9D%E7%BB%B4First-class-function.pdf" target="_blank" rel="noopener">http://img.lessisbetter.site/Go%E8%AF%AD%E8%A8%80%E6%80%9D%E7%BB%B4First-class-function.pdf</a></p>
<p>或<strong>阅读原文</strong>下载。</p>
<h1 id="云象介绍"><a href="#云象介绍" class="headerlink" title="云象介绍"></a>云象介绍</h1><p>广告时间，云象区块链持续招人，欢迎来撩。</p>
<p><img src="http://img.lessisbetter.site/2019-06-09-幻灯片42.png" alt="幻灯片42"></p>
<h1 id="活动总结"><a href="#活动总结" class="headerlink" title="活动总结"></a>活动总结</h1><p>最后奉上Seekload关于本次活动的总结：<a href="https://mp.weixin.qq.com/s/wfDW4cKjzuEE1K94anuImA" target="_blank" rel="noopener">Gopher杭州线下面基第一期</a>。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/05/18/linux-simulate-bad-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/18/linux-simulate-bad-network/" class="post-title-link" itemprop="url">Linux内网测试环境模拟网络丢包和延时</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-18 15:37:05" itemprop="dateCreated datePublished" datetime="2019-05-18T15:37:05+08:00">2019-05-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文源自同事分享，在此基础之上做简要修改而成。</p>
</blockquote>
<p>Linux下有2traffic control（简写TC）和netem这2个工具。Netem 是 Linux 2.6 及以上内核版本提供的一个网络模拟功能模块，该功能模块可以用来在性能良好的局域网中，模拟出复杂的互联网传输性能，诸如低带宽、传输延迟、丢包等等情况。使用 Linux 2.6 (或以上) 版本内核的很多发行版 Linux 都开启了该内核功能，比如Fedora、Ubuntu、Redhat、OpenSuse、CentOS、Debian等等。TC可以用来控制 netem 的工作模式，可完成如下功能：（故障模拟） 模拟时延，丢包，重复包，乱序，控制带宽等。</p>
<p>本文介绍简单的使用方法，更详细的介绍及用法见：<a href="https://wiki.linuxfoundation.org/networking/netem" target="_blank" rel="noopener">wiki:network emulation</a>。</p>
<h1 id="TC实现原理"><a href="#TC实现原理" class="headerlink" title="TC实现原理"></a>TC实现原理</h1><p>TC用于Linux内核的流量控制，主要是通过在输出端口处建立一个队列来实现流量控制。接收包从输入接口（Input Interface）进来后，经过流量限制（Ingress Policing）丢弃不符合规定的数据包，由输入多路分配器（Input De-Multiplexing）进行判断选择：如果接收包的目的是本主机，那么将该包送给上层处理；否则需要进行转发，将接收包交到转发块（Forwarding Block）处理。转发块同时也接收本主机上层（TCP、UDP等）产生的包。转发块通过查看路由表，决定所处理包的下一跳。然后，对包进行排列以便将它们传送到输出接口（Output Interface）。一般我们只能限制网卡发送的数据包，不能限制网卡接收的数据包，所以我们可以通过改变发送次序来控制传输速率。Linux流量控制主要是在输出接口排列时进行处理和实现的。</p>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>以下模拟命令可配合使用，实现即延迟又丢包等情况。</p>
<h2 id="模拟延迟传输"><a href="#模拟延迟传输" class="headerlink" title="模拟延迟传输"></a>模拟延迟传输</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem delay 100ms</span><br></pre></td></tr></table></figure>
<p>该命令将 eth0 网卡的传输设置为延迟100毫秒发送。<br>更真实的情况下，延迟值不会这么精确，会有一定的波动，我们可以用下面的情况来模拟出带有波动性的延迟值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem delay 100ms 50ms</span><br></pre></td></tr></table></figure>
<p>该命令将 eth0 网卡的传输设置为延迟 100ms ± 50ms （50 ~ 150 ms 之间的任意值）发送。<br>还可以更进一步加强这种波动的随机性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem delay 100ms 50ms 30%</span><br></pre></td></tr></table></figure>
<p>该命令将 eth0 网卡的传输设置为 100ms ，同时，大约有 30% 的包会延迟 ± 50ms 发送。
　　</p>
<h2 id="模拟网络丢包"><a href="#模拟网络丢包" class="headerlink" title="模拟网络丢包"></a>模拟网络丢包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem loss 10%</span><br></pre></td></tr></table></figure>
<p>该命令将 eth0 网卡的传输设置为随机丢掉 10% 的数据包。<br>也可以设置丢包的成功率：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem loss 10% 30%</span><br></pre></td></tr></table></figure>
<h2 id="模拟包重复"><a href="#模拟包重复" class="headerlink" title="模拟包重复"></a>模拟包重复</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem duplicate 10%</span><br></pre></td></tr></table></figure>
<p>该命令将 eth0 网卡的传输设置为随机产生 10% 的重复数据包 。</p>
<h2 id="模拟包损坏"><a href="#模拟包损坏" class="headerlink" title="模拟包损坏"></a>模拟包损坏</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem corrupt 1%</span><br></pre></td></tr></table></figure>
<h2 id="模拟包乱序"><a href="#模拟包乱序" class="headerlink" title="模拟包乱序"></a>模拟包乱序</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc change dev eth0 root netem delay 10ms reorder 10% 50%</span><br></pre></td></tr></table></figure>
<p>该命令将 eth0 网卡的传输设置为:有 10% 的数据包（50%相关）会被立即发送，其他的延迟 10 秒。</p>
<h2 id="删除设备及显示设置"><a href="#删除设备及显示设置" class="headerlink" title="删除设备及显示设置"></a>删除设备及显示设置</h2><p>显示配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc sh dev eth0</span><br></pre></td></tr></table></figure>
<p>删除配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tc qd del dev eth0 root</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.cnblogs.com/fsw-blog/p/4788036.html" target="_blank" rel="noopener">Linux网络流量控制工具—Netem</a></p>
<blockquote>
<ol>
<li>如果这篇文章对你有帮助，不妨关注下我的Github，有文章会收到通知。</li>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/05/18/linux-simulate-bad-network/">http://lessisbetter.site/2019/05/18/linux-simulate-bad-network/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/05/18/go-goroutine-leak/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/18/go-goroutine-leak/" class="post-title-link" itemprop="url">实战Go内存泄露</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-18 10:30:47" itemprop="dateCreated datePublished" datetime="2019-05-18T10:30:47+08:00">2019-05-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近解决了我们项目中的一个内存泄露问题，事实再次证明pprof是一个好工具，但掌握好工具的正确用法，才能发挥好工具的威力，不然就算你手里有屠龙刀，也成不了天下第一，本文就是带你用pprof定位内存泄露问题。</p>
<p>关于Go的内存泄露有这么一句话不知道你听过没有：</p>
<blockquote>
<p>10次内存泄露，有9次是goroutine泄露。</p>
</blockquote>
<p>我所解决的问题，也是goroutine泄露导致的内存泄露，所以<strong>这篇文章主要介绍Go程序的goroutine泄露，掌握了如何定位和解决goroutine泄露，就掌握了内存泄露的大部分场景</strong>。</p>
<blockquote>
<p>本文草稿最初数据都是生产坏境数据，为了防止敏感内容泄露，全部替换成了demo数据，demo的数据比生产环境数据简单多了，更适合入门理解，有助于掌握pprof。</p>
</blockquote>
<hr>
<h1 id="go-pprof基本知识"><a href="#go-pprof基本知识" class="headerlink" title="go pprof基本知识"></a>go pprof基本知识</h1><p>定位goroutine泄露会使用到pprof，pprof是Go的性能工具，在开始介绍内存泄露前，先简单介绍下pprof的基本使用，更详细的使用给大家推荐了资料。</p>
<h2 id="什么是pprof"><a href="#什么是pprof" class="headerlink" title="什么是pprof"></a>什么是pprof</h2><p>pprof是Go的性能分析工具，在程序运行过程中，可以记录程序的运行信息，可以是CPU使用情况、内存使用情况、goroutine运行情况等，当需要性能调优或者定位Bug时候，这些记录的信息是相当重要。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>使用pprof有多种方式，Go已经现成封装好了1个：<code>net/http/pprof</code>，使用简单的几行命令，就可以开启pprof，记录运行信息，并且提供了Web服务，能够通过浏览器和命令行2种方式获取运行数据。</p>
<p>看个最简单的pprof的例子：</p>
<p><em>文件：<a href="https://github.com/Shitaibin/golang_step_by_step/blob/master/pprof/pprof/demo.go" target="_blank" rel="noopener">golang_step_by_step/pprof/pprof/demo.go</a></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	_ <span class="string">"net/http/pprof"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 开启pprof，监听请求</span></span><br><span class="line">	ip := <span class="string">"0.0.0.0:6060"</span></span><br><span class="line">	<span class="keyword">if</span> err := http.ListenAndServe(ip, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"start pprof failed on %s\n"</span>, ip)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>提醒：本文所有代码部分可左右滑动</em></p>
<h3 id="浏览器方式"><a href="#浏览器方式" class="headerlink" title="浏览器方式"></a>浏览器方式</h3><p><img src="http://img.lessisbetter.site/2019-05-image-20190516173924325-7999564.png" alt="image-20190516173924325"></p>
<p>输入网址<code>ip:port/debug/pprof/</code>打开pprof主页，从上到下依次是<strong>5类profile信息</strong>：</p>
<ol>
<li><strong>block</strong>：goroutine的阻塞信息，本例就截取自一个goroutine阻塞的demo，但block为0，没掌握block的用法</li>
<li><strong>goroutine</strong>：所有goroutine的信息，下面的<code>full goroutine stack dump</code>是输出所有goroutine的调用栈，是goroutine的debug=2，后面会详细介绍。</li>
<li><strong>heap</strong>：堆内存的信息</li>
<li><strong>mutex</strong>：锁的信息</li>
<li><strong>threadcreate</strong>：线程信息</li>
</ol>
<p>这篇文章我们主要关注goroutine和heap，这两个都会打印调用栈信息，goroutine里面还会包含goroutine的数量信息，heap则是内存分配信息，本文用不到的地方就不展示了，最后推荐几篇文章大家去看。</p>
<h3 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h3><p>当连接在服务器终端上的时候，是没有浏览器可以使用的，Go提供了命令行的方式，能够获取以上5类信息，这种方式用起来更方便。</p>
<p>使用命令<code>go tool pprof url</code>可以获取指定的profile文件，此命令会发起http请求，然后下载数据到本地，之后进入交互式模式，就像gdb一样，可以使用命令查看运行信息，以下是5类请求的方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载cpu profile，默认从当前开始收集30s的cpu使用情况，需要等待30s</span></span><br><span class="line">go tool pprof http://localhost:6060/debug/pprof/profile   <span class="comment"># 30-second CPU profile</span></span><br><span class="line">go tool pprof http://localhost:6060/debug/pprof/profile?seconds=120     <span class="comment"># wait 120s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载heap profile</span></span><br><span class="line">go tool pprof http://localhost:6060/debug/pprof/heap      <span class="comment"># heap profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载goroutine profile</span></span><br><span class="line">go tool pprof http://localhost:6060/debug/pprof/goroutine <span class="comment"># goroutine profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载block profile</span></span><br><span class="line">go tool pprof http://localhost:6060/debug/pprof/block     <span class="comment"># goroutine blocking profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载mutex profile</span></span><br><span class="line">go tool pprof http://localhost:6060/debug/pprof/mutex</span><br></pre></td></tr></table></figure>
<p>上面的<code>pprof/demo.go</code>太简单了，如果去获取内存profile，几乎获取不到什么，换一个Demo进行内存profile的展示：</p>
<p><em>文件：<a href="https://github.com/Shitaibin/golang_step_by_step/blob/master/pprof/heap/demo2.go" target="_blank" rel="noopener">golang_step_by_step/pprof/heap/demo2.go</a></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 展示内存增长和pprof，并不是泄露</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	_ <span class="string">"net/http/pprof"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行一段时间：fatal error: runtime: out of memory</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 开启pprof</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ip := <span class="string">"0.0.0.0:6060"</span></span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(ip, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"start pprof failed on %s\n"</span>, ip)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	tick := time.Tick(time.Second / <span class="number">100</span>)</span><br><span class="line">	<span class="keyword">var</span> buf []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">for</span> <span class="keyword">range</span> tick &#123;</span><br><span class="line">		buf = <span class="built_in">append</span>(buf, <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>)...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这个demo会不断的申请内存，把它编译运行起来，然后执行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:6060/debug/pprof/heap</span></span><br><span class="line"></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:6060/debug/pprof/heap</span></span><br><span class="line">Saved profile in /home/ubuntu/pprof/pprof.demo.alloc_objects.alloc_space.inuse_objects.inuse_space<span class="number">.001</span>.pb.gz       <span class="comment">//&lt;--- 下载到的内存profile文件</span></span><br><span class="line">File: demo <span class="comment">// 程序名称</span></span><br><span class="line">Build ID: a9069a125ee9c0df3713b2149ca859e8d4d11d5a</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">8</span>:<span class="number">55</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof) help  <span class="comment">// 使用help打印所有可用命令</span></span><br><span class="line">  Commands:</span><br><span class="line">    callgrind        Outputs a graph in callgrind format</span><br><span class="line">    comments         Output all profile comments</span><br><span class="line">    disasm           Output assembly listings annotated with samples</span><br><span class="line">    dot              Outputs a graph in DOT format</span><br><span class="line">    eog              Visualize graph through eog</span><br><span class="line">    evince           Visualize graph through evince</span><br><span class="line">    gif              Outputs a graph image in GIF format</span><br><span class="line">    gv               Visualize graph through gv</span><br><span class="line">    kcachegrind      Visualize report in KCachegrind</span><br><span class="line">    list             Output annotated source <span class="keyword">for</span> functions matching regexp</span><br><span class="line">    pdf              Outputs a graph in PDF format</span><br><span class="line">    peek             Output callers/callees of functions matching regexp</span><br><span class="line">    png              Outputs a graph image in PNG format</span><br><span class="line">    proto            Outputs the profile in compressed protobuf format</span><br><span class="line">    ps               Outputs a graph in PS format</span><br><span class="line">    raw              Outputs a text representation of the raw profile</span><br><span class="line">    svg              Outputs a graph in SVG format</span><br><span class="line">    tags             Outputs all tags in the profile</span><br><span class="line">    text             Outputs top entries in text form</span><br><span class="line">    top              Outputs top entries in text form</span><br><span class="line">    topproto         Outputs top entries in compressed protobuf format</span><br><span class="line">    traces           Outputs all profile samples in text form</span><br><span class="line">    tree             Outputs a text rendering of call graph</span><br><span class="line">    web              Visualize graph through web browser</span><br><span class="line">    weblist          Display annotated source in a web browser</span><br><span class="line">    o/options        List options and their current values</span><br><span class="line">    quit/exit/^D     Exit pprof</span><br><span class="line">    </span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>
<p>以上信息我们只关注2个地方：</p>
<ol>
<li>下载得到的文件：<code>/home/ubuntu/pprof/pprof.demo.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz</code>，这其中包含了程序名<code>demo</code>，profile类型<code>alloc</code>已分配的内存，<code>inuse</code>代表使用中的内存。</li>
<li><code>help</code>可以获取帮助，最先会列出支持的命令，想掌握pprof，要多看看，多尝试。</li>
</ol>
<p>关于命令，本文只会用到3个，我认为也是最常用的：<code>top</code>、<code>list</code>、<code>traces</code>，分别介绍一下。</p>
<h4 id="top"><a href="#top" class="headerlink" title="top"></a>top</h4><p>按指标大小列出前10个函数，比如内存是按内存占用多少，CPU是按执行时间多少。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">814.62</span>MB, <span class="number">100</span>% of <span class="number">814.62</span>MB total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">  <span class="number">814.62</span>MB   <span class="number">100</span>%   <span class="number">100</span>%   <span class="number">814.62</span>MB   <span class="number">100</span>%  main.main</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%   <span class="number">814.62</span>MB   <span class="number">100</span>%  runtime.main</span><br></pre></td></tr></table></figure>
<p>top会列出5个统计数据：</p>
<ul>
<li>flat: 本函数占用的内存量。</li>
<li>flat%: 本函数内存占使用中内存总量的百分比。</li>
<li>sum%: 前面每一行flat百分比的和，比如第2行虽然的100% 是 100% + 0%。</li>
<li>cum: 是累计量，加入main函数调用了函数f，函数f占用的内存量，也会记进来。</li>
<li>cum%: 是累计量占总量的百分比。</li>
</ul>
<h4 id="list"><a href="#list" class="headerlink" title="list"></a>list</h4><p>查看某个函数的代码，以及该函数每行代码的指标信息，如果函数名不明确，会进行模糊匹配，比如<code>list main</code>会列出<code>main.main</code>和<code>runtime.main</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(pprof) list main.main  <span class="comment">// 精确列出函数</span></span><br><span class="line">Total: <span class="number">814.62</span>MB</span><br><span class="line">ROUTINE ======================== main.main in /home/ubuntu/heap/demo2.<span class="keyword">go</span></span><br><span class="line">  <span class="number">814.62</span>MB   <span class="number">814.62</span>MB (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">20</span>:	&#125;()</span><br><span class="line">         .          .     <span class="number">21</span>:</span><br><span class="line">         .          .     <span class="number">22</span>:	tick := time.Tick(time.Second / <span class="number">100</span>)</span><br><span class="line">         .          .     <span class="number">23</span>:	<span class="keyword">var</span> buf []<span class="keyword">byte</span></span><br><span class="line">         .          .     <span class="number">24</span>:	<span class="keyword">for</span> <span class="keyword">range</span> tick &#123;</span><br><span class="line">  <span class="number">814.62</span>MB   <span class="number">814.62</span>MB     <span class="number">25</span>:		buf = <span class="built_in">append</span>(buf, <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>)...)</span><br><span class="line">         .          .     <span class="number">26</span>:	&#125;</span><br><span class="line">         .          .     <span class="number">27</span>:&#125;</span><br><span class="line">         .          .     <span class="number">28</span>:</span><br><span class="line">(pprof) list main  <span class="comment">// 匹配所有函数名带main的函数</span></span><br><span class="line">Total: <span class="number">814.62</span>MB</span><br><span class="line">ROUTINE ======================== main.main in /home/ubuntu/heap/demo2.<span class="keyword">go</span></span><br><span class="line">  <span class="number">814.62</span>MB   <span class="number">814.62</span>MB (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">20</span>:	&#125;()</span><br><span class="line">         .          .     <span class="number">21</span>:</span><br><span class="line">..... <span class="comment">// 省略几行</span></span><br><span class="line">         .          .     <span class="number">28</span>:</span><br><span class="line">ROUTINE ======================== runtime.main in /usr/lib/<span class="keyword">go</span><span class="number">-1.10</span>/src/runtime/proc.<span class="keyword">go</span></span><br><span class="line">         <span class="number">0</span>   <span class="number">814.62</span>MB (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .    <span class="number">193</span>:		<span class="comment">// A program compiled with -buildmode=c-archive or c-shared</span></span><br><span class="line">..... <span class="comment">// 省略几行</span></span><br></pre></td></tr></table></figure>
<p>可以看到在<code>main.main</code>中的第25行占用了814.62MB内存，左右2个数据分别是flat和cum，含义和top中解释的一样。</p>
<h4 id="traces"><a href="#traces" class="headerlink" title="traces"></a>traces</h4><p>打印所有调用栈，以及调用栈的指标信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(pprof) traces</span><br><span class="line">File: demo2</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">7</span>:<span class="number">08</span>pm (CST)</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">     bytes:  <span class="number">813.46</span>MB</span><br><span class="line">  <span class="number">813.46</span>MB   main.main</span><br><span class="line">             runtime.main</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">     bytes:  <span class="number">650.77</span>MB</span><br><span class="line">         <span class="number">0</span>   main.main</span><br><span class="line">             runtime.main</span><br><span class="line">....... <span class="comment">// 省略几十行</span></span><br></pre></td></tr></table></figure>
<p>每个<code>- - - - -</code> 隔开的是一个调用栈，能看到<code>runtime.main</code>调用了<code>main.main</code>，并且<code>main.main</code>中占用了813.46MB内存。</p>
<p>其他的profile操作和内存是类似的，这里就不展示了。</p>
<p>这里只是简单介绍本文用到的pprof的功能，pprof功能很强大，也经常和benchmark结合起来，但这不是本文的重点，所以就不多介绍了，为大家推荐几篇文章，一定要好好研读、实践：</p>
<ol>
<li>Go官方博客关于pprof的介绍，很详细，也包含样例，可以实操：<a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="noopener">Profiling Go Programs</a>。</li>
<li>跟煎鱼也讨论过pprof，煎鱼的这篇文章也很适合入门： <a href="https://github.com/EDDYCJY/blog/blob/master/golang/2018-09-15-Golang%20%E5%A4%A7%E6%9D%80%E5%99%A8%E4%B9%8B%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90%20PProf.md" target="_blank" rel="noopener">Golang 大杀器之性能剖析 PProf</a>。</li>
</ol>
<hr>
<h1 id="什么是内存泄露"><a href="#什么是内存泄露" class="headerlink" title="什么是内存泄露"></a>什么是内存泄露</h1><p>内存泄露指的是程序运行过程中已不再使用的内存，没有被释放掉，导致这些内存无法被使用，直到程序结束这些内存才被释放的问题。</p>
<p>Go虽然有GC来回收不再使用的堆内存，减轻了开发人员对内存的管理负担，但这并不意味着Go程序不再有内存泄露问题。在Go程序中，如果没有Go语言的编程思维，也不遵守良好的编程实践，就可能埋下隐患，造成内存泄露问题。</p>
<h1 id="怎么发现内存泄露"><a href="#怎么发现内存泄露" class="headerlink" title="怎么发现内存泄露"></a>怎么发现内存泄露</h1><p>在Go中发现内存泄露有2种方法，一个是通用的监控工具，另一个是go pprof：</p>
<ol>
<li><strong>监控工具</strong>：固定周期对进程的内存占用情况进行采样，数据可视化后，根据内存占用走势（持续上升），很容易发现是否发生内存泄露。</li>
<li><strong>go pprof</strong>：适合没有监控工具的情况，使用Go提供的pprof工具判断是否发生内存泄露。</li>
</ol>
<p>这2种方式分别介绍一下。</p>
<h2 id="监控工具查看进程内在占用情况"><a href="#监控工具查看进程内在占用情况" class="headerlink" title="监控工具查看进程内在占用情况"></a>监控工具查看进程内在占用情况</h2><p><strong>如果使用云平台部署Go程序</strong>，云平台都提供了内存查看的工具，可以查看OS的内存占用情况和某个进程的内存占用情况，比如阿里云，我们在1个云主机上只部署了1个Go服务，所以OS的内存占用情况，基本是也反映了进程内存占用情况，OS内存占用情况如下，可以看到<strong>随着时间的推进，内存的占用率在不断的提高，这是内存泄露的最明显现象</strong>：</p>
<p><img src="http://img.lessisbetter.site/2019-05-image-20190512111200988-7630721.png" alt="image-20190512111200988"></p>
<p><strong>如果没有云平台这种内存监控工具，可以制作一个简单的内存记录工具。</strong></p>
<p>1、建立一个脚本<code>prog_mem.sh</code>，获取进程占用的物理内存情况，脚本内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">prog_name=<span class="string">"your_programe_name"</span></span><br><span class="line">prog_mem=$(pidstat  -r -u -h -C <span class="variable">$prog_name</span> |awk <span class="string">'NR==4&#123;print $12&#125;'</span>)</span><br><span class="line">time=$(date <span class="string">"+%Y-%m-%d %H:%M:%S"</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$time</span><span class="string">"\tmemory(Byte)\t"</span><span class="variable">$prog_mem</span> &gt;&gt;~/record/prog_mem.log</span><br></pre></td></tr></table></figure>
<p>2、然后使用<code>crontab</code>建立定时任务，每分钟记录1次。使用<code>crontab -e</code>编辑crontab配置，在最后增加1行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/1 * * * * ~/record/prog_mem.sh</span><br></pre></td></tr></table></figure>
<p>脚本输出的内容保存在<code>prog_mem.log</code>，只要大体浏览一下就可以发现内存的增长情况，判断是否存在内存泄露。如果需要可视化，可以直接黏贴<code>prog_mem.log</code>内容到Excel等表格工具，绘制内存占用图。</p>
<p><img src="http://img.lessisbetter.site/2019-05-image-20190512172935195-7653375.png" alt="image-20190512172935195"></p>
<h2 id="go-pprof发现存在内存问题"><a href="#go-pprof发现存在内存问题" class="headerlink" title="go pprof发现存在内存问题"></a>go pprof发现存在内存问题</h2><blockquote>
<p>有情提醒：如果对pprof不了解，可以先看<a href="#go pprof基本知识">go pprof基本知识</a>，这是下一节，看完再倒回来看。</p>
</blockquote>
<p>如果你Google或者百度，Go程序内存泄露的文章，它总会告诉你使用<strong>pprof heap</strong>，能够生成漂亮的调用路径图，火焰图等等，然后你根据调用路径就能定位内存泄露问题，我最初也是对此深信不疑，尝试了若干天后，只是发现内存泄露跟某种场景有关，根本找不到内存泄露的根源，<strong>如果哪位朋友用heap就能定位内存泄露的线上问题，麻烦介绍下</strong>。</p>
<p>后来读了Dave的<a href="https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html#using_more_than_one_cpu" target="_blank" rel="noopener">《High Performance Go Workshop》</a>，刷新了对heap的认识，内存pprof的简要内容如下：</p>
<p><img src="http://img.lessisbetter.site/2019-05-image-20190512114048868-7632448.png" alt="image-20190512114048868"></p>
<p>Dave讲了以下几点：</p>
<ol>
<li><strong>内存profiling记录的是堆内存分配的情况，以及调用栈信息</strong>，并不是进程完整的内存情况，猜测这也是在go pprof中称为heap而不是memory的原因。</li>
<li><strong>栈内存的分配是在调用栈结束后会被释放的内存，所以并不在内存profile中</strong>。</li>
<li>内存profiling是基于抽样的，默认是每1000次堆内存分配，执行1次profile记录。</li>
<li>因为内存profiling是基于抽样和它跟踪的是已分配的内存，而不是使用中的内存，（比如有些内存已经分配，看似使用，但实际以及不使用的内存，比如内存泄露的那部分），所以<strong>不能使用内存profiling衡量程序总体的内存使用情况</strong>。</li>
<li><strong>Dave个人观点：使用内存profiling不能够发现内存泄露</strong>。</li>
</ol>
<p>基于目前对heap的认知，我有2个观点：</p>
<ol>
<li><strong>heap能帮助我们发现内存问题，但不一定能发现内存泄露问题</strong>，这个看法与Dave是类似的。heap记录了内存分配的情况，我们能通过heap观察内存的变化，增长与减少，内存主要被哪些代码占用了，程序存在内存问题，这只能说明内存有使用不合理的地方，但并不能说明这是内存泄露。</li>
<li><strong>heap在帮助定位内存泄露原因上贡献的力量微乎其微</strong>。如第一条所言，能通过heap找到占用内存多的位置，但这个位置通常不一定是内存泄露，就算是内存泄露，也只是内存泄露的结果，并不是真正导致内存泄露的根源。</li>
</ol>
<p>接下来，我介绍怎么用heap发现问题，然后再解释为什么heap几乎不能定位内存泄露的根因。</p>
<h3 id="怎么用heap发现内存问题"><a href="#怎么用heap发现内存问题" class="headerlink" title="怎么用heap发现内存问题"></a>怎么用heap发现内存问题</h3><p>使用pprof的heap能够获取程序运行时的内存信息，在程序平稳运行的情况下，每个一段时间使用heap获取内存的profile，<strong>然后使用<code>base</code>能够对比两个profile文件的差别，就像<code>diff</code>命令一样显示出增加和减少的变化</strong>，使用一个简单的demo来说明heap和base的使用，依然使用demo2进行展示。</p>
<p><em>文件：<a href="https://github.com/Shitaibin/golang_step_by_step/blob/master/pprof/heap/demo2.go" target="_blank" rel="noopener">golang_step_by_step/pprof/heap/demo2.go</a></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 展示内存增长和pprof，并不是泄露</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	_ <span class="string">"net/http/pprof"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行一段时间：fatal error: runtime: out of memory</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 开启pprof</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ip := <span class="string">"0.0.0.0:6060"</span></span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(ip, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"start pprof failed on %s\n"</span>, ip)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	tick := time.Tick(time.Second / <span class="number">100</span>)</span><br><span class="line">	<span class="keyword">var</span> buf []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">for</span> <span class="keyword">range</span> tick &#123;</span><br><span class="line">		buf = <span class="built_in">append</span>(buf, <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>)...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将上面代码运行起来，执行以下命令获取profile文件，Ctrl-D退出，1分钟后再获取1次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof http://localhost:6060/debug/pprof/heap</span><br></pre></td></tr></table></figure>
<p>我已经获取到了两个profile文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz</span><br><span class="line">pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz</span><br></pre></td></tr></table></figure>
<p>使用<code>base</code>把001文件作为基准，然后用002和001对比，先执行<code>top</code>看<code>top</code>的对比，然后执行<code>list main</code>列出<code>main</code>函数的内存对比，结果如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof -base pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space<span class="number">.001</span>.pb.gz pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space<span class="number">.002</span>.pb.gz</span><br><span class="line"></span><br><span class="line">File: demo2</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: May <span class="number">14</span>, <span class="number">2019</span> at <span class="number">2</span>:<span class="number">33</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">970.34</span>MB, <span class="number">32.30</span>% of <span class="number">3003.99</span>MB total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">  <span class="number">970.34</span>MB <span class="number">32.30</span>% <span class="number">32.30</span>%   <span class="number">970.34</span>MB <span class="number">32.30</span>%  main.main   <span class="comment">// 看这</span></span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>% <span class="number">32.30</span>%   <span class="number">970.34</span>MB <span class="number">32.30</span>%  runtime.main</span><br><span class="line">(pprof)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof) list main.main</span><br><span class="line">Total: <span class="number">2.93</span>GB</span><br><span class="line">ROUTINE ======================== main.main in /home/ubuntu/heap/demo2.<span class="keyword">go</span></span><br><span class="line">  <span class="number">970.34</span>MB   <span class="number">970.34</span>MB (flat, cum) <span class="number">32.30</span>% of Total</span><br><span class="line">         .          .     <span class="number">20</span>:	&#125;()</span><br><span class="line">         .          .     <span class="number">21</span>:</span><br><span class="line">         .          .     <span class="number">22</span>:	tick := time.Tick(time.Second / <span class="number">100</span>)</span><br><span class="line">         .          .     <span class="number">23</span>:	<span class="keyword">var</span> buf []<span class="keyword">byte</span></span><br><span class="line">         .          .     <span class="number">24</span>:	<span class="keyword">for</span> <span class="keyword">range</span> tick &#123;</span><br><span class="line">  <span class="number">970.34</span>MB   <span class="number">970.34</span>MB     <span class="number">25</span>:		buf = <span class="built_in">append</span>(buf, <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>)...) <span class="comment">// 看这</span></span><br><span class="line">         .          .     <span class="number">26</span>:	&#125;</span><br><span class="line">         .          .     <span class="number">27</span>:&#125;</span><br><span class="line">         .          .     <span class="number">28</span>:</span><br></pre></td></tr></table></figure>
<p><code>top</code>列出了<code>main.main</code>和<code>runtime.main</code>，<code>main.main</code>就是我们编写的main函数，<code>runtime.main</code>是runtime包中的main函数，也就是所有main函数的入口，这里不多介绍了，有兴趣可以看之前的调度器文章<a href="http://lessisbetter.site/2019/03/26/golang-scheduler-2-macro-view/">《Go调度器系列（2）宏观看调度器》</a>。</p>
<p><code>top</code>显示<code>main.main</code> 第2次内存占用，比第1次内存占用多了970.34MB。</p>
<p><code>list main.main</code>告诉了我们增长的内存都在这一行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="built_in">append</span>(buf, <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>)...)</span><br></pre></td></tr></table></figure>
<p>001和002 profile的文件不进去看了，你本地测试下计算差值，绝对是刚才对比出的970.34MB。</p>
<h3 id="heap“不能”定位内存泄露"><a href="#heap“不能”定位内存泄露" class="headerlink" title="heap“不能”定位内存泄露"></a>heap“不能”定位内存泄露</h3><p>heap能显示内存的分配情况，以及哪行代码占用了多少内存，我们能轻易的找到占用内存最多的地方，如果这个地方的数值还在不断怎大，基本可以认定这里就是内存泄露的位置。</p>
<p>曾想按图索骥，从内存泄露的位置，根据调用栈向上查找，总能找到内存泄露的原因，这种方案看起来是不错的，但实施起来却找不到内存泄露的原因，结果是事半功倍。</p>
<p>原因在于一个Go程序，其中有大量的goroutine，这其中的调用关系也许有点复杂，也许内存泄露是在某个三方包里。举个栗子，比如下面这幅图，每个椭圆代表1个goroutine，其中的数字为编号，箭头代表调用关系。heap profile显示g111（最下方标红节点）这个协程的代码出现了泄露，任何一个从g101到g111的调用路径都可能造成了g111的内存泄露，有2类可能：</p>
<ol>
<li>该goroutine只调用了少数几次，但消耗了大量的内存，说明每个goroutine调用都消耗了不少内存，<strong>内存泄露的原因基本就在该协程内部</strong>。</li>
<li>该goroutine的调用次数非常多，虽然每个协程调用过程中消耗的内存不多，但该调用路径上，协程数量巨大，造成消耗大量的内存，并且这些goroutine由于某种原因无法退出，占用的内存不会释放，<strong>内存泄露的原因在到g111调用路径上某段代码实现有问题，造成创建了大量的g111</strong>。</li>
</ol>
<p><strong>第2种情况，就是goroutine泄露，这是通过heap无法发现的，所以heap在定位内存泄露这件事上，发挥的作用不大</strong>。</p>
<p><img src="http://img.lessisbetter.site/2019-05-image-20190512144150064-7643310.png" alt="image-20190512144150064"></p>
<hr>
<h1 id="goroutine泄露怎么导致内存泄露"><a href="#goroutine泄露怎么导致内存泄露" class="headerlink" title="goroutine泄露怎么导致内存泄露"></a>goroutine泄露怎么导致内存泄露</h1><h2 id="什么是goroutine泄露"><a href="#什么是goroutine泄露" class="headerlink" title="什么是goroutine泄露"></a>什么是goroutine泄露</h2><p>如果你启动了1个goroutine，但并没有符合预期的退出，直到程序结束，此goroutine才退出，这种情况就是goroutine泄露。</p>
<blockquote>
<p>提前思考：什么会导致goroutine无法退出/阻塞？</p>
</blockquote>
<h2 id="goroutine泄露怎么导致内存泄露-1"><a href="#goroutine泄露怎么导致内存泄露-1" class="headerlink" title="goroutine泄露怎么导致内存泄露"></a>goroutine泄露怎么导致内存泄露</h2><p>每个goroutine占用2KB内存，泄露1百万goroutine至少泄露<code>2KB * 1000000 = 2GB</code>内存，为什么说至少呢？</p>
<p>goroutine执行过程中还存在一些变量，如果这些变量指向堆内存中的内存，GC会认为这些内存仍在使用，不会对其进行回收，这些内存谁都无法使用，造成了内存泄露。</p>
<p>所以goroutine泄露有2种方式造成内存泄露：</p>
<ol>
<li>goroutine本身的栈所占用的空间造成内存泄露。</li>
<li>goroutine中的变量所占用的堆内存导致堆内存泄露，这一部分是能通过heap profile体现出来的。</li>
</ol>
<p>Dave在文章中也提到了，如果不知道何时停止一个goroutine，这个goroutine就是潜在的内存泄露：</p>
<blockquote>
<p><a href="https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html#know_when_to_stop_a_goroutine" target="_blank" rel="noopener">7.1.1 Know when to stop a goroutine</a></p>
<p>If you don’t know the answer, that’s a potential memory leak as the goroutine will pin its stack’s memory on the heap, as well as any heap allocated variables reachable from the stack.</p>
</blockquote>
<h2 id="怎么确定是goroutine泄露引发的内存泄露"><a href="#怎么确定是goroutine泄露引发的内存泄露" class="headerlink" title="怎么确定是goroutine泄露引发的内存泄露"></a>怎么确定是goroutine泄露引发的内存泄露</h2><p>掌握了前面的pprof命令行的基本用法，很快就可以确认是否是goroutine泄露导致内存泄露，如果你不记得了，马上回去看一下<a href="#go pprof基本知识">go pprof基本知识</a>。</p>
<p><strong>判断依据：在节点正常运行的情况下，隔一段时间获取goroutine的数量，如果后面获取的那次，某些goroutine比前一次多，如果多获取几次，是持续增长的，就极有可能是goroutine泄露</strong>。</p>
<p>goroutine导致内存泄露的demo：</p>
<p><em>文件：<a href="https://github.com/Shitaibin/golang_step_by_step/blob/master/pprof/goroutine/leak_demo1.go" target="_blank" rel="noopener">golang_step_by_step/pprof/goroutine/leak_demo1.go</a></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// goroutine泄露导致内存泄露</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	_ <span class="string">"net/http/pprof"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 开启pprof</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ip := <span class="string">"0.0.0.0:6060"</span></span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(ip, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"start pprof failed on %s\n"</span>, ip)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	outCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	<span class="comment">// 死代码，永不读取</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="literal">false</span> &#123;</span><br><span class="line">			&lt;-outCh</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 每s起100个goroutine，goroutine会阻塞，不释放内存</span></span><br><span class="line">	tick := time.Tick(time.Second / <span class="number">100</span>)</span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> <span class="keyword">range</span> tick &#123;</span><br><span class="line">		i++</span><br><span class="line">		fmt.Println(i)</span><br><span class="line">		alloc1(outCh)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alloc1</span><span class="params">(outCh <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> alloc2(outCh)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alloc2</span><span class="params">(outCh <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> fmt.Println(<span class="string">"alloc-fm exit"</span>)</span><br><span class="line">		<span class="comment">// 分配内存，假用一下</span></span><br><span class="line">		buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">		_ = <span class="built_in">len</span>(buf)</span><br><span class="line">		fmt.Println(<span class="string">"alloc done"</span>)</span><br><span class="line"></span><br><span class="line">		outCh &lt;- <span class="number">0</span> <span class="comment">// 53行</span></span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译并运行以上代码，然后使用<code>go tool pprof</code>获取gorourine的profile文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof http://localhost:6060/debug/pprof/goroutine</span><br></pre></td></tr></table></figure>
<p>已经通过pprof命令获取了2个goroutine的profile文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">/home/ubuntu/pprof/pprof.leak_demo.goroutine.001.pb.gz</span><br><span class="line">/home/ubuntu/pprof/pprof.leak_demo.goroutine.002.pb.gz</span><br></pre></td></tr></table></figure>
<p>同heap一样，我们可以使用<code>base</code>对比2个goroutine profile文件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">go</span> tool pprof -base pprof.leak_demo.goroutine<span class="number">.001</span>.pb.gz pprof.leak_demo.goroutine<span class="number">.002</span>.pb.gz</span><br><span class="line"></span><br><span class="line">File: leak_demo</span><br><span class="line">Type: goroutine</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">2</span>:<span class="number">44</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">20312</span>, <span class="number">100</span>% of <span class="number">20312</span> total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     <span class="number">20312</span>   <span class="number">100</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.gopark</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  main.alloc2</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  main.alloc2.func1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.chansend</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.chansend1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.goparkunlock</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure>
<p>可以看到运行到<code>runtime.gopark</code>的goroutine数量增加了20312个。再通过002文件，看一眼执行到<code>gopark</code>的goroutine数量，即挂起的goroutine数量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> tool pprof pprof.leak_demo.goroutine<span class="number">.002</span>.pb.gz</span><br><span class="line">File: leak_demo</span><br><span class="line">Type: goroutine</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">2</span>:<span class="number">47</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">24330</span>, <span class="number">100</span>% of <span class="number">24331</span> total</span><br><span class="line">Dropped <span class="number">32</span> nodes (cum &lt;= <span class="number">121</span>)</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     <span class="number">24330</span>   <span class="number">100</span>%   <span class="number">100</span>%      <span class="number">24330</span>   <span class="number">100</span>%  runtime.gopark</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">24326</span>   <span class="number">100</span>%  main.alloc2</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">24326</span>   <span class="number">100</span>%  main.alloc2.func1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">24326</span>   <span class="number">100</span>%  runtime.chansend</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">24326</span>   <span class="number">100</span>%  runtime.chansend1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">24327</span>   <span class="number">100</span>%  runtime.goparkunlock</span><br></pre></td></tr></table></figure>
<p>显示有24330个goroutine被挂起，这不是goroutine泄露这是啥？已经能确定八九成goroutine泄露了。</p>
<p>是什么导致如此多的goroutine被挂起而无法退出？接下来就看怎么定位goroutine泄露。</p>
<hr>
<h1 id="定位goroutine泄露的2种方法"><a href="#定位goroutine泄露的2种方法" class="headerlink" title="定位goroutine泄露的2种方法"></a>定位goroutine泄露的2种方法</h1><p>使用pprof有2种方式，一种是web网页，一种是<code>go tool pprof</code>命令行交互，这两种方法查看goroutine都支持，但有轻微不同，也有各自的优缺点。</p>
<p>我们先看Web的方式，再看命令行交互的方式，这两种都很好使用，结合起来用也不错。</p>
<h2 id="Web可视化查看"><a href="#Web可视化查看" class="headerlink" title="Web可视化查看"></a>Web可视化查看</h2><p>Web方式适合web服务器的端口能访问的情况，使用起来方便，有2种方式：</p>
<ol>
<li><strong>查看某条调用路径上，当前阻塞在此goroutine的数量</strong></li>
<li>查看所有goroutine的运行栈（调用路径），可以<strong>显示阻塞在此的时间</strong></li>
</ol>
<h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><p>url请求中设置debug=1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:port/debug/pprof/goroutine?debug=1</span><br></pre></td></tr></table></figure></p>
<p>效果如下：</p>
<p><img src="http://img.lessisbetter.site/2019-05-image-20190516143740567-7988660.png" alt=""></p>
<p>看起来密密麻麻的，其实简单又十分有用，看上图标出来的部分，手机上图看起来可能不方便，那就放大图片，或直接看下面各字段的含义：</p>
<ol>
<li><code>goroutine profile: total 32023</code>：32023是<strong>goroutine的总数量</strong>，</li>
<li><code>32015 @ 0x42e15a 0x42e20e 0x40534b 0x4050e5 ...</code>：32015代表当前有32015个goroutine运行这个调用栈，并且停在相同位置，@后面的十六进制，现在用不到这个数据，所以暂不深究了。</li>
<li>下面是当前goroutine的<strong>调用栈</strong>，列出了<strong>函数和所在文件的行数，这个行数对定位很有帮助</strong>，如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">32015 @ 0x42e15a 0x42e20e 0x40534b 0x4050e5 0x6d8559 0x6d831b 0x45abe1</span><br><span class="line">#	0x6d8558	main.alloc2.func1+0xf8	/home/ubuntu/heap/leak_demo.go:53</span><br><span class="line">#	0x6d831a	main.alloc2+0x2a	/home/ubuntu/heap/leak_demo.go:54</span><br></pre></td></tr></table></figure>
<p>根据上面的提示，就能判断32015个goroutine运行到<code>leak_demo.go</code>的53行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alloc2</span><span class="params">(outCh <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> fmt.Println(<span class="string">"alloc-fm exit"</span>)</span><br><span class="line">		<span class="comment">// 分配内存，假用一下</span></span><br><span class="line">		buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">		_ = <span class="built_in">len</span>(buf)</span><br><span class="line">		fmt.Println(<span class="string">"alloc done"</span>)</span><br><span class="line"></span><br><span class="line">		outCh &lt;- <span class="number">0</span> <span class="comment">// 53行</span></span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>阻塞的原因是outCh这个写操作无法完成，outCh是无缓冲的通道，并且由于以下代码是死代码，所以goroutine始终没有从outCh读数据，造成outCh阻塞，进而造成无数个alloc2的goroutine阻塞，形成内存泄露：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="literal">false</span> &#123;</span><br><span class="line">    &lt;-outCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><p>url请求中设置debug=2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:port/debug/pprof/goroutine?debug=2</span><br></pre></td></tr></table></figure>
<p><img src="http://img.lessisbetter.site/2019-05-image-20190516143537339-7988537.png" alt=""></p>
<p>第2种方式和第1种方式是互补的，它可以看到每个goroutine的信息：</p>
<ol>
<li><code>goroutine 20 [chan send, 2 minutes]</code>：20是goroutine id，<code>[]</code>中是当前goroutine的状态，阻塞在写channel，并且阻塞了2分钟，长时间运行的系统，你能看到阻塞时间更长的情况。</li>
<li>同时，也可以看到调用栈，看当前执行停到哪了：<code>leak_demo.go</code>的53行，</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">goroutine <span class="number">20</span> [<span class="keyword">chan</span> send, <span class="number">2</span> minutes]:</span><br><span class="line">main.alloc2.func1(<span class="number">0xc42015e060</span>)</span><br><span class="line">	/home/ubuntu/heap/leak_demo.<span class="keyword">go</span>:<span class="number">53</span> +<span class="number">0xf9</span>  <span class="comment">// 这</span></span><br><span class="line">main.alloc2(<span class="number">0xc42015e060</span>)</span><br><span class="line">	/home/ubuntu/heap/leak_demo.<span class="keyword">go</span>:<span class="number">54</span> +<span class="number">0x2b</span></span><br><span class="line">created by main.alloc1</span><br><span class="line">	/home/ubuntu/heap/leak_demo.<span class="keyword">go</span>:<span class="number">42</span> +<span class="number">0x3f</span></span><br></pre></td></tr></table></figure>
<h2 id="命令行交互式方法"><a href="#命令行交互式方法" class="headerlink" title="命令行交互式方法"></a>命令行交互式方法</h2><p>Web的方法是简单粗暴，无需登录服务器，浏览器打开看看就行了。但就像前面提的，没有浏览器可访问时，命令行交互式才是最佳的方式，并且也是手到擒来，感觉比Web一样方便。</p>
<p>命令行交互式只有1种获取goroutine profile的方法，不像Web网页分<code>debug=1</code>和<code>debug=2</code>2中方式，并将profile文件保存到本地：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意命令没有`debug=1`，debug=1，加debug有些版本的go不支持</span></span><br><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//0.0.0.0:6060/debug/pprof/goroutine</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:6061/debug/pprof/goroutine</span></span><br><span class="line">Saved profile in /home/ubuntu/pprof/pprof.leak_demo.goroutine<span class="number">.001</span>.pb.gz  <span class="comment">// profile文件保存位置</span></span><br><span class="line">File: leak_demo</span><br><span class="line">Type: goroutine</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">2</span>:<span class="number">44</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure>
<p>命令行只需要掌握3个命令就好了，上面介绍过了，详细的倒回去看<a href="#top">top</a>, <a href="#list">list</a>, <a href="#traces">traces</a>：</p>
<ol>
<li><strong>top</strong>：显示正运行到某个函数goroutine的数量</li>
<li><strong>traces</strong>：显示所有goroutine的调用栈</li>
<li><strong>list</strong>：列出代码详细的信息。</li>
</ol>
<p>我们依然使用<code>leak_demo.go</code>这个demo，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$  <span class="keyword">go</span> tool pprof -base pprof.leak_demo.goroutine<span class="number">.001</span>.pb.gz pprof.leak_demo.goroutine<span class="number">.002</span>.pb.gz</span><br><span class="line">File: leak_demo</span><br><span class="line">Type: goroutine</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">2</span>:<span class="number">44</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">20312</span>, <span class="number">100</span>% of <span class="number">20312</span> total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     <span class="number">20312</span>   <span class="number">100</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.gopark</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  main.alloc2</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  main.alloc2.func1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.chansend</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.chansend1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%      <span class="number">20312</span>   <span class="number">100</span>%  runtime.goparkunlock</span><br><span class="line">(pprof)</span><br><span class="line">(pprof) traces</span><br><span class="line">File: leak_demo</span><br><span class="line">Type: goroutine</span><br><span class="line">Time: May <span class="number">16</span>, <span class="number">2019</span> at <span class="number">2</span>:<span class="number">44</span>pm (CST)</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">     <span class="number">20312</span>   runtime.gopark</span><br><span class="line">             runtime.goparkunlock</span><br><span class="line">             runtime.chansend</span><br><span class="line">             runtime.chansend1 <span class="comment">// channel发送</span></span><br><span class="line">             main.alloc2.func1 <span class="comment">// alloc2中的匿名函数</span></span><br><span class="line">             main.alloc2</span><br><span class="line">-----------+-------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>top命令在<a href="#怎么确定是goroutine泄露引发的内存泄露">怎么确定是goroutine泄露引发的内存泄露</a>介绍过了，直接看traces命令，traces能列出002中比001中多的那些goroutine的调用栈，这里只有1个调用栈，有20312个goroutine都执行这个调用路径，可以看到alloc2中的匿名函数<code>alloc2.func1</code>调用了写channel的操作，然后阻塞挂起了goroutine，使用list列出<code>alloc2.func1</code>的代码，显示有20312个goroutine阻塞在53行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(pprof) list main.alloc2.func1</span><br><span class="line">Total: <span class="number">20312</span></span><br><span class="line">ROUTINE ======================== main.alloc2.func1 in /home/ubuntu/heap/leak_demo.<span class="keyword">go</span></span><br><span class="line">         <span class="number">0</span>      <span class="number">20312</span> (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">48</span>:		<span class="comment">// 分配内存，假用一下</span></span><br><span class="line">         .          .     <span class="number">49</span>:		buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">         .          .     <span class="number">50</span>:		_ = <span class="built_in">len</span>(buf)</span><br><span class="line">         .          .     <span class="number">51</span>:		fmt.Println(<span class="string">"alloc done"</span>)</span><br><span class="line">         .          .     <span class="number">52</span>:</span><br><span class="line">         .      <span class="number">20312</span>     <span class="number">53</span>:		outCh &lt;- <span class="number">0</span>  <span class="comment">// 看这</span></span><br><span class="line">         .          .     <span class="number">54</span>:	&#125;()</span><br><span class="line">         .          .     <span class="number">55</span>:&#125;</span><br><span class="line">         .          .     <span class="number">56</span>:</span><br></pre></td></tr></table></figure>
<p><strong>友情提醒：使用list命令的前提是程序的源码在当前机器，不然可没法列出源码。</strong>服务器上，通常没有源码，那我们咋办呢？刚才介绍了Web查看的方式，那里会列出代码行数，我们可以使用<code>wget</code>下载网页：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://localhost:6060/debug/pprof/goroutine?debug=1</span><br></pre></td></tr></table></figure>
<p>下载网页后，使用编辑器打开文件，使用关键字<code>main.alloc2.func1</code>进行搜索，找到与当前相同的调用栈，就可以看到该goroutine阻塞在哪一行了，不要忘记使用<code>debug=2</code>还可以看到阻塞了多久和原因，Web方式中已经介绍了，此处省略代码几十行。</p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>文章略长，但全是干货，感谢阅读到这。然读到着了，跟定很想掌握pprof，建议实践一把，现在和大家温习一把本文的主要内容。</p>
<h2 id="goroutine泄露的本质"><a href="#goroutine泄露的本质" class="headerlink" title="goroutine泄露的本质"></a>goroutine泄露的本质</h2><p>goroutine泄露的本质是channel阻塞，无法继续向下执行，导致此goroutine关联的内存都无法释放，进一步造成内存泄露。</p>
<h2 id="goroutine泄露的发现和定位"><a href="#goroutine泄露的发现和定位" class="headerlink" title="goroutine泄露的发现和定位"></a>goroutine泄露的发现和定位</h2><p>利用好go pprof获取goroutine profile文件，然后利用3个命令top、traces、list定位内存泄露的原因。</p>
<h2 id="goroutine泄露的场景"><a href="#goroutine泄露的场景" class="headerlink" title="goroutine泄露的场景"></a>goroutine泄露的场景</h2><p>泄露的场景不仅限于以下两类，但因channel相关的泄露是最多的。</p>
<ol>
<li>channel的读或者写：<ol>
<li>无缓冲channel的阻塞通常是写操作因为没有读而阻塞</li>
<li>有缓冲的channel因为缓冲区满了，写操作阻塞</li>
<li>期待从channel读数据，结果没有goroutine写</li>
</ol>
</li>
<li>select操作，select里也是channel操作，如果所有case上的操作阻塞，goroutine也无法继续执行。</li>
</ol>
<h2 id="编码goroutine泄露的建议"><a href="#编码goroutine泄露的建议" class="headerlink" title="编码goroutine泄露的建议"></a>编码goroutine泄露的建议</h2><p>为避免goroutine泄露造成内存泄露，启动goroutine前要思考清楚：</p>
<ol>
<li>goroutine如何退出？</li>
<li>是否会有阻塞造成无法退出？如果有，那么这个路径是否会创建大量的goroutine？</li>
</ol>
<h1 id="示例源码"><a href="#示例源码" class="headerlink" title="示例源码"></a>示例源码</h1><p><strong>本文所有示例源码，及历史文章、代码都存储在Github，阅读原文可直接跳转</strong>，Github：<a href="https://github.com/Shitaibin/golang_step_by_step/tree/master/pprof" target="_blank" rel="noopener">https://github.com/Shitaibin/golang_step_by_step/tree/master/pprof</a> 。</p>
<h1 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h1><p>这些既是参考资料也是推荐阅读的文章，不容错过。</p>
<p>【Go Blog关于pprof详细介绍和Demo】 <a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="noopener">https://blog.golang.org/profiling-go-programs</a></p>
<p>【Dave关于高性能Go程序的workshop】 <a href="https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html#using_more_than_one_cpu" target="_blank" rel="noopener">https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html#using_more_than_one_cpu</a></p>
<p>【煎鱼pprof文章，很适合入门 Golang大杀器之性能剖析PProf】 <a href="https://segmentfault.com/a/1190000016412013" target="_blank" rel="noopener">https://segmentfault.com/a/1190000016412013</a></p>
<p>【SO上goroutine调用栈各字段的介绍】<a href="https://stackoverflow.com/a/38414527/4296218" target="_blank" rel="noopener">https://stackoverflow.com/a/38414527/4296218</a></p>
<p>【我的老文，有runtime.main的介绍，想学习调度器，可以看下系列文章 Go调度器系列（2）宏观看调度器】<a href="http://lessisbetter.site/2019/03/26/golang-scheduler-2-macro-view/">http://lessisbetter.site/2019/03/26/golang-scheduler-2-macro-view/</a></p>
<blockquote>
<ol>
<li>如果这篇文章对你有帮助，不妨关注下我的Github，有文章会收到通知。</li>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/05/18/go-goroutine-leak/">http://lessisbetter.site/2019/05/18/go-goroutine-leak/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/05/03/go-concurrent-problems1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/03/go-concurrent-problems1/" class="post-title-link" itemprop="url">Go面试题：并发</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-03 09:23:17" itemprop="dateCreated datePublished" datetime="2019-05-03T09:23:17+08:00">2019-05-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-13 16:18:50" itemprop="dateModified" datetime="2019-08-13T16:18:50+08:00">2019-08-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Once"><a href="#Once" class="headerlink" title="Once"></a>Once</h3><p>这个once的实现有没有什么问题？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Once <span class="keyword">struct</span> &#123;</span><br><span class="line">	m    sync.Mutex</span><br><span class="line">	done <span class="keyword">uint32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Once)</span> <span class="title">Do</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> o.done == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	o.m.Lock()</span><br><span class="line">	<span class="keyword">defer</span> o.m.Unlock()</span><br><span class="line">	<span class="keyword">if</span> o.done == <span class="number">0</span> &#123;</span><br><span class="line">		o.done = <span class="number">1</span></span><br><span class="line">		f()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有。讨论见这里：<a href="https://github.com/smallnest/gitalk/issues/101#issuecomment-490738912" target="_blank" rel="noopener">https://github.com/smallnest/gitalk/issues/101#issuecomment-490738912</a></p>
<p>正确的姿势是使用原子操作，原子操作在修改变量的值后，会也让其他核立马看到数据的变动。Once.Do的官方实现就使用的原子操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Once)</span> <span class="title">Do</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Slow-path.</span></span><br><span class="line">	o.m.Lock()</span><br><span class="line">	<span class="keyword">defer</span> o.m.Unlock()</span><br><span class="line">	<span class="keyword">if</span> o.done == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> atomic.StoreUint32(&amp;o.done, <span class="number">1</span>)</span><br><span class="line">		f()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于缓存，可以看鸟窝的<a href="https://colobu.com/2019/01/24/cacheline-affects-performance-in-go/" target="_blank" rel="noopener">《cacheline 对 Go 程序的影响》</a>和知乎<a href="https://zhuanlan.zhihu.com/p/31875174" target="_blank" rel="noopener">《细说Cache-L1/L2/L3/TLB》</a>。</p>
<h3 id="Wait-Group"><a href="#Wait-Group" class="headerlink" title="Wait Group"></a>Wait Group</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		time.Sleep(time.Millisecond)</span><br><span class="line">		wg.Done()</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会panic：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">panic: sync: WaitGroup is reused before previous Wait has returned</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">sync.(*WaitGroup).Wait(0xc000018090)</span><br><span class="line">	/Users/shitaibin/go/src/github.com/golang/go/src/sync/waitgroup.go:132 +0xae</span><br><span class="line">main.main()</span><br><span class="line">	/Users/shitaibin/Workspace/golang_step_by_step/problems/concurrent/waitgroup0.go:16 +0x79</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure>
<p>原因：第13行执行<code>wg.Done()</code>后，wg的计数已经变成了0，<code>wg.Wait()</code>实际以及完成并返回，14行再次使用此<code>wg.Add()</code>报错。</p>
<h3 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyMutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	count <span class="keyword">int</span></span><br><span class="line">	sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> mu MyMutex</span><br><span class="line">	mu.Lock()</span><br><span class="line">	<span class="keyword">var</span> mu2 = mu</span><br><span class="line">	mu.count++</span><br><span class="line">	mu.Unlock()</span><br><span class="line">	mu2.Lock()</span><br><span class="line">	mu2.count++</span><br><span class="line">	mu2.Unlock()</span><br><span class="line">	fmt.Println(mu.count, mu2.count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果panic：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine 1 [semacquire]:</span><br><span class="line">sync.runtime_SemacquireMutex(0xc0000180ac, 0x100ae00)</span><br><span class="line">	/Users/shitaibin/go/src/github.com/golang/go/src/runtime/sema.go:71 +0x3d</span><br><span class="line">sync.(*Mutex).Lock(0xc0000180a8)</span><br><span class="line">	/Users/shitaibin/go/src/github.com/golang/go/src/sync/mutex.go:134 +0x109</span><br><span class="line">main.main()</span><br><span class="line">	/Users/shitaibin/Workspace/golang_step_by_step/problems/concurrent/mutex0.go:19 +0xb4</span><br></pre></td></tr></table></figure>
<p>原因：<code>MyMutex</code>和<code>sync.Mutex</code>都是结构体，不包含指针，第16行根据mu新建了mu2对象，2者占用不同的内存区域，但2者的“内容”是相同的，所以mu2新建后就已经是Lock状态。第19行<code>mu2.Lock()</code>所以会死锁。</p>
<p>修改：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">gopackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyMutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	count <span class="keyword">int</span></span><br><span class="line">	sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> mu MyMutex</span><br><span class="line">	mu.Lock()</span><br><span class="line">	<span class="keyword">var</span> mu2 = mu</span><br><span class="line">	mu.count++</span><br><span class="line">	mu.Unlock()</span><br><span class="line">	mu2.Unlock() <span class="comment">// 先解锁，或新建mu2时移动到mu.Lock之前</span></span><br><span class="line">	mu2.Lock()</span><br><span class="line">	mu2.count++</span><br><span class="line">	mu2.Unlock()</span><br><span class="line">	fmt.Println(mu.count, mu2.count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Pool"><a href="#Pool" class="headerlink" title="Pool"></a>Pool</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pool = sync.Pool&#123;New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123; <span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer) &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			processRequest(<span class="number">1</span> &lt;&lt; <span class="number">28</span>) <span class="comment">// 256MiB</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				processRequest(<span class="number">1</span> &lt;&lt; <span class="number">10</span>) <span class="comment">// 1KiB</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> stats runtime.MemStats</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</span><br><span class="line">		runtime.ReadMemStats(&amp;stats)</span><br><span class="line">		fmt.Printf(<span class="string">"Cycle %d: %d MB\n"</span>, i, stats.Alloc/<span class="number">1024</span>/<span class="number">1024</span>)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		runtime.GC()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processRequest</span><span class="params">(size <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	b := pool.Get().(*bytes.Buffer)</span><br><span class="line">	time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">	b.Grow(size)</span><br><span class="line">	pool.Put(b)</span><br><span class="line">	time.Sleep(<span class="number">1</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以编译，运行时内存先暴涨，但是过一会会回收掉。结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Cycle 0: 0 MB</span><br><span class="line">Cycle 1: 256 MB</span><br><span class="line">Cycle 2: 513 MB</span><br><span class="line">Cycle 3: 769 MB</span><br><span class="line">Cycle 4: 1281 MB</span><br><span class="line">Cycle 5: 1281 MB</span><br><span class="line">Cycle 6: 1281 MB</span><br><span class="line">Cycle 7: 1537 MB</span><br><span class="line">Cycle 8: 1793 MB</span><br><span class="line">Cycle 9: 2049 MB</span><br><span class="line">Cycle 10: 2049 MB</span><br><span class="line">......</span><br><span class="line">Cycle 107: 14593 MB</span><br><span class="line">Cycle 108: 15105 MB</span><br><span class="line">Cycle 109: 2304 MB</span><br><span class="line">Cycle 110: 0 MB</span><br><span class="line">Cycle 111: 256 MB</span><br><span class="line">Cycle 112: 513 MB</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><code>sync.Pool</code>用来存放经常使用的临时对象，如果每次这些内存被GC回收，会加大GC的压力，Pool的出现就是为<strong>减缓</strong>GC的压力，而不是完全不让GC回收Pool的内存。</p>
<p>关于Pool不可错过Dave在<a href="https://dave.cheney.net/high-performance-go-workshop/gopherchina-2019.html#using_sync_pool" target="_blank" rel="noopener">高性能Go程序的这段介绍</a>。</p>
<h3 id="channel-1"><a href="#channel-1" class="headerlink" title="channel 1"></a>channel 1</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">		ch &lt;- <span class="number">1</span></span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		&lt;-ch</span><br><span class="line">	&#125;(ch)</span><br><span class="line">	c := time.Tick(<span class="number">1</span> * time.Second)</span><br><span class="line">	<span class="keyword">for</span> <span class="keyword">range</span> c &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"#goroutines: %d\n"</span>, runtime.NumGoroutine())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2个闭包goroutine可运行并结束。最后只有main和定时器协程，所以最终有2个协程在运行，持续打印<code>#goroutines: 2</code>。</p>
<h3 id="channel-2"><a href="#channel-2" class="headerlink" title="channel 2"></a>channel 2</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">var</span> count <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ch &lt;- <span class="number">1</span></span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		count++</span><br><span class="line">		<span class="built_in">close</span>(ch)</span><br><span class="line">	&#125;()</span><br><span class="line">	&lt;-ch</span><br><span class="line">	fmt.Println(count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ch只声明，未进行初始化，所以panic：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">panic: close of nil channel</span><br><span class="line"></span><br><span class="line">goroutine 34 [running]:</span><br><span class="line">main.main.func2(0xc000096000, 0x0)</span><br><span class="line">	/Users/shitaibin/Workspace/golang_step_by_step/problems/concurrent/channel1.go:13 +0x33</span><br><span class="line">created by main.main</span><br><span class="line">	/Users/shitaibin/Workspace/golang_step_by_step/problems/concurrent/channel1.go:11 +0x87</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure>
<p>修改为下面这样，还有问题吗？：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// var ch chan int</span></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	<span class="keyword">var</span> count <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ch &lt;- <span class="number">1</span></span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		count++</span><br><span class="line">		<span class="built_in">close</span>(ch)</span><br><span class="line">	&#125;()</span><br><span class="line">	&lt;-ch</span><br><span class="line">	fmt.Println(count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样会panic，典型的channel由非发送者关闭，造成在关闭的channel上写数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">panic: send on closed channel</span><br><span class="line"></span><br><span class="line">goroutine 4 [running]:</span><br><span class="line">main.main.func1(0xc000070060)</span><br><span class="line">	/Users/shitaibin/Workspace/golang_step_by_step/problems/concurrent/channel1.go:10 +0x37</span><br><span class="line">created by main.main</span><br><span class="line">	/Users/shitaibin/Workspace/golang_step_by_step/problems/concurrent/channel1.go:9 +0x80</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure>
<h3 id="Map-1"><a href="#Map-1" class="headerlink" title="Map 1"></a>Map 1</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m sync.Map</span><br><span class="line">	m.LoadOrStore(<span class="string">"a"</span>, <span class="number">1</span>)</span><br><span class="line">	m.Delete(<span class="string">"a"</span>)</span><br><span class="line">	fmt.Println(m.Len())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无法编译，因为Map没有Len()方法。</p>
<h3 id="Map-2"><a href="#Map-2" class="headerlink" title="Map 2"></a>Map 2</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">	m <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line">	sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	m.Lock()</span><br><span class="line">	<span class="keyword">defer</span> m.Unlock()</span><br><span class="line">	i, ok := m.m[key]</span><br><span class="line">	<span class="keyword">return</span> i, ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Put</span><span class="params">(key, value <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	m.Lock()</span><br><span class="line">	<span class="keyword">defer</span> m.Unlock()</span><br><span class="line">	m.m[key] = value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(m.m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	m := Map&#123;m: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)&#125;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++ &#123;</span><br><span class="line">			m.Put(i, i)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++ &#123;</span><br><span class="line">			m.Len()</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>能正常编译和运行。map不是协程安全的，需要锁的保护，但Len()的实现并没有加锁，当map写数据时，并且调用Len读长度，则存在map的并发读写问题，因为不是同时读写map所存的内容，所以可以编译和运行，但存在读取的map内存长度不准确问题。map定义和len的声明如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A header for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class="line">	<span class="comment">// Make sure this stays in sync with the compiler's definition.</span></span><br><span class="line">	count     <span class="keyword">int</span> <span class="comment">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class="line">	flags     <span class="keyword">uint8</span></span><br><span class="line">	B         <span class="keyword">uint8</span>  <span class="comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class="line">	noverflow <span class="keyword">uint16</span> <span class="comment">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class="line">	hash0     <span class="keyword">uint32</span> <span class="comment">// hash seed</span></span><br><span class="line"></span><br><span class="line">	buckets    unsafe.Pointer <span class="comment">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class="line">	oldbuckets unsafe.Pointer <span class="comment">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class="line">	nevacuate  <span class="keyword">uintptr</span>        <span class="comment">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class="line"></span><br><span class="line">	extra *mapextra <span class="comment">// optional fields</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The len built-in function returns the length of v, according to its type:</span></span><br><span class="line"><span class="comment">//	Array: the number of elements in v.</span></span><br><span class="line"><span class="comment">//	Pointer to array: the number of elements in *v (even if v is nil).</span></span><br><span class="line"><span class="comment">//	Slice, or map: the number of elements in v; if v is nil, len(v) is zero.</span></span><br><span class="line"><span class="comment">//	String: the number of bytes in v.</span></span><br><span class="line"><span class="comment">//	Channel: the number of elements queued (unread) in the channel buffer;</span></span><br><span class="line"><span class="comment">//	if v is nil, len(v) is zero.</span></span><br><span class="line"><span class="comment">// For some arguments, such as a string literal or a simple array expression, the</span></span><br><span class="line"><span class="comment">// result can be a constant. See the Go language specification's "Length and</span></span><br><span class="line"><span class="comment">// capacity" section for details.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">len</span><span class="params">(v Type)</span> <span class="title">int</span></span></span><br></pre></td></tr></table></figure>
<h3 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">var</span> ints = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">			ints = <span class="built_in">append</span>(ints, i)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">			ints = <span class="built_in">append</span>(ints, i)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(<span class="built_in">len</span>(ints))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，slice不是协程安全的，自身也又没锁的保护，多协程访问存在并发问题：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">	array unsafe.Pointer</span><br><span class="line">	<span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line">	<span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次，append中有可能还会分配新的内存空间，切片可能指向了新的内存区域：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The append built-in function appends elements to the end of a slice. If</span></span><br><span class="line"><span class="comment">// it has sufficient capacity, the destination is resliced to accommodate the</span></span><br><span class="line"><span class="comment">// new elements. If it does not, a new underlying array will be allocated.</span></span><br><span class="line"><span class="comment">// Append returns the updated slice. It is therefore necessary to store the</span></span><br><span class="line"><span class="comment">// result of append, often in the variable holding the slice itself:</span></span><br><span class="line"><span class="comment">//	slice = append(slice, elem1, elem2)</span></span><br><span class="line"><span class="comment">//	slice = append(slice, anotherSlice...)</span></span><br><span class="line"><span class="comment">// As a special case, it is legal to append a string to a byte slice, like this:</span></span><br><span class="line"><span class="comment">//	slice = append([]byte("hello "), "world"...)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(slice []Type, elems ...Type)</span> []<span class="title">Type</span></span></span><br></pre></td></tr></table></figure>
<p>所以，两个协程同时写，是不安全的，并且大概率可能存在数据丢失，所以结果可能不是2000。</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><a href="https://github.com/Shitaibin/golang_step_by_step/tree/master/problems" target="_blank" rel="noopener">golang_step_by_step</a></p>
<blockquote>
<ol>
<li>如果这篇文章对你有帮助，不妨关注下我的Github，有文章会收到通知。</li>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/05/03/go-concurrent-problems1/">http://lessisbetter.site/2019/05/03/go-concurrent-problems1/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://img.lessisbetter.site/gzh-qrcode-logo-small.png"
                alt="大彬" />
            
              <p class="site-author-name" itemprop="name">大彬</p>
              <p class="site-description motion-element" itemprop="description">区块链、Go语言</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">98</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://img.lessisbetter.site/gzh-qrcode-logo-small.png" title="公众号 &rarr; http://img.lessisbetter.site/gzh-qrcode-logo-small.png" rel="noopener" target="_blank"><i class="fa fa-fw fa-wechat"></i>公众号</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/shitaibin" title="GitHub &rarr; https://github.com/shitaibin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://segmentfault.com/u/lessisbetter" title="SegmentFault &rarr; https://segmentfault.com/u/lessisbetter" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>SegmentFault</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/947f3ccdd481" title="简书 &rarr; https://www.jianshu.com/u/947f3ccdd481" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>简书</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://stackoverflow.com/users/4296218/james-shi" title="StackOverflow &rarr; https://stackoverflow.com/users/4296218/james-shi" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:hz_stb@163.com" title="E-Mail &rarr; mailto:hz_stb@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友链
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xargin.com" title="https://xargin.com" rel="noopener" target="_blank">Xargin曹大博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://pingcap.com/blog-cn/" title="https://pingcap.com/blog-cn/" rel="noopener" target="_blank">PingCap技术博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://qcrao.github.io/" title="https://qcrao.github.io/" rel="noopener" target="_blank">码农桃花源博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://book.eddycjy.com/golang/" title="https://book.eddycjy.com/golang/" rel="noopener" target="_blank">煎鱼的迷之博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://dave.cheney.net" title="https://dave.cheney.net" rel="noopener" target="_blank">Dave Cheney的博客</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">[object Object]</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.6.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1275814754&web_id=1275814754" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.6.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  

  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
