<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lessisbetter.site","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。 fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。 Makefile文件就在fabric的">
<meta name="keywords" content="区块链,Fabric,Makefile">
<meta property="og:type" content="article">
<meta property="og:title" content="通过Fabric 1.4 的Makefile，轻松掌握Fabric构建">
<meta property="og:url" content="http://lessisbetter.site/2019/07/10/fabric-makefile/index.html">
<meta property="og:site_name" content="Go语言充电站">
<meta property="og:description" content="初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。 fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。 Makefile文件就在fabric的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://img.lessisbetter.site/2019-01-article_qrcode.jpg">
<meta property="og:updated_time" content="2019-08-28T02:45:31.746Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="通过Fabric 1.4 的Makefile，轻松掌握Fabric构建">
<meta name="twitter:description" content="初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。 fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。 Makefile文件就在fabric的">
<meta name="twitter:image" content="http://img.lessisbetter.site/2019-01-article_qrcode.jpg">

<link rel="canonical" href="http://lessisbetter.site/2019/07/10/fabric-makefile/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>通过Fabric 1.4 的Makefile，轻松掌握Fabric构建 | Go语言充电站</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Go语言充电站" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Go语言充电站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">大彬 less is better</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-主页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>主页</a>

  </li>
        <li class="menu-item menu-item-标签云">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签云</a>

  </li>
        <li class="menu-item menu-item-专题文章">

    <a href="/subject/" rel="section"><i class="fa fa-fw fa-th"></i>专题文章</a>

  </li>
        <li class="menu-item menu-item-文章列表">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>文章列表</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-大牛博客">

    <a href="/blogs/" rel="section"><i class="fa fa-fw fa-sitemap"></i>大牛博客</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/10/fabric-makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          通过Fabric 1.4 的Makefile，轻松掌握Fabric构建
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-10 07:18:48" itemprop="dateCreated datePublished" datetime="2019-07-10T07:18:48+08:00">2019-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-08-28 10:45:31" itemprop="dateModified" datetime="2019-08-28T10:45:31+08:00">2019-08-28</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。</p>
<p>fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。</p>
<p>Makefile文件就在fabric的根目录下，该文件还引入了另外2个Makefile文件：</p>
<ol>
<li>docker-env.mk，这个文件描述了Docker构建先关的信息</li>
<li>gotools.mk，这个文件描述了go tools相关的构建信息</li>
</ol>
<p>我们先介绍Makefile文件，然后介绍另外2个文件，如果想在Makefile遇到这2个文件的时候查看，可随时使用目录跳转去查看即可。</p>
<p>即使掌握了Makefile，仍然会遇到一些问题，所以最后会给出一些建议，让你少踩一些坑。</p>
<blockquote>
<p>本文基于fabric 1.4，commit id：9dce73，不同版本可能有细微差别，但不影响掌握构建过程。</p>
</blockquote>
<h1 id="Makefile详细解读"><a href="#Makefile详细解读" class="headerlink" title="Makefile详细解读"></a>Makefile详细解读</h1><p>Makefile看起来有点长，磨刀不误砍柴工，花2个小时，是非常有益处的，建议多看几遍，吃透编译流程。</p>
<h2 id="fabric的Makefile"><a href="#fabric的Makefile" class="headerlink" title="fabric的Makefile"></a>fabric的Makefile</h2><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright IBM Corp All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># -------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># This makefile defines the following targets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># make项列表</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 构建所有</span></span><br><span class="line"><span class="comment">#   - all (default) - builds all targets and runs all non-integration tests/checks</span></span><br><span class="line"><span class="comment"># 运行所有测试和检查</span></span><br><span class="line"><span class="comment">#   - checks - runs all non-integration tests/checks</span></span><br><span class="line"><span class="comment"># 运行linter和verify来检查改动的文件</span></span><br><span class="line"><span class="comment">#   - desk-check - runs linters and verify to test changed packages</span></span><br><span class="line"><span class="comment"># 构建configtxgen，主要用来创建创世块、创建通道时的配置交易、更新通道的锚点交易</span></span><br><span class="line"><span class="comment">#   - configtxgen - builds a native configtxgen binary</span></span><br><span class="line"><span class="comment"># 构建configtxlator，configtxgen生成的配置是二进制，使用configtxlator转换为json</span></span><br><span class="line"><span class="comment">#   - configtxlator - builds a native configtxlator binary</span></span><br><span class="line"><span class="comment"># 构建cryptogen，提供加解密的程序</span></span><br><span class="line"><span class="comment">#   - cryptogen  -  builds a native cryptogen binary</span></span><br><span class="line"><span class="comment"># 构建idemixgen，用来创建身份（id）混合器创建配置文件</span></span><br><span class="line"><span class="comment">#   - idemixgen  -  builds a native idemixgen binary</span></span><br><span class="line"><span class="comment"># peer节点</span></span><br><span class="line"><span class="comment">#   - peer - builds a native fabric peer binary</span></span><br><span class="line"><span class="comment"># 排序节点</span></span><br><span class="line"><span class="comment">#   - orderer - builds a native fabric orderer binary</span></span><br><span class="line"><span class="comment"># 发布当前平台的包</span></span><br><span class="line"><span class="comment">#   - release - builds release packages for the host platform</span></span><br><span class="line"><span class="comment"># 发布所有平台的包</span></span><br><span class="line"><span class="comment">#   - release-all - builds release packages for all target platforms</span></span><br><span class="line"><span class="comment"># 跑单元测试</span></span><br><span class="line"><span class="comment">#   - unit-test - runs the go-test based unit tests</span></span><br><span class="line"><span class="comment"># 对更改过的文件跑单元测试</span></span><br><span class="line"><span class="comment">#   - verify - runs unit tests for only the changed package tree</span></span><br><span class="line"><span class="comment"># 以coverprofile模式对所有pkg跑单元测试</span></span><br><span class="line"><span class="comment">#   - profile - runs unit tests for all packages in coverprofile mode (slow)</span></span><br><span class="line"><span class="comment">#   - test-cmd - generates a "go test" string suitable for manual customization</span></span><br><span class="line"><span class="comment"># 安装go tools，TODO 安装到哪，镜像还是外部GOPATH下？</span></span><br><span class="line"><span class="comment">#   - gotools - installs go tools like golint</span></span><br><span class="line"><span class="comment"># 对所有代码运行lint</span></span><br><span class="line"><span class="comment">#   - linter - runs all code checks</span></span><br><span class="line"><span class="comment"># 检查dep依赖</span></span><br><span class="line"><span class="comment">#   - check-deps - check for vendored dependencies that are no longer used</span></span><br><span class="line"><span class="comment"># 检查所有代码Apache license</span></span><br><span class="line"><span class="comment">#   - license - checks go source files for Apache license header</span></span><br><span class="line"><span class="comment"># 构建所有的native程序，包含peer，orderer等</span></span><br><span class="line"><span class="comment">#   - native - ensures all native binaries are available</span></span><br><span class="line"><span class="comment"># 构建所有的docker镜像，docker-clean为清除镜像</span></span><br><span class="line"><span class="comment">#   - docker[-clean] - ensures all docker images are available[/cleaned]</span></span><br><span class="line"><span class="comment"># 列出所有相关的docker镜像</span></span><br><span class="line"><span class="comment">#   - docker-list - generates a list of docker images that 'make docker' produces</span></span><br><span class="line"><span class="comment"># 构建peer-docker镜像</span></span><br><span class="line"><span class="comment">#   - peer-docker[-clean] - ensures the peer container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 构建orderer-docker镜像</span></span><br><span class="line"><span class="comment">#   - orderer-docker[-clean] - ensures the orderer container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 构建tools-docker镜像</span></span><br><span class="line"><span class="comment">#   - tools-docker[-clean] - ensures the tools container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 基于.proto文件生成所有的protobuf文件</span></span><br><span class="line"><span class="comment">#   - protos - generate all protobuf artifacts based on .proto files</span></span><br><span class="line"><span class="comment"># 清理所有构建数据</span></span><br><span class="line"><span class="comment">#   - clean - cleans the build area</span></span><br><span class="line"><span class="comment"># 比clean更牛，还会清理掉持久状态数据</span></span><br><span class="line"><span class="comment">#   - clean-all - superset of 'clean' that also removes persistent state</span></span><br><span class="line"><span class="comment"># 清理发布的包</span></span><br><span class="line"><span class="comment">#   - dist-clean - clean release packages for all target platforms</span></span><br><span class="line"><span class="comment"># 清理单元测试状态数据</span></span><br><span class="line"><span class="comment">#   - unit-test-clean - cleans unit test state (particularly from docker)</span></span><br><span class="line"><span class="comment"># 执行基本的检查，比如license，拼写，lint等</span></span><br><span class="line"><span class="comment">#   - basic-checks - performs basic checks like license, spelling, trailing spaces and linter</span></span><br><span class="line"><span class="comment"># CI使用的选项</span></span><br><span class="line"><span class="comment">#   - enable_ci_only_tests - triggers unit-tests in downstream jobs. Applicable only for CI not to</span></span><br><span class="line"><span class="comment">#     use in the local machine.</span></span><br><span class="line"><span class="comment"># 拉去第三方docker镜像</span></span><br><span class="line"><span class="comment">#   - docker-thirdparty - pulls thirdparty images (kafka,zookeeper,couchdb)</span></span><br><span class="line"><span class="comment"># 把所有make docker所产生的镜像，打上latest tag</span></span><br><span class="line"><span class="comment">#   - docker-tag-latest - re-tags the images made by 'make docker' with the :latest tag</span></span><br><span class="line"><span class="comment"># 把所有make docker所产生的镜像，打上stable tag</span></span><br><span class="line"><span class="comment">#   - docker-tag-stable - re-tags the images made by 'make docker' with the :stable tag</span></span><br><span class="line"><span class="comment"># 生成命令参考文档</span></span><br><span class="line"><span class="comment">#   - help-docs - generate the command reference docs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础版本</span></span><br><span class="line">BASE_VERSION = 1.4.2</span><br><span class="line"><span class="comment"># 前一个版本</span></span><br><span class="line">PREV_VERSION = 1.4.1</span><br><span class="line"><span class="comment"># chaintool版本</span></span><br><span class="line">CHAINTOOL_RELEASE=1.1.3</span><br><span class="line"><span class="comment"># 基础镜像版本</span></span><br><span class="line">BASEIMAGE_RELEASE=0.4.15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置项目名称，如果没有设置，则使用hyperledger</span></span><br><span class="line"><span class="comment"># Allow to build as a submodule setting the main project to</span></span><br><span class="line"><span class="comment"># the PROJECT_NAME env variable, for example,</span></span><br><span class="line"><span class="comment"># export PROJECT_NAME=hyperledger/fabric-test</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(PROJECT_NAME)</span>,true)</span><br><span class="line">PROJECT_NAME = <span class="variable">$(PROJECT_NAME)</span>/fabric</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">PROJECT_NAME = hyperledger/fabric</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建路径</span></span><br><span class="line"><span class="comment"># ?=指当没有指定BUILD_DIR时，才使用默认的`.build`作为构建目录</span></span><br><span class="line">BUILD_DIR ?= .build</span><br><span class="line"><span class="comment"># 未知，全文未使用</span></span><br><span class="line">NEXUS_REPO = nexus3.hyperledger.org:10001/hyperledger</span><br><span class="line"></span><br><span class="line"><span class="comment"># 额外版本：git commit号</span></span><br><span class="line">EXTRA_VERSION ?= <span class="variable">$(<span class="built_in">shell</span> git rev-parse --short HEAD)</span></span><br><span class="line"><span class="comment"># 项目版本由基础版本和额外版本组成</span></span><br><span class="line">PROJECT_VERSION=<span class="variable">$(BASE_VERSION)</span>-snapshot-<span class="variable">$(EXTRA_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go编译信息</span></span><br><span class="line"><span class="comment"># 设置包名</span></span><br><span class="line">PKGNAME = github.com/<span class="variable">$(PROJECT_NAME)</span></span><br><span class="line"><span class="comment"># CGO编译选项</span></span><br><span class="line">CGO_FLAGS = CGO_CFLAGS=<span class="string">" "</span></span><br><span class="line"><span class="comment"># 当前CPU架构</span></span><br><span class="line">ARCH=<span class="variable">$(<span class="built_in">shell</span> go env GOARCH)</span></span><br><span class="line"><span class="comment"># OS和CPU架构</span></span><br><span class="line">MARCH=<span class="variable">$(<span class="built_in">shell</span> go env GOOS)</span>-<span class="variable">$(<span class="built_in">shell</span> go env GOARCH)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go编译时传入的版本信息，主要是docker相关信息，比如</span></span><br><span class="line"><span class="comment">## var Version string = "latest"</span></span><br><span class="line"><span class="comment">## var CommitSHA string = "development build"</span></span><br><span class="line"><span class="comment">## var BaseVersion string = "0.4.15"</span></span><br><span class="line"><span class="comment">## var BaseDockerLabel string = "org.hyperledger.fabric"</span></span><br><span class="line"><span class="comment">## var DockerNamespace string = "hyperledger"</span></span><br><span class="line"><span class="comment">## var BaseDockerNamespace string = "hyperledger"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defined in common/metadata/metadata.go</span></span><br><span class="line">METADATA_VAR = Version=<span class="variable">$(BASE_VERSION)</span></span><br><span class="line">METADATA_VAR += CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span><br><span class="line">METADATA_VAR += BaseVersion=<span class="variable">$(BASEIMAGE_RELEASE)</span></span><br><span class="line">METADATA_VAR += BaseDockerLabel=<span class="variable">$(BASE_DOCKER_LABEL)</span></span><br><span class="line">METADATA_VAR += DockerNamespace=<span class="variable">$(DOCKER_NS)</span></span><br><span class="line">METADATA_VAR += BaseDockerNamespace=<span class="variable">$(BASE_DOCKER_NS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用GO_LDFLAGS设置go的ldflag信息，传入METADATA_VAR</span></span><br><span class="line"><span class="comment"># patsubst指替换通配符</span></span><br><span class="line">GO_LDFLAGS = <span class="variable">$(<span class="built_in">patsubst</span> %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line">GO_TAGS ?=</span><br><span class="line"></span><br><span class="line"><span class="comment"># chaintool下载链接</span></span><br><span class="line">CHAINTOOL_URL ?= https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/chaintool-<span class="variable">$(CHAINTOOL_RELEASE)</span>/hyperledger-fabric-chaintool-<span class="variable">$(CHAINTOOL_RELEASE)</span>.jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> GO_LDFLAGS GO_TAGS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查go、docker、git、curl这几个程序是否存在</span></span><br><span class="line">EXECUTABLES ?= go docker git curl</span><br><span class="line">K := <span class="variable">$(<span class="built_in">foreach</span> exec,<span class="variable">$(EXECUTABLES)</span>,\</span></span><br><span class="line"><span class="variable">	$(<span class="built_in">if</span> $(<span class="built_in">shell</span> which <span class="variable">$(exec)</span>)</span>,some string,<span class="variable">$(<span class="built_in">error</span> "No <span class="variable">$(exec)</span> in PATH: Check dependencies")</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go shim的依赖项，shim是chaincode的一个模块，可以先不去理解</span></span><br><span class="line">GOSHIM_DEPS = <span class="variable">$(<span class="built_in">shell</span> ./scripts/goListFiles.sh <span class="variable">$(PKGNAME)</span>/core/chaincode/shim)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># protobuf相关的文件</span></span><br><span class="line">PROTOS = <span class="variable">$(<span class="built_in">shell</span> git ls-files *.proto | grep -Ev 'vendor/|testdata/')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目文件，不包含git、样例、图片、vendor等文件</span></span><br><span class="line"><span class="comment"># No sense rebuilding when non production code is changed</span></span><br><span class="line">PROJECT_FILES = <span class="variable">$(<span class="built_in">shell</span> git ls-files  | grep -v ^test | grep -v ^unit-test | \</span></span><br><span class="line"><span class="variable">	grep -v ^.git | grep -v ^examples | grep -v ^devenv | grep -v .png$ | \</span></span><br><span class="line"><span class="variable">	grep -v ^LICENSE | grep -v ^vendor )</span></span><br><span class="line"><span class="comment"># docker镜像发布模板</span></span><br><span class="line">RELEASE_TEMPLATES = <span class="variable">$(<span class="built_in">shell</span> git ls-files | grep "release/templates")</span></span><br><span class="line"><span class="comment"># 镜像列表</span></span><br><span class="line">IMAGES = peer orderer ccenv buildenv tools</span><br><span class="line"><span class="comment"># 发布平台</span></span><br><span class="line">RELEASE_PLATFORMS = windows-amd64 darwin-amd64 linux-amd64 linux-s390x linux-ppc64le</span><br><span class="line"><span class="comment"># 发布的package</span></span><br><span class="line">RELEASE_PKGS = configtxgen cryptogen idemixgen discover configtxlator peer orderer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要发的pkg和它们的路径</span></span><br><span class="line">pkgmap.cryptogen      := <span class="variable">$(PKGNAME)</span>/common/tools/cryptogen</span><br><span class="line">pkgmap.idemixgen      := <span class="variable">$(PKGNAME)</span>/common/tools/idemixgen</span><br><span class="line">pkgmap.configtxgen    := <span class="variable">$(PKGNAME)</span>/common/tools/configtxgen</span><br><span class="line">pkgmap.configtxlator  := <span class="variable">$(PKGNAME)</span>/common/tools/configtxlator</span><br><span class="line">pkgmap.peer           := <span class="variable">$(PKGNAME)</span>/peer</span><br><span class="line">pkgmap.orderer        := <span class="variable">$(PKGNAME)</span>/orderer</span><br><span class="line">pkgmap.block-listener := <span class="variable">$(PKGNAME)</span>/examples/events/block-listener</span><br><span class="line">pkgmap.discover       := <span class="variable">$(PKGNAME)</span>/cmd/discover</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把docker-env.mk包含进来，主要是docker构建相关的选项</span></span><br><span class="line"><span class="keyword">include</span> docker-env.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># all包含/依赖了编译程序、编译镜像和进行检查</span></span><br><span class="line"><span class="comment"># all会进行检查，本地编译和发布docker镜像</span></span><br><span class="line"><span class="section">all: native docker checks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查包含/依赖了基本检查、单元测试和集成测试</span></span><br><span class="line"><span class="section">checks: basic-checks unit-test integration-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本检查指许可证、拼写和格式</span></span><br><span class="line"><span class="section">basic-checks: license spelling trailing-spaces linter check-metrics-doc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含/依赖检查和验证</span></span><br><span class="line"><span class="section">desk-check: checks verify</span></span><br><span class="line"></span><br><span class="line"><span class="section">help-docs: native</span></span><br><span class="line">	@scripts/generateHelpDocs.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取第三方镜像，并打上tag，BASE_DOCKER_TAG定义在docker-env.mk</span></span><br><span class="line"><span class="comment"># 都是fabric定制的couchdb、zookeeper、kafka镜像</span></span><br><span class="line"><span class="comment"># Pull thirdparty docker images based on the latest baseimage release version</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: docker-thirdparty</span></span><br><span class="line"><span class="section">docker-thirdparty:</span></span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-couchdb:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-couchdb:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-couchdb</span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-zookeeper:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-zookeeper:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-zookeeper</span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-kafka:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-kafka:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-kafka</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行拼写检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: spelling</span></span><br><span class="line"><span class="section">spelling:</span></span><br><span class="line">	@scripts/check_spelling.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行许可证检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: license</span></span><br><span class="line"><span class="section">license:</span></span><br><span class="line">	@scripts/check_license.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行末尾空格检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: trailing-spaces</span></span><br><span class="line"><span class="section">trailing-spaces:</span></span><br><span class="line">	@scripts/check_trailingspaces.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含gotools.mk，这个文件主要用来安装一些gotools，可以使用单个命令来装某个gotools，比如安装dep</span></span><br><span class="line"><span class="comment"># `make gotool.dep`，具体见该文件</span></span><br><span class="line"><span class="keyword">include</span> gotools.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际调用gotools-install安装相关的gotools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools</span></span><br><span class="line"><span class="section">gotools: gotools-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下这段设置是各程序的依赖</span></span><br><span class="line"><span class="comment"># 编译peer，依赖./build/bin/peer</span></span><br><span class="line"><span class="comment"># 编译peer-docker，依赖./build/image/peer/$(DUMMY)，DUMMY指DOCKER-TAG，定义在docker-env.mk</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: peer</span></span><br><span class="line"><span class="section">peer: <span class="variable">$(BUILD_DIR)</span>/bin/peer</span></span><br><span class="line"><span class="section">peer-docker: <span class="variable">$(BUILD_DIR)</span>/image/peer/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># orderer和镜像的依赖</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: orderer</span></span><br><span class="line"><span class="section">orderer: <span class="variable">$(BUILD_DIR)</span>/bin/orderer</span></span><br><span class="line"><span class="section">orderer-docker: <span class="variable">$(BUILD_DIR)</span>/image/orderer/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译configtxgen的依赖</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: configtxgen</span></span><br><span class="line"><span class="section">configtxgen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">configtxgen: <span class="variable">$(BUILD_DIR)</span>/bin/configtxgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译configtxlator的依赖</span></span><br><span class="line"><span class="section">configtxlator: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">configtxlator: <span class="variable">$(BUILD_DIR)</span>/bin/configtxlator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译cryptogen的依赖</span></span><br><span class="line"><span class="section">cryptogen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">cryptogen: <span class="variable">$(BUILD_DIR)</span>/bin/cryptogen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译idemixgen的依赖</span></span><br><span class="line"><span class="section">idemixgen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">idemixgen: <span class="variable">$(BUILD_DIR)</span>/bin/idemixgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译discover的依赖</span></span><br><span class="line"><span class="section">discover: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.Version=<span class="variable">$(PROJECT_VERSION)</span></span></span><br><span class="line"><span class="section">discover: <span class="variable">$(BUILD_DIR)</span>/bin/discover</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译tools相关的docker</span></span><br><span class="line"><span class="section">tools-docker: <span class="variable">$(BUILD_DIR)</span>/image/tools/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建环境（buildenv)镜像</span></span><br><span class="line"><span class="section">buildenv: <span class="variable">$(BUILD_DIR)</span>/image/buildenv/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 未知</span></span><br><span class="line"><span class="section">ccenv: <span class="variable">$(BUILD_DIR)</span>/image/ccenv/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行集成测试</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: integration-test</span></span><br><span class="line"><span class="section">integration-test: gotool.ginkgo ccenv docker-thirdparty</span></span><br><span class="line">	./scripts/run-integration-tests.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行单元测试</span></span><br><span class="line"><span class="section">unit-test: unit-test-clean peer-docker docker-thirdparty ccenv</span></span><br><span class="line">	unit-test/run.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行单元测试</span></span><br><span class="line"><span class="section">unit-tests: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CI选项</span></span><br><span class="line"><span class="section">enable_ci_only_tests: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行verify，就像注释说的，依然是单元测试</span></span><br><span class="line"><span class="section">verify: export JOB_TYPE=VERIFY</span></span><br><span class="line"><span class="section">verify: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行带有profile的单元测试</span></span><br><span class="line"><span class="section">profile: export JOB_TYPE=PROFILE</span></span><br><span class="line"><span class="section">profile: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generates a string to the terminal suitable for manual augmentation / re-issue, useful for running tests by hand</span></span><br><span class="line"><span class="section">test-cmd:</span></span><br><span class="line">	@echo <span class="string">"go test -tags \"<span class="variable">$(GO_TAGS)\"</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译所有docker镜像，依赖都是.build/image下</span></span><br><span class="line"><span class="section">docker: $(patsubst %,<span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译所有native程序，native指所有fabric本身的程序，依赖如下</span></span><br><span class="line"><span class="section">native: peer orderer configtxgen cryptogen idemixgen configtxlator discover</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行linter</span></span><br><span class="line"><span class="section">linter: check-deps buildenv</span></span><br><span class="line">	@echo <span class="string">"LINT: Running code checks.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/golinter.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行check-deps</span></span><br><span class="line"><span class="section">check-deps: buildenv</span></span><br><span class="line">	@echo <span class="string">"DEP: Checking for dependency issues.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/check_deps.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行check-metrics-doc</span></span><br><span class="line"><span class="section">check-metrics-doc: buildenv</span></span><br><span class="line">	@echo <span class="string">"METRICS: Checking for outdated reference documentation.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/metrics_doc.sh check</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行generate-metrics-doc</span></span><br><span class="line"><span class="section">generate-metrics-doc: buildenv</span></span><br><span class="line">	@echo <span class="string">"Generating metrics reference documentation..."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/metrics_doc.sh generate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装chain tool</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%/chaintool: Makefile</span><br><span class="line">	@echo <span class="string">"Installing chaintool"</span></span><br><span class="line">	@mkdir -p $(@D)</span><br><span class="line">	curl -fL <span class="variable">$(CHAINTOOL_URL)</span> &gt; <span class="variable">$@</span></span><br><span class="line">	chmod +x <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We (re)build a package within a docker context but persist the $GOPATH/pkg</span></span><br><span class="line"><span class="comment"># directory so that subsequent builds are faster</span></span><br><span class="line"><span class="comment"># 构建所有镜像和pkg</span></span><br><span class="line"><span class="comment"># DRUN是`docker run`和参数的简写</span></span><br><span class="line"><span class="comment"># 本地创建docker里要用到的gopath目录，然后挂载到docker里</span></span><br><span class="line"><span class="comment"># 然后在docker里按个编译pkgmap里面的程序，比如peer、orderer、cryptogen等等</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/bin/%: <span class="variable">$(PROJECT_FILES)</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/docker/bin/%,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span>"</span></span><br><span class="line">	@mkdir -p <span class="variable">$(BUILD_DIR)</span>/docker/bin <span class="variable">$(BUILD_DIR)</span>/docker/<span class="variable">$(TARGET)</span>/pkg</span><br><span class="line">	@<span class="variable">$(DRUN)</span> \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(BUILD_DIR)</span>/docker/bin)</span>:/opt/gopath/bin \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(BUILD_DIR)</span>/docker/<span class="variable">$(TARGET)</span>/pkg)</span>:/opt/gopath/pkg \</span><br><span class="line">		<span class="variable">$(BASE_DOCKER_NS)</span>/fabric-baseimage:<span class="variable">$(BASE_DOCKER_TAG)</span> \</span><br><span class="line">		go install -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(DOCKER_GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建本地bin目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/bin:</span><br><span class="line">	mkdir -p <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行changelog</span></span><br><span class="line"><span class="section">changelog:</span></span><br><span class="line">	./scripts/changelog.sh v<span class="variable">$(PREV_VERSION)</span> v<span class="variable">$(BASE_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># protoc-gen-go依赖.build/docker/gotools</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go: <span class="variable">$(BUILD_DIR)</span>/docker/gotools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建go tools的docker镜像，给payload使用</span></span><br><span class="line"><span class="comment"># 创建本地目录(.build/docker/gotools)并挂载到(/opt/gotools)，依赖基础镜像，然后在docker中执行gotools.mk</span></span><br><span class="line"><span class="comment"># 最后调用gotools.mk生成程序，设置了GOTOOLS_BINDIR，生成的二进制会放在这个目录，因为这个目录映射了出来，</span></span><br><span class="line"><span class="comment"># 所以bin就在主机的`.build/docker/gotools/bin/`目录</span></span><br><span class="line"><span class="comment"># So, 如果构建成功，不需要像其他文章说的那样，需要手动拷贝protoc-gen-go到`.build/docker/gotools/bin/`目录</span></span><br><span class="line"><span class="comment"># 但是，如果翻墙失败，可以考虑手动复制protoc-gen-go的方式</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/gotools: gotools.mk</span><br><span class="line">	@echo <span class="string">"Building dockerized gotools"</span></span><br><span class="line">	@mkdir -p <span class="variable">$@</span>/bin <span class="variable">$@</span>/obj</span><br><span class="line">	@<span class="variable">$(DRUN)</span> \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span>:/opt/gotools \</span><br><span class="line">		-w /opt/gopath/src/<span class="variable">$(PKGNAME)</span> \</span><br><span class="line">		<span class="variable">$(BASE_DOCKER_NS)</span>/fabric-baseimage:<span class="variable">$(BASE_DOCKER_TAG)</span> \</span><br><span class="line">		make -f gotools.mk GOTOOLS_BINDIR=/opt/gotools/bin GOTOOLS_GOPATH=/opt/gotools/obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建本地的运行文件，依赖设置都在上面了，这是进行构建，与Docker类似</span></span><br><span class="line"><span class="comment"># 程序即pkgmap中的程序</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/bin/%: <span class="variable">$(PROJECT_FILES)</span></span><br><span class="line">	@mkdir -p $(@D)</span><br><span class="line">	@echo <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> $(@D)</span>) go install -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line">	@echo <span class="string">"Binary available as <span class="variable">$@</span>"</span></span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置各镜像各自的payload文件</span></span><br><span class="line"><span class="comment"># 比如ccenv的payload拷贝会翻译成：cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span></span><br><span class="line"><span class="comment"># payload definitions'</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/ccenv/payload:      <span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/bin/chaintool \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/peer/payload:       <span class="variable">$(BUILD_DIR)</span>/docker/bin/peer \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/orderer/payload:    <span class="variable">$(BUILD_DIR)</span>/docker/bin/orderer \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/buildenv/payload:   <span class="variable">$(BUILD_DIR)</span>/gotools.tar.bz2 \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 各镜像payload的实际拷贝</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/payload:</span><br><span class="line">	mkdir -p <span class="variable">$@</span></span><br><span class="line">	cp <span class="variable">$^</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">.PRECIOUS: <span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据image下的各目录中的Dockerfile.in生成对应的Dockerfile</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile: images/%/Dockerfile.in</span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	@cat <span class="variable">$&lt;</span> \</span><br><span class="line">		| sed -e 's|_BASE_NS_|<span class="variable">$(BASE_DOCKER_NS)</span>|g' \</span><br><span class="line">		| sed -e 's|_NS_|<span class="variable">$(DOCKER_NS)</span>|g' \</span><br><span class="line">		| sed -e 's|_BASE_TAG_|<span class="variable">$(BASE_DOCKER_TAG)</span>|g' \</span><br><span class="line">		| sed -e 's|_TAG_|<span class="variable">$(DOCKER_TAG)</span>|g' \</span><br><span class="line">		&gt; <span class="variable">$@</span></span><br><span class="line">	@echo LABEL <span class="variable">$(BASE_DOCKER_LABEL)</span>.version=<span class="variable">$(BASE_VERSION)</span> \\&gt;&gt;<span class="variable">$@</span></span><br><span class="line">	@echo <span class="string">"     "</span> <span class="variable">$(BASE_DOCKER_LABEL)</span>.base.version=<span class="variable">$(BASEIMAGE_RELEASE)</span>&gt;&gt;<span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Dockerfile生成tools-image，并打上2个tag，分别是当前版本tag和latest tag</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/tools/<span class="variable">$(DUMMY)</span>: <span class="variable">$(BUILD_DIR)</span>/image/tools/Dockerfile</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building docker <span class="variable">$(TARGET)</span>-image"</span></span><br><span class="line">	<span class="variable">$(DBUILD)</span> -t <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> -f $(@D)/Dockerfile .</span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-latest</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Dockerfile、payload生成image下的所有镜像，比如orderer，然后打上tag</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>: Makefile <span class="variable">$(BUILD_DIR)</span>/image/%/payload <span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building docker <span class="variable">$(TARGET)</span>-image"</span></span><br><span class="line">	<span class="variable">$(DBUILD)</span> -t <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> $(@D)</span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-latest</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包gotools</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/gotools.tar.bz2: <span class="variable">$(BUILD_DIR)</span>/docker/gotools</span><br><span class="line">	(cd <span class="variable">$&lt;</span>/bin &amp;&amp; tar -jc *) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包goshim</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2: <span class="variable">$(GOSHIM_DEPS)</span></span><br><span class="line">	@echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">	@tar -jhc -C <span class="variable">$(GOPATH)</span>/src <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(GOPATH)</span>/src/%,%,<span class="variable">$(GOSHIM_DEPS)</span>)</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包sampleconfig</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2: <span class="variable">$(<span class="built_in">shell</span> find sampleconfig -type f)</span></span><br><span class="line">	(cd sampleconfig &amp;&amp; tar -jc *) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包protos</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/protos.tar.bz2: <span class="variable">$(PROTOS)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.tar.bz2:</span><br><span class="line">	@echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">	@tar -jc <span class="variable">$^</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布当前平台的relase包</span></span><br><span class="line"><span class="comment"># builds release packages for the host platform</span></span><br><span class="line"><span class="section">release: $(patsubst %,release/%, <span class="variable">$(MARCH)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># builds release packages for all target platforms</span></span><br><span class="line"><span class="section">release-all: $(patsubst %,release/%, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"></span><br><span class="line"><span class="section">release/windows-amd64: GOOS=windows</span></span><br><span class="line"><span class="section">release/windows-amd64: $(patsubst %,release/windows-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/darwin-amd64: GOOS=darwin</span></span><br><span class="line"><span class="section">release/darwin-amd64: $(patsubst %,release/darwin-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-amd64: GOOS=linux</span></span><br><span class="line"><span class="section">release/linux-amd64: $(patsubst %,release/linux-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%-amd64: GOARCH=amd64</span></span><br><span class="line"><span class="section">release/linux-%: GOOS=linux</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-s390x: GOARCH=s390x</span></span><br><span class="line"><span class="section">release/linux-s390x: $(patsubst %,release/linux-s390x/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-ppc64le: GOARCH=ppc64le</span></span><br><span class="line"><span class="section">release/linux-ppc64le: $(patsubst %,release/linux-ppc64le/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/configtxlator: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/configtxgen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/cryptogen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/idemixgen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/discover: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/orderer: GO_LDFLAGS = $(patsubst %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/orderer: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/peer: GO_LDFLAGS = $(patsubst %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/peer: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: dist</span></span><br><span class="line"><span class="section">dist: dist-clean dist/<span class="variable">$(MARCH)</span></span></span><br><span class="line"></span><br><span class="line"><span class="section">dist-all: dist-clean $(patsubst %,dist/%, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist/%: release/%</span></span><br><span class="line">	mkdir -p release/$(@F)/config</span><br><span class="line">	cp -r sampleconfig/*.yaml release/$(@F)/config</span><br><span class="line">	cd release/$(@F) &amp;&amp; tar -czvf hyperledger-fabric-$(@F).<span class="variable">$(PROJECT_VERSION)</span>.tar.gz *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在docker中生成protobuf文件</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: protos</span></span><br><span class="line"><span class="section">protos: buildenv</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/compile_protos.sh</span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-list:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-list,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出当前所有镜像</span></span><br><span class="line"><span class="section">docker-list: $(patsubst %,%-docker-list, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-clean:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-clean,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	-docker images --quiet --filter=reference='<span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-<span class="variable">$(BASE_VERSION)</span><span class="variable">$(<span class="built_in">if</span> <span class="variable">$(EXTRA_VERSION)</span>,-snapshot-*,)</span>' | xargs docker rmi -f</span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span>/image/<span class="variable">$(TARGET)</span> ||:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有镜像</span></span><br><span class="line"><span class="section">docker-clean: $(patsubst %,%-docker-clean, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">docker-tag-latest: $(IMAGES:%=%-docker-tag-latest)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-tag-latest:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-tag-latest,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:latest</span><br><span class="line"></span><br><span class="line"><span class="section">docker-tag-stable: $(IMAGES:%=%-docker-tag-stable)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-tag-stable:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-tag-stable,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:stable</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: docker-clean unit-test-clean release-clean</span></span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有状态数据，依赖tools清理，发包清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean-all</span></span><br><span class="line"><span class="section">clean-all: clean gotools-clean dist-clean</span></span><br><span class="line">	-@rm -rf /var/hyperledger/*</span><br><span class="line">	-@rm -rf docs/build/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布版本清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: dist-clean</span></span><br><span class="line"><span class="section">dist-clean:</span></span><br><span class="line">	-@rm -rf release/windows-amd64/hyperledger-fabric-windows-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/darwin-amd64/hyperledger-fabric-darwin-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-amd64/hyperledger-fabric-linux-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-s390x/hyperledger-fabric-linux-s390x.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-ppc64le/hyperledger-fabric-linux-ppc64le.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="section">%-release-clean:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-release-clean,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	-@rm -rf release/<span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发包清理</span></span><br><span class="line"><span class="section">release-clean: $(patsubst %,%-release-clean, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单元测试清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: unit-test-clean</span></span><br><span class="line"><span class="section">unit-test-clean:</span></span><br><span class="line">	cd unit-test &amp;&amp; docker-compose down</span><br></pre></td></tr></table></figure>
<h2 id="docker-env的Makefile"><a href="#docker-env的Makefile" class="headerlink" title="docker env的Makefile"></a>docker env的Makefile</h2><p><code>docker-env.mk</code>主要是Docker镜像构建相关的设置。</p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">// docker-env.mk</span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mac上设置--user选项</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> uname)</span>,Darwin)</span><br><span class="line">DOCKER_RUN_FLAGS=--user=<span class="variable">$(<span class="built_in">shell</span> id -u)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 架构是s390x，uid不是0（root账号）的时候，-v选项</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">shell</span> uname -m)</span>,s390x)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> id -u)</span>,0)</span><br><span class="line">DOCKER_RUN_FLAGS+=-v /etc/passwd:/etc/passwd:ro</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下是http和https的代理设置</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(http_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'http_proxy=<span class="variable">$(http_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'http_proxy=<span class="variable">$(http_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(https_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'https_proxy=<span class="variable">$(https_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'https_proxy=<span class="variable">$(https_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(HTTP_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'HTTP_PROXY=<span class="variable">$(HTTP_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'HTTP_PROXY=<span class="variable">$(HTTP_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(HTTPS_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'HTTPS_PROXY=<span class="variable">$(HTTPS_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'HTTPS_PROXY=<span class="variable">$(HTTPS_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(no_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'no_proxy=<span class="variable">$(no_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'no_proxy=<span class="variable">$(no_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(NO_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'NO_PROXY=<span class="variable">$(NO_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'NO_PROXY=<span class="variable">$(NO_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DRUN代表docker run，并伴随以下参数，把当前路径映射到容器的gopath对应路径下</span></span><br><span class="line"><span class="comment"># 并且设置容器内的工作目录</span></span><br><span class="line">DRUN = docker run -i --rm <span class="variable">$(DOCKER_RUN_FLAGS)</span> \</span><br><span class="line">	-v <span class="variable">$(<span class="built_in">abspath</span> .)</span>:/opt/gopath/src/<span class="variable">$(PKGNAME)</span> \</span><br><span class="line">	-w /opt/gopath/src/<span class="variable">$(PKGNAME)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker build</span></span><br><span class="line">DBUILD = docker build <span class="variable">$(DOCKER_BUILD_FLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础docker namespace设置时，使用hyperledger</span></span><br><span class="line">BASE_DOCKER_NS ?= hyperledger</span><br><span class="line"><span class="comment"># 基础docker tag，由arch和release组成docker tag</span></span><br><span class="line">BASE_DOCKER_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(BASEIMAGE_RELEASE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与上面类似</span></span><br><span class="line">DOCKER_NS ?= hyperledger</span><br><span class="line">DOCKER_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line">PREV_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(PREV_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础镜像标签</span></span><br><span class="line">BASE_DOCKER_LABEL=org.hyperledger.fabric</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态连接信息</span></span><br><span class="line">DOCKER_DYNAMIC_LINK ?= false</span><br><span class="line"><span class="comment"># Docker内的ldfalgs信息，继承makefile的</span></span><br><span class="line">DOCKER_GO_LDFLAGS += <span class="variable">$(GO_LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DOCKER_DYNAMIC_LINK)</span>,false)</span><br><span class="line">DOCKER_GO_LDFLAGS += -linkmode external -extldflags '-static -lpthread'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># What is a .dummy file?</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make is designed to work with files.  It uses the presence (or lack thereof)</span></span><br><span class="line"><span class="comment"># and timestamps of files when deciding if a given target needs to be rebuilt.</span></span><br><span class="line"><span class="comment"># Docker containers throw a wrench into the works because the output of docker</span></span><br><span class="line"><span class="comment"># builds do not translate into standard files that makefile rules can evaluate.</span></span><br><span class="line"><span class="comment"># Therefore, we have to fake it.  We do this by constructioning our rules such</span></span><br><span class="line"><span class="comment"># as</span></span><br><span class="line"><span class="comment">#       my-docker-target/.dummy:</span></span><br><span class="line"><span class="comment">#              docker build ...</span></span><br><span class="line"><span class="comment">#              touch $@</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If the docker-build succeeds, the touch operation creates/updates the .dummy</span></span><br><span class="line"><span class="comment"># file.  If it fails, the touch command never runs.  This means the .dummy</span></span><br><span class="line"><span class="comment"># file follows relatively 1:1 with the underlying container.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This isn't perfect, however.  For instance, someone could delete a docker</span></span><br><span class="line"><span class="comment"># container using docker-rmi outside of the build, and make would be fooled</span></span><br><span class="line"><span class="comment"># into thinking the dependency is statisfied when it really isn't.  This is</span></span><br><span class="line"><span class="comment"># our closest approximation we can come up with.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># As an aside, also note that we incorporate the version number in the .dummy</span></span><br><span class="line"><span class="comment"># file to differentiate different tags to fix FAB-1145</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">DUMMY = .dummy-<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make是跟文件打交道的，它使用文件位置（？）和时间戳觉得是否要重新构建文件。</span></span><br><span class="line"><span class="comment"># 但Docker容器产生的文件是make无法识别的。所以做了适配，docker build运行</span></span><br><span class="line"><span class="comment"># 成功时，touch回去创建或更新dummy文件，如果失败则touch不执行。</span></span><br><span class="line"><span class="comment"># 这样保证了dummy文件和容器保持一对一的关系。</span></span><br></pre></td></tr></table></figure>
<h2 id="go-tools的Makefile"><a href="#go-tools的Makefile" class="headerlink" title="go tools的Makefile"></a>go tools的Makefile</h2><p>gotools指的一些列go语言的工具，并不是golang/tools仓库，具体是哪些tools，请看Makefile文件解析。</p>
<p>这些tools的安装有2种方式：</p>
<ol>
<li>少数几个支持从vendor目录直接安装</li>
<li>默认方式是使用go get方式安装，所以请<strong>翻墙</strong></li>
</ol>
<p>另外，gotools.mk实际是在docker中运行的，也就是生成的程序都在docker镜像中，在当前host并没有运行，具体看gotools.mk调用的地方。调用处把GOBIN设置为了<code>.build/docker/gotools/bin</code>，并映射到了docker，构建后可以查看生成的程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ls .build/docker/gotools/bin</span><br><span class="line">counterfeiter  dep  ginkgo  gocov  gocov-xml  goimports  golint  manifest-tool  misspell  mockery  protoc-gen-go</span><br></pre></td></tr></table></figure>
<p>Makefile注释：</p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// gotools.mk</span><br><span class="line"><span class="comment"># Copyright IBM Corp All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有相关的tools，之所以叫go tools，因为是Go语言的，并不是指golang/tools仓库</span></span><br><span class="line">GOTOOLS = counterfeiter dep golint goimports protoc-gen-go ginkgo gocov gocov-xml misspell mockery manifest-tool</span><br><span class="line"><span class="comment"># 构建目录与Makefile保持一致</span></span><br><span class="line">BUILD_DIR ?= .build</span><br><span class="line"><span class="comment"># 构建gotools是的GOPATH，也就源码所在目录，当未设置时，使用默认路径</span></span><br><span class="line">GOTOOLS_GOPATH ?= <span class="variable">$(BUILD_DIR)</span>/gotools</span><br><span class="line"><span class="comment"># gotools的生成二进制位置，当未设置时，使用GOPATH/bin</span></span><br><span class="line">GOTOOLS_BINDIR ?= <span class="variable">$(GOPATH)</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个tool的目录映射</span></span><br><span class="line"><span class="comment"># go tool-&gt;path mapping</span></span><br><span class="line">go.fqp.counterfeiter := github.com/maxbrunsfeld/counterfeiter</span><br><span class="line">go.fqp.gocov         := github.com/axw/gocov/gocov</span><br><span class="line">go.fqp.gocov-xml     := github.com/AlekSi/gocov-xml</span><br><span class="line">go.fqp.goimports     := golang.org/x/tools/cmd/goimports</span><br><span class="line">go.fqp.golint        := golang.org/x/lint/golint</span><br><span class="line">go.fqp.manifest-tool := github.com/estesp/manifest-tool</span><br><span class="line">go.fqp.misspell      := github.com/client9/misspell/cmd/misspell</span><br><span class="line">go.fqp.mockery       := github.com/vektra/mockery/cmd/mockery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装所有tools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools-install</span></span><br><span class="line"><span class="section">gotools-install: $(patsubst %,<span class="variable">$(GOTOOLS_BINDIR)</span>/%, <span class="variable">$(GOTOOLS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理tools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools-clean</span></span><br><span class="line"><span class="section">gotools-clean:</span></span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span>/gotools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用vendor中的版本构建部分tools，比如protoc-gen-go，ginkgo，goimports，golint</span></span><br><span class="line"><span class="comment"># Special override for protoc-gen-go since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.protoc-gen-go:</span></span><br><span class="line">	@echo <span class="string">"Building github.com/golang/protobuf/protoc-gen-go -&gt; protoc-gen-go"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/github.com/golang/protobuf/protoc-gen-go</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for ginkgo since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.ginkgo:</span></span><br><span class="line">	@echo <span class="string">"Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for goimports since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.goimports:</span></span><br><span class="line">	@echo <span class="string">"Building golang.org/x/tools/cmd/goimports -&gt; goimports"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for golint since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.golint:</span></span><br><span class="line">	@echo <span class="string">"Building golang.org/x/lint/golint -&gt; golint"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/golang.org/x/lint/golint</span><br><span class="line"></span><br><span class="line"><span class="comment"># go dep的构建，使用特定版本</span></span><br><span class="line"><span class="comment"># Lock to a versioned dep</span></span><br><span class="line"><span class="section">gotool.dep: DEP_VERSION ?= "v0.5.1"</span></span><br><span class="line"><span class="section">gotool.dep:</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> go get -d -u github.com/golang/dep</span><br><span class="line">	@git -C <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span>/src/github.com/golang/dep checkout -q <span class="variable">$(DEP_VERSION)</span></span><br><span class="line">	@echo <span class="string">"Building github.com/golang/dep <span class="variable">$(DEP_VERSION)</span> -&gt; dep"</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install -ldflags=<span class="string">"-X main.version=<span class="variable">$(DEP_VERSION)</span> -X main.buildDate=$$(date '+%Y-%m-%d')"</span> github.com/golang/dep/cmd/dep</span><br><span class="line">	@git -C <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span>/src/github.com/golang/dep checkout -q master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有tools构建时的默认安装方式，会使用go get从网络拉去</span></span><br><span class="line"><span class="comment"># Default rule for gotools uses the name-&gt;path map for a generic 'go get' style build</span></span><br><span class="line"><span class="section">gotool.%:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TOOL = $&#123;<span class="built_in">subst</span> gotool.,,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building $&#123;go.fqp.$&#123;TOOL&#125;&#125; -&gt; <span class="variable">$(TOOL)</span>"</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go get $&#123;go.fqp.$&#123;TOOL&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$(GOTOOLS_BINDIR)</span>/%:</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TOOL = $&#123;<span class="built_in">subst</span> <span class="variable">$(GOTOOLS_BINDIR)</span>/,,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@<span class="variable">$(MAKE)</span> -f gotools.mk gotool.<span class="variable">$(TOOL)</span></span><br></pre></td></tr></table></figure>
<h1 id="构建建议"><a href="#构建建议" class="headerlink" title="构建建议"></a>构建建议</h1><p>列出几条构建建议，建议在make前先做好，会提高构建效率，并且少采坑。</p>
<h2 id="翻墙"><a href="#翻墙" class="headerlink" title="翻墙"></a>翻墙</h2><p>设置好翻墙，包括http和https代理，以便能下载Github，golang.org的包，参考<a href="http://lessisbetter.site/2018/09/06/Science-and-the-Internet/">让终端科学上网</a>。</p>
<blockquote>
<p>发文时fabric还使用的vendor，如果限制fabric已经使用go mod了，建议配置国内go modules代理，这样就无需翻墙了，参考本文<a href="#结束语">结束语</a>。</p>
</blockquote>
<h2 id="Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"><a href="#Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源" class="headerlink" title="Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"></a>Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源</h2><p>参考<a href="http://lessisbetter.site/2019/07/13/fast-mirrors/">让镜像飞，加速你的开发</a>。</p>
<h2 id="docker设置为国内的源"><a href="#docker设置为国内的源" class="headerlink" title="docker设置为国内的源"></a>docker设置为国内的源</h2><p>参考<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html" target="_blank" rel="noopener">Docker镜像加速</a>。</p>
<h2 id="检查GOPATH和PATH，以及http代理"><a href="#检查GOPATH和PATH，以及http代理" class="headerlink" title="检查GOPATH和PATH，以及http代理"></a>检查GOPATH和PATH，以及http代理</h2><p>确保配置正确：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo $http_proxy</span><br><span class="line">echo $https_proxy</span><br><span class="line">echo $GOPATH</span><br><span class="line">echo $PATH</span><br></pre></td></tr></table></figure>
<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><p>centos7下请参考：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></p>
<h2 id="Mac上安装Gnu-tar"><a href="#Mac上安装Gnu-tar" class="headerlink" title="Mac上安装Gnu-tar"></a>Mac上安装Gnu-tar</h2><p>如果未安装，可能遇到下面的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Step 3/5 : ADD payload/goshim.tar.bz2 $GOPATH/src/</span><br><span class="line">failed to copy files: Error processing tar file(bzip2 data invalid: bad magic value in continuation file):</span><br><span class="line">make: [build/image/ccenv/.dummy-x86_64-1.0.7-snapshot-ac3fabd] Error 1</span><br></pre></td></tr></table></figure>
<p>需要安装gnu-tar，用gnu-tar替换mac默认的bsdtar，可以用brew list gnu-tar找到gnu-tar的位置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ brew install gnu-tar</span><br><span class="line">➜  fabric git:(yx-release-1.4) ✗ brew install gnu-tar</span><br><span class="line">==&gt; Reinstalling gnu-tar</span><br><span class="line">==&gt; Downloading https://mirrors.cloud.tencent.com/homebrew-bottles/bottles/gnu-tar-1.32.mojave.bottle.tar.gz</span><br><span class="line">######################################################################## 100.0%</span><br><span class="line">==&gt; Pouring gnu-tar-1.32.mojave.bottle.tar.gz</span><br><span class="line">==&gt; Caveats</span><br><span class="line">GNU &quot;tar&quot; has been installed as &quot;gtar&quot;.</span><br><span class="line">If you need to use it as &quot;tar&quot;, you can add a &quot;gnubin&quot; directory</span><br><span class="line">to your PATH from your bashrc like:</span><br><span class="line"></span><br><span class="line">    PATH=&quot;/usr/local/opt/gnu-tar/libexec/gnubin:$PATH&quot;</span><br><span class="line">==&gt; Summary</span><br><span class="line">🍺  /usr/local/Cellar/gnu-tar/1.32: 15 files, 1.7MB</span><br><span class="line">$ which tar</span><br><span class="line">/usr/local/opt/gnu-tar/libexec/gnubin/tar</span><br></pre></td></tr></table></figure>
<p>按提示设置PATH才可以使用gnu tar。<code>export PATH=&quot;/usr/local/opt/gnu-tar/libexec/gnubin:$PATH&quot;</code>加入到<code>.zshrc</code>，不必每次构建都设置PATH，但这样会让Mac默认使用GNU tar。</p>
<p>需要<code>make clean</code>然后重新<code>make</code>，不然依然会遇到bad magic的问题。</p>
<h2 id="Git升级到2-22以上版本"><a href="#Git升级到2-22以上版本" class="headerlink" title="Git升级到2.22以上版本"></a>Git升级到2.22以上版本</h2><p>如果未升级可能遇到上文提到的dep不存在的问题。</p>
<h1 id="通过Makefile定位编译问题"><a href="#通过Makefile定位编译问题" class="headerlink" title="通过Makefile定位编译问题"></a>通过Makefile定位编译问题</h1><p>这类问题是类似的，要找到报错的位置，是做哪项构建时报的错，以及报错位置的前提条件是什么，这里列举2个。</p>
<h2 id="dep不存在的问题"><a href="#dep不存在的问题" class="headerlink" title="dep不存在的问题"></a>dep不存在的问题</h2><p>在执行<code>make all</code>的时候，遇到了<code>dep</code>不存在的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEP: Checking for dependency issues..</span><br><span class="line">./scripts/check_deps.sh: line 7: dep: command not found</span><br></pre></td></tr></table></figure>
<p>通过Makefile知道，dep属于gotools，单独执行<code>make gotools</code>查看问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make gotools</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/maxbrunsfeld/counterfeiter -&gt; counterfeiter</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building golang.org/x/lint/golint -&gt; golint</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/golang.org/x/lint/golint</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building golang.org/x/tools/cmd/goimports -&gt; goimports</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/axw/gocov/gocov -&gt; gocov</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/AlekSi/gocov-xml -&gt; gocov-xml</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/vektra/mockery/cmd/mockery -&gt; mockery</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/estesp/manifest-tool -&gt; manifest-tool</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br></pre></td></tr></table></figure>
<p>其中，果然没有安装dep，单独编译dep：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make gotool.dep</span><br><span class="line">Unknown option: -C</span><br><span class="line">usage: git [--version] [--<span class="built_in">help</span>] [-c name=value]</span><br><span class="line">           [--<span class="built_in">exec</span>-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class="line">           [-p|--paginate|--no-pager] [--no-replace-objects] [--bare]</span><br><span class="line">           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class="line">           &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line">make: *** [gotool.dep] 错误 129</span><br></pre></td></tr></table></figure>
<p>报错误，git没有<code>-C</code>选项，怀疑centos系统自带git太老，<code>git version</code>查看果然只有<code>1.9</code>。</p>
<p>按照Git的INSTALL文件指导安装git，详细见：<a href="https://github.com/git/git/blob/master/INSTALL" target="_blank" rel="noopener">https://github.com/git/git/blob/master/INSTALL</a> ，下面是简要安装步骤。</p>
<p>通过wget下载最新的<a href="https://github.com/git/git/releases" target="_blank" rel="noopener">git release</a>，然后使用以下命令安装git到<code>/usr/bin</code>目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/git/git/archive/v2.22.0.tar.gz</span><br><span class="line"><span class="comment"># 省略：解压然后进入该目录</span></span><br><span class="line">make</span><br><span class="line">make prefix=/usr install</span><br></pre></td></tr></table></figure>
<p>验证git版本，和make dep。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ git version</span><br><span class="line">git version 2.22.0</span><br><span class="line"></span><br><span class="line">➜  fabric git:(r1.4) ✗ make gotool.dep</span><br><span class="line">Building github.com/golang/dep v0.5.1 -&gt; dep</span><br></pre></td></tr></table></figure>
<p>通过fabric Makefile可知<code>check_deps.sh</code>是<code>make check-deps</code>的一部分，执行<code>make check-deps</code>可以看到检查dep通过了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) make check-deps</span><br><span class="line">DEP: Checking <span class="keyword">for</span> dependency issues..</span><br><span class="line">dep:</span><br><span class="line"> version     : v0.5.1</span><br><span class="line"> build date  : 2019-07-15</span><br><span class="line"> git <span class="built_in">hash</span>    :</span><br><span class="line"> go version  : go1.11.5</span><br><span class="line"> go compiler : gc</span><br><span class="line"> platform    : linux/amd64</span><br><span class="line"> features    : ImportDuringSolve=<span class="literal">false</span></span><br><span class="line"><span class="comment"># out of sync, but ignored, due to noverify in Gopkg.toml:</span></span><br><span class="line">github.com/grpc-ecosystem/go-grpc-middleware: <span class="built_in">hash</span> of vendored tree not equal to digest <span class="keyword">in</span> Gopkg.lock</span><br></pre></td></tr></table></figure>
<h2 id="protoc-gen-go-不存在的问题"><a href="#protoc-gen-go-不存在的问题" class="headerlink" title="protoc-gen-go 不存在的问题"></a>protoc-gen-go 不存在的问题</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make all</span><br><span class="line">mkdir -p .build/image/ccenv/payload</span><br><span class="line">cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span><br><span class="line">cp: .build/docker/gotools/bin/protoc-gen-go: No such file or directory</span><br><span class="line">make: *** [.build/image/ccenv/payload] Error 1</span><br></pre></td></tr></table></figure>
<p>查看构建日志是否有以下日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Building dockerized gotools</span><br></pre></td></tr></table></figure>
<p>应当是不存在，不过构建存在错误，所以才没有构建出docker要使用的gotools。</p>
<p>解决办法是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br><span class="line">$ make .build/docker/gotools <span class="comment"># 直接编译docker的gotools</span></span><br></pre></td></tr></table></figure>
<p>如果报网络连接导致的错误，参考<a href="http://lessisbetter.site/2018/09/06/Science-and-the-Internet/">终端科学上网</a>，然后重新执行，或者下面这种办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make gotools <span class="comment"># 本地安装gotools</span></span><br><span class="line">$ cp `<span class="built_in">which</span> protoc-gen-go` .build/docker/gotools/bin/ <span class="comment"># 拷贝到docker gotools目录</span></span><br></pre></td></tr></table></figure>
<p>然后重新<code>make all</code>或<code>make docker</code>。</p>
<h1 id="构建日志"><a href="#构建日志" class="headerlink" title="构建日志"></a>构建日志</h1><p>构建日志比较长，放到了<a href="#附录">附录</a>中，对构建日志加了注释，可根据构建日志进一步掌握构建过程。</p>
<h1 id="镜像解读"><a href="#镜像解读" class="headerlink" title="镜像解读"></a>镜像解读</h1><p>通过<code>make all</code>或<code>make docker</code>可以生成fabric的所有镜像，这些镜像可以通过<code>make docker-list</code>查看，如果使用docker images查看，会看到更多的镜像，并且发现下面这5个镜像还有另外一个”lastest”的标签，看Makefile可以知道，其实是1个镜像2个标签而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) make docker-list</span><br><span class="line">hyperledger/fabric-peer:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-orderer:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-ccenv:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-buildenv:amd64-1.4.2-snapshot-9dce7357b</span><br><span class="line">hyperledger/fabric-tools:amd64-1.4.2-snapshot-9dce7357b</span><br></pre></td></tr></table></figure>
<ul>
<li>fabric-peer：可以使用该镜像启动一个peer节点。</li>
<li>fabric-orderer：可以使用该镜像启动一个排序节点。</li>
<li>fabric-ccenv：这是智能合约环境镜像，ccenv是chaincode env的缩写。</li>
<li>fabric-buildenv：实际包含的是go tools.tar.bz2和protoc-gen-go的镜像。</li>
<li>fabric-tools：是fabric自身tools集合的镜像。</li>
</ul>
<p>这几个镜像的Dockerfile文件在：<code>images</code>目录下，各镜像具体内容见各自的Dockerfile。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) tree images</span><br><span class="line">images</span><br><span class="line">├── buildenv</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── ccenv</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── orderer</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── peer</span><br><span class="line">│   └── Dockerfile.in</span><br><span class="line">├── testenv</span><br><span class="line">│   ├── Dockerfile.alpine</span><br><span class="line">│   └── softhsm</span><br><span class="line">│       └── APKBUILD</span><br><span class="line">└── tools</span><br><span class="line">    └── Dockerfile.in</span><br><span class="line"></span><br><span class="line">7 directories, 7 files</span><br></pre></td></tr></table></figure>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>现在国内已经有第三方的Go modules代理服务了，比如：</p>
<ol>
<li><a href="https://goproxy.io/zh/" target="_blank" rel="noopener">goproxy.io</a>，是即将毕业的<a href="https://github.com/aofei" target="_blank" rel="noopener">盛奥飞</a>小哥捐给了七牛搭建的Go modules代理服务。</li>
<li><a href="http://mirrors.aliyun.com/goproxy/" target="_blank" rel="noopener">aliyun goproxy</a>，现在阿里云开放了Go modules代理服务。</li>
</ol>
<p>fabric使用vendor，下载各种东西的时候需要翻墙，即便是可以翻墙，也是有缺点的：</p>
<ol>
<li>慢。</li>
<li>翻墙有流量限制。</li>
</ol>
<p>fabric赶紧支持go mod吧，这样再也不用翻墙了。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://shanma.pro/tutorial/56688.html" target="_blank" rel="noopener">fabric工程项目构建Makefile翻译及解析</a></li>
</ol>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>一份构建日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make all</span><br><span class="line">// 构建native那些程序，等价make native</span><br><span class="line">// peer</span><br><span class="line">.build/bin/peer</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.4.2 -X github.com/hyperledger/fabric/common/metadata.CommitSHA=9dce735 -X github.com/hyperledger/fabric/common/metadata.BaseVersion=0.4.15 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger&quot; github.com/hyperledger/fabric/peer</span><br><span class="line">Binary available as .build/bin/peer</span><br><span class="line">// orderer</span><br><span class="line">.build/bin/orderer</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.4.2 -X github.com/hyperledger/fabric/common/metadata.CommitSHA=9dce735 -X github.com/hyperledger/fabric/common/metadata.BaseVersion=0.4.15 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger&quot; github.com/hyperledger/fabric/orderer</span><br><span class="line">Binary available as .build/bin/orderer</span><br><span class="line">// configtxgen</span><br><span class="line">.build/bin/configtxgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxgen</span><br><span class="line">Binary available as .build/bin/configtxgen</span><br><span class="line">// cryptogen</span><br><span class="line">.build/bin/cryptogen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/cryptogen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/cryptogen</span><br><span class="line">Binary available as .build/bin/cryptogen</span><br><span class="line">// idemixgen</span><br><span class="line">.build/bin/idemixgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/idemixgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/idemixgen</span><br><span class="line">Binary available as .build/bin/idemixgen</span><br><span class="line">// configtxlator</span><br><span class="line">.build/bin/configtxlator</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxlator/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxlator</span><br><span class="line">Binary available as .build/bin/configtxlator</span><br><span class="line">// discover</span><br><span class="line">.build/bin/discover</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/home/centos/go/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/cmd/discover/metadata.Version=1.4.2-snapshot-9dce735&quot; github.com/hyperledger/fabric/cmd/discover</span><br><span class="line">Binary available as .build/bin/discover</span><br><span class="line"></span><br><span class="line">// 以下这部分等价make docker</span><br><span class="line">// 构建peer镜像</span><br><span class="line">Building .build/docker/bin/peer</span><br><span class="line"># github.com/hyperledger/fabric/peer</span><br><span class="line">/tmp/go-link-829040977/000006.o: In function `pluginOpen&apos;:</span><br><span class="line">/workdir/go/src/plugin/plugin_dlopen.go:19: warning: Using &apos;dlopen&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000021.o: In function `mygetgrouplist&apos;:</span><br><span class="line">/workdir/go/src/os/user/getgrouplist_unix.go:16: warning: Using &apos;getgrouplist&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetgrgid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:38: warning: Using &apos;getgrgid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetgrnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:43: warning: Using &apos;getgrnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetpwnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:33: warning: Using &apos;getpwnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000020.o: In function `mygetpwuid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:28: warning: Using &apos;getpwuid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-829040977/000004.o: In function `_cgo_18049202ccd9_C2func_getaddrinfo&apos;:</span><br><span class="line">/tmp/go-build/cgo-gcc-prolog:49: warning: Using &apos;getaddrinfo&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">// 构建需要的压缩包</span><br><span class="line">(cd sampleconfig &amp;&amp; tar -jc *) &gt; .build/sampleconfig.tar.bz2</span><br><span class="line">// 复制peer需要的payload</span><br><span class="line">mkdir -p .build/image/peer/payload</span><br><span class="line">cp .build/docker/bin/peer .build/sampleconfig.tar.bz2 .build/image/peer/payload</span><br><span class="line">// 打包peer镜像</span><br><span class="line">mkdir -p .build/image/peer</span><br><span class="line">Building docker peer-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-peer .build/image/peer</span><br><span class="line">Sending build context to Docker daemon  33.56MB</span><br><span class="line">Step 1/7 : FROM hyperledger/fabric-baseos:amd64-0.4.15</span><br><span class="line"> ---&gt; 9d6ec11c60ff</span><br><span class="line">Step 2/7 : ENV FABRIC_CFG_PATH /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 3bea4b2a628b</span><br><span class="line">Removing intermediate container 3bea4b2a628b</span><br><span class="line"> ---&gt; 8892a2046872</span><br><span class="line">Step 3/7 : RUN mkdir -p /var/hyperledger/production $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; Running in 06437fde2305</span><br><span class="line">Removing intermediate container 06437fde2305</span><br><span class="line"> ---&gt; 98fc3c6b0fae</span><br><span class="line">Step 4/7 : COPY payload/peer /usr/local/bin</span><br><span class="line"> ---&gt; 635a5f0e02c4</span><br><span class="line">Step 5/7 : ADD  payload/sampleconfig.tar.bz2 $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; d2e3f4b80946</span><br><span class="line">Step 6/7 : CMD [&quot;peer&quot;,&quot;node&quot;,&quot;start&quot;]</span><br><span class="line"> ---&gt; Running in 47e57005f4f8</span><br><span class="line">Removing intermediate container 47e57005f4f8</span><br><span class="line"> ---&gt; 59a7e54bfe1a</span><br><span class="line">Step 7/7 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in aaacacec80e8</span><br><span class="line">Removing intermediate container aaacacec80e8</span><br><span class="line"> ---&gt; e97b7fd4ff49</span><br><span class="line">Successfully built e97b7fd4ff49</span><br><span class="line">// 构建peer镜像完成，为镜像打包</span><br><span class="line">Successfully tagged hyperledger/fabric-peer:latest</span><br><span class="line">docker tag hyperledger/fabric-peer hyperledger/fabric-peer:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-peer hyperledger/fabric-peer:amd64-latest</span><br><span class="line">// 以下为构建orderer镜像，与peer镜像过程类似</span><br><span class="line">Building .build/docker/bin/orderer</span><br><span class="line"># github.com/hyperledger/fabric/orderer</span><br><span class="line">/tmp/go-link-846385019/000018.o: In function `pluginOpen&apos;:</span><br><span class="line">/workdir/go/src/plugin/plugin_dlopen.go:19: warning: Using &apos;dlopen&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000021.o: In function `mygetgrouplist&apos;:</span><br><span class="line">/workdir/go/src/os/user/getgrouplist_unix.go:16: warning: Using &apos;getgrouplist&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetgrgid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:38: warning: Using &apos;getgrgid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetgrnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:43: warning: Using &apos;getgrnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetpwnam_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:33: warning: Using &apos;getpwnam_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000020.o: In function `mygetpwuid_r&apos;:</span><br><span class="line">/workdir/go/src/os/user/cgo_lookup_unix.go:28: warning: Using &apos;getpwuid_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/tmp/go-link-846385019/000004.o: In function `_cgo_18049202ccd9_C2func_getaddrinfo&apos;:</span><br><span class="line">/tmp/go-build/cgo-gcc-prolog:49: warning: Using &apos;getaddrinfo&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">mkdir -p .build/image/orderer/payload</span><br><span class="line">cp .build/docker/bin/orderer .build/sampleconfig.tar.bz2 .build/image/orderer/payload</span><br><span class="line">mkdir -p .build/image/orderer</span><br><span class="line">Building docker orderer-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-orderer .build/image/orderer</span><br><span class="line">Sending build context to Docker daemon  28.09MB</span><br><span class="line">Step 1/8 : FROM hyperledger/fabric-baseos:amd64-0.4.15</span><br><span class="line"> ---&gt; 9d6ec11c60ff</span><br><span class="line">Step 2/8 : ENV FABRIC_CFG_PATH /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 8892a2046872</span><br><span class="line">Step 3/8 : RUN mkdir -p /var/hyperledger/production $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 98fc3c6b0fae</span><br><span class="line">Step 4/8 : COPY payload/orderer /usr/local/bin</span><br><span class="line"> ---&gt; 50854bee0fa6</span><br><span class="line">Step 5/8 : ADD payload/sampleconfig.tar.bz2 $FABRIC_CFG_PATH/</span><br><span class="line"> ---&gt; bab56963bf0f</span><br><span class="line">Step 6/8 : EXPOSE 7050</span><br><span class="line"> ---&gt; Running in bda05dbbf18a</span><br><span class="line">Removing intermediate container bda05dbbf18a</span><br><span class="line"> ---&gt; 7b335f36f7d2</span><br><span class="line">Step 7/8 : CMD [&quot;orderer&quot;]</span><br><span class="line"> ---&gt; Running in 210013bf0e3e</span><br><span class="line">Removing intermediate container 210013bf0e3e</span><br><span class="line"> ---&gt; b543c69c8caf</span><br><span class="line">Step 8/8 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in c762fc3e0590</span><br><span class="line">Removing intermediate container c762fc3e0590</span><br><span class="line"> ---&gt; aa8604c99f23</span><br><span class="line">Successfully built aa8604c99f23</span><br><span class="line">Successfully tagged hyperledger/fabric-orderer:latest</span><br><span class="line">docker tag hyperledger/fabric-orderer hyperledger/fabric-orderer:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-orderer hyperledger/fabric-orderer:amd64-latest</span><br><span class="line">// 以下开始构gotools镜像</span><br><span class="line">Building dockerized gotools</span><br><span class="line">// 以下实际在docker中运行</span><br><span class="line">// 默认go get下载，然后默认安装到$GOPATH/bin</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/maxbrunsfeld/counterfeiter -&gt; counterfeiter</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/golang/dep v0.5.1 -&gt; dep</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building golang.org/x/lint/golint -&gt; golint</span><br><span class="line">// 这几个指定了安装目录/opt/gotools/bin，实际映射到.build/docker/gotools/bin/</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/golang.org/x/lint/golint</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building golang.org/x/tools/cmd/goimports -&gt; goimports</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/golang/protobuf/protoc-gen-go -&gt; protoc-gen-go</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/github.com/golang/protobuf/protoc-gen-go</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo</span><br><span class="line">GOBIN=/opt/gotools/bin go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line">// 以下安装到$GOPATH/bin</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/axw/gocov/gocov -&gt; gocov</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/AlekSi/gocov-xml -&gt; gocov-xml</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/client9/misspell/cmd/misspell -&gt; misspell</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/vektra/mockery/cmd/mockery -&gt; mockery</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">make[1]: Entering directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">Building github.com/estesp/manifest-tool -&gt; manifest-tool</span><br><span class="line">make[1]: Leaving directory &apos;/opt/gopath/src/github.com/hyperledger/fabric&apos;</span><br><span class="line">// 安装chaintool，gotools镜像需要</span><br><span class="line">Installing chaintool</span><br><span class="line">curl -fL https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/chaintool-1.1.3/hyperledger-fabric-chaintool-1.1.3.jar &gt; .build/bin/chaintool</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 16.4M  100 16.4M    0     0  1142k      0  0:00:14  0:00:14 --:--:-- 2544k</span><br><span class="line">chmod +x .build/bin/chaintool</span><br><span class="line">Creating .build/goshim.tar.bz2</span><br><span class="line">// 设置ccenv的payload</span><br><span class="line">mkdir -p .build/image/ccenv/payload</span><br><span class="line">cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span><br><span class="line">mkdir -p .build/image/ccenv</span><br><span class="line">// 构建ccenv镜像，是chain code的环境镜像，所以简写为ccenv</span><br><span class="line">Building docker ccenv-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-ccenv .build/image/ccenv</span><br><span class="line">Sending build context to Docker daemon  25.12MB</span><br><span class="line">Step 1/5 : FROM hyperledger/fabric-baseimage:amd64-0.4.15</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 2/5 : COPY payload/chaintool payload/protoc-gen-go /usr/local/bin/</span><br><span class="line"> ---&gt; 44e06a863d08</span><br><span class="line">Step 3/5 : ADD payload/goshim.tar.bz2 $GOPATH/src/</span><br><span class="line"> ---&gt; 233605b067d5</span><br><span class="line">Step 4/5 : RUN mkdir -p /chaincode/input /chaincode/output</span><br><span class="line"> ---&gt; Running in be1909a39e06</span><br><span class="line">Removing intermediate container be1909a39e06</span><br><span class="line"> ---&gt; 605b1c70e97f</span><br><span class="line">Step 5/5 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in dc470f15e125</span><br><span class="line">Removing intermediate container dc470f15e125</span><br><span class="line"> ---&gt; 7cb803c8b124</span><br><span class="line">Successfully built 7cb803c8b124</span><br><span class="line">Successfully tagged hyperledger/fabric-ccenv:latest</span><br><span class="line">docker tag hyperledger/fabric-ccenv hyperledger/fabric-ccenv:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-ccenv hyperledger/fabric-ccenv:amd64-latest</span><br><span class="line">// 构建buildenv镜像</span><br><span class="line">// gotools放进压缩包</span><br><span class="line">(cd .build/docker/gotools/bin &amp;&amp; tar -jc *) &gt; .build/gotools.tar.bz2</span><br><span class="line">mkdir -p .build/image/buildenv/payload</span><br><span class="line">// gotools和protoc-gen-go是buildenv的payload</span><br><span class="line">cp .build/gotools.tar.bz2 .build/docker/gotools/bin/protoc-gen-go .build/image/buildenv/payload</span><br><span class="line">mkdir -p .build/image/buildenv</span><br><span class="line">Building docker buildenv-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-buildenv .build/image/buildenv</span><br><span class="line">Sending build context to Docker daemon  47.17MB</span><br><span class="line">Step 1/5 : FROM hyperledger/fabric-baseimage:amd64-0.4.15</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 2/5 : COPY payload/protoc-gen-go /usr/local/bin/</span><br><span class="line"> ---&gt; 90f62f1410b4</span><br><span class="line">Step 3/5 : ADD payload/gotools.tar.bz2 /usr/local/bin/</span><br><span class="line"> ---&gt; e27228cd3fb8</span><br><span class="line">Step 4/5 : ENV GOCACHE &quot;/tmp&quot;</span><br><span class="line"> ---&gt; Running in 780e38380727</span><br><span class="line">Removing intermediate container 780e38380727</span><br><span class="line"> ---&gt; b610d861e6ce</span><br><span class="line">Step 5/5 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in 226095fc14b5</span><br><span class="line">Removing intermediate container 226095fc14b5</span><br><span class="line"> ---&gt; 6ba655852ec7</span><br><span class="line">Successfully built 6ba655852ec7</span><br><span class="line">Successfully tagged hyperledger/fabric-buildenv:latest</span><br><span class="line">// gotools实际打包在了buildenv镜像中</span><br><span class="line">docker tag hyperledger/fabric-buildenv hyperledger/fabric-buildenv:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-buildenv hyperledger/fabric-buildenv:amd64-latest</span><br><span class="line">// 打包tools镜像，它的dockerfile文件：.build/image/tools/Dockerfile</span><br><span class="line">// 从这里可以看到镜像里实际包含的是configtxgen configtxlator cryptogen peer discover idemixgen，这几个工具</span><br><span class="line">// 并对系统进行了更新</span><br><span class="line">// 所以tools镜像指的是fabric tools的镜像，而不是go tools</span><br><span class="line">mkdir -p .build/image/tools</span><br><span class="line">Building docker tools-image</span><br><span class="line">docker build --build-arg &apos;http_proxy=http://192.168.102.143:1087&apos; --build-arg &apos;https_proxy=http://192.168.102.143:1087&apos; -t hyperledger/fabric-tools -f .build/image/tools/Dockerfile .</span><br><span class="line">Sending build context to Docker daemon  179.5MB</span><br><span class="line">Step 1/14 : FROM hyperledger/fabric-baseimage:amd64-0.4.15 as builder</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 2/14 : WORKDIR /opt/gopath</span><br><span class="line"> ---&gt; Running in bc4dd206cdcd</span><br><span class="line">Removing intermediate container bc4dd206cdcd</span><br><span class="line"> ---&gt; c156c64ba0c0</span><br><span class="line">Step 3/14 : RUN mkdir src &amp;&amp; mkdir pkg &amp;&amp; mkdir bin</span><br><span class="line"> ---&gt; Running in 752a63efe3be</span><br><span class="line">Removing intermediate container 752a63efe3be</span><br><span class="line"> ---&gt; 001cb4d1136f</span><br><span class="line">Step 4/14 : ADD . src/github.com/hyperledger/fabric</span><br><span class="line"> ---&gt; 5ba1e6fe79df</span><br><span class="line">Step 5/14 : WORKDIR /opt/gopath/src/github.com/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 9b03a753a124</span><br><span class="line">Removing intermediate container 9b03a753a124</span><br><span class="line"> ---&gt; e0eb57e0b44b</span><br><span class="line">Step 6/14 : ENV EXECUTABLES go git curl</span><br><span class="line"> ---&gt; Running in 6b5978688143</span><br><span class="line">Removing intermediate container 6b5978688143</span><br><span class="line"> ---&gt; 2a28ae07b3da</span><br><span class="line">Step 7/14 : RUN make configtxgen configtxlator cryptogen peer discover idemixgen</span><br><span class="line"> ---&gt; Running in 27e814a9a148</span><br><span class="line">//  在镜像里安装native中的各种工具，所以gotools镜像，包含的并不是gotools那几个工具</span><br><span class="line">.build/bin/configtxgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxgen</span><br><span class="line">Binary available as .build/bin/configtxgen</span><br><span class="line">.build/bin/configtxlator</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/configtxlator/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/configtxlator</span><br><span class="line">Binary available as .build/bin/configtxlator</span><br><span class="line">.build/bin/cryptogen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/cryptogen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/cryptogen</span><br><span class="line">Binary available as .build/bin/cryptogen</span><br><span class="line">.build/bin/peer</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.4.2 -X github.com/hyperledger/fabric/common/metadata.CommitSHA=9dce735 -X github.com/hyperledger/fabric/common/metadata.BaseVersion=0.4.15 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric -X github.com/hyperledger/fabric/common/metadata.DockerNamespace=hyperledger -X github.com/hyperledger/fabric/common/metadata.BaseDockerNamespace=hyperledger&quot; github.com/hyperledger/fabric/peer</span><br><span class="line">Binary available as .build/bin/peer</span><br><span class="line">.build/bin/discover</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/cmd/discover/metadata.Version=1.4.2-snapshot-9dce735&quot; github.com/hyperledger/fabric/cmd/discover</span><br><span class="line">Binary available as .build/bin/discover</span><br><span class="line">.build/bin/idemixgen</span><br><span class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/.build/bin go install -tags &quot;&quot; -ldflags &quot;-X github.com/hyperledger/fabric/common/tools/idemixgen/metadata.CommitSHA=9dce735&quot; github.com/hyperledger/fabric/common/tools/idemixgen</span><br><span class="line">Binary available as .build/bin/idemixgen</span><br><span class="line">Removing intermediate container 27e814a9a148</span><br><span class="line"> ---&gt; 019fcc98aafe</span><br><span class="line">Step 8/14 : FROM hyperledger/fabric-baseimage:amd64-0.4.15</span><br><span class="line"> ---&gt; c4c532c23a50</span><br><span class="line">Step 9/14 : ENV FABRIC_CFG_PATH /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 971f1e778c1b</span><br><span class="line">Removing intermediate container 971f1e778c1b</span><br><span class="line"> ---&gt; 3abe7ab3eda7</span><br><span class="line">Step 10/14 : RUN apt-get update &amp;&amp; apt-get install -y jq</span><br><span class="line"> ---&gt; Running in 0c6bc2dab637</span><br><span class="line">Get:1 http://security.ubuntu.com/ubuntu xenial-security InRelease [109 kB]</span><br><span class="line">Get:2 http://archive.ubuntu.com/ubuntu xenial InRelease [247 kB]</span><br><span class="line">Get:3 http://archive.ubuntu.com/ubuntu xenial-updates InRelease [109 kB]</span><br><span class="line">Get:4 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [896 kB]</span><br><span class="line">Get:5 http://archive.ubuntu.com/ubuntu xenial-backports InRelease [107 kB]</span><br><span class="line">Get:6 http://archive.ubuntu.com/ubuntu xenial/main amd64 Packages [1558 kB]</span><br><span class="line">Get:7 http://security.ubuntu.com/ubuntu xenial-security/restricted amd64 Packages [12.7 kB]</span><br><span class="line">Get:8 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [569 kB]</span><br><span class="line">Get:9 http://archive.ubuntu.com/ubuntu xenial/restricted amd64 Packages [14.1 kB]</span><br><span class="line">Get:10 http://archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [9827 kB]</span><br><span class="line">Get:11 http://security.ubuntu.com/ubuntu xenial-security/multiverse amd64 Packages [6117 B]</span><br><span class="line">Get:12 http://archive.ubuntu.com/ubuntu xenial/multiverse amd64 Packages [176 kB]</span><br><span class="line">Get:13 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [1277 kB]</span><br><span class="line">Get:14 http://archive.ubuntu.com/ubuntu xenial-updates/restricted amd64 Packages [13.1 kB]</span><br><span class="line">Get:15 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [974 kB]</span><br><span class="line">Get:16 http://archive.ubuntu.com/ubuntu xenial-updates/multiverse amd64 Packages [19.1 kB]</span><br><span class="line">Get:17 http://archive.ubuntu.com/ubuntu xenial-backports/main amd64 Packages [7942 B]</span><br><span class="line">Get:18 http://archive.ubuntu.com/ubuntu xenial-backports/universe amd64 Packages [8532 B]</span><br><span class="line">Fetched 15.9 MB in 17s (896 kB/s)</span><br><span class="line">Reading package lists...</span><br><span class="line">Reading package lists...</span><br><span class="line">Building dependency tree...</span><br><span class="line">Reading state information...</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  libonig2</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  jq libonig2</span><br><span class="line">0 upgraded, 2 newly installed, 0 to remove and 55 not upgraded.</span><br><span class="line">Need to get 231 kB of archives.</span><br><span class="line">After this operation, 797 kB of additional disk space will be used.</span><br><span class="line">Get:1 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 libonig2 amd64 5.9.6-1ubuntu0.1 [86.7 kB]</span><br><span class="line">Get:2 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 jq amd64 1.5+dfsg-1ubuntu0.1 [144 kB]</span><br><span class="line">debconf: unable to initialize frontend: Dialog</span><br><span class="line">debconf: (TERM is not set, so the dialog frontend is not usable.)</span><br><span class="line">debconf: falling back to frontend: Readline</span><br><span class="line">debconf: unable to initialize frontend: Readline</span><br><span class="line">debconf: (This frontend requires a controlling tty.)</span><br><span class="line">debconf: falling back to frontend: Teletype</span><br><span class="line">dpkg-preconfigure: unable to re-open stdin:</span><br><span class="line">Fetched 231 kB in 2s (105 kB/s)</span><br><span class="line">Selecting previously unselected package libonig2:amd64.</span><br><span class="line">(Reading database ... 22655 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../libonig2_5.9.6-1ubuntu0.1_amd64.deb ...</span><br><span class="line">Unpacking libonig2:amd64 (5.9.6-1ubuntu0.1) ...</span><br><span class="line">Selecting previously unselected package jq.</span><br><span class="line">Preparing to unpack .../jq_1.5+dfsg-1ubuntu0.1_amd64.deb ...</span><br><span class="line">Unpacking jq (1.5+dfsg-1ubuntu0.1) ...</span><br><span class="line">Processing triggers for libc-bin (2.23-0ubuntu11) ...</span><br><span class="line">Setting up libonig2:amd64 (5.9.6-1ubuntu0.1) ...</span><br><span class="line">Setting up jq (1.5+dfsg-1ubuntu0.1) ...</span><br><span class="line">Processing triggers for libc-bin (2.23-0ubuntu11) ...</span><br><span class="line">Removing intermediate container 0c6bc2dab637</span><br><span class="line"> ---&gt; bc8cfafb544f</span><br><span class="line">Step 11/14 : VOLUME /etc/hyperledger/fabric</span><br><span class="line"> ---&gt; Running in 260f4ec6bd3e</span><br><span class="line">Removing intermediate container 260f4ec6bd3e</span><br><span class="line"> ---&gt; 9f682419f109</span><br><span class="line">Step 12/14 : COPY --from=builder /opt/gopath/src/github.com/hyperledger/fabric/.build/bin /usr/local/bin</span><br><span class="line"> ---&gt; ff18ec787bf5</span><br><span class="line">Step 13/14 : COPY --from=builder /opt/gopath/src/github.com/hyperledger/fabric/sampleconfig $FABRIC_CFG_PATH</span><br><span class="line"> ---&gt; 70163f0cac4f</span><br><span class="line">Step 14/14 : LABEL org.hyperledger.fabric.version=1.4.2       org.hyperledger.fabric.base.version=0.4.15</span><br><span class="line"> ---&gt; Running in 2f70bb608ac2</span><br><span class="line">Removing intermediate container 2f70bb608ac2</span><br><span class="line"> ---&gt; e395ec9d27e8</span><br><span class="line">Successfully built e395ec9d27e8</span><br><span class="line">Successfully tagged hyperledger/fabric-tools:latest</span><br><span class="line">// gotools镜像打包完成，打上tag</span><br><span class="line">docker tag hyperledger/fabric-tools hyperledger/fabric-tools:amd64-1.4.2-snapshot-9dce735</span><br><span class="line">docker tag hyperledger/fabric-tools hyperledger/fabric-tools:amd64-latest</span><br><span class="line"></span><br><span class="line">// 以下等价于make checks</span><br><span class="line">// 许可证检查</span><br><span class="line">All files have SPDX-License-Identifier headers</span><br><span class="line">// 拼写检查</span><br><span class="line">Checking changed go files for spelling errors ...</span><br><span class="line">spell checker passed</span><br><span class="line">// trailing spaces检查</span><br><span class="line">Checking trailing spaces ...</span><br><span class="line">// dep检查</span><br><span class="line">DEP: Checking for dependency issues..</span><br><span class="line">dep:</span><br><span class="line"> version     : v0.5.1</span><br><span class="line"> build date  : 2019-07-16</span><br><span class="line"> git hash    :</span><br><span class="line"> go version  : go1.11.5</span><br><span class="line"> go compiler : gc</span><br><span class="line"> platform    : linux/amd64</span><br><span class="line"> features    : ImportDuringSolve=false</span><br><span class="line"># out of sync, but ignored, due to noverify in Gopkg.toml:</span><br><span class="line">github.com/grpc-ecosystem/go-grpc-middleware: hash of vendored tree not equal to digest in Gopkg.lock</span><br><span class="line">// 执行lint</span><br><span class="line">LINT: Running code checks..</span><br><span class="line">Checking with gofmt</span><br><span class="line">Checking with goimports</span><br><span class="line">Checking for golang.org/x/net/context</span><br><span class="line">Checking with go vet</span><br><span class="line">METRICS: Checking for outdated reference documentation..</span><br><span class="line">cd unit-test &amp;&amp; docker-compose down</span><br><span class="line">WARNING: The TEST_PKGS variable is not set. Defaulting to a blank string.</span><br><span class="line">WARNING: The JOB_TYPE variable is not set. Defaulting to a blank string.</span><br><span class="line">docker pull hyperledger/fabric-couchdb:amd64-0.4.15</span><br><span class="line">amd64-0.4.15: Pulling from hyperledger/fabric-couchdb</span><br><span class="line">34667c7e4631: Already exists</span><br><span class="line">d18d76a881a4: Already exists</span><br><span class="line">119c7358fbfc: Already exists</span><br><span class="line">2aaf13f3eff0: Already exists</span><br><span class="line">3f89de4cf84b: Already exists</span><br><span class="line">24194f819972: Already exists</span><br><span class="line">78e4eabd31a5: Already exists</span><br><span class="line">c7652b6bde40: Already exists</span><br><span class="line">b4646dd65c45: Already exists</span><br><span class="line">5e6defad8a30: Already exists</span><br><span class="line">7695bf5d0b9d: Pull complete</span><br><span class="line">6d9d46f66bc3: Pull complete</span><br><span class="line">4912f1b4990a: Pull complete</span><br><span class="line">f3b174a93eea: Pull complete</span><br><span class="line">3763a939777a: Pull complete</span><br><span class="line">f293593adbb6: Pull complete</span><br><span class="line">1ae53ace804f: Pull complete</span><br><span class="line">d4aa6d764b18: Pull complete</span><br><span class="line">d747b2b30e48: Pull complete</span><br><span class="line">52cbd2253fea: Pull complete</span><br><span class="line">Digest: sha256:e9c528f90c84c50dd3a79c2d2c5f1ff87264a8009a1971b269ceecace4ef1fb9</span><br><span class="line">Status: Downloaded newer image for hyperledger/fabric-couchdb:amd64-0.4.15</span><br><span class="line">docker tag hyperledger/fabric-couchdb:amd64-0.4.15 hyperledger/fabric-couchdb</span><br><span class="line">docker pull hyperledger/fabric-zookeeper:amd64-0.4.15</span><br><span class="line">amd64-0.4.15: Pulling from hyperledger/fabric-zookeeper</span><br><span class="line">34667c7e4631: Already exists</span><br><span class="line">d18d76a881a4: Already exists</span><br><span class="line">119c7358fbfc: Already exists</span><br><span class="line">2aaf13f3eff0: Already exists</span><br><span class="line">3f89de4cf84b: Already exists</span><br><span class="line">24194f819972: Already exists</span><br><span class="line">78e4eabd31a5: Already exists</span><br><span class="line">c7652b6bde40: Already exists</span><br><span class="line">b4646dd65c45: Already exists</span><br><span class="line">5e6defad8a30: Already exists</span><br><span class="line">0e045d9c2cdc: Pull complete</span><br><span class="line">7ef4d8920518: Pull complete</span><br><span class="line">dbeed81d9a45: Pull complete</span><br><span class="line">aeea025ecc4e: Pull complete</span><br><span class="line">Digest: sha256:4e4e8b8aaed7864f23d0c6c018cc8589e8e1d042413abc034dd7a6b3faacd2f0</span><br><span class="line">Status: Downloaded newer image for hyperledger/fabric-zookeeper:amd64-0.4.15</span><br><span class="line">docker tag hyperledger/fabric-zookeeper:amd64-0.4.15 hyperledger/fabric-zookeeper</span><br><span class="line">docker pull hyperledger/fabric-kafka:amd64-0.4.15</span><br><span class="line">amd64-0.4.15: Pulling from hyperledger/fabric-kafka</span><br><span class="line">34667c7e4631: Already exists</span><br><span class="line">d18d76a881a4: Already exists</span><br><span class="line">119c7358fbfc: Already exists</span><br><span class="line">2aaf13f3eff0: Already exists</span><br><span class="line">3f89de4cf84b: Already exists</span><br><span class="line">24194f819972: Already exists</span><br><span class="line">78e4eabd31a5: Already exists</span><br><span class="line">c7652b6bde40: Already exists</span><br><span class="line">b4646dd65c45: Already exists</span><br><span class="line">5e6defad8a30: Already exists</span><br><span class="line">d0459116a54a: Pull complete</span><br><span class="line">1bbcec7bfdef: Pull complete</span><br><span class="line">5911218c5933: Pull complete</span><br><span class="line">Digest: sha256:68398b1e1ee4165fd80b1a2f0e123625f489150673c7dc4816177816e43ace78</span><br><span class="line">Status: Downloaded newer image for hyperledger/fabric-kafka:amd64-0.4.15</span><br><span class="line">docker tag hyperledger/fabric-kafka:amd64-0.4.15 hyperledger/fabric-kafka</span><br><span class="line">unit-test/run.sh</span><br><span class="line"></span><br><span class="line">// 省略后面的单元测试</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>本文作者：<a href="http://lessisbetter.site/about/">大彬</a></li>
<li>如果喜欢本文，随意转载，但请保留此原文链接：<a href="http://lessisbetter.site/2019/07/16/fabric-makefile/">http://lessisbetter.site/2019/07/16/fabric-makefile/</a></li>
</ol>
</blockquote>
<p><div style="color:#0096FF; text-align:center">关注公众号，获取最新Golang文章</div><br><img src="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" style="border:0" align="center"></p>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
                <span class="icon">
                  <i class="fa fa-wechat"></i>
                </span>

                <span class="label">公众号</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/区块链/" rel="tag"># 区块链</a>
              <a href="/tags/Fabric/" rel="tag"># Fabric</a>
              <a href="/tags/Makefile/" rel="tag"># Makefile</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/07/06/go-memory-allocation/" rel="prev" title="Go内存分配那些事，就这么简单！">
      <i class="fa fa-chevron-left"></i> Go内存分配那些事，就这么简单！
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/07/12/do-not-abuse-of-log/" rel="next" title="你滥用log了吗">
      你滥用log了吗 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Makefile详细解读"><span class="nav-number">1.</span> <span class="nav-text">Makefile详细解读</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#fabric的Makefile"><span class="nav-number">1.1.</span> <span class="nav-text">fabric的Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-env的Makefile"><span class="nav-number">1.2.</span> <span class="nav-text">docker env的Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-tools的Makefile"><span class="nav-number">1.3.</span> <span class="nav-text">go tools的Makefile</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建建议"><span class="nav-number">2.</span> <span class="nav-text">构建建议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#翻墙"><span class="nav-number">2.1.</span> <span class="nav-text">翻墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"><span class="nav-number">2.2.</span> <span class="nav-text">Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker设置为国内的源"><span class="nav-number">2.3.</span> <span class="nav-text">docker设置为国内的源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查GOPATH和PATH，以及http代理"><span class="nav-number">2.4.</span> <span class="nav-text">检查GOPATH和PATH，以及http代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装docker-compose"><span class="nav-number">2.5.</span> <span class="nav-text">安装docker-compose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mac上安装Gnu-tar"><span class="nav-number">2.6.</span> <span class="nav-text">Mac上安装Gnu-tar</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Git升级到2-22以上版本"><span class="nav-number">2.7.</span> <span class="nav-text">Git升级到2.22以上版本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通过Makefile定位编译问题"><span class="nav-number">3.</span> <span class="nav-text">通过Makefile定位编译问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#dep不存在的问题"><span class="nav-number">3.1.</span> <span class="nav-text">dep不存在的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protoc-gen-go-不存在的问题"><span class="nav-number">3.2.</span> <span class="nav-text">protoc-gen-go 不存在的问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建日志"><span class="nav-number">4.</span> <span class="nav-text">构建日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#镜像解读"><span class="nav-number">5.</span> <span class="nav-text">镜像解读</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结束语"><span class="nav-number">6.</span> <span class="nav-text">结束语</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">7.</span> <span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录"><span class="nav-number">8.</span> <span class="nav-text">附录</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="大彬"
      src="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
  <p class="site-author-name" itemprop="name">大彬</p>
  <div class="site-description" itemprop="description">区块链、Go语言</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="http://img.lessisbetter.site/gzh-qrcode-logo-small.png" title="公众号 → http://img.lessisbetter.site/gzh-qrcode-logo-small.png" rel="noopener" target="_blank"><i class="fa fa-fw fa-wechat"></i>公众号</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/shitaibin" title="GitHub → https://github.com/shitaibin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://segmentfault.com/u/lessisbetter" title="SegmentFault → https://segmentfault.com/u/lessisbetter" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>SegmentFault</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/947f3ccdd481" title="简书 → https://www.jianshu.com/u/947f3ccdd481" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>简书</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/4296218/james-shi" title="StackOverflow → https://stackoverflow.com/users/4296218/james-shi" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hz_stb@163.com" title="E-Mail → mailto:hz_stb@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://xargin.com" title="https://xargin.com" rel="noopener" target="_blank">Xargin曹大博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://pingcap.com/blog-cn/" title="https://pingcap.com/blog-cn/" rel="noopener" target="_blank">PingCap技术博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://qcrao.github.io/" title="https://qcrao.github.io/" rel="noopener" target="_blank">码农桃花源博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://book.eddycjy.com/golang/" title="https://book.eddycjy.com/golang/" rel="noopener" target="_blank">煎鱼的迷之博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://dave.cheney.net" title="https://dave.cheney.net" rel="noopener" target="_blank">Dave Cheney的博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://theme-next.iissnan.com/getting-started.html" title="http://theme-next.iissnan.com/getting-started.html" rel="noopener" target="_blank">Hexo Next主题配置</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">大彬</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1275814754&web_id=1275814754"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/algolia-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '42138cdfb007b8368d81',
      clientSecret: '317f1e9c0f7579358dcefb5402abe1bcc3e7388a',
      repo        : 'shitaibin.github.io',
      owner       : 'Shitaibin',
      admin       : ['Shitaibin'],
      id          : '7d56de7baf91a566d6ca1bb2f217afb3',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
