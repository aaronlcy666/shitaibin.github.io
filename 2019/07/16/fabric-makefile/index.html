<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">
































<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。 fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。 Makefile文件就在fabric的">
<meta name="keywords" content="区块链,Fabric,Makefile">
<meta property="og:type" content="article">
<meta property="og:title" content="通过Fabric 1.4 的Makefile，轻松掌握Fabric构建">
<meta property="og:url" content="http://lessisbetter.site/2019/07/16/fabric-makefile/index.html">
<meta property="og:site_name" content="大彬 LIB">
<meta property="og:description" content="初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。 fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。 Makefile文件就在fabric的">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-07-15T23:27:30.481Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="通过Fabric 1.4 的Makefile，轻松掌握Fabric构建">
<meta name="twitter:description" content="初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。 fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。 Makefile文件就在fabric的">






  <link rel="canonical" href="http://lessisbetter.site/2019/07/16/fabric-makefile/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>通过Fabric 1.4 的Makefile，轻松掌握Fabric构建 | 大彬 LIB</title>
  












  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">大彬 LIB</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">大道至简 less is better</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-主页">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />主页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-标签云">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签云</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-专题文章">

    
    
    
      
    

    

    <a href="/subject/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />专题文章</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-文章列表">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />文章列表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-关于">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-内推">

    
    
    
      
    

    

    <a href="/jobs/" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />内推</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

    <a href="https://github.com/Shitaibin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/07/16/fabric-makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="技术与人生 | 区块链架构师">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="大彬 LIB">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">通过Fabric 1.4 的Makefile，轻松掌握Fabric构建

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-16 07:18:48 / 修改时间：07:27:30" itemprop="dateCreated datePublished" datetime="2019-07-16T07:18:48+08:00">2019-07-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>初次接触fabric会遇到各种构建问题，坑很多，网上有各种规避办法，但规避不是解决办法，所以决定把fabric的Makefile扫一遍。</p>
<p>fabric的Makefile包含了fabric所有的构建信息，掌握了这个Makefile，遇到任何构建问题，我相信你都能找到问题的根源，并从根上解决问题。而不是遇到问题，就网上找资料，结果做了很多无用功，也无法解决问题。</p>
<p>Makefile文件就在fabric的根目录下，该文件还引入了另外2个Makefile文件：</p>
<ol>
<li>docker-env.mk，这个文件描述了Docker构建先关的信息</li>
<li>gotools.mk，这个文件描述了go tools相关的构建信息</li>
</ol>
<p>我们先介绍Makefile文件，然后介绍另外2个文件，如果想在Makefile遇到这2个文件的时候查看，可随时使用目录跳转去查看即可。</p>
<p>即使掌握了Makefile，仍然会遇到一些问题，所以最后会给出一些建议，让你少踩一些坑。</p>
<blockquote>
<p>本文基于fabric 1.4，commit id：9dce73，不同版本可能有细微差别，但不影响掌握构建过程。</p>
</blockquote>
<h1 id="Makefile详细解读"><a href="#Makefile详细解读" class="headerlink" title="Makefile详细解读"></a>Makefile详细解读</h1><p>Makefile看起来有点长，磨刀不误砍柴工，花2个小时，是非常有益处的，建议多看几遍，吃透编译流程。</p>
<h2 id="fabric的Makefile"><a href="#fabric的Makefile" class="headerlink" title="fabric的Makefile"></a>fabric的Makefile</h2><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright IBM Corp All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># -------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># This makefile defines the following targets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># make项列表</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 构建所有</span></span><br><span class="line"><span class="comment">#   - all (default) - builds all targets and runs all non-integration tests/checks</span></span><br><span class="line"><span class="comment"># 运行所有测试和检查</span></span><br><span class="line"><span class="comment">#   - checks - runs all non-integration tests/checks</span></span><br><span class="line"><span class="comment"># 运行linter和verify来检查改动的文件</span></span><br><span class="line"><span class="comment">#   - desk-check - runs linters and verify to test changed packages</span></span><br><span class="line"><span class="comment"># 构建configtxgen，主要用来创建创世块、创建通道时的配置交易、更新通道的锚点交易</span></span><br><span class="line"><span class="comment">#   - configtxgen - builds a native configtxgen binary</span></span><br><span class="line"><span class="comment"># 构建configtxlator，configtxgen生成的配置是二进制，使用configtxlator转换为json</span></span><br><span class="line"><span class="comment">#   - configtxlator - builds a native configtxlator binary</span></span><br><span class="line"><span class="comment"># 构建cryptogen，提供加解密的程序</span></span><br><span class="line"><span class="comment">#   - cryptogen  -  builds a native cryptogen binary</span></span><br><span class="line"><span class="comment"># 构建idemixgen，用来创建身份（id）混合器创建配置文件</span></span><br><span class="line"><span class="comment">#   - idemixgen  -  builds a native idemixgen binary</span></span><br><span class="line"><span class="comment"># peer节点</span></span><br><span class="line"><span class="comment">#   - peer - builds a native fabric peer binary</span></span><br><span class="line"><span class="comment"># 排序节点</span></span><br><span class="line"><span class="comment">#   - orderer - builds a native fabric orderer binary</span></span><br><span class="line"><span class="comment"># 发布当前平台的包</span></span><br><span class="line"><span class="comment">#   - release - builds release packages for the host platform</span></span><br><span class="line"><span class="comment"># 发布所有平台的包</span></span><br><span class="line"><span class="comment">#   - release-all - builds release packages for all target platforms</span></span><br><span class="line"><span class="comment"># 跑单元测试</span></span><br><span class="line"><span class="comment">#   - unit-test - runs the go-test based unit tests</span></span><br><span class="line"><span class="comment"># 对更改过的文件跑单元测试</span></span><br><span class="line"><span class="comment">#   - verify - runs unit tests for only the changed package tree</span></span><br><span class="line"><span class="comment"># 以coverprofile模式对所有pkg跑单元测试</span></span><br><span class="line"><span class="comment">#   - profile - runs unit tests for all packages in coverprofile mode (slow)</span></span><br><span class="line"><span class="comment">#   - test-cmd - generates a "go test" string suitable for manual customization</span></span><br><span class="line"><span class="comment"># 安装go tools，TODO 安装到哪，镜像还是外部GOPATH下？</span></span><br><span class="line"><span class="comment">#   - gotools - installs go tools like golint</span></span><br><span class="line"><span class="comment"># 对所有代码运行lint</span></span><br><span class="line"><span class="comment">#   - linter - runs all code checks</span></span><br><span class="line"><span class="comment"># 检查dep依赖</span></span><br><span class="line"><span class="comment">#   - check-deps - check for vendored dependencies that are no longer used</span></span><br><span class="line"><span class="comment"># 检查所有代码Apache license</span></span><br><span class="line"><span class="comment">#   - license - checks go source files for Apache license header</span></span><br><span class="line"><span class="comment"># 构建所有的native程序，包含peer，orderer等</span></span><br><span class="line"><span class="comment">#   - native - ensures all native binaries are available</span></span><br><span class="line"><span class="comment"># 构建所有的docker镜像，docker-clean为清除镜像</span></span><br><span class="line"><span class="comment">#   - docker[-clean] - ensures all docker images are available[/cleaned]</span></span><br><span class="line"><span class="comment"># 列出所有相关的docker镜像</span></span><br><span class="line"><span class="comment">#   - docker-list - generates a list of docker images that 'make docker' produces</span></span><br><span class="line"><span class="comment"># 构建peer-docker镜像</span></span><br><span class="line"><span class="comment">#   - peer-docker[-clean] - ensures the peer container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 构建orderer-docker镜像</span></span><br><span class="line"><span class="comment">#   - orderer-docker[-clean] - ensures the orderer container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 构建tools-docker镜像</span></span><br><span class="line"><span class="comment">#   - tools-docker[-clean] - ensures the tools container is available[/cleaned]</span></span><br><span class="line"><span class="comment"># 基于.proto文件生成所有的protobuf文件</span></span><br><span class="line"><span class="comment">#   - protos - generate all protobuf artifacts based on .proto files</span></span><br><span class="line"><span class="comment"># 清理所有构建数据</span></span><br><span class="line"><span class="comment">#   - clean - cleans the build area</span></span><br><span class="line"><span class="comment"># 比clean更牛，还会清理掉持久状态数据</span></span><br><span class="line"><span class="comment">#   - clean-all - superset of 'clean' that also removes persistent state</span></span><br><span class="line"><span class="comment"># 清理发布的包</span></span><br><span class="line"><span class="comment">#   - dist-clean - clean release packages for all target platforms</span></span><br><span class="line"><span class="comment"># 清理单元测试状态数据</span></span><br><span class="line"><span class="comment">#   - unit-test-clean - cleans unit test state (particularly from docker)</span></span><br><span class="line"><span class="comment"># 执行基本的检查，比如license，拼写，lint等</span></span><br><span class="line"><span class="comment">#   - basic-checks - performs basic checks like license, spelling, trailing spaces and linter</span></span><br><span class="line"><span class="comment"># CI使用的选项</span></span><br><span class="line"><span class="comment">#   - enable_ci_only_tests - triggers unit-tests in downstream jobs. Applicable only for CI not to</span></span><br><span class="line"><span class="comment">#     use in the local machine.</span></span><br><span class="line"><span class="comment"># 拉去第三方docker镜像</span></span><br><span class="line"><span class="comment">#   - docker-thirdparty - pulls thirdparty images (kafka,zookeeper,couchdb)</span></span><br><span class="line"><span class="comment"># 把所有make docker所产生的镜像，打上latest tag</span></span><br><span class="line"><span class="comment">#   - docker-tag-latest - re-tags the images made by 'make docker' with the :latest tag</span></span><br><span class="line"><span class="comment"># 把所有make docker所产生的镜像，打上stable tag</span></span><br><span class="line"><span class="comment">#   - docker-tag-stable - re-tags the images made by 'make docker' with the :stable tag</span></span><br><span class="line"><span class="comment"># 生成命令参考文档</span></span><br><span class="line"><span class="comment">#   - help-docs - generate the command reference docs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础版本</span></span><br><span class="line">BASE_VERSION = 1.4.2</span><br><span class="line"><span class="comment"># 前一个版本</span></span><br><span class="line">PREV_VERSION = 1.4.1</span><br><span class="line"><span class="comment"># chaintool版本</span></span><br><span class="line">CHAINTOOL_RELEASE=1.1.3</span><br><span class="line"><span class="comment"># 基础镜像版本</span></span><br><span class="line">BASEIMAGE_RELEASE=0.4.15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置项目名称，如果没有设置，则使用hyperledger</span></span><br><span class="line"><span class="comment"># Allow to build as a submodule setting the main project to</span></span><br><span class="line"><span class="comment"># the PROJECT_NAME env variable, for example,</span></span><br><span class="line"><span class="comment"># export PROJECT_NAME=hyperledger/fabric-test</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(PROJECT_NAME)</span>,true)</span><br><span class="line">PROJECT_NAME = <span class="variable">$(PROJECT_NAME)</span>/fabric</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">PROJECT_NAME = hyperledger/fabric</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建路径</span></span><br><span class="line"><span class="comment"># ?=指当没有指定BUILD_DIR时，才使用默认的`.build`作为构建目录</span></span><br><span class="line">BUILD_DIR ?= .build</span><br><span class="line"><span class="comment"># 未知，全文未使用</span></span><br><span class="line">NEXUS_REPO = nexus3.hyperledger.org:10001/hyperledger</span><br><span class="line"></span><br><span class="line"><span class="comment"># 额外版本：git commit号</span></span><br><span class="line">EXTRA_VERSION ?= <span class="variable">$(<span class="built_in">shell</span> git rev-parse --short HEAD)</span></span><br><span class="line"><span class="comment"># 项目版本由基础版本和额外版本组成</span></span><br><span class="line">PROJECT_VERSION=<span class="variable">$(BASE_VERSION)</span>-snapshot-<span class="variable">$(EXTRA_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go编译信息</span></span><br><span class="line"><span class="comment"># 设置包名</span></span><br><span class="line">PKGNAME = github.com/<span class="variable">$(PROJECT_NAME)</span></span><br><span class="line"><span class="comment"># CGO编译选项</span></span><br><span class="line">CGO_FLAGS = CGO_CFLAGS=<span class="string">" "</span></span><br><span class="line"><span class="comment"># 当前CPU架构</span></span><br><span class="line">ARCH=<span class="variable">$(<span class="built_in">shell</span> go env GOARCH)</span></span><br><span class="line"><span class="comment"># OS和CPU架构</span></span><br><span class="line">MARCH=<span class="variable">$(<span class="built_in">shell</span> go env GOOS)</span>-<span class="variable">$(<span class="built_in">shell</span> go env GOARCH)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go编译时传入的版本信息，主要是docker相关信息，比如</span></span><br><span class="line"><span class="comment">## var Version string = "latest"</span></span><br><span class="line"><span class="comment">## var CommitSHA string = "development build"</span></span><br><span class="line"><span class="comment">## var BaseVersion string = "0.4.15"</span></span><br><span class="line"><span class="comment">## var BaseDockerLabel string = "org.hyperledger.fabric"</span></span><br><span class="line"><span class="comment">## var DockerNamespace string = "hyperledger"</span></span><br><span class="line"><span class="comment">## var BaseDockerNamespace string = "hyperledger"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defined in common/metadata/metadata.go</span></span><br><span class="line">METADATA_VAR = Version=<span class="variable">$(BASE_VERSION)</span></span><br><span class="line">METADATA_VAR += CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span><br><span class="line">METADATA_VAR += BaseVersion=<span class="variable">$(BASEIMAGE_RELEASE)</span></span><br><span class="line">METADATA_VAR += BaseDockerLabel=<span class="variable">$(BASE_DOCKER_LABEL)</span></span><br><span class="line">METADATA_VAR += DockerNamespace=<span class="variable">$(DOCKER_NS)</span></span><br><span class="line">METADATA_VAR += BaseDockerNamespace=<span class="variable">$(BASE_DOCKER_NS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用GO_LDFLAGS设置go的ldflag信息，传入METADATA_VAR</span></span><br><span class="line"><span class="comment"># patsubst指替换通配符</span></span><br><span class="line">GO_LDFLAGS = <span class="variable">$(<span class="built_in">patsubst</span> %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line">GO_TAGS ?=</span><br><span class="line"></span><br><span class="line"><span class="comment"># chaintool下载链接</span></span><br><span class="line">CHAINTOOL_URL ?= https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/chaintool-<span class="variable">$(CHAINTOOL_RELEASE)</span>/hyperledger-fabric-chaintool-<span class="variable">$(CHAINTOOL_RELEASE)</span>.jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> GO_LDFLAGS GO_TAGS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查go、docker、git、curl这几个程序是否存在</span></span><br><span class="line">EXECUTABLES ?= go docker git curl</span><br><span class="line">K := <span class="variable">$(<span class="built_in">foreach</span> exec,<span class="variable">$(EXECUTABLES)</span>,\</span></span><br><span class="line"><span class="variable">	$(<span class="built_in">if</span> $(<span class="built_in">shell</span> which <span class="variable">$(exec)</span>)</span>,some string,<span class="variable">$(<span class="built_in">error</span> "No <span class="variable">$(exec)</span> in PATH: Check dependencies")</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go shim的依赖项，shim是chaincode的一个模块，可以先不去理解</span></span><br><span class="line">GOSHIM_DEPS = <span class="variable">$(<span class="built_in">shell</span> ./scripts/goListFiles.sh <span class="variable">$(PKGNAME)</span>/core/chaincode/shim)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># protobuf相关的文件</span></span><br><span class="line">PROTOS = <span class="variable">$(<span class="built_in">shell</span> git ls-files *.proto | grep -Ev 'vendor/|testdata/')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目文件，不包含git、样例、图片、vendor等文件</span></span><br><span class="line"><span class="comment"># No sense rebuilding when non production code is changed</span></span><br><span class="line">PROJECT_FILES = <span class="variable">$(<span class="built_in">shell</span> git ls-files  | grep -v ^test | grep -v ^unit-test | \</span></span><br><span class="line"><span class="variable">	grep -v ^.git | grep -v ^examples | grep -v ^devenv | grep -v .png$ | \</span></span><br><span class="line"><span class="variable">	grep -v ^LICENSE | grep -v ^vendor )</span></span><br><span class="line"><span class="comment"># docker镜像发布模板</span></span><br><span class="line">RELEASE_TEMPLATES = <span class="variable">$(<span class="built_in">shell</span> git ls-files | grep "release/templates")</span></span><br><span class="line"><span class="comment"># 镜像列表</span></span><br><span class="line">IMAGES = peer orderer ccenv buildenv tools</span><br><span class="line"><span class="comment"># 发布平台</span></span><br><span class="line">RELEASE_PLATFORMS = windows-amd64 darwin-amd64 linux-amd64 linux-s390x linux-ppc64le</span><br><span class="line"><span class="comment"># 发布的package</span></span><br><span class="line">RELEASE_PKGS = configtxgen cryptogen idemixgen discover configtxlator peer orderer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要发的pkg和它们的路径</span></span><br><span class="line">pkgmap.cryptogen      := <span class="variable">$(PKGNAME)</span>/common/tools/cryptogen</span><br><span class="line">pkgmap.idemixgen      := <span class="variable">$(PKGNAME)</span>/common/tools/idemixgen</span><br><span class="line">pkgmap.configtxgen    := <span class="variable">$(PKGNAME)</span>/common/tools/configtxgen</span><br><span class="line">pkgmap.configtxlator  := <span class="variable">$(PKGNAME)</span>/common/tools/configtxlator</span><br><span class="line">pkgmap.peer           := <span class="variable">$(PKGNAME)</span>/peer</span><br><span class="line">pkgmap.orderer        := <span class="variable">$(PKGNAME)</span>/orderer</span><br><span class="line">pkgmap.block-listener := <span class="variable">$(PKGNAME)</span>/examples/events/block-listener</span><br><span class="line">pkgmap.discover       := <span class="variable">$(PKGNAME)</span>/cmd/discover</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把docker-env.mk包含进来，主要是docker构建相关的选项</span></span><br><span class="line"><span class="keyword">include</span> docker-env.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># all包含/依赖了编译程序、编译镜像和进行检查</span></span><br><span class="line"><span class="comment"># all会进行检查，本地编译和发布docker镜像</span></span><br><span class="line"><span class="section">all: native docker checks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查包含/依赖了基本检查、单元测试和集成测试</span></span><br><span class="line"><span class="section">checks: basic-checks unit-test integration-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本检查指许可证、拼写和格式</span></span><br><span class="line"><span class="section">basic-checks: license spelling trailing-spaces linter check-metrics-doc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含/依赖检查和验证</span></span><br><span class="line"><span class="section">desk-check: checks verify</span></span><br><span class="line"></span><br><span class="line"><span class="section">help-docs: native</span></span><br><span class="line">	@scripts/generateHelpDocs.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取第三方镜像，并打上tag，BASE_DOCKER_TAG定义在docker-env.mk</span></span><br><span class="line"><span class="comment"># 都是fabric定制的couchdb、zookeeper、kafka镜像</span></span><br><span class="line"><span class="comment"># Pull thirdparty docker images based on the latest baseimage release version</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: docker-thirdparty</span></span><br><span class="line"><span class="section">docker-thirdparty:</span></span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-couchdb:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-couchdb:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-couchdb</span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-zookeeper:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-zookeeper:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-zookeeper</span><br><span class="line">	docker pull <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-kafka:<span class="variable">$(BASE_DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(BASE_DOCKER_NS)</span>/fabric-kafka:<span class="variable">$(BASE_DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-kafka</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行拼写检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: spelling</span></span><br><span class="line"><span class="section">spelling:</span></span><br><span class="line">	@scripts/check_spelling.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行许可证检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: license</span></span><br><span class="line"><span class="section">license:</span></span><br><span class="line">	@scripts/check_license.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用脚本执行末尾空格检查</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: trailing-spaces</span></span><br><span class="line"><span class="section">trailing-spaces:</span></span><br><span class="line">	@scripts/check_trailingspaces.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含gotools.mk，这个文件主要用来安装一些gotools，可以使用单个命令来装某个gotools，比如安装dep</span></span><br><span class="line"><span class="comment"># `make gotool.dep`，具体见该文件</span></span><br><span class="line"><span class="keyword">include</span> gotools.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际调用gotools-install安装相关的gotools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools</span></span><br><span class="line"><span class="section">gotools: gotools-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下这段设置是各程序的依赖</span></span><br><span class="line"><span class="comment"># 编译peer，依赖./build/bin/peer</span></span><br><span class="line"><span class="comment"># 编译peer-docker，依赖./build/image/peer/$(DUMMY)，DUMMY指DOCKER-TAG，定义在docker-env.mk</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: peer</span></span><br><span class="line"><span class="section">peer: <span class="variable">$(BUILD_DIR)</span>/bin/peer</span></span><br><span class="line"><span class="section">peer-docker: <span class="variable">$(BUILD_DIR)</span>/image/peer/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># orderer和镜像的依赖</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: orderer</span></span><br><span class="line"><span class="section">orderer: <span class="variable">$(BUILD_DIR)</span>/bin/orderer</span></span><br><span class="line"><span class="section">orderer-docker: <span class="variable">$(BUILD_DIR)</span>/image/orderer/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译configtxgen的依赖</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: configtxgen</span></span><br><span class="line"><span class="section">configtxgen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">configtxgen: <span class="variable">$(BUILD_DIR)</span>/bin/configtxgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译configtxlator的依赖</span></span><br><span class="line"><span class="section">configtxlator: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">configtxlator: <span class="variable">$(BUILD_DIR)</span>/bin/configtxlator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译cryptogen的依赖</span></span><br><span class="line"><span class="section">cryptogen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">cryptogen: <span class="variable">$(BUILD_DIR)</span>/bin/cryptogen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译idemixgen的依赖</span></span><br><span class="line"><span class="section">idemixgen: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"><span class="section">idemixgen: <span class="variable">$(BUILD_DIR)</span>/bin/idemixgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译discover的依赖</span></span><br><span class="line"><span class="section">discover: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.Version=<span class="variable">$(PROJECT_VERSION)</span></span></span><br><span class="line"><span class="section">discover: <span class="variable">$(BUILD_DIR)</span>/bin/discover</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译tools相关的docker</span></span><br><span class="line"><span class="section">tools-docker: <span class="variable">$(BUILD_DIR)</span>/image/tools/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建环境（buildenv)镜像</span></span><br><span class="line"><span class="section">buildenv: <span class="variable">$(BUILD_DIR)</span>/image/buildenv/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 未知</span></span><br><span class="line"><span class="section">ccenv: <span class="variable">$(BUILD_DIR)</span>/image/ccenv/<span class="variable">$(DUMMY)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行集成测试</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: integration-test</span></span><br><span class="line"><span class="section">integration-test: gotool.ginkgo ccenv docker-thirdparty</span></span><br><span class="line">	./scripts/run-integration-tests.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行单元测试</span></span><br><span class="line"><span class="section">unit-test: unit-test-clean peer-docker docker-thirdparty ccenv</span></span><br><span class="line">	unit-test/run.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行单元测试</span></span><br><span class="line"><span class="section">unit-tests: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CI选项</span></span><br><span class="line"><span class="section">enable_ci_only_tests: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行verify，就像注释说的，依然是单元测试</span></span><br><span class="line"><span class="section">verify: export JOB_TYPE=VERIFY</span></span><br><span class="line"><span class="section">verify: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行带有profile的单元测试</span></span><br><span class="line"><span class="section">profile: export JOB_TYPE=PROFILE</span></span><br><span class="line"><span class="section">profile: unit-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generates a string to the terminal suitable for manual augmentation / re-issue, useful for running tests by hand</span></span><br><span class="line"><span class="section">test-cmd:</span></span><br><span class="line">	@echo <span class="string">"go test -tags \"<span class="variable">$(GO_TAGS)\"</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译所有docker镜像，依赖都是.build/image下</span></span><br><span class="line"><span class="section">docker: $(patsubst %,<span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译所有native程序，native指所有fabric本身的程序，依赖如下</span></span><br><span class="line"><span class="section">native: peer orderer configtxgen cryptogen idemixgen configtxlator discover</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行linter</span></span><br><span class="line"><span class="section">linter: check-deps buildenv</span></span><br><span class="line">	@echo <span class="string">"LINT: Running code checks.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/golinter.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行check-deps</span></span><br><span class="line"><span class="section">check-deps: buildenv</span></span><br><span class="line">	@echo <span class="string">"DEP: Checking for dependency issues.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/check_deps.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行check-metrics-doc</span></span><br><span class="line"><span class="section">check-metrics-doc: buildenv</span></span><br><span class="line">	@echo <span class="string">"METRICS: Checking for outdated reference documentation.."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/metrics_doc.sh check</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行generate-metrics-doc</span></span><br><span class="line"><span class="section">generate-metrics-doc: buildenv</span></span><br><span class="line">	@echo <span class="string">"Generating metrics reference documentation..."</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/metrics_doc.sh generate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装chain tool</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%/chaintool: Makefile</span><br><span class="line">	@echo <span class="string">"Installing chaintool"</span></span><br><span class="line">	@mkdir -p $(@D)</span><br><span class="line">	curl -fL <span class="variable">$(CHAINTOOL_URL)</span> &gt; <span class="variable">$@</span></span><br><span class="line">	chmod +x <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We (re)build a package within a docker context but persist the $GOPATH/pkg</span></span><br><span class="line"><span class="comment"># directory so that subsequent builds are faster</span></span><br><span class="line"><span class="comment"># 构建所有镜像和pkg</span></span><br><span class="line"><span class="comment"># DRUN是`docker run`和参数的简写</span></span><br><span class="line"><span class="comment"># 本地创建docker里要用到的gopath目录，然后挂载到docker里</span></span><br><span class="line"><span class="comment"># 然后在docker里按个编译pkgmap里面的程序，比如peer、orderer、cryptogen等等</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/bin/%: <span class="variable">$(PROJECT_FILES)</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/docker/bin/%,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span>"</span></span><br><span class="line">	@mkdir -p <span class="variable">$(BUILD_DIR)</span>/docker/bin <span class="variable">$(BUILD_DIR)</span>/docker/<span class="variable">$(TARGET)</span>/pkg</span><br><span class="line">	@<span class="variable">$(DRUN)</span> \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(BUILD_DIR)</span>/docker/bin)</span>:/opt/gopath/bin \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(BUILD_DIR)</span>/docker/<span class="variable">$(TARGET)</span>/pkg)</span>:/opt/gopath/pkg \</span><br><span class="line">		<span class="variable">$(BASE_DOCKER_NS)</span>/fabric-baseimage:<span class="variable">$(BASE_DOCKER_TAG)</span> \</span><br><span class="line">		go install -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(DOCKER_GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建本地bin目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/bin:</span><br><span class="line">	mkdir -p <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行changelog</span></span><br><span class="line"><span class="section">changelog:</span></span><br><span class="line">	./scripts/changelog.sh v<span class="variable">$(PREV_VERSION)</span> v<span class="variable">$(BASE_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># protoc-gen-go依赖.build/docker/gotools</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go: <span class="variable">$(BUILD_DIR)</span>/docker/gotools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建go tools的docker镜像，给payload使用</span></span><br><span class="line"><span class="comment"># 创建本地目录(.build/docker/gotools)并挂载到(/opt/gotools)，依赖基础镜像，然后在docker中执行gotools.mk</span></span><br><span class="line"><span class="comment"># 最后调用gotools.mk生成程序，设置了GOTOOLS_BINDIR，生成的二进制会放在这个目录，因为这个目录映射了出来，</span></span><br><span class="line"><span class="comment"># 所以bin就在主机的`.build/docker/gotools/bin/`目录</span></span><br><span class="line"><span class="comment"># So, 如果构建成功，不需要像其他文章说的那样，需要手动拷贝protoc-gen-go到`.build/docker/gotools/bin/`目录</span></span><br><span class="line"><span class="comment"># 但是，如果翻墙失败，可以考虑手动复制protoc-gen-go的方式</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/docker/gotools: gotools.mk</span><br><span class="line">	@echo <span class="string">"Building dockerized gotools"</span></span><br><span class="line">	@mkdir -p <span class="variable">$@</span>/bin <span class="variable">$@</span>/obj</span><br><span class="line">	@<span class="variable">$(DRUN)</span> \</span><br><span class="line">		-v <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span>:/opt/gotools \</span><br><span class="line">		-w /opt/gopath/src/<span class="variable">$(PKGNAME)</span> \</span><br><span class="line">		<span class="variable">$(BASE_DOCKER_NS)</span>/fabric-baseimage:<span class="variable">$(BASE_DOCKER_TAG)</span> \</span><br><span class="line">		make -f gotools.mk GOTOOLS_BINDIR=/opt/gotools/bin GOTOOLS_GOPATH=/opt/gotools/obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建本地的运行文件，依赖设置都在上面了，这是进行构建，与Docker类似</span></span><br><span class="line"><span class="comment"># 程序即pkgmap中的程序</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/bin/%: <span class="variable">$(PROJECT_FILES)</span></span><br><span class="line">	@mkdir -p $(@D)</span><br><span class="line">	@echo <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> $(@D)</span>) go install -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line">	@echo <span class="string">"Binary available as <span class="variable">$@</span>"</span></span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置各镜像各自的payload文件</span></span><br><span class="line"><span class="comment"># 比如ccenv的payload拷贝会翻译成：cp .build/docker/gotools/bin/protoc-gen-go .build/bin/chaintool .build/goshim.tar.bz2 .build/image/ccenv/payload</span></span><br><span class="line"><span class="comment"># payload definitions'</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/ccenv/payload:      <span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/bin/chaintool \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/peer/payload:       <span class="variable">$(BUILD_DIR)</span>/docker/bin/peer \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/orderer/payload:    <span class="variable">$(BUILD_DIR)</span>/docker/bin/orderer \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2</span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/buildenv/payload:   <span class="variable">$(BUILD_DIR)</span>/gotools.tar.bz2 \</span><br><span class="line">				<span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 各镜像payload的实际拷贝</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/payload:</span><br><span class="line">	mkdir -p <span class="variable">$@</span></span><br><span class="line">	cp <span class="variable">$^</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">.PRECIOUS: <span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据image下的各目录中的Dockerfile.in生成对应的Dockerfile</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile: images/%/Dockerfile.in</span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	@cat <span class="variable">$&lt;</span> \</span><br><span class="line">		| sed -e 's|_BASE_NS_|<span class="variable">$(BASE_DOCKER_NS)</span>|g' \</span><br><span class="line">		| sed -e 's|_NS_|<span class="variable">$(DOCKER_NS)</span>|g' \</span><br><span class="line">		| sed -e 's|_BASE_TAG_|<span class="variable">$(BASE_DOCKER_TAG)</span>|g' \</span><br><span class="line">		| sed -e 's|_TAG_|<span class="variable">$(DOCKER_TAG)</span>|g' \</span><br><span class="line">		&gt; <span class="variable">$@</span></span><br><span class="line">	@echo LABEL <span class="variable">$(BASE_DOCKER_LABEL)</span>.version=<span class="variable">$(BASE_VERSION)</span> \\&gt;&gt;<span class="variable">$@</span></span><br><span class="line">	@echo <span class="string">"     "</span> <span class="variable">$(BASE_DOCKER_LABEL)</span>.base.version=<span class="variable">$(BASEIMAGE_RELEASE)</span>&gt;&gt;<span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Dockerfile生成tools-image，并打上2个tag，分别是当前版本tag和latest tag</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/tools/<span class="variable">$(DUMMY)</span>: <span class="variable">$(BUILD_DIR)</span>/image/tools/Dockerfile</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building docker <span class="variable">$(TARGET)</span>-image"</span></span><br><span class="line">	<span class="variable">$(DBUILD)</span> -t <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> -f $(@D)/Dockerfile .</span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-latest</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Dockerfile、payload生成image下的所有镜像，比如orderer，然后打上tag</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>: Makefile <span class="variable">$(BUILD_DIR)</span>/image/%/payload <span class="variable">$(BUILD_DIR)</span>/image/%/Dockerfile</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> <span class="variable">$(BUILD_DIR)</span>/image/%/<span class="variable">$(DUMMY)</span>,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building docker <span class="variable">$(TARGET)</span>-image"</span></span><br><span class="line">	<span class="variable">$(DBUILD)</span> -t <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> $(@D)</span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-latest</span><br><span class="line">	@touch <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包gotools</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/gotools.tar.bz2: <span class="variable">$(BUILD_DIR)</span>/docker/gotools</span><br><span class="line">	(cd <span class="variable">$&lt;</span>/bin &amp;&amp; tar -jc *) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包goshim</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2: <span class="variable">$(GOSHIM_DEPS)</span></span><br><span class="line">	@echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">	@tar -jhc -C <span class="variable">$(GOPATH)</span>/src <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(GOPATH)</span>/src/%,%,<span class="variable">$(GOSHIM_DEPS)</span>)</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包sampleconfig</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/sampleconfig.tar.bz2: <span class="variable">$(<span class="built_in">shell</span> find sampleconfig -type f)</span></span><br><span class="line">	(cd sampleconfig &amp;&amp; tar -jc *) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包protos</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/protos.tar.bz2: <span class="variable">$(PROTOS)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.tar.bz2:</span><br><span class="line">	@echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">	@tar -jc <span class="variable">$^</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布当前平台的relase包</span></span><br><span class="line"><span class="comment"># builds release packages for the host platform</span></span><br><span class="line"><span class="section">release: $(patsubst %,release/%, <span class="variable">$(MARCH)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># builds release packages for all target platforms</span></span><br><span class="line"><span class="section">release-all: $(patsubst %,release/%, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%: GO_LDFLAGS=-X $(pkgmap.$(@F))/metadata.CommitSHA=<span class="variable">$(EXTRA_VERSION)</span></span></span><br><span class="line"></span><br><span class="line"><span class="section">release/windows-amd64: GOOS=windows</span></span><br><span class="line"><span class="section">release/windows-amd64: $(patsubst %,release/windows-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/darwin-amd64: GOOS=darwin</span></span><br><span class="line"><span class="section">release/darwin-amd64: $(patsubst %,release/darwin-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-amd64: GOOS=linux</span></span><br><span class="line"><span class="section">release/linux-amd64: $(patsubst %,release/linux-amd64/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%-amd64: GOARCH=amd64</span></span><br><span class="line"><span class="section">release/linux-%: GOOS=linux</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-s390x: GOARCH=s390x</span></span><br><span class="line"><span class="section">release/linux-s390x: $(patsubst %,release/linux-s390x/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/linux-ppc64le: GOARCH=ppc64le</span></span><br><span class="line"><span class="section">release/linux-ppc64le: $(patsubst %,release/linux-ppc64le/bin/%, <span class="variable">$(RELEASE_PKGS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/configtxlator: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/configtxgen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/cryptogen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/idemixgen: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/discover: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/orderer: GO_LDFLAGS = $(patsubst %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/orderer: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/peer: GO_LDFLAGS = $(patsubst %,-X <span class="variable">$(PKGNAME)</span>/common/metadata.%,<span class="variable">$(METADATA_VAR)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">release/%/bin/peer: <span class="variable">$(PROJECT_FILES)</span></span></span><br><span class="line">	@echo <span class="string">"Building <span class="variable">$@</span> for <span class="variable">$(GOOS)</span>-<span class="variable">$(GOARCH)</span>"</span></span><br><span class="line">	mkdir -p $(@D)</span><br><span class="line">	<span class="variable">$(CGO_FLAGS)</span> GOOS=<span class="variable">$(GOOS)</span> GOARCH=<span class="variable">$(GOARCH)</span> go build -o <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$@</span>)</span> -tags <span class="string">"<span class="variable">$(GO_TAGS)</span>"</span> -ldflags <span class="string">"<span class="variable">$(GO_LDFLAGS)</span>"</span> $(pkgmap.$(@F))</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: dist</span></span><br><span class="line"><span class="section">dist: dist-clean dist/<span class="variable">$(MARCH)</span></span></span><br><span class="line"></span><br><span class="line"><span class="section">dist-all: dist-clean $(patsubst %,dist/%, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist/%: release/%</span></span><br><span class="line">	mkdir -p release/$(@F)/config</span><br><span class="line">	cp -r sampleconfig/*.yaml release/$(@F)/config</span><br><span class="line">	cd release/$(@F) &amp;&amp; tar -czvf hyperledger-fabric-$(@F).<span class="variable">$(PROJECT_VERSION)</span>.tar.gz *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在docker中生成protobuf文件</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: protos</span></span><br><span class="line"><span class="section">protos: buildenv</span></span><br><span class="line">	@<span class="variable">$(DRUN)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-buildenv:<span class="variable">$(DOCKER_TAG)</span> ./scripts/compile_protos.sh</span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-list:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-list,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出当前所有镜像</span></span><br><span class="line"><span class="section">docker-list: $(patsubst %,%-docker-list, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-clean:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-clean,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	-docker images --quiet --filter=reference='<span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(ARCH)</span>-<span class="variable">$(BASE_VERSION)</span><span class="variable">$(<span class="built_in">if</span> <span class="variable">$(EXTRA_VERSION)</span>,-snapshot-*,)</span>' | xargs docker rmi -f</span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span>/image/<span class="variable">$(TARGET)</span> ||:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有镜像</span></span><br><span class="line"><span class="section">docker-clean: $(patsubst %,%-docker-clean, <span class="variable">$(IMAGES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">docker-tag-latest: $(IMAGES:%=%-docker-tag-latest)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-tag-latest:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-tag-latest,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:latest</span><br><span class="line"></span><br><span class="line"><span class="section">docker-tag-stable: $(IMAGES:%=%-docker-tag-stable)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%-docker-tag-stable:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-docker-tag-stable,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	docker tag <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:<span class="variable">$(DOCKER_TAG)</span> <span class="variable">$(DOCKER_NS)</span>/fabric-<span class="variable">$(TARGET)</span>:stable</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: docker-clean unit-test-clean release-clean</span></span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有状态数据，依赖tools清理，发包清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean-all</span></span><br><span class="line"><span class="section">clean-all: clean gotools-clean dist-clean</span></span><br><span class="line">	-@rm -rf /var/hyperledger/*</span><br><span class="line">	-@rm -rf docs/build/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布版本清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: dist-clean</span></span><br><span class="line"><span class="section">dist-clean:</span></span><br><span class="line">	-@rm -rf release/windows-amd64/hyperledger-fabric-windows-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/darwin-amd64/hyperledger-fabric-darwin-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-amd64/hyperledger-fabric-linux-amd64.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-s390x/hyperledger-fabric-linux-s390x.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line">	-@rm -rf release/linux-ppc64le/hyperledger-fabric-linux-ppc64le.<span class="variable">$(PROJECT_VERSION)</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="section">%-release-clean:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TARGET = $&#123;<span class="built_in">patsubst</span> %-release-clean,%,$&#123;@&#125;&#125;)</span></span><br><span class="line">	-@rm -rf release/<span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发包清理</span></span><br><span class="line"><span class="section">release-clean: $(patsubst %,%-release-clean, <span class="variable">$(RELEASE_PLATFORMS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单元测试清理</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: unit-test-clean</span></span><br><span class="line"><span class="section">unit-test-clean:</span></span><br><span class="line">	cd unit-test &amp;&amp; docker-compose down</span><br></pre></td></tr></table></figure>
<h2 id="docker-env的Makefile"><a href="#docker-env的Makefile" class="headerlink" title="docker env的Makefile"></a>docker env的Makefile</h2><p><code>docker-env.mk</code>主要是Docker镜像构建相关的设置。</p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">// docker-env.mk</span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mac上设置--user选项</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> uname)</span>,Darwin)</span><br><span class="line">DOCKER_RUN_FLAGS=--user=<span class="variable">$(<span class="built_in">shell</span> id -u)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 架构是s390x，uid不是0（root账号）的时候，-v选项</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">shell</span> uname -m)</span>,s390x)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> id -u)</span>,0)</span><br><span class="line">DOCKER_RUN_FLAGS+=-v /etc/passwd:/etc/passwd:ro</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下是http和https的代理设置</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(http_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'http_proxy=<span class="variable">$(http_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'http_proxy=<span class="variable">$(http_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(https_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'https_proxy=<span class="variable">$(https_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'https_proxy=<span class="variable">$(https_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(HTTP_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'HTTP_PROXY=<span class="variable">$(HTTP_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'HTTP_PROXY=<span class="variable">$(HTTP_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(HTTPS_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'HTTPS_PROXY=<span class="variable">$(HTTPS_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'HTTPS_PROXY=<span class="variable">$(HTTPS_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(no_proxy)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'no_proxy=<span class="variable">$(no_proxy)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'no_proxy=<span class="variable">$(no_proxy)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(NO_PROXY)</span>,)</span><br><span class="line">DOCKER_BUILD_FLAGS+=--build-arg 'NO_PROXY=<span class="variable">$(NO_PROXY)</span>'</span><br><span class="line">DOCKER_RUN_FLAGS+=-e 'NO_PROXY=<span class="variable">$(NO_PROXY)</span>'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DRUN代表docker run，并伴随以下参数，把当前路径映射到容器的gopath对应路径下</span></span><br><span class="line"><span class="comment"># 并且设置容器内的工作目录</span></span><br><span class="line">DRUN = docker run -i --rm <span class="variable">$(DOCKER_RUN_FLAGS)</span> \</span><br><span class="line">	-v <span class="variable">$(<span class="built_in">abspath</span> .)</span>:/opt/gopath/src/<span class="variable">$(PKGNAME)</span> \</span><br><span class="line">	-w /opt/gopath/src/<span class="variable">$(PKGNAME)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker build</span></span><br><span class="line">DBUILD = docker build <span class="variable">$(DOCKER_BUILD_FLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础docker namespace设置时，使用hyperledger</span></span><br><span class="line">BASE_DOCKER_NS ?= hyperledger</span><br><span class="line"><span class="comment"># 基础docker tag，由arch和release组成docker tag</span></span><br><span class="line">BASE_DOCKER_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(BASEIMAGE_RELEASE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与上面类似</span></span><br><span class="line">DOCKER_NS ?= hyperledger</span><br><span class="line">DOCKER_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line">PREV_TAG=<span class="variable">$(ARCH)</span>-<span class="variable">$(PREV_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础镜像标签</span></span><br><span class="line">BASE_DOCKER_LABEL=org.hyperledger.fabric</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态连接信息</span></span><br><span class="line">DOCKER_DYNAMIC_LINK ?= false</span><br><span class="line"><span class="comment"># Docker内的ldfalgs信息，继承makefile的</span></span><br><span class="line">DOCKER_GO_LDFLAGS += <span class="variable">$(GO_LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DOCKER_DYNAMIC_LINK)</span>,false)</span><br><span class="line">DOCKER_GO_LDFLAGS += -linkmode external -extldflags '-static -lpthread'</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># What is a .dummy file?</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make is designed to work with files.  It uses the presence (or lack thereof)</span></span><br><span class="line"><span class="comment"># and timestamps of files when deciding if a given target needs to be rebuilt.</span></span><br><span class="line"><span class="comment"># Docker containers throw a wrench into the works because the output of docker</span></span><br><span class="line"><span class="comment"># builds do not translate into standard files that makefile rules can evaluate.</span></span><br><span class="line"><span class="comment"># Therefore, we have to fake it.  We do this by constructioning our rules such</span></span><br><span class="line"><span class="comment"># as</span></span><br><span class="line"><span class="comment">#       my-docker-target/.dummy:</span></span><br><span class="line"><span class="comment">#              docker build ...</span></span><br><span class="line"><span class="comment">#              touch $@</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If the docker-build succeeds, the touch operation creates/updates the .dummy</span></span><br><span class="line"><span class="comment"># file.  If it fails, the touch command never runs.  This means the .dummy</span></span><br><span class="line"><span class="comment"># file follows relatively 1:1 with the underlying container.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This isn't perfect, however.  For instance, someone could delete a docker</span></span><br><span class="line"><span class="comment"># container using docker-rmi outside of the build, and make would be fooled</span></span><br><span class="line"><span class="comment"># into thinking the dependency is statisfied when it really isn't.  This is</span></span><br><span class="line"><span class="comment"># our closest approximation we can come up with.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># As an aside, also note that we incorporate the version number in the .dummy</span></span><br><span class="line"><span class="comment"># file to differentiate different tags to fix FAB-1145</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">DUMMY = .dummy-<span class="variable">$(DOCKER_TAG)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make是跟文件打交道的，它使用文件位置（？）和时间戳觉得是否要重新构建文件。</span></span><br><span class="line"><span class="comment"># 但Docker容器产生的文件是make无法识别的。所以做了适配，docker build运行</span></span><br><span class="line"><span class="comment"># 成功时，touch回去创建或更新dummy文件，如果失败则touch不执行。</span></span><br><span class="line"><span class="comment"># 这样保证了dummy文件和容器保持一对一的关系。</span></span><br></pre></td></tr></table></figure>
<h2 id="go-tools的Makefile"><a href="#go-tools的Makefile" class="headerlink" title="go tools的Makefile"></a>go tools的Makefile</h2><p>gotools指的一些列go语言的工具，并不是golang/tools仓库，具体是哪些tools，请看Makefile文件解析。</p>
<p>这些tools的安装有2种方式：</p>
<ol>
<li>少数几个支持从vendor目录直接安装</li>
<li>默认方式是使用go get方式安装，所以请<strong>翻墙</strong></li>
</ol>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// gotools.mk</span><br><span class="line"><span class="comment"># Copyright IBM Corp All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Copyright London Stock Exchange Group All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有相关的tools，之所以叫go tools，因为是Go语言的，并不是指golang/tools仓库</span></span><br><span class="line">GOTOOLS = counterfeiter dep golint goimports protoc-gen-go ginkgo gocov gocov-xml misspell mockery manifest-tool</span><br><span class="line"><span class="comment"># 构建目录与Makefile保持一致</span></span><br><span class="line">BUILD_DIR ?= .build</span><br><span class="line"><span class="comment"># 构建gotools是的GOPATH，也就源码所在目录，当未设置时，使用默认路径</span></span><br><span class="line">GOTOOLS_GOPATH ?= <span class="variable">$(BUILD_DIR)</span>/gotools</span><br><span class="line"><span class="comment"># gotools的生成二进制位置，当未设置时，使用GOPATH/bin</span></span><br><span class="line">GOTOOLS_BINDIR ?= <span class="variable">$(GOPATH)</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个tool的目录映射</span></span><br><span class="line"><span class="comment"># go tool-&gt;path mapping</span></span><br><span class="line">go.fqp.counterfeiter := github.com/maxbrunsfeld/counterfeiter</span><br><span class="line">go.fqp.gocov         := github.com/axw/gocov/gocov</span><br><span class="line">go.fqp.gocov-xml     := github.com/AlekSi/gocov-xml</span><br><span class="line">go.fqp.goimports     := golang.org/x/tools/cmd/goimports</span><br><span class="line">go.fqp.golint        := golang.org/x/lint/golint</span><br><span class="line">go.fqp.manifest-tool := github.com/estesp/manifest-tool</span><br><span class="line">go.fqp.misspell      := github.com/client9/misspell/cmd/misspell</span><br><span class="line">go.fqp.mockery       := github.com/vektra/mockery/cmd/mockery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装所有tools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools-install</span></span><br><span class="line"><span class="section">gotools-install: $(patsubst %,<span class="variable">$(GOTOOLS_BINDIR)</span>/%, <span class="variable">$(GOTOOLS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理tools</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gotools-clean</span></span><br><span class="line"><span class="section">gotools-clean:</span></span><br><span class="line">	-@rm -rf <span class="variable">$(BUILD_DIR)</span>/gotools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用vendor中的版本构建部分tools，比如protoc-gen-go，ginkgo，goimports，golint</span></span><br><span class="line"><span class="comment"># Special override for protoc-gen-go since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.protoc-gen-go:</span></span><br><span class="line">	@echo <span class="string">"Building github.com/golang/protobuf/protoc-gen-go -&gt; protoc-gen-go"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/github.com/golang/protobuf/protoc-gen-go</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for ginkgo since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.ginkgo:</span></span><br><span class="line">	@echo <span class="string">"Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for goimports since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.goimports:</span></span><br><span class="line">	@echo <span class="string">"Building golang.org/x/tools/cmd/goimports -&gt; goimports"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special override for golint since we want to use the version vendored with the project</span></span><br><span class="line"><span class="section">gotool.golint:</span></span><br><span class="line">	@echo <span class="string">"Building golang.org/x/lint/golint -&gt; golint"</span></span><br><span class="line">	GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install ./vendor/golang.org/x/lint/golint</span><br><span class="line"></span><br><span class="line"><span class="comment"># go dep的构建，使用特定版本</span></span><br><span class="line"><span class="comment"># Lock to a versioned dep</span></span><br><span class="line"><span class="section">gotool.dep: DEP_VERSION ?= "v0.5.1"</span></span><br><span class="line"><span class="section">gotool.dep:</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> go get -d -u github.com/golang/dep</span><br><span class="line">	@git -C <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span>/src/github.com/golang/dep checkout -q <span class="variable">$(DEP_VERSION)</span></span><br><span class="line">	@echo <span class="string">"Building github.com/golang/dep <span class="variable">$(DEP_VERSION)</span> -&gt; dep"</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go install -ldflags=<span class="string">"-X main.version=<span class="variable">$(DEP_VERSION)</span> -X main.buildDate=$$(date '+%Y-%m-%d')"</span> github.com/golang/dep/cmd/dep</span><br><span class="line">	@git -C <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span>/src/github.com/golang/dep checkout -q master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有tools构建时的默认安装方式，会使用go get从网络拉去</span></span><br><span class="line"><span class="comment"># Default rule for gotools uses the name-&gt;path map for a generic 'go get' style build</span></span><br><span class="line"><span class="section">gotool.%:</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TOOL = $&#123;<span class="built_in">subst</span> gotool.,,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@echo <span class="string">"Building $&#123;go.fqp.$&#123;TOOL&#125;&#125; -&gt; <span class="variable">$(TOOL)</span>"</span></span><br><span class="line">	@GOPATH=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_GOPATH)</span>)</span> GOBIN=<span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(GOTOOLS_BINDIR)</span>)</span> go get $&#123;go.fqp.$&#123;TOOL&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$(GOTOOLS_BINDIR)</span>/%:</span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> TOOL = $&#123;<span class="built_in">subst</span> <span class="variable">$(GOTOOLS_BINDIR)</span>/,,$&#123;@&#125;&#125;)</span></span><br><span class="line">	@<span class="variable">$(MAKE)</span> -f gotools.mk gotool.<span class="variable">$(TOOL)</span></span><br></pre></td></tr></table></figure>
<h2 id="通过Makefile定位编译问题"><a href="#通过Makefile定位编译问题" class="headerlink" title="通过Makefile定位编译问题"></a>通过Makefile定位编译问题</h2><p>这类问题是类似的，要找到报错的位置，是做哪项构建时报的错，以及报错位置的前提条件是什么。</p>
<p>通过：dep不存在的问题，进行举例介绍。</p>
<p>在执行<code>make all</code>的时候，遇到了<code>dep</code>不存在的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEP: Checking for dependency issues..</span><br><span class="line">./scripts/check_deps.sh: line 7: dep: command not found</span><br></pre></td></tr></table></figure>
<p>通过Makefile知道，dep属于gotools，单独执行<code>make gotools</code>查看问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make gotools</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/maxbrunsfeld/counterfeiter -&gt; counterfeiter</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building golang.org/x/lint/golint -&gt; golint</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/golang.org/x/lint/golint</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building golang.org/x/tools/cmd/goimports -&gt; goimports</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/golang.org/x/tools/cmd/goimports</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/onsi/ginkgo/ginkgo -&gt; ginkgo</span><br><span class="line">GOBIN=/home/centos/go/bin go install ./vendor/github.com/onsi/ginkgo/ginkgo</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/axw/gocov/gocov -&gt; gocov</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/AlekSi/gocov-xml -&gt; gocov-xml</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/vektra/mockery/cmd/mockery -&gt; mockery</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">make[1]: 进入目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br><span class="line">Building github.com/estesp/manifest-tool -&gt; manifest-tool</span><br><span class="line">make[1]: 离开目录“/home/centos/go/src/github.com/hyperledger/fabric”</span><br></pre></td></tr></table></figure>
<p>其中，果然没有安装dep，单独编译dep：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ make gotool.dep</span><br><span class="line">Unknown option: -C</span><br><span class="line">usage: git [--version] [--<span class="built_in">help</span>] [-c name=value]</span><br><span class="line">           [--<span class="built_in">exec</span>-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class="line">           [-p|--paginate|--no-pager] [--no-replace-objects] [--bare]</span><br><span class="line">           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class="line">           &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line">make: *** [gotool.dep] 错误 129</span><br></pre></td></tr></table></figure>
<p>报错误，git没有<code>-C</code>选项，怀疑centos系统自带git太老，<code>git version</code>查看果然只有<code>1.9</code>。</p>
<p>按照Git的INSTALL文件指导安装git，详细见：<a href="https://github.com/git/git/blob/master/INSTALL" target="_blank" rel="noopener">https://github.com/git/git/blob/master/INSTALL</a> ，下面是简要安装步骤。</p>
<p>通过wget下载最新的<a href="https://github.com/git/git/releases" target="_blank" rel="noopener">git release</a>，然后使用以下命令安装git到<code>/usr/bin</code>目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/git/git/archive/v2.22.0.tar.gz</span><br><span class="line"><span class="comment"># 省略：解压然后进入该目录</span></span><br><span class="line">make</span><br><span class="line">make prefix=/usr install</span><br></pre></td></tr></table></figure>
<p>验证git版本，和make dep。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) ✗ git version</span><br><span class="line">git version 2.22.0</span><br><span class="line"></span><br><span class="line">➜  fabric git:(r1.4) ✗ make gotool.dep</span><br><span class="line">Building github.com/golang/dep v0.5.1 -&gt; dep</span><br></pre></td></tr></table></figure>
<p>通过fabric Makefile可知<code>check_deps.sh</code>是<code>make check-deps</code>的一部分，执行<code>make check-deps</code>可以看到检查dep通过了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  fabric git:(r1.4) make check-deps</span><br><span class="line">DEP: Checking <span class="keyword">for</span> dependency issues..</span><br><span class="line">dep:</span><br><span class="line"> version     : v0.5.1</span><br><span class="line"> build date  : 2019-07-15</span><br><span class="line"> git <span class="built_in">hash</span>    :</span><br><span class="line"> go version  : go1.11.5</span><br><span class="line"> go compiler : gc</span><br><span class="line"> platform    : linux/amd64</span><br><span class="line"> features    : ImportDuringSolve=<span class="literal">false</span></span><br><span class="line"><span class="comment"># out of sync, but ignored, due to noverify in Gopkg.toml:</span></span><br><span class="line">github.com/grpc-ecosystem/go-grpc-middleware: <span class="built_in">hash</span> of vendored tree not equal to digest <span class="keyword">in</span> Gopkg.lock</span><br></pre></td></tr></table></figure>
<h1 id="构建建议"><a href="#构建建议" class="headerlink" title="构建建议"></a>构建建议</h1><p>列出几条构建建议，建议在make前先做好，会提高构建效率，并且少采坑。</p>
<h2 id="翻墙"><a href="#翻墙" class="headerlink" title="翻墙"></a>翻墙</h2><p>设置好翻墙，包括http和https代理，以便能下载Github，golang.org的包，参考<a href="http://lessisbetter.site/2018/09/06/Science-and-the-Internet/">让终端科学上网</a>。</p>
<blockquote>
<p>发文时fabric还使用的vendor，如果限制fabric已经使用go mod了，建议配置国内go modules代理，这样就无需翻墙了，参考本文<a href="#结束语">结束语</a>。</p>
</blockquote>
<h2 id="Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"><a href="#Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源" class="headerlink" title="Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"></a>Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源</h2><p>参考<a href="http://lessisbetter.site/2019/07/13/fast-mirrors/">让镜像飞，加速你的开发</a>。</p>
<h2 id="docker设置为国内的源"><a href="#docker设置为国内的源" class="headerlink" title="docker设置为国内的源"></a>docker设置为国内的源</h2><p>参考<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html" target="_blank" rel="noopener">Docker镜像加速</a>。</p>
<h2 id="检查GOPATH和PATH，以及http代理"><a href="#检查GOPATH和PATH，以及http代理" class="headerlink" title="检查GOPATH和PATH，以及http代理"></a>检查GOPATH和PATH，以及http代理</h2><p>确保配置正确：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo $http_proxy</span><br><span class="line">echo $https_proxy</span><br><span class="line">echo $GOPATH</span><br><span class="line">echo $PATH</span><br></pre></td></tr></table></figure>
<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><p>centos7下请参考：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></p>
<h2 id="Mac上安装Gnu-tar"><a href="#Mac上安装Gnu-tar" class="headerlink" title="Mac上安装Gnu-tar"></a>Mac上安装Gnu-tar</h2><p>如果未安装，可能遇到下面的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Step 3/5 : ADD payload/goshim.tar.bz2 $GOPATH/src/</span><br><span class="line">failed to copy files: Error processing tar file(bzip2 data invalid: bad magic value in continuation file):</span><br><span class="line">make: [build/image/ccenv/.dummy-x86_64-1.0.7-snapshot-ac3fabd] Error 1</span><br></pre></td></tr></table></figure>
<p>需要安装gnu-tar，用gnu-tar替换mac默认的bsdtar，可以用brew list gnu-tar找到gnu-tar的位置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ brew install gnu-tar --with-default-names</span><br><span class="line">$ export PATH=&quot;/usr/local/Cellar/gnu-tar/1.30/libexec/gnubin/:$PATH&quot;</span><br><span class="line">$ which tar</span><br><span class="line">/usr/local/Cellar/gnu-tar/1.30/libexec/gnubin//tar</span><br></pre></td></tr></table></figure>
<h2 id="Git升级到2-22以上版本"><a href="#Git升级到2-22以上版本" class="headerlink" title="Git升级到2.22以上版本"></a>Git升级到2.22以上版本</h2><p>如果未升级可能遇到上文提到的dep不存在的问题。</p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>现在国内已经有第三方的Go modules代理服务了，比如：</p>
<ol>
<li><a href="https://goproxy.io/zh/" target="_blank" rel="noopener">goproxy.io</a>，被即将毕业的盛奥飞小哥捐给了七牛。</li>
<li><a href="http://mirrors.aliyun.com/goproxy/" target="_blank" rel="noopener">aliyun goproxy</a>，阿里云昨天（2019年07月15日）刚开放了Go modules代理服务。</li>
</ol>
<p>fabric使用vendor，下载各种东西的时候需要翻墙，即便是可以翻墙，也是有缺点的：</p>
<ol>
<li>慢。</li>
<li>翻墙有流量限制。</li>
</ol>
<p>fabric赶紧支持go mod吧，这样再也不用翻墙了。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://shanma.pro/tutorial/56688.html" target="_blank" rel="noopener">fabric工程项目构建Makefile翻译及解析</a></li>
</ol>

      
    </div>

    
      


    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/区块链/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
          
            <a href="/tags/Fabric/" rel="tag"><i class="fa fa-tag"></i> Fabric</a>
          
            <a href="/tags/Makefile/" rel="tag"><i class="fa fa-tag"></i> Makefile</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/13/fast-mirrors/" rel="next" title="让镜像飞，加速你的开发">
                <i class="fa fa-chevron-left"></i> 让镜像飞，加速你的开发
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>
    
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">大彬</p>
              <p class="site-description motion-element" itemprop="description">技术与人生 | 区块链架构师</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">87</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">58</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://img.lessisbetter.site/2019-01-article_qrcode.jpg" title="公众号 &rarr; http://img.lessisbetter.site/2019-01-article_qrcode.jpg" rel="noopener" target="_blank"><i class="fa fa-fw fa-wechat"></i>公众号</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/shitaibin" title="GitHub &rarr; https://github.com/shitaibin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://segmentfault.com/u/lessisbetter" title="SegmentFault &rarr; https://segmentfault.com/u/lessisbetter" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>SegmentFault</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/947f3ccdd481" title="简书 &rarr; https://www.jianshu.com/u/947f3ccdd481" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>简书</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://stackoverflow.com/users/4296218/james-shi" title="StackOverflow &rarr; https://stackoverflow.com/users/4296218/james-shi" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:hz_stb@163.com" title="E-Mail &rarr; mailto:hz_stb@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友链
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://segmentfault.com/u/lessisbetter" title="https://segmentfault.com/u/lessisbetter" rel="noopener" target="_blank">SF</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Makefile详细解读"><span class="nav-number">1.</span> <span class="nav-text">Makefile详细解读</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#fabric的Makefile"><span class="nav-number">1.1.</span> <span class="nav-text">fabric的Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-env的Makefile"><span class="nav-number">1.2.</span> <span class="nav-text">docker env的Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-tools的Makefile"><span class="nav-number">1.3.</span> <span class="nav-text">go tools的Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过Makefile定位编译问题"><span class="nav-number">1.4.</span> <span class="nav-text">通过Makefile定位编译问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建建议"><span class="nav-number">2.</span> <span class="nav-text">构建建议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#翻墙"><span class="nav-number">2.1.</span> <span class="nav-text">翻墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源"><span class="nav-number">2.2.</span> <span class="nav-text">Linux系统包管理设置为国内的源，Mac上brew设置为腾讯源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker设置为国内的源"><span class="nav-number">2.3.</span> <span class="nav-text">docker设置为国内的源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查GOPATH和PATH，以及http代理"><span class="nav-number">2.4.</span> <span class="nav-text">检查GOPATH和PATH，以及http代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装docker-compose"><span class="nav-number">2.5.</span> <span class="nav-text">安装docker-compose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mac上安装Gnu-tar"><span class="nav-number">2.6.</span> <span class="nav-text">Mac上安装Gnu-tar</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Git升级到2-22以上版本"><span class="nav-number">2.7.</span> <span class="nav-text">Git升级到2.22以上版本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结束语"><span class="nav-number">3.</span> <span class="nav-text">结束语</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">[object Object]</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.6.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1275814754&web_id=1275814754" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.6.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  
  
  <script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>

  
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.css">

  
  
  <script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

   <script>
        var gitalk = new Gitalk({
          clientID: '42138cdfb007b8368d81',
          clientSecret: '317f1e9c0f7579358dcefb5402abe1bcc3e7388a',
          repo: 'shitaibin.github.io',
          owner: 'Shitaibin',
          admin: ['Shitaibin'],
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')
       </script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
