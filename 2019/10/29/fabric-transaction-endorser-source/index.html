<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lessisbetter.site","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="流程在 快速入门Fabric核心概念和框架 这篇文章中，介绍了 Fabric 的很多概念，其中也包含了交易、提案（Proposal）和链码。同时也介绍了，交易的执行流程，链码的调用流程等。 本文聚焦介绍交易流程的一个环节：交易背书，以下的3幅图，在快速入门Fabric核心概念和框架 中都有介绍，有必要的话，去读一下上下文信息。 交易宏观流程 交易的详细流程请阅读 交易流程，了解交易流程的几大环节。">
<meta property="og:type" content="article">
<meta property="og:title" content="Fabric 1.4源码解读 4：交易背书流程解读">
<meta property="og:url" content="http://lessisbetter.site/2019/10/29/fabric-transaction-endorser-source/index.html">
<meta property="og:site_name" content="Go语言充电站">
<meta property="og:description" content="流程在 快速入门Fabric核心概念和框架 这篇文章中，介绍了 Fabric 的很多概念，其中也包含了交易、提案（Proposal）和链码。同时也介绍了，交易的执行流程，链码的调用流程等。 本文聚焦介绍交易流程的一个环节：交易背书，以下的3幅图，在快速入门Fabric核心概念和框架 中都有介绍，有必要的话，去读一下上下文信息。 交易宏观流程 交易的详细流程请阅读 交易流程，了解交易流程的几大环节。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.lessisbetter.site/2019-07-tx-flow.png">
<meta property="og:image" content="http://img.lessisbetter.site/2019-07-fabric-invoke-chaincode.png">
<meta property="og:image" content="http://img.lessisbetter.site/2019-07-chaincode_swimlane.png">
<meta property="og:image" content="http://img.lessisbetter.site/2019-10-peer-cc-handler.png">
<meta property="article:published_time" content="2019-10-29T10:05:43.000Z">
<meta property="article:modified_time" content="2019-12-26T06:23:23.715Z">
<meta property="article:author" content="大彬">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="Fabric">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.lessisbetter.site/2019-07-tx-flow.png">

<link rel="canonical" href="http://lessisbetter.site/2019/10/29/fabric-transaction-endorser-source/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>Fabric 1.4源码解读 4：交易背书流程解读 | Go语言充电站</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Go语言充电站" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Go语言充电站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">大彬 less is better</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-主页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>主页</a>

  </li>
        <li class="menu-item menu-item-标签云">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签云</a>

  </li>
        <li class="menu-item menu-item-专题文章">

    <a href="/subject/" rel="section"><i class="fa fa-fw fa-th"></i>专题文章</a>

  </li>
        <li class="menu-item menu-item-文章列表">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>文章列表</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-大牛博客">

    <a href="/blogs/" rel="section"><i class="fa fa-fw fa-sitemap"></i>大牛博客</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lessisbetter.site/2019/10/29/fabric-transaction-endorser-source/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
      <meta itemprop="name" content="大彬">
      <meta itemprop="description" content="区块链、Go语言">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go语言充电站">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Fabric 1.4源码解读 4：交易背书流程解读
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-29 18:05:43" itemprop="dateCreated datePublished" datetime="2019-10-29T18:05:43+08:00">2019-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-26 14:23:23" itemprop="dateModified" datetime="2019-12-26T14:23:23+08:00">2019-12-26</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>在 <a href="http://lessisbetter.site/2019/07/17/fabric-concepts-notes/">快速入门Fabric核心概念和框架</a> 这篇文章中，介绍了 Fabric 的很多概念，其中也包含了交易、提案（Proposal）和链码。同时也介绍了，交易的执行流程，链码的调用流程等。</p>
<p>本文聚焦介绍交易流程的一个环节：交易背书，以下的3幅图，在<a href="http://lessisbetter.site/2019/07/17/fabric-concepts-notes/">快速入门Fabric核心概念和框架</a> 中都有介绍，有必要的话，去读一下上下文信息。</p>
<h3 id="交易宏观流程"><a href="#交易宏观流程" class="headerlink" title="交易宏观流程"></a>交易宏观流程</h3><p><img src="http://img.lessisbetter.site/2019-07-tx-flow.png" alt=""></p>
<p>交易的详细流程请阅读 <a href="http://lessisbetter.site/2019/07/17/fabric-concepts-notes/#%E4%BA%A4%E6%98%93">交易流程</a>，了解交易流程的几大环节。</p>
<h3 id="链码调用流程"><a href="#链码调用流程" class="headerlink" title="链码调用流程"></a>链码调用流程</h3><p><img src="http://img.lessisbetter.site/2019-07-fabric-invoke-chaincode.png" alt=""></p>
<p>上图，展示了客户端、Peer，以及链码容器 3大主体在交易流程中的背书过程，请关注一下Peer中的 Handler，它负责和链码容器交互。</p>
<h3 id="提案背书流程"><a href="#提案背书流程" class="headerlink" title="提案背书流程"></a>提案背书流程</h3><p><img src="http://img.lessisbetter.site/2019-07-chaincode_swimlane.png" alt=""></p>
<p>上图，从接近源码的层面，展示了交易背书过程。其中Fabric、Shim 是 Peer 中的模块，ChainCode 代表链码容器，Endorser Chaincode 代表 Peer 对交易提案和模拟执行结果进行背书。</p>
<p>如果了解过Chaincode，你会知道 Shim 是链码容器和 Peer 交互所依赖的模块。</p>
<p>最后推荐一份保华大佬整理的 <a href="https://github.com/yeasy/hyperledger_code_fabric/blob/master/process/peer_endorse.md" target="_blank" rel="noopener">Peer 提案背书过程</a>，是读源码前，必读的资料。虽然精简，但把重要的核心流程都串联起来了。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="Proposal定义"><a href="#Proposal定义" class="headerlink" title="Proposal定义"></a>Proposal定义</h3><p>客户端发送被背书节点的是 <code>SignedProposal</code> ，它包含了签名和Proposal，这是它在<code>proposal.proto</code>中的组成简介，：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SignedProposal</span><br><span class="line">|\_ Signature                                    (signature on the Proposal message by the creator specified in the header)</span><br><span class="line"> \_ Proposal</span><br><span class="line">    |\_ Header                                   (the header for this proposal)</span><br><span class="line">     \_ Payload                                  (the payload for this proposal)</span><br></pre></td></tr></table></figure>
<p><code>proposal.proto</code>这个文件还简要介绍了Client和背书节点之间通信的消息类型和过程。</p>
<h4 id="Proposal"><a href="#Proposal" class="headerlink" title="Proposal"></a>Proposal</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SignedProposal <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// The bytes of Proposal</span></span><br><span class="line">	ProposalBytes []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=proposal_bytes,json=proposalBytes,proto3" json:"proposal_bytes,omitempty"`</span></span><br><span class="line">	<span class="comment">// Signaure over proposalBytes; this signature is to be verified against</span></span><br><span class="line">	<span class="comment">// the creator identity contained in the header of the Proposal message</span></span><br><span class="line">	<span class="comment">// marshaled as proposalBytes</span></span><br><span class="line">	Signature            []<span class="keyword">byte</span>   <span class="string">`protobuf:"bytes,2,opt,name=signature,proto3" json:"signature,omitempty"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Proposal <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// The header of the proposal. It is the bytes of the Header</span></span><br><span class="line">	Header []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=header,proto3" json:"header,omitempty"`</span></span><br><span class="line">	<span class="comment">// The payload of the proposal as defined by the type in the proposal</span></span><br><span class="line">	<span class="comment">// header.</span></span><br><span class="line">	Payload []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=payload,proto3" json:"payload,omitempty"`</span></span><br><span class="line">	<span class="comment">// Optional extensions to the proposal. Its content depends on the Header's</span></span><br><span class="line">	<span class="comment">// type field.  For the type CHAINCODE, it might be the bytes of a</span></span><br><span class="line">	<span class="comment">// ChaincodeAction message.</span></span><br><span class="line">	Extension            []<span class="keyword">byte</span>   <span class="string">`protobuf:"bytes,3,opt,name=extension,proto3" json:"extension,omitempty"`</span></span><br><span class="line">	XXX_NoUnkeyedLiteral <span class="keyword">struct</span>&#123;&#125; <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_unrecognized     []<span class="keyword">byte</span>   <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_sizecache        <span class="keyword">int32</span>    <span class="string">`json:"-"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123;</span><br><span class="line">	ChannelHeader        []<span class="keyword">byte</span>   <span class="string">`protobuf:"bytes,1,opt,name=channel_header,json=channelHeader,proto3" json:"channel_header,omitempty"`</span></span><br><span class="line">	SignatureHeader      []<span class="keyword">byte</span>   <span class="string">`protobuf:"bytes,2,opt,name=signature_header,json=signatureHeader,proto3" json:"signature_header,omitempty"`</span></span><br><span class="line">	XXX_NoUnkeyedLiteral <span class="keyword">struct</span>&#123;&#125; <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_unrecognized     []<span class="keyword">byte</span>   <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_sizecache        <span class="keyword">int32</span>    <span class="string">`json:"-"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Header is a generic replay prevention and identity message to include in a signed payload</span></span><br><span class="line"><span class="keyword">type</span> ChannelHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">	Type <span class="keyword">int32</span> <span class="string">`protobuf:"varint,1,opt,name=type,proto3" json:"type,omitempty"`</span></span><br><span class="line">	<span class="comment">// Version indicates message protocol version</span></span><br><span class="line">	Version <span class="keyword">int32</span> <span class="string">`protobuf:"varint,2,opt,name=version,proto3" json:"version,omitempty"`</span></span><br><span class="line">	<span class="comment">// Timestamp is the local time when the message was created</span></span><br><span class="line">	<span class="comment">// by the sender</span></span><br><span class="line">	Timestamp *timestamp.Timestamp <span class="string">`protobuf:"bytes,3,opt,name=timestamp,proto3" json:"timestamp,omitempty"`</span></span><br><span class="line">	<span class="comment">// Identifier of the channel this message is bound for</span></span><br><span class="line">	ChannelId <span class="keyword">string</span> <span class="string">`protobuf:"bytes,4,opt,name=channel_id,json=channelId,proto3" json:"channel_id,omitempty"`</span></span><br><span class="line">	<span class="comment">// An unique identifier that is used end-to-end.</span></span><br><span class="line">	<span class="comment">//  -  set by higher layers such as end user or SDK</span></span><br><span class="line">	<span class="comment">//  -  passed to the endorser (which will check for uniqueness)</span></span><br><span class="line">	<span class="comment">//  -  as the header is passed along unchanged, it will be</span></span><br><span class="line">	<span class="comment">//     be retrieved by the committer (uniqueness check here as well)</span></span><br><span class="line">	<span class="comment">//  -  to be stored in the ledger</span></span><br><span class="line">	TxId <span class="keyword">string</span> <span class="string">`protobuf:"bytes,5,opt,name=tx_id,json=txId,proto3" json:"tx_id,omitempty"`</span></span><br><span class="line">	<span class="comment">// The epoch in which this header was generated, where epoch is defined based on block height</span></span><br><span class="line">	<span class="comment">// Epoch in which the response has been generated. This field identifies a</span></span><br><span class="line">	<span class="comment">// logical window of time. A proposal response is accepted by a peer only if</span></span><br><span class="line">	<span class="comment">// two conditions hold:</span></span><br><span class="line">	<span class="comment">// 1. the epoch specified in the message is the current epoch</span></span><br><span class="line">	<span class="comment">// 2. this message has been only seen once during this epoch (i.e. it hasn't</span></span><br><span class="line">	<span class="comment">//    been replayed)</span></span><br><span class="line">	Epoch <span class="keyword">uint64</span> <span class="string">`protobuf:"varint,6,opt,name=epoch,proto3" json:"epoch,omitempty"`</span></span><br><span class="line">	<span class="comment">// Extension that may be attached based on the header type</span></span><br><span class="line">	Extension []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,7,opt,name=extension,proto3" json:"extension,omitempty"`</span></span><br><span class="line">	<span class="comment">// If mutual TLS is employed, this represents</span></span><br><span class="line">	<span class="comment">// the hash of the client's TLS certificate</span></span><br><span class="line">	TlsCertHash          []<span class="keyword">byte</span>   <span class="string">`protobuf:"bytes,8,opt,name=tls_cert_hash,json=tlsCertHash,proto3" json:"tls_cert_hash,omitempty"`</span></span><br><span class="line">	XXX_NoUnkeyedLiteral <span class="keyword">struct</span>&#123;&#125; <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_unrecognized     []<span class="keyword">byte</span>   <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_sizecache        <span class="keyword">int32</span>    <span class="string">`json:"-"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SignatureHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Creator of the message, a marshaled msp.SerializedIdentity</span></span><br><span class="line">	Creator []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=creator,proto3" json:"creator,omitempty"`</span></span><br><span class="line">	<span class="comment">// Arbitrary number that may only be used once. Can be used to detect replay attacks.</span></span><br><span class="line">	Nonce                []<span class="keyword">byte</span>   <span class="string">`protobuf:"bytes,2,opt,name=nonce,proto3" json:"nonce,omitempty"`</span></span><br><span class="line">	XXX_NoUnkeyedLiteral <span class="keyword">struct</span>&#123;&#125; <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_unrecognized     []<span class="keyword">byte</span>   <span class="string">`json:"-"`</span></span><br><span class="line">	XXX_sizecache        <span class="keyword">int32</span>    <span class="string">`json:"-"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gRPC定义"><a href="#gRPC定义" class="headerlink" title="gRPC定义"></a>gRPC定义</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EndorserClient is the client API for Endorser service.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.</span></span><br><span class="line"><span class="keyword">type</span> EndorserClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	ProcessProposal(ctx context.Context, in *SignedProposal, opts ...grpc.CallOption) (*ProposalResponse, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EndorserServer is the server API for Endorser service.</span></span><br><span class="line"><span class="keyword">type</span> EndorserServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	ProcessProposal(context.Context, *SignedProposal) (*ProposalResponse, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SDK发送Proposal"><a href="#SDK发送Proposal" class="headerlink" title="SDK发送Proposal"></a>SDK发送Proposal</h3><h3 id="Peer接收Proposal"><a href="#Peer接收Proposal" class="headerlink" title="Peer接收Proposal"></a>Peer接收Proposal</h3><h3 id="Peer处理Proposal主流程"><a href="#Peer处理Proposal主流程" class="headerlink" title="Peer处理Proposal主流程"></a>Peer处理Proposal主流程</h3><p>主要是把背书节点的背书工作聚合一下：</p>
<ol>
<li>Proposal预处理</li>
<li>获取交易执行模拟器，模拟执行Proposal</li>
<li>如果模拟执行成功，调用ESCC对Proposal和结果进行背书，如果模拟执行失败直接返回背书失败的响应</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">ProcessProposal</span><span class="params">(ctx context.Context, signedProp *pb.SignedProposal)</span> <span class="params">(*pb.ProposalResponse, error)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// 0 -- check and validate</span></span><br><span class="line">	<span class="comment">// 这里有相当多的工作量</span></span><br><span class="line">	vr, err := e.preProcess(signedProp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		resp := vr.resp</span><br><span class="line">		<span class="keyword">return</span> resp, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	prop, hdrExt, chainID, txid := vr.prop, vr.hdrExt, vr.chainID, vr.txid</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取指定账本模拟器</span></span><br><span class="line">	<span class="comment">// obtaining once the tx simulator for this proposal. This will be nil</span></span><br><span class="line">	<span class="comment">// for chainless proposals</span></span><br><span class="line">	<span class="comment">// Also obtain a history query executor for history queries, since tx simulator does not cover history</span></span><br><span class="line">	<span class="keyword">var</span> txsim ledger.TxSimulator</span><br><span class="line">	<span class="keyword">var</span> historyQueryExecutor ledger.HistoryQueryExecutor</span><br><span class="line">	<span class="keyword">if</span> acquireTxSimulator(chainID, vr.hdrExt.ChaincodeId) &#123;</span><br><span class="line">		<span class="keyword">if</span> txsim, err = e.s.GetTxSimulator(chainID, txid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">defer</span> txsim.Done()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> historyQueryExecutor, err = e.s.GetHistoryQueryExecutor(chainID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	txParams := &amp;ccprovider.TransactionParams&#123;</span><br><span class="line">		ChannelID:            chainID,</span><br><span class="line">		TxID:                 txid,</span><br><span class="line">		SignedProp:           signedProp,</span><br><span class="line">		Proposal:             prop,</span><br><span class="line">		TXSimulator:          txsim,</span><br><span class="line">		HistoryQueryExecutor: historyQueryExecutor,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// this could be a request to a chainless SysCC</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟执行交易，失败则返回背书失败的响应</span></span><br><span class="line">	<span class="comment">// 1 -- simulate</span></span><br><span class="line">	cd, res, simulationResult, ccevent, err := e.SimulateProposal(txParams, hdrExt.ChaincodeId)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> res.Status &gt;= shim.ERROR &#123;</span><br><span class="line">			endorserLogger.Errorf(<span class="string">"[%s][%s] simulateProposal() resulted in chaincode %s response status %d for txid: %s"</span>, chainID, shorttxid(txid), hdrExt.ChaincodeId, res.Status, txid)</span><br><span class="line">			<span class="keyword">var</span> cceventBytes []<span class="keyword">byte</span></span><br><span class="line">			<span class="keyword">if</span> ccevent != <span class="literal">nil</span> &#123;</span><br><span class="line">				cceventBytes, err = putils.GetBytesChaincodeEvent(ccevent)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">"failed to marshal event bytes"</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			pResp, err := putils.CreateProposalResponseFailure(prop.Header, prop.Payload, res, simulationResult, cceventBytes, hdrExt.ChaincodeId, hdrExt.PayloadVisibility)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> pResp, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对模拟执行的结果进行签名背书</span></span><br><span class="line">	<span class="comment">// 2 -- endorse and get a marshalled ProposalResponse message</span></span><br><span class="line">	<span class="keyword">var</span> pResp *pb.ProposalResponse</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO till we implement global ESCC, CSCC for system chaincodes</span></span><br><span class="line">	<span class="comment">// chainless proposals (such as CSCC) don't have to be endorsed</span></span><br><span class="line">	<span class="keyword">if</span> chainID == <span class="string">""</span> &#123;</span><br><span class="line">		pResp = &amp;pb.ProposalResponse&#123;Response: res&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Note: To endorseProposal(), we pass the released txsim. Hence, an error would occur if we try to use this txsim</span></span><br><span class="line">		pResp, err = e.endorseProposal(ctx, chainID, txid, signedProp, prop, res, simulationResult, ccevent, hdrExt.PayloadVisibility, hdrExt.ChaincodeId, txsim, cd)</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the proposal response payload - it</span></span><br><span class="line">	<span class="comment">// contains the "return value" from the</span></span><br><span class="line">	<span class="comment">// chaincode invocation</span></span><br><span class="line">	pResp.Response = res</span><br><span class="line"></span><br><span class="line">	<span class="comment">// total failed proposals = ProposalsReceived-SuccessfulProposals</span></span><br><span class="line">	e.Metrics.SuccessfulProposals.Add(<span class="number">1</span>)</span><br><span class="line">	success = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pResp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="preProcess-检查和获取信息"><a href="#preProcess-检查和获取信息" class="headerlink" title="preProcess 检查和获取信息"></a>preProcess 检查和获取信息</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// preProcess checks the tx proposal headers, uniqueness and ACL</span></span><br><span class="line"><span class="comment">// 检查proposal、ACL</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">preProcess</span><span class="params">(signedProp *pb.SignedProposal)</span> <span class="params">(*validateResult, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 包含proposal、header、chainID、txid等信息</span></span><br><span class="line">	vr := &amp;validateResult&#123;&#125;</span><br><span class="line">	<span class="comment">// at first, we check whether the message is valid</span></span><br><span class="line">	<span class="comment">// 检查proposal，并获取各种需要的信息</span></span><br><span class="line">	prop, hdr, hdrExt, err := validation.ValidateProposalMessage(signedProp)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		e.Metrics.ProposalValidationFailed.Add(<span class="number">1</span>)</span><br><span class="line">		vr.resp = &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;</span><br><span class="line">		<span class="keyword">return</span> vr, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取Header中的2个Header</span></span><br><span class="line">	chdr, err := putils.UnmarshalChannelHeader(hdr.ChannelHeader)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		vr.resp = &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;</span><br><span class="line">		<span class="keyword">return</span> vr, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	shdr, err := putils.GetSignatureHeader(hdr.SignatureHeader)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		vr.resp = &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;</span><br><span class="line">		<span class="keyword">return</span> vr, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查是否调用了不可外部（用户）的系统链码</span></span><br><span class="line">	<span class="comment">// 先找到链码实例，然后调用链码的方法判断本身是否可调用</span></span><br><span class="line">	<span class="comment">// block invocations to security-sensitive system chaincodes</span></span><br><span class="line">	<span class="keyword">if</span> e.s.IsSysCCAndNotInvokableExternal(hdrExt.ChaincodeId.Name) &#123;</span><br><span class="line">		endorserLogger.Errorf(<span class="string">"Error: an attempt was made by %#v to invoke system chaincode %s"</span>, shdr.Creator, hdrExt.ChaincodeId.Name)</span><br><span class="line">		err = errors.Errorf(<span class="string">"chaincode %s cannot be invoked through a proposal"</span>, hdrExt.ChaincodeId.Name)</span><br><span class="line">		vr.resp = &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;</span><br><span class="line">		<span class="keyword">return</span> vr, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	chainID := chdr.ChannelId</span><br><span class="line">	txid := chdr.TxId</span><br><span class="line">	endorserLogger.Debugf(<span class="string">"[%s][%s] processing txid: %s"</span>, chainID, shorttxid(txid), txid)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> chainID != <span class="string">""</span> &#123;</span><br><span class="line">		<span class="comment">// labels that provide context for failure metrics</span></span><br><span class="line">		meterLabels := []<span class="keyword">string</span>&#123;</span><br><span class="line">			<span class="string">"channel"</span>, chainID,</span><br><span class="line">			<span class="string">"chaincode"</span>, hdrExt.ChaincodeId.Name + <span class="string">":"</span> + hdrExt.ChaincodeId.Version,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 检查交易是否已上链</span></span><br><span class="line">		<span class="comment">// Here we handle uniqueness check and ACLs for proposals targeting a chain</span></span><br><span class="line">		<span class="comment">// Notice that ValidateProposalMessage has already verified that TxID is computed properly</span></span><br><span class="line">		<span class="keyword">if</span> _, err = e.s.GetTransactionByID(chainID, txid); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// increment failure due to duplicate transactions. Useful for catching replay attacks in</span></span><br><span class="line">			<span class="comment">// addition to benign retries</span></span><br><span class="line">			e.Metrics.DuplicateTxsFailure.With(meterLabels...).Add(<span class="number">1</span>)</span><br><span class="line">			err = errors.Errorf(<span class="string">"duplicate transaction found [%s]. Creator [%x]"</span>, txid, shdr.Creator)</span><br><span class="line">			vr.resp = &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;</span><br><span class="line">			<span class="keyword">return</span> vr, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 用户链码检查ACL</span></span><br><span class="line">		<span class="comment">// check ACL only for application chaincodes; ACLs</span></span><br><span class="line">		<span class="comment">// for system chaincodes are checked elsewhere</span></span><br><span class="line">		<span class="keyword">if</span> !e.s.IsSysCC(hdrExt.ChaincodeId.Name) &#123;</span><br><span class="line">			<span class="comment">// check that the proposal complies with the Channel's writers</span></span><br><span class="line">			<span class="keyword">if</span> err = e.s.CheckACL(signedProp, chdr, shdr, hdrExt); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				e.Metrics.ProposalACLCheckFailed.With(meterLabels...).Add(<span class="number">1</span>)</span><br><span class="line">				vr.resp = &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;</span><br><span class="line">				<span class="keyword">return</span> vr, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// chainless proposals do not/cannot affect ledger and cannot be submitted as transactions</span></span><br><span class="line">		<span class="comment">// ignore uniqueness checks; also, chainless proposals are not validated using the policies</span></span><br><span class="line">		<span class="comment">// of the chain since by definition there is no chain; they are validated against the local</span></span><br><span class="line">		<span class="comment">// MSP of the peer instead by the call to ValidateProposalMessage above</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 保存提取的各信息</span></span><br><span class="line">	vr.prop, vr.hdrExt, vr.chainID, vr.txid = prop, hdrExt, chainID, txid</span><br><span class="line">	<span class="keyword">return</span> vr, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ValidateProposalMessage checks the validity of a SignedProposal message</span></span><br><span class="line"><span class="comment">// this function returns Header and ChaincodeHeaderExtension messages since they</span></span><br><span class="line"><span class="comment">// have been unmarshalled and validated</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ValidateProposalMessage</span><span class="params">(signedProp *pb.SignedProposal)</span> <span class="params">(*pb.Proposal, *common.Header, *pb.ChaincodeHeaderExtension, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> signedProp == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.New(<span class="string">"nil arguments"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	putilsLogger.Debugf(<span class="string">"ValidateProposalMessage starts for signed proposal %p"</span>, signedProp)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// extract the Proposal message from signedProp</span></span><br><span class="line">	prop, err := utils.GetProposal(signedProp.ProposalBytes)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1) look at the ProposalHeader</span></span><br><span class="line">	hdr, err := utils.GetHeader(prop.Header)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// validate the header</span></span><br><span class="line">	chdr, shdr, err := validateCommonHeader(hdr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从SignatureHeader交易客户端的签名</span></span><br><span class="line">	<span class="comment">// validate the signature</span></span><br><span class="line">	err = checkSignatureFromCreator(shdr.Creator, signedProp.Signature, signedProp.ProposalBytes, chdr.ChannelId)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// log the exact message on the peer but return a generic error message to</span></span><br><span class="line">		<span class="comment">// avoid malicious users scanning for channels</span></span><br><span class="line">		putilsLogger.Warningf(<span class="string">"channel [%s]: %s"</span>, chdr.ChannelId, err)</span><br><span class="line">		sId := &amp;msp.SerializedIdentity&#123;&#125;</span><br><span class="line">		err := proto.Unmarshal(shdr.Creator, sId)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// log the error here as well but still only return the generic error</span></span><br><span class="line">			err = errors.Wrap(err, <span class="string">"could not deserialize a SerializedIdentity"</span>)</span><br><span class="line">			putilsLogger.Warningf(<span class="string">"channel [%s]: %s"</span>, chdr.ChannelId, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Errorf(<span class="string">"access denied: channel [%s] creator org [%s]"</span>, chdr.ChannelId, sId.Mspid)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查txid的计算是否符合规则</span></span><br><span class="line">	<span class="comment">// Verify that the transaction ID has been computed properly.</span></span><br><span class="line">	<span class="comment">// This check is needed to ensure that the lookup into the ledger</span></span><br><span class="line">	<span class="comment">// for the same TxID catches duplicates.</span></span><br><span class="line">	err = utils.CheckTxID(</span><br><span class="line">		chdr.TxId,</span><br><span class="line">		shdr.Nonce,</span><br><span class="line">		shdr.Creator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 依据不同的proposal类型对proposal分别进行检查</span></span><br><span class="line">	<span class="comment">// continue the validation in a way that depends on the type specified in the header</span></span><br><span class="line">	<span class="keyword">switch</span> common.HeaderType(chdr.Type) &#123;</span><br><span class="line">	<span class="keyword">case</span> common.HeaderType_CONFIG:</span><br><span class="line">		<span class="comment">//which the types are different the validation is the same</span></span><br><span class="line">		<span class="comment">//viz, validate a proposal to a chaincode. If we need other</span></span><br><span class="line">		<span class="comment">//special validation for confguration, we would have to implement</span></span><br><span class="line">		<span class="comment">//special validation</span></span><br><span class="line">		<span class="keyword">fallthrough</span></span><br><span class="line">	<span class="keyword">case</span> common.HeaderType_ENDORSER_TRANSACTION:</span><br><span class="line">		<span class="comment">// 主要是提取ChaincodeHeaderExtension</span></span><br><span class="line">		<span class="comment">// validation of the proposal message knowing it's of type CHAINCODE</span></span><br><span class="line">		chaincodeHdrExt, err := validateChaincodeProposalMessage(prop, hdr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> prop, hdr, chaincodeHdrExt, err</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment">//NOTE : we proably need a case</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Errorf(<span class="string">"unsupported proposal type %d"</span>, common.HeaderType(chdr.Type))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="背书节点模拟执行交易"><a href="#背书节点模拟执行交易" class="headerlink" title="背书节点模拟执行交易"></a>背书节点模拟执行交易</h3><h4 id="获取模拟器"><a href="#获取模拟器" class="headerlink" title="获取模拟器"></a>获取模拟器</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Support contains functions that the endorser requires to execute its tasks</span></span><br><span class="line"><span class="keyword">type</span> Support <span class="keyword">interface</span> &#123;</span><br><span class="line">	crypto.SignerSupport</span><br><span class="line">	<span class="comment">// IsSysCCAndNotInvokableExternal returns true if the supplied chaincode is</span></span><br><span class="line">	<span class="comment">// ia system chaincode and it NOT invokable</span></span><br><span class="line">	IsSysCCAndNotInvokableExternal(name <span class="keyword">string</span>) <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetTxSimulator returns the transaction simulator for the specified ledger</span></span><br><span class="line">	<span class="comment">// a client may obtain more than one such simulator; they are made unique</span></span><br><span class="line">	<span class="comment">// by way of the supplied txid</span></span><br><span class="line">	GetTxSimulator(ledgername <span class="keyword">string</span>, txid <span class="keyword">string</span>) (ledger.TxSimulator, error)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetTxSimulator returns the transaction simulator for the specified ledger</span></span><br><span class="line"><span class="comment">// a client may obtain more than one such simulator; they are made unique</span></span><br><span class="line"><span class="comment">// by way of the supplied txid</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SupportImpl)</span> <span class="title">GetTxSimulator</span><span class="params">(ledgername <span class="keyword">string</span>, txid <span class="keyword">string</span>)</span> <span class="params">(ledger.TxSimulator, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 使用账本和txid创建模拟器，每个交易有单独的模拟器</span></span><br><span class="line">	lgr := s.Peer.GetLedger(ledgername)</span><br><span class="line">	<span class="keyword">if</span> lgr == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">"Channel does not exist: %s"</span>, ledgername)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> lgr.NewTxSimulator(txid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewTxSimulator returns new `ledger.TxSimulator`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *kvLedger)</span> <span class="title">NewTxSimulator</span><span class="params">(txid <span class="keyword">string</span>)</span> <span class="params">(ledger.TxSimulator, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> l.txtmgmt.NewTxSimulator(txid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewTxSimulator implements method in interface `txmgmt.TxMgr`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(txmgr *LockBasedTxMgr)</span> <span class="title">NewTxSimulator</span><span class="params">(txid <span class="keyword">string</span>)</span> <span class="params">(ledger.TxSimulator, error)</span></span> &#123;</span><br><span class="line">	logger.Debugf(<span class="string">"constructing new tx simulator"</span>)</span><br><span class="line">	s, err := newLockBasedTxSimulator(txmgr, txid)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	txmgr.commitRWLock.RLock()</span><br><span class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 就2项重要的：查询执行器、读写集构建器</span></span><br><span class="line"><span class="comment">// LockBasedTxSimulator is a transaction simulator used in `LockBasedTxMgr`</span></span><br><span class="line"><span class="keyword">type</span> lockBasedTxSimulator <span class="keyword">struct</span> &#123;</span><br><span class="line">	lockBasedQueryExecutor</span><br><span class="line">	rwsetBuilder              *rwsetutil.RWSetBuilder</span><br><span class="line">	writePerformed            <span class="keyword">bool</span></span><br><span class="line">	pvtdataQueriesPerformed   <span class="keyword">bool</span></span><br><span class="line">	simulationResultsComputed <span class="keyword">bool</span></span><br><span class="line">	paginatedQueriesPerformed <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newLockBasedTxSimulator</span><span class="params">(txmgr *LockBasedTxMgr, txid <span class="keyword">string</span>)</span> <span class="params">(*lockBasedTxSimulator, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建读写集构建器，能帮助构建读写集</span></span><br><span class="line">	rwsetBuilder := rwsetutil.NewRWSetBuilder()</span><br><span class="line">	helper := newQueryHelper(txmgr, rwsetBuilder)</span><br><span class="line">	logger.Debugf(<span class="string">"constructing new tx simulator txid = [%s]"</span>, txid)</span><br><span class="line">	<span class="keyword">return</span> &amp;lockBasedTxSimulator&#123;lockBasedQueryExecutor&#123;helper, txid&#125;, rwsetBuilder, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LockBasedQueryExecutor is a query executor used in `LockBasedTxMgr`</span></span><br><span class="line"><span class="comment">// "只读"，不包含写相关的操作</span></span><br><span class="line"><span class="keyword">type</span> lockBasedQueryExecutor <span class="keyword">struct</span> &#123;</span><br><span class="line">	helper *queryHelper</span><br><span class="line">	txid   <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="模拟执行"><a href="#模拟执行" class="headerlink" title="模拟执行"></a>模拟执行</h4><h5 id="endorser部分"><a href="#endorser部分" class="headerlink" title="endorser部分"></a>endorser部分</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> acquireTxSimulator(chainID, vr.hdrExt.ChaincodeId) &#123;</span><br><span class="line">	<span class="keyword">if</span> txsim, err = e.s.GetTxSimulator(chainID, txid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> txsim.Done()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 历史查询器</span></span><br><span class="line">	<span class="keyword">if</span> historyQueryExecutor, err = e.s.GetHistoryQueryExecutor(chainID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: &amp;pb.Response&#123;Status: <span class="number">500</span>, Message: err.Error()&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">txParams := &amp;ccprovider.TransactionParams&#123;</span><br><span class="line">	ChannelID:            chainID,</span><br><span class="line">	TxID:                 txid,</span><br><span class="line">	SignedProp:           signedProp,</span><br><span class="line">	Proposal:             prop,</span><br><span class="line">	TXSimulator:          txsim,	<span class="comment">// 模拟器在此</span></span><br><span class="line">	HistoryQueryExecutor: historyQueryExecutor,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// this could be a request to a chainless SysCC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> if the proposal has an extension, it will be of type ChaincodeAction;</span></span><br><span class="line"><span class="comment">//       if it's present it means that no simulation is to be performed because</span></span><br><span class="line"><span class="comment">//       we're trying to emulate a submitting peer. On the other hand, we need</span></span><br><span class="line"><span class="comment">//       to validate the supplied action before endorsing it</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟执行交易，失败则返回背书失败的响应</span></span><br><span class="line"><span class="comment">// 1 -- simulate</span></span><br><span class="line">cd, res, simulationResult, ccevent, err := e.SimulateProposal(txParams, hdrExt.ChaincodeId)</span><br></pre></td></tr></table></figure>
<p>调用chaincode模块模拟执行交易，获取交易执行的公开和私密数据读写集，以及交易执行产生的事件，并把结果返回给上层进行背书。</p>
<p>其中还包含了私密数据的处理，会把它取出来，然后通过Gossip传播给在私密数据中的Peer节点。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SimulateProposal simulates the proposal by calling the chaincode</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">SimulateProposal</span><span class="params">(txParams *ccprovider.TransactionParams, cid *pb.ChaincodeID)</span> <span class="params">(ccprovider.ChaincodeDefinition, *pb.Response, []<span class="keyword">byte</span>, *pb.ChaincodeEvent, error)</span></span> &#123;</span><br><span class="line">	endorserLogger.Debugf(<span class="string">"[%s][%s] Entry chaincode: %s"</span>, txParams.ChannelID, shorttxid(txParams.TxID), cid)</span><br><span class="line">	<span class="keyword">defer</span> endorserLogger.Debugf(<span class="string">"[%s][%s] Exit"</span>, txParams.ChannelID, shorttxid(txParams.TxID))</span><br><span class="line">	<span class="comment">// we do expect the payload to be a ChaincodeInvocationSpec</span></span><br><span class="line">	<span class="comment">// if we are supporting other payloads in future, this be glaringly point</span></span><br><span class="line">	<span class="comment">// as something that should change</span></span><br><span class="line">	<span class="comment">// 根据Proposal生成Invoke需要的信息</span></span><br><span class="line">	cis, err := putils.GetChaincodeInvocationSpec(txParams.Proposal)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 链码的元数据</span></span><br><span class="line">	<span class="keyword">var</span> cdLedger ccprovider.ChaincodeDefinition</span><br><span class="line">	<span class="keyword">var</span> version <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置version</span></span><br><span class="line">	<span class="keyword">if</span> !e.s.IsSysCC(cid.Name) &#123;</span><br><span class="line">		<span class="comment">// 根据要调用的链码名称，从lscc获取链码的元数据</span></span><br><span class="line">		cdLedger, err = e.s.GetChaincodeDefinition(cid.Name, txParams.TXSimulator)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"make sure the chaincode %s has been successfully instantiated and try again"</span>, cid.Name))</span><br><span class="line">		&#125;</span><br><span class="line">		version = cdLedger.CCVersion()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实际被打桩了，无实现</span></span><br><span class="line">		err = e.s.CheckInstantiationPolicy(cid.Name, version, cdLedger)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// scc版本是固定的"latest"</span></span><br><span class="line">		version = util.GetSysCCVersion()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ---3. execute the proposal and get simulation results</span></span><br><span class="line">	<span class="keyword">var</span> simResult *ledger.TxSimulationResults</span><br><span class="line">	<span class="keyword">var</span> pubSimResBytes []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">var</span> res *pb.Response</span><br><span class="line">	<span class="keyword">var</span> ccevent *pb.ChaincodeEvent</span><br><span class="line">	<span class="comment">// 模拟执行，执行结果保存在模拟器</span></span><br><span class="line">	res, ccevent, err = e.callChaincode(txParams, version, cis.ChaincodeSpec.Input, cid)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		endorserLogger.Errorf(<span class="string">"[%s][%s] failed to invoke chaincode %s, error: %+v"</span>, txParams.ChannelID, shorttxid(txParams.TxID), cid, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> txParams.TXSimulator != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 通过模拟器获取模拟执行结果，包含公开和私密数据2份读写集</span></span><br><span class="line">		<span class="keyword">if</span> simResult, err = txParams.TXSimulator.GetTxSimulationResults(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			txParams.TXSimulator.Done()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 存在私密数据</span></span><br><span class="line">		<span class="keyword">if</span> simResult.PvtSimulationResults != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> cid.Name == <span class="string">"lscc"</span> &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag">TODO:</span> remove once we can store collection configuration outside of LSCC</span></span><br><span class="line">				txParams.TXSimulator.Done()</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.New(<span class="string">"Private data is forbidden to be used in instantiate"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 获取要通过Gossip传播的私密数据</span></span><br><span class="line">			pvtDataWithConfig, err := e.AssemblePvtRWSet(simResult.PvtSimulationResults, txParams.TXSimulator)</span><br><span class="line">			<span class="comment">// To read collection config need to read collection updates before</span></span><br><span class="line">			<span class="comment">// releasing the lock, hence txParams.TXSimulator.Done()  moved down here</span></span><br><span class="line">			txParams.TXSimulator.Done()</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.WithMessage(err, <span class="string">"failed to obtain collections config"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			endorsedAt, err := e.s.GetLedgerHeight(txParams.ChannelID)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprint(<span class="string">"failed to obtain ledger height for channel"</span>, txParams.ChannelID))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Add ledger height at which transaction was endorsed,</span></span><br><span class="line">			<span class="comment">// `endorsedAt` is obtained from the block storage and at times this could be 'endorsement Height + 1'.</span></span><br><span class="line">			<span class="comment">// However, since we use this height only to select the configuration (3rd parameter in distributePrivateData) and</span></span><br><span class="line">			<span class="comment">// manage transient store purge for orphaned private writesets (4th parameter in distributePrivateData), this works for now.</span></span><br><span class="line">			<span class="comment">// Ideally, ledger should add support in the simulator as a first class function `GetHeight()`.</span></span><br><span class="line">			pvtDataWithConfig.EndorsedAt = endorsedAt</span><br><span class="line">			<span class="comment">// 把私密数据同通道id、交易id和区块高度发出去，代表私密数据所属的区块和交易</span></span><br><span class="line">			<span class="keyword">if</span> err := e.distributePrivateData(txParams.ChannelID, txParams.TxID, pvtDataWithConfig, endorsedAt); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 交易模拟完成，释放模拟器占用的资源</span></span><br><span class="line">		txParams.TXSimulator.Done()</span><br><span class="line">		<span class="comment">// 获取模拟执行的公开结果</span></span><br><span class="line">		<span class="keyword">if</span> pubSimResBytes, err = simResult.GetPubSimulationBytes(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 返回链码元数据、模拟执行结果、交易执行产生的事件</span></span><br><span class="line">	<span class="keyword">return</span> cdLedger, res, pubSimResBytes, ccevent, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>callChaincode</code> 调用chaincode模块执行链码。在前面的流程中，还没有区分系统链码SCC和用户链码UCC，SCC和UCC都会通过<code>Execute</code>函数被传递给chaincode模块而执行。</p>
<p>如果是调用<code>lscc</code>部署或升级UCC，会调用<code>ExecuteLegacyInit</code>执行链码容器的初始化。</p>
<p>最后返回链码模拟执行结果和事件。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// call specified chaincode (system or user)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">callChaincode</span><span class="params">(txParams *ccprovider.TransactionParams, version <span class="keyword">string</span>, input *pb.ChaincodeInput, cid *pb.ChaincodeID)</span> <span class="params">(*pb.Response, *pb.ChaincodeEvent, error)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// scc也在这执行</span></span><br><span class="line">	<span class="comment">// is this a system chaincode</span></span><br><span class="line">	res, ccevent, err = e.s.Execute(txParams, txParams.ChannelID, cid.Name, version, txParams.TxID, txParams.SignedProp, txParams.Proposal, input)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果是调用lscc部署或升级链码，会走这段流程</span></span><br><span class="line">	<span class="keyword">if</span> cid.Name == <span class="string">"lscc"</span> &amp;&amp; <span class="built_in">len</span>(input.Args) &gt;= <span class="number">3</span> &amp;&amp; (<span class="keyword">string</span>(input.Args[<span class="number">0</span>]) == <span class="string">"deploy"</span> || <span class="keyword">string</span>(input.Args[<span class="number">0</span>]) == <span class="string">"upgrade"</span>) &#123;</span><br><span class="line">		userCDS, err := putils.GetChaincodeDeploymentSpec(input.Args[<span class="number">2</span>], e.PlatformRegistry)</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">// 进行链码容器初始化，最后会调用链码的Init的函数</span></span><br><span class="line">		_, _, err = e.s.ExecuteLegacyInit(txParams, txParams.ChannelID, cds.ChaincodeSpec.ChaincodeId.Name, cds.ChaincodeSpec.ChaincodeId.Version, txParams.TxID, txParams.SignedProp, txParams.Proposal, cds)</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ----- END -------</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res, ccevent, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Support</code> 接口实际集合了众多背书节点需要的外部模块功能，比如链码、系统链码、ACL等。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Support contains functions that the endorser requires to execute its tasks</span></span><br><span class="line"><span class="keyword">type</span> Support <span class="keyword">interface</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">// SupportImpl provides an implementation of the endorser.Support interface</span></span><br><span class="line"><span class="comment">// issuing calls to various static methods of the peer</span></span><br><span class="line"><span class="keyword">type</span> SupportImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">	*PluginEndorser</span><br><span class="line">	crypto.SignerSupport</span><br><span class="line">	Peer             peer.Operations</span><br><span class="line">	PeerSupport      peer.Support</span><br><span class="line">	ChaincodeSupport *chaincode.ChaincodeSupport</span><br><span class="line">	SysCCProvider    *scc.Provider</span><br><span class="line">	ACLProvider      aclmgmt.ACLProvider</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Execute</code>就是调用<code>ChaincodeSupport.Execute</code>实现的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Execute a proposal and return the chaincode response</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SupportImpl)</span> <span class="title">Execute</span><span class="params">(txParams *ccprovider.TransactionParams, cid, name, version, txid <span class="keyword">string</span>, signedProp *pb.SignedProposal, prop *pb.Proposal, input *pb.ChaincodeInput)</span> <span class="params">(*pb.Response, *pb.ChaincodeEvent, error)</span></span> &#123;</span><br><span class="line">	cccid := &amp;ccprovider.CCContext&#123;</span><br><span class="line">		Name:    name,</span><br><span class="line">		Version: version,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// decorate the chaincode input</span></span><br><span class="line">	decorators := library.InitRegistry(library.Config&#123;&#125;).Lookup(library.Decoration).([]decoration.Decorator)</span><br><span class="line">	input.Decorations = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span>)</span><br><span class="line">	input = decoration.Apply(prop, input, decorators...)</span><br><span class="line">	txParams.ProposalDecorations = input.Decorations</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s.ChaincodeSupport.Execute(txParams, cccid, input)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="chaincode部分"><a href="#chaincode部分" class="headerlink" title="chaincode部分"></a>chaincode部分</h5><p>通过上面的接口，跨入chaincode模块的大门。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Execute</span><span class="params">(txParams *ccprovider.TransactionParams, cccid *ccprovider.CCContext, input *pb.ChaincodeInput)</span> <span class="params">(*pb.Response, *pb.ChaincodeEvent, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Invoke得到ChaincodeMessage</span></span><br><span class="line">	resp, err := cs.Invoke(txParams, cccid, input)</span><br><span class="line">	<span class="comment">// 根据ChaincodeMessage得到Response和事件</span></span><br><span class="line">	<span class="keyword">return</span> processChaincodeExecutionResult(txParams.TxID, cccid.Name, resp, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Invoke</span><span class="params">(txParams *ccprovider.TransactionParams, cccid *ccprovider.CCContext, input *pb.ChaincodeInput)</span> <span class="params">(*pb.ChaincodeMessage, error)</span></span> &#123;</span><br><span class="line">	h, err := cs.Launch(txParams.ChannelID, cccid.Name, cccid.Version, txParams.TXSimulator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行调用链码的交易（和链码之间的消息为ChaincodeMessage_TRANSACTION）</span></span><br><span class="line">	cctype := pb.ChaincodeMessage_TRANSACTION</span><br><span class="line">	<span class="keyword">return</span> cs.execute(cctype, txParams, cccid, input, h)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="获取链码执行环境"><a href="#获取链码执行环境" class="headerlink" title="获取链码执行环境"></a>获取链码执行环境</h5><p><code>Launch</code> 可以获取链码执行环境，即用户链码容器，如果已实例化的链码，在当前背书节点上，链码容器未启动，则启动链码容器，<code>Launch</code>会返回一个跟链码容器交互Handler。</p>
<p>某个 Peer 上可以部署多个链码容器，Peer 为了和这些链码容器交互/通信，给每个链码容器都创建了一个 Handler，Handler 携带了 Peer 和链码容器交互的资源。</p>
<p><img src="http://img.lessisbetter.site/2019-10-peer-cc-handler.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch starts executing chaincode if it is not already running. This method</span></span><br><span class="line"><span class="comment">// blocks until the peer side handler gets into ready state or encounters a fatal</span></span><br><span class="line"><span class="comment">// error. If the chaincode is already running, it simply returns.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Launch</span><span class="params">(chainID, chaincodeName, chaincodeVersion <span class="keyword">string</span>, qe ledger.QueryExecutor)</span> <span class="params">(*Handler, error)</span></span> &#123;</span><br><span class="line">	cname := chaincodeName + <span class="string">":"</span> + chaincodeVersion</span><br><span class="line">	<span class="keyword">if</span> h := cs.HandlerRegistry.Handler(cname); h != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> h, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动链码容器 ...</span></span><br><span class="line"></span><br><span class="line">	h := cs.HandlerRegistry.Handler(cname)</span><br><span class="line">	<span class="keyword">if</span> h == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">"[channel %s] claimed to start chaincode container for %s but could not find handler"</span>, chainID, cname)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> h, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>链码容器的启动过程，不是本文的重点，所以不继续深入Launch的调用细节。</p>
<h5 id="模拟执行交易"><a href="#模拟执行交易" class="headerlink" title="模拟执行交易"></a>模拟执行交易</h5><p><code>execute</code>封装出执行交易的消息，然后使用 Handler 执行交易。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// execute executes a transaction and waits for it to complete until a timeout value.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">execute</span><span class="params">(cctyp pb.ChaincodeMessage_Type, txParams *ccprovider.TransactionParams, cccid *ccprovider.CCContext, input *pb.ChaincodeInput, h *Handler)</span> <span class="params">(*pb.ChaincodeMessage, error)</span></span> &#123;</span><br><span class="line">	input.Decorations = txParams.ProposalDecorations</span><br><span class="line">	<span class="comment">// 创建消息</span></span><br><span class="line">	ccMsg, err := createCCMessage(cctyp, txParams.ChannelID, txParams.TxID, input)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, <span class="string">"failed to create chaincode message"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行交易</span></span><br><span class="line">	ccresp, err := h.Execute(txParams, cccid, ccMsg, cs.ExecuteTimeout)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error sending"</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ccresp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意以下这个参数 <code>txParams *ccprovider.TransactionParams</code> 其类型定义如下，它包含了一条交易执行过程中的信息和资源，所以交易传递的过程中，一直有这个参数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TransactionParams are parameters which are tied to a particular transaction</span></span><br><span class="line"><span class="comment">// and which are required for invoking chaincode.</span></span><br><span class="line"><span class="keyword">type</span> TransactionParams <span class="keyword">struct</span> &#123;</span><br><span class="line">	TxID                 <span class="keyword">string</span></span><br><span class="line">	ChannelID            <span class="keyword">string</span></span><br><span class="line">	SignedProp           *pb.SignedProposal</span><br><span class="line">	Proposal             *pb.Proposal</span><br><span class="line">	TXSimulator          ledger.TxSimulator</span><br><span class="line">	HistoryQueryExecutor ledger.HistoryQueryExecutor</span><br><span class="line">	CollectionStore      privdata.CollectionStore</span><br><span class="line">	IsInitTransaction    <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// this is additional data passed to the chaincode</span></span><br><span class="line">	ProposalDecorations <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Handler 执行交易的过程如下，创建交易执行的上下文 Context，因为链码容器在执行交易的时候，会和 Peer 之间进行多次通信，进行数据的读写，上下文可以让数据读写获取到正确的信息。</p>
<p>之后 Handler 把消息发送给链码容器，并等待链码容器发来包含执行结果的消息，或者执行超时，默认执行时间是 30s。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">Execute</span><span class="params">(txParams *ccprovider.TransactionParams, cccid *ccprovider.CCContext, msg *pb.ChaincodeMessage, timeout time.Duration)</span> <span class="params">(*pb.ChaincodeMessage, error)</span></span> &#123;</span><br><span class="line">	chaincodeLogger.Debugf(<span class="string">"Entry"</span>)</span><br><span class="line">	<span class="keyword">defer</span> chaincodeLogger.Debugf(<span class="string">"Exit"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 私密数据</span></span><br><span class="line">	txParams.CollectionStore = h.getCollectionStore(msg.ChannelId)</span><br><span class="line">	<span class="comment">// 是否是执行链码初始化</span></span><br><span class="line">	txParams.IsInitTransaction = (msg.Type == pb.ChaincodeMessage_INIT)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建交易context</span></span><br><span class="line">	txctx, err := h.TXContexts.Create(txParams)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 退出时（执行交易完毕），释放交易上下文资源</span></span><br><span class="line">	<span class="keyword">defer</span> h.TXContexts.Delete(msg.ChannelId, msg.Txid)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// proposal保存到msg</span></span><br><span class="line">	<span class="keyword">if</span> err := h.setChaincodeProposal(txParams.SignedProp, txParams.Proposal, msg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 向链码容器发送msg</span></span><br><span class="line">	h.serialSendAsync(msg)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等待链码容器响应，或者超时</span></span><br><span class="line">	<span class="keyword">var</span> ccresp *pb.ChaincodeMessage</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> ccresp = &lt;-txctx.ResponseNotifier:</span><br><span class="line">		<span class="comment">// response is sent to user or calling chaincode. ChaincodeMessage_ERROR</span></span><br><span class="line">		<span class="comment">// are typically treated as error</span></span><br><span class="line">	<span class="keyword">case</span> &lt;-time.After(timeout):</span><br><span class="line">		err = errors.New(<span class="string">"timeout expired while executing transaction"</span>)</span><br><span class="line">		ccName := cccid.Name + <span class="string">":"</span> + cccid.Version</span><br><span class="line">		h.Metrics.ExecuteTimeouts.With(</span><br><span class="line">			<span class="string">"chaincode"</span>, ccName,</span><br><span class="line">		).Add(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ccresp, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="处理链码容器模拟响应"><a href="#处理链码容器模拟响应" class="headerlink" title="处理链码容器模拟响应"></a>处理链码容器模拟响应</h5><p>链码容器执行的响应会向上传递，直到 <code>ChaincodeSupport.Execute</code>，它调用 <code>processChaincodeExecutionResult</code> 把链码容器返回的响应，转化为交易模拟执行的 Response，而 Response 最终会返回给Endorser，大家可去调用流程上翻。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processChaincodeExecutionResult</span><span class="params">(txid, ccName <span class="keyword">string</span>, resp *pb.ChaincodeMessage, err error)</span> <span class="params">(*pb.Response, *pb.ChaincodeEvent, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">"failed to execute transaction %s"</span>, txid)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> resp == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Errorf(<span class="string">"nil response from transaction %s"</span>, txid)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> resp.ChaincodeEvent != <span class="literal">nil</span> &#123;</span><br><span class="line">		resp.ChaincodeEvent.ChaincodeId = ccName</span><br><span class="line">		resp.ChaincodeEvent.TxId = txid</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> resp.Type &#123;</span><br><span class="line">	<span class="comment">// 交易执行成功则提取Payload中保存的Response</span></span><br><span class="line">	<span class="keyword">case</span> pb.ChaincodeMessage_COMPLETED:</span><br><span class="line">		res := &amp;pb.Response&#123;&#125;</span><br><span class="line">		err := proto.Unmarshal(resp.Payload, res)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">"failed to unmarshal response for transaction %s"</span>, txid)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res, resp.ChaincodeEvent, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 	失败，则提取Payload中保存的错误信息</span></span><br><span class="line">	<span class="keyword">case</span> pb.ChaincodeMessage_ERROR:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, resp.ChaincodeEvent, errors.Errorf(<span class="string">"transaction returned with failure: %s"</span>, resp.Payload)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Errorf(<span class="string">"unexpected response type %d for transaction %s"</span>, resp.Type, txid)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="释放模拟器资源"><a href="#释放模拟器资源" class="headerlink" title="释放模拟器资源"></a>释放模拟器资源</h4><p>回想一下，在 <code>Endorser.SimulateProposal</code> 中，它获取了 交易模拟执行器 <code>TXSimulator</code>，这里面可是有很多资源的，如果不及时释放，在高 TPS 下，Peer压力上大，资源泄露，性能低下等问题会爆发出来。</p>
<p><code>txParams.TXSimulator.Done()</code> 用来释放资源，上文提到 <code>TxSimulator</code> 包含了 <code>QueryExecutor</code>, <code>lockBasedQueryExecutor</code> 实现了 <code>QueryExecutor</code>，也就是说，主要是释放查询操作相关的资源。</p>
<p>从源码可以看到会释放读写锁以及迭代器资源，如果不及时释放，后果果然不堪。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Done implements method in interface `ledger.QueryExecutor`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *lockBasedQueryExecutor)</span> <span class="title">Done</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logger.Debugf(<span class="string">"Done with transaction simulation / query execution [%s]"</span>, q.txid)</span><br><span class="line">	q.helper.done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *queryHelper)</span> <span class="title">done</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> h.doneInvoked &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// 释放锁</span></span><br><span class="line">		h.txmgr.commitRWLock.RUnlock()</span><br><span class="line">		h.doneInvoked = <span class="literal">true</span></span><br><span class="line">		<span class="comment">// 释放迭代器</span></span><br><span class="line">		<span class="keyword">for</span> _, itr := <span class="keyword">range</span> h.itrs &#123;</span><br><span class="line">			itr.Close()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ESCC处理模拟执行结果"><a href="#ESCC处理模拟执行结果" class="headerlink" title="ESCC处理模拟执行结果"></a>ESCC处理模拟执行结果</h3><p>上文提到，模拟执行的 Response 会最终回到 Endorser，Endorser 会调用 ESCC 对结果进行背书，最终生成 <code>ProposalResponse</code>，我们看一下这个过程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">ProcessProposal</span><span class="params">(ctx context.Context, signedProp *pb.SignedProposal)</span> <span class="params">(*pb.ProposalResponse, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Pre-process, simulate</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> chainID == <span class="string">""</span> &#123;</span><br><span class="line">		pResp = &amp;pb.ProposalResponse&#123;Response: res&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Note: To endorseProposal(), we pass the released txsim. Hence, an error would occur if we try to use this txsim</span></span><br><span class="line">		pResp, err = e.endorseProposal(ctx, chainID, txid, signedProp, prop, res, simulationResult, ccevent, hdrExt.PayloadVisibility, hdrExt.ChaincodeId, txsim, cd)</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Endorser-endorseProposal"><a href="#Endorser-endorseProposal" class="headerlink" title="Endorser.endorseProposal"></a>Endorser.endorseProposal</h5><p>背书链码实现了可插拔，可以使用不同的ESCC，系统链码和用户链码的背书过程是不同的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// endorse the proposal by calling the ESCC</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">endorseProposal</span><span class="params">(_ context.Context, chainID <span class="keyword">string</span>, txid <span class="keyword">string</span>, signedProp *pb.SignedProposal, proposal *pb.Proposal, response *pb.Response, simRes []<span class="keyword">byte</span>, event *pb.ChaincodeEvent, visibility []<span class="keyword">byte</span>, ccid *pb.ChaincodeID, txsim ledger.TxSimulator, cd ccprovider.ChaincodeDefinition)</span> <span class="params">(*pb.ProposalResponse, error)</span></span> &#123;</span><br><span class="line">	endorserLogger.Debugf(<span class="string">"[%s][%s] Entry chaincode: %s"</span>, chainID, shorttxid(txid), ccid)</span><br><span class="line">	<span class="keyword">defer</span> endorserLogger.Debugf(<span class="string">"[%s][%s] Exit"</span>, chainID, shorttxid(txid))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 系统链码和用户链码使用不同的ESCC</span></span><br><span class="line">	isSysCC := cd == <span class="literal">nil</span></span><br><span class="line">	<span class="comment">// 1) extract the name of the escc that is requested to endorse this chaincode</span></span><br><span class="line">	<span class="keyword">var</span> escc <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// ie, "lscc" or system chaincodes</span></span><br><span class="line">	<span class="keyword">if</span> isSysCC &#123;</span><br><span class="line">		escc = <span class="string">"escc"</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		escc = cd.Endorsement()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	endorserLogger.Debugf(<span class="string">"[%s][%s] escc for chaincode %s is %s"</span>, chainID, shorttxid(txid), ccid, escc)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// marshalling event bytes</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">var</span> eventBytes []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">if</span> event != <span class="literal">nil</span> &#123;</span><br><span class="line">		eventBytes, err = putils.GetBytesChaincodeEvent(event)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">"failed to marshal event bytes"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set version of executing chaincode</span></span><br><span class="line">	<span class="keyword">if</span> isSysCC &#123;</span><br><span class="line">		<span class="comment">// if we want to allow mixed fabric levels we should</span></span><br><span class="line">		<span class="comment">// set syscc version to ""</span></span><br><span class="line">		ccid.Version = util.GetSysCCVersion()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ccid.Version = cd.CCVersion()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建背书上下文信息</span></span><br><span class="line">	ctx := Context&#123;</span><br><span class="line">		PluginName:     escc, <span class="comment">// 插件名称</span></span><br><span class="line">		Channel:        chainID,</span><br><span class="line">		SignedProposal: signedProp,</span><br><span class="line">		ChaincodeID:    ccid,</span><br><span class="line">		Event:          eventBytes,</span><br><span class="line">		SimRes:         simRes,</span><br><span class="line">		Response:       response,</span><br><span class="line">		Visibility:     visibility,</span><br><span class="line">		Proposal:       proposal,</span><br><span class="line">		TxID:           txid,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用插件背书</span></span><br><span class="line">	<span class="keyword">return</span> e.s.EndorseWithPlugin(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>背书插件实现下面的接口即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Plugin endorses a proposal response</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Endorse signs the given payload(ProposalResponsePayload bytes), and optionally mutates it.</span></span><br><span class="line">	<span class="comment">// Returns:</span></span><br><span class="line">	<span class="comment">// The Endorsement: A signature over the payload, and an identity that is used to verify the signature</span></span><br><span class="line">	<span class="comment">// The payload that was given as input (could be modified within this function)</span></span><br><span class="line">	<span class="comment">// Or error on failure</span></span><br><span class="line">	Endorse(payload []<span class="keyword">byte</span>, sp *peer.SignedProposal) (*peer.Endorsement, []<span class="keyword">byte</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Init injects dependencies into the instance of the Plugin</span></span><br><span class="line">	Init(dependencies ...Dependency) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用插件背书，需获取插件实例，然后组装响应Payload，它包含了交易执行的多种结果，然后对Payload以及签名的Proposal背书。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EndorseWithPlugin endorses the response with a plugin</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pe *PluginEndorser)</span> <span class="title">EndorseWithPlugin</span><span class="params">(ctx Context)</span> <span class="params">(*pb.ProposalResponse, error)</span></span> &#123;</span><br><span class="line">	endorserLogger.Debug(<span class="string">"Entering endorsement for"</span>, ctx)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ctx.Response == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"response is nil"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ctx.Response.Status &gt;= shim.ERRORTHRESHOLD &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;pb.ProposalResponse&#123;Response: ctx.Response&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取插件</span></span><br><span class="line">	plugin, err := pe.getOrCreatePlugin(PluginName(ctx.PluginName), ctx.Channel)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		endorserLogger.Warning(<span class="string">"Endorsement with plugin for"</span>, ctx, <span class="string">" failed:"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">"plugin with name %s could not be used: %v"</span>, ctx.PluginName, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把模拟执行的信息组成生成背书响应Payload</span></span><br><span class="line">	prpBytes, err := proposalResponsePayloadFromContext(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		endorserLogger.Warning(<span class="string">"Endorsement with plugin for"</span>, ctx, <span class="string">" failed:"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">"failed assembling proposal response payload"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对Payload和签名的Proposal进行背书</span></span><br><span class="line">	endorsement, prpBytes, err := plugin.Endorse(prpBytes, ctx.SignedProposal)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		endorserLogger.Warning(<span class="string">"Endorsement with plugin for"</span>, ctx, <span class="string">" failed:"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithStack(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resp := &amp;pb.ProposalResponse&#123;</span><br><span class="line">		Version:     <span class="number">1</span>,</span><br><span class="line">		Endorsement: endorsement,</span><br><span class="line">		Payload:     prpBytes,</span><br><span class="line">		Response:    ctx.Response,</span><br><span class="line">	&#125;</span><br><span class="line">	endorserLogger.Debug(<span class="string">"Exiting"</span>, ctx)</span><br><span class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统提供的默认背书插件如下，<strong>本质是对交易执行结果和Proposal签名人信息进行签名。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Endorse signs the given payload(ProposalResponsePayload bytes), and optionally mutates it.</span></span><br><span class="line"><span class="comment">// Returns:</span></span><br><span class="line"><span class="comment">// The Endorsement: A signature over the payload, and an identity that is used to verify the signature</span></span><br><span class="line"><span class="comment">// The payload that was given as input (could be modified within this function)</span></span><br><span class="line"><span class="comment">// Or error on failure</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *DefaultEndorsement)</span> <span class="title">Endorse</span><span class="params">(prpBytes []<span class="keyword">byte</span>, sp *peer.SignedProposal)</span> <span class="params">(*peer.Endorsement, []<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 提取Proposal的签名人</span></span><br><span class="line">	signer, err := e.SigningIdentityForRequest(sp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.New(fmt.Sprintf(<span class="string">"failed fetching signing identity: %v"</span>, err))</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 得到签名人身份</span></span><br><span class="line">	<span class="comment">// serialize the signing identity</span></span><br><span class="line">	identityBytes, err := signer.Serialize()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.New(fmt.Sprintf(<span class="string">"could not serialize the signing identity: %v"</span>, err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对Payload和身份进行签名</span></span><br><span class="line">	<span class="comment">// sign the concatenation of the proposal response and the serialized endorser identity with this endorser's key</span></span><br><span class="line">	signature, err := signer.Sign(<span class="built_in">append</span>(prpBytes, identityBytes...))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.New(fmt.Sprintf(<span class="string">"could not sign the proposal response payload: %v"</span>, err))</span><br><span class="line">	&#125;</span><br><span class="line">	endorsement := &amp;peer.Endorsement&#123;Signature: signature, Endorser: identityBytes&#125;</span><br><span class="line">	<span class="keyword">return</span> endorsement, prpBytes, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送Response"><a href="#发送Response" class="headerlink" title="发送Response"></a>发送Response</h3><p><code>ProcessProposal</code> 会把 ProposalResponse 作为返回值，剩下的就交给 gRPC，发送给请求方了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文从宏观和源码层面，解读了交易提案背书涉及的数据结构，以及其主要背书流程，核心可以主要包含以下几步：</p>
<ol>
<li>检查Proposal</li>
<li>为交易创建模拟器，并调用模拟器模拟执行交易，生成执行结果</li>
<li>背书模块对执行结果和Proposal身份信息背书（签名），然后生成背书响应发送给客户端</li>
</ol>
<p>关于背书流程，本文未涉及的环节有：</p>
<ol>
<li>Proposal中各字段，层层递进的含义</li>
<li>模拟执行交易，是链码执行函数，并和Peer交互的过程，以及模拟执行的各种资源</li>
<li>2种插件化ESCC的实现</li>
</ol>
<p>后面的章节，会对相关源码实现做进一步分析。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>大彬
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://lessisbetter.site/2019/10/29/fabric-transaction-endorser-source/" title="Fabric 1.4源码解读 4：交易背书流程解读">http://lessisbetter.site/2019/10/29/fabric-transaction-endorser-source/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
                <span class="icon">
                  <i class="fa fa-wechat"></i>
                </span>

                <span class="label">公众号</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"># 区块链</a>
              <a href="/tags/Fabric/" rel="tag"># Fabric</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/10/20/go-gc-1-history-and-priciple/" rel="prev" title="Go垃圾回收 1：历史和原理">
      <i class="fa fa-chevron-left"></i> Go垃圾回收 1：历史和原理
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/10/31/fabric-sdk-go-configure-graph/" rel="next" title="fabric-sdk-go 配置项分类">
      fabric-sdk-go 配置项分类 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#流程"><span class="nav-number">1.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#交易宏观流程"><span class="nav-number">1.1.</span> <span class="nav-text">交易宏观流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#链码调用流程"><span class="nav-number">1.2.</span> <span class="nav-text">链码调用流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提案背书流程"><span class="nav-number">1.3.</span> <span class="nav-text">提案背书流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">2.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Proposal定义"><span class="nav-number">2.1.</span> <span class="nav-text">Proposal定义</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proposal"><span class="nav-number">2.1.1.</span> <span class="nav-text">Proposal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Header"><span class="nav-number">2.1.2.</span> <span class="nav-text">Header</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gRPC定义"><span class="nav-number">2.2.</span> <span class="nav-text">gRPC定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDK发送Proposal"><span class="nav-number">2.3.</span> <span class="nav-text">SDK发送Proposal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Peer接收Proposal"><span class="nav-number">2.4.</span> <span class="nav-text">Peer接收Proposal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Peer处理Proposal主流程"><span class="nav-number">2.5.</span> <span class="nav-text">Peer处理Proposal主流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#preProcess-检查和获取信息"><span class="nav-number">2.6.</span> <span class="nav-text">preProcess 检查和获取信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#背书节点模拟执行交易"><span class="nav-number">2.7.</span> <span class="nav-text">背书节点模拟执行交易</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取模拟器"><span class="nav-number">2.7.1.</span> <span class="nav-text">获取模拟器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟执行"><span class="nav-number">2.7.2.</span> <span class="nav-text">模拟执行</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#endorser部分"><span class="nav-number">2.7.2.1.</span> <span class="nav-text">endorser部分</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#chaincode部分"><span class="nav-number">2.7.2.2.</span> <span class="nav-text">chaincode部分</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#获取链码执行环境"><span class="nav-number">2.7.2.3.</span> <span class="nav-text">获取链码执行环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#模拟执行交易"><span class="nav-number">2.7.2.4.</span> <span class="nav-text">模拟执行交易</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#处理链码容器模拟响应"><span class="nav-number">2.7.2.5.</span> <span class="nav-text">处理链码容器模拟响应</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#释放模拟器资源"><span class="nav-number">2.7.3.</span> <span class="nav-text">释放模拟器资源</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ESCC处理模拟执行结果"><span class="nav-number">2.8.</span> <span class="nav-text">ESCC处理模拟执行结果</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Endorser-endorseProposal"><span class="nav-number">2.8.0.1.</span> <span class="nav-text">Endorser.endorseProposal</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送Response"><span class="nav-number">2.9.</span> <span class="nav-text">发送Response</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="大彬"
      src="http://img.lessisbetter.site/gzh-qrcode-logo-small.png">
  <p class="site-author-name" itemprop="name">大彬</p>
  <div class="site-description" itemprop="description">区块链、Go语言</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">136</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="http://img.lessisbetter.site/gzh-qrcode-logo-small.png" title="公众号 → http://img.lessisbetter.site/gzh-qrcode-logo-small.png" rel="noopener" target="_blank"><i class="fa fa-fw fa-wechat"></i>公众号</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/shitaibin" title="GitHub → https://github.com/shitaibin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://segmentfault.com/u/lessisbetter" title="SegmentFault → https://segmentfault.com/u/lessisbetter" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>SegmentFault</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/947f3ccdd481" title="简书 → https://www.jianshu.com/u/947f3ccdd481" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>简书</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/4296218/james-shi" title="StackOverflow → https://stackoverflow.com/users/4296218/james-shi" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hz_stb@163.com" title="E-Mail → mailto:hz_stb@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://xargin.com" title="https://xargin.com" rel="noopener" target="_blank">Xargin曹大博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://pingcap.com/blog-cn/" title="https://pingcap.com/blog-cn/" rel="noopener" target="_blank">PingCap技术博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://qcrao.github.io/" title="https://qcrao.github.io/" rel="noopener" target="_blank">码农桃花源博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://book.eddycjy.com/golang/" title="https://book.eddycjy.com/golang/" rel="noopener" target="_blank">煎鱼的迷之博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://dave.cheney.net" title="https://dave.cheney.net" rel="noopener" target="_blank">Dave Cheney的博客</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://theme-next.iissnan.com/getting-started.html" title="http://theme-next.iissnan.com/getting-started.html" rel="noopener" target="_blank">Hexo Next主题配置</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">浙ICP </a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=18051706" rel="noopener" target="_blank">备18051706 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">大彬</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1275814754&web_id=1275814754"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'default',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '5bfe6f6d1ad3c04f357d',
      clientSecret: '478b8db1365b4cd59cd27297cafe5d5a29f2cf0e',
      repo        : 'shitaibin.github.io',
      owner       : 'Shitaibin',
      admin       : ['Shitaibin'],
      id          : '79ed036beb27d75bae22dae119e4d047',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
